<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>KVM (Kernel-based Virtual Machine) æ·±åº¦å­¦ä¹ ç¬”è®° - å¼€å‘</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å¼€å‘</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="æœç´¢æœ¬ä¹¦å†…å®¹..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="kvm-kernel-based-virtual-machine-æ·±åº¦å­¦ä¹ ç¬”è®°"><a class="header" href="#kvm-kernel-based-virtual-machine-æ·±åº¦å­¦ä¹ ç¬”è®°">KVM (Kernel-based Virtual Machine) æ·±åº¦å­¦ä¹ ç¬”è®°</a></h1>
<h2 id="-å­¦ä¹ è·¯çº¿å›¾"><a class="header" href="#-å­¦ä¹ è·¯çº¿å›¾">ğŸ“‹ å­¦ä¹ è·¯çº¿å›¾</a></h2>
<pre><code>åŸºç¡€æ¦‚å¿µ â†’ ç¡¬ä»¶è™šæ‹ŸåŒ– â†’ å†…å­˜è™šæ‹ŸåŒ– â†’ CPUè™šæ‹ŸåŒ– â†’ I/Oè™šæ‹ŸåŒ– â†’ å®æˆ˜éƒ¨ç½² â†’ æ€§èƒ½ä¼˜åŒ–
   â†“           â†“            â†“           â†“           â†“          â†“          â†“
 KVMæ¶æ„   VT-x/AMD-V    EPT/NPT      vCPU       Virtio    QEMU/KVM   è°ƒä¼˜æŠ€å·§
</code></pre>
<hr />
<h2 id="ç¬¬ä¸€ç« kvmåŸºç¡€æ¶æ„ä¸æ ¸å¿ƒæ¦‚å¿µ"><a class="header" href="#ç¬¬ä¸€ç« kvmåŸºç¡€æ¶æ„ä¸æ ¸å¿ƒæ¦‚å¿µ">ç¬¬ä¸€ç« ï¼šKVMåŸºç¡€æ¶æ„ä¸æ ¸å¿ƒæ¦‚å¿µ</a></h2>
<h3 id="11-ä»€ä¹ˆæ˜¯kvm"><a class="header" href="#11-ä»€ä¹ˆæ˜¯kvm">1.1 ä»€ä¹ˆæ˜¯KVM</a></h3>
<p><strong>KVM (Kernel-based Virtual Machine)</strong> æ˜¯Linuxå†…æ ¸çš„è™šæ‹ŸåŒ–æ¨¡å—ï¼Œäº2007å¹´é›†æˆåˆ°Linux 2.6.20å†…æ ¸ä¸­ã€‚å®ƒå°†Linuxå†…æ ¸è½¬å˜ä¸ºä¸€ä¸ªType-1å‹è£¸æœºè™šæ‹Ÿæœºç›‘æ§å™¨(Hypervisor)ã€‚</p>
<h4 id="æ ¸å¿ƒç‰¹ç‚¹"><a class="header" href="#æ ¸å¿ƒç‰¹ç‚¹">æ ¸å¿ƒç‰¹ç‚¹</a></h4>
<ol>
<li><strong>å†…æ ¸çº§è™šæ‹ŸåŒ–</strong>ï¼šKVMæ˜¯Linuxå†…æ ¸æ¨¡å—ï¼Œè€Œä¸æ˜¯ç‹¬ç«‹çš„è™šæ‹Ÿæœºç›‘æ§å™¨</li>
<li><strong>ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–</strong>ï¼šå¿…é¡»ä¾èµ–CPUç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆIntel VT-x æˆ– AMD-Vï¼‰</li>
<li><strong>å®Œæ•´è™šæ‹ŸåŒ–</strong>ï¼šæä¾›å®Œå…¨è™šæ‹ŸåŒ–ï¼ŒGuest OSæ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ</li>
<li><strong>å¼€æºç”Ÿæ€</strong>ï¼šåŸºäºGPLåè®®ï¼Œä¸Linuxå†…æ ¸ç´§å¯†é›†æˆ</li>
</ol>
<h4 id="kvmä¸ä¼ ç»Ÿè™šæ‹ŸåŒ–çš„åŒºåˆ«"><a class="header" href="#kvmä¸ä¼ ç»Ÿè™šæ‹ŸåŒ–çš„åŒºåˆ«">KVMä¸ä¼ ç»Ÿè™šæ‹ŸåŒ–çš„åŒºåˆ«</a></h4>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>KVM</th><th>VMware ESXi</th><th>Xen</th></tr></thead><tbody>
<tr><td>ç±»å‹</td><td>Type-1ï¼ˆå€ŸåŠ©Linuxå†…æ ¸ï¼‰</td><td>Type-1</td><td>Type-1</td></tr>
<tr><td>å†…æ ¸é›†æˆ</td><td>æ˜¯ï¼ˆLinuxå†…æ ¸æ¨¡å—ï¼‰</td><td>å¦ï¼ˆç‹¬ç«‹Hypervisorï¼‰</td><td>éƒ¨åˆ†ï¼ˆDom0ï¼‰</td></tr>
<tr><td>ç¡¬ä»¶è¦æ±‚</td><td>å¿…é¡»VT-x/AMD-V</td><td>å¿…é¡»VT-x/AMD-V</td><td>å¯é€‰ç¡¬ä»¶è™šæ‹ŸåŒ–</td></tr>
<tr><td>è®¸å¯è¯</td><td>GPLå¼€æº</td><td>å•†ä¸š+å…è´¹ç‰ˆ</td><td>GPLå¼€æº</td></tr>
<tr><td>Guesté©±åŠ¨</td><td>Virtio</td><td>VMware Tools</td><td>Xen PVé©±åŠ¨</td></tr>
</tbody></table>
</div>
<h3 id="12-kvmæ¶æ„å‰–æ"><a class="header" href="#12-kvmæ¶æ„å‰–æ">1.2 KVMæ¶æ„å‰–æ</a></h3>
<h4 id="ä¸‰å±‚æ¶æ„æ¨¡å‹"><a class="header" href="#ä¸‰å±‚æ¶æ„æ¨¡å‹">ä¸‰å±‚æ¶æ„æ¨¡å‹</a></h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Guest OS (è™šæ‹Ÿæœº)                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ åº”ç”¨ç¨‹åº  â”‚  â”‚ åº”ç”¨ç¨‹åº  â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚    Guest Kernel          â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†• (VM Exit/Entry)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      QEMU ç”¨æˆ·ç©ºé—´è¿›ç¨‹                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  è®¾å¤‡æ¨¡æ‹Ÿå™¨   â”‚  â”‚  I/Oå¤„ç†   â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†• (ioctlç³»ç»Ÿè°ƒç”¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      KVM å†…æ ¸æ¨¡å—                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  kvm.ko      â”‚  â”‚ kvm-intel/ â”‚     â”‚
â”‚   â”‚  (æ ¸å¿ƒæ¨¡å—)   â”‚  â”‚ kvm-amd    â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Linux ä¸»æœºå†…æ ¸                      â”‚
â”‚   (è¿›ç¨‹è°ƒåº¦ã€å†…å­˜ç®¡ç†ã€I/Oå­ç³»ç»Ÿ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç‰©ç†ç¡¬ä»¶ (CPU/å†…å­˜/è®¾å¤‡)            â”‚
â”‚   (Intel VT-x / AMD-V)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="æ ¸å¿ƒç»„ä»¶è¯¦è§£"><a class="header" href="#æ ¸å¿ƒç»„ä»¶è¯¦è§£">æ ¸å¿ƒç»„ä»¶è¯¦è§£</a></h4>
<p><strong>1. KVMå†…æ ¸æ¨¡å—ï¼ˆkvm.koï¼‰</strong></p>
<p>KVMå†…æ ¸æ¨¡å—è´Ÿè´£æ ¸å¿ƒè™šæ‹ŸåŒ–åŠŸèƒ½ï¼š</p>
<pre><code class="language-c">// KVMæ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
struct kvm {
    spinlock_t mmu_lock;                // MMUé”
    struct list_head vm_list;           // è™šæ‹Ÿæœºåˆ—è¡¨
    struct kvm_memslots *memslots;      // å†…å­˜æ§½
    struct kvm_vcpu *vcpus[KVM_MAX_VCPUS]; // vCPUæ•°ç»„
    struct kvm_io_bus *buses[KVM_NR_BUSES]; // I/Oæ€»çº¿
};

struct kvm_vcpu {
    struct kvm *kvm;                    // æ‰€å±è™šæ‹Ÿæœº
    int cpu;                            // ç»‘å®šçš„ç‰©ç†CPU
    struct kvm_run *run;                // è¿è¡Œæ—¶çŠ¶æ€
    unsigned long requests;              // è¯·æ±‚æ ‡å¿—
    struct kvm_vcpu_arch arch;          // æ¶æ„ç›¸å…³
};
</code></pre>
<p><strong>ä¸»è¦èŒè´£ï¼š</strong></p>
<ul>
<li>CPUè™šæ‹ŸåŒ–ï¼švCPUç®¡ç†ã€å¯„å­˜å™¨ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>å†…å­˜è™šæ‹ŸåŒ–ï¼šEPT/NPTç®¡ç†ã€å½±å­é¡µè¡¨</li>
<li>ä¸­æ–­è™šæ‹ŸåŒ–ï¼šä¸­æ–­æ³¨å…¥ã€APICè™šæ‹ŸåŒ–</li>
<li>è®¾å¤‡ç›´é€šï¼šIOMMUã€SR-IOVæ”¯æŒ</li>
</ul>
<p><strong>2. æ¶æ„ç‰¹å®šæ¨¡å—ï¼ˆkvm-intel.ko / kvm-amd.koï¼‰</strong></p>
<p>å¤„ç†ç‰¹å®šCPUæ¶æ„çš„è™šæ‹ŸåŒ–æŒ‡ä»¤ï¼š</p>
<pre><code class="language-c">// Intel VT-xç‰¹å®šç»“æ„
struct vcpu_vmx {
    struct kvm_vcpu vcpu;
    struct vmcs *vmcs;          // è™šæ‹Ÿæœºæ§åˆ¶ç»“æ„
    u32 exit_reason;            // VM ExitåŸå› 
    u32 idt_vectoring_info;     // ä¸­æ–­å‘é‡ä¿¡æ¯
};

// AMD-Vç‰¹å®šç»“æ„
struct vcpu_svm {
    struct kvm_vcpu vcpu;
    struct vmcb *vmcb;          // è™šæ‹Ÿæœºæ§åˆ¶å—
    u32 exit_code;              // VM Exitä»£ç 
};
</code></pre>
<p><strong>3. QEMUç”¨æˆ·ç©ºé—´</strong></p>
<p>QEMUæ˜¯KVMçš„è®¾å¤‡æ¨¡æ‹Ÿå™¨å’Œè™šæ‹Ÿæœºç®¡ç†å™¨ï¼š</p>
<ul>
<li><strong>è®¾å¤‡æ¨¡æ‹Ÿ</strong>ï¼šæ¨¡æ‹Ÿç¡¬ç›˜ã€ç½‘å¡ã€æ˜¾å¡ç­‰è™šæ‹Ÿè®¾å¤‡</li>
<li><strong>BIOS/UEFI</strong>ï¼šæä¾›SeaBIOSæˆ–OVMFå›ºä»¶</li>
<li><strong>å†…å­˜ç®¡ç†</strong>ï¼šé€šè¿‡mmapåˆ†é…Guestç‰©ç†å†…å­˜</li>
<li><strong>I/Oå¤„ç†</strong>ï¼šå¤„ç†MMIOå’ŒPIOæ“ä½œ</li>
<li><strong>ç›‘æ§æ¥å£</strong>ï¼šQMPï¼ˆQEMU Monitor Protocolï¼‰</li>
</ul>
<h4 id="kvmå·¥ä½œæµç¨‹"><a class="header" href="#kvmå·¥ä½œæµç¨‹">KVMå·¥ä½œæµç¨‹</a></h4>
<p><strong>è™šæ‹Ÿæœºå¯åŠ¨æµç¨‹ï¼š</strong></p>
<pre><code>1. QEMUè¿›ç¨‹å¯åŠ¨
   â†“
2. æ‰“å¼€/dev/kvmè®¾å¤‡
   ioctl(KVM_CREATE_VM)  â†’ åˆ›å»ºè™šæ‹Ÿæœº
   â†“
3. é…ç½®è™šæ‹Ÿæœº
   ioctl(KVM_SET_USER_MEMORY_REGION) â†’ è®¾ç½®å†…å­˜
   ioctl(KVM_CREATE_VCPU) â†’ åˆ›å»ºvCPU
   ioctl(KVM_SET_CPUID2) â†’ è®¾ç½®CPUID
   â†“
4. åˆå§‹åŒ–vCPU
   ioctl(KVM_SET_REGS) â†’ è®¾ç½®å¯„å­˜å™¨
   ioctl(KVM_SET_SREGS) â†’ è®¾ç½®ç‰¹æ®Šå¯„å­˜å™¨
   â†“
5. è¿è¡Œè™šæ‹Ÿæœº
   ioctl(KVM_RUN) â†’ è¿›å…¥Guestæ¨¡å¼
   â†“
6. å¤„ç†VM Exit
   - å¤„ç†I/Oæ“ä½œ
   - å¤„ç†MMIO
   - å¤„ç†ä¸­æ–­
   â†“
7. è¿”å›Guestç»§ç»­æ‰§è¡Œ
</code></pre>
<p><strong>å…³é”®ioctlè°ƒç”¨ï¼š</strong></p>
<pre><code class="language-c">// åˆ›å»ºè™šæ‹Ÿæœº
vm_fd = ioctl(kvm_fd, KVM_CREATE_VM, 0);

// è®¾ç½®å†…å­˜åŒºåŸŸ
struct kvm_userspace_memory_region region = {
    .slot = 0,
    .guest_phys_addr = 0x0,
    .memory_size = 1ULL &lt;&lt; 30,  // 1GB
    .userspace_addr = (unsigned long)guest_memory,
};
ioctl(vm_fd, KVM_SET_USER_MEMORY_REGION, &amp;region);

// åˆ›å»ºvCPU
vcpu_fd = ioctl(vm_fd, KVM_CREATE_VCPU, 0);

// è¿è¡ŒvCPU
while (1) {
    ioctl(vcpu_fd, KVM_RUN, 0);

    // å¤„ç†VM Exit
    switch (run-&gt;exit_reason) {
        case KVM_EXIT_IO:
            handle_io(run);
            break;
        case KVM_EXIT_MMIO:
            handle_mmio(run);
            break;
        case KVM_EXIT_HLT:
            // è™šæ‹Ÿæœºhalt
            return 0;
    }
}
</code></pre>
<h3 id="13-ç¡¬ä»¶è™šæ‹ŸåŒ–åŸºç¡€"><a class="header" href="#13-ç¡¬ä»¶è™šæ‹ŸåŒ–åŸºç¡€">1.3 ç¡¬ä»¶è™šæ‹ŸåŒ–åŸºç¡€</a></h3>
<h4 id="cpuè™šæ‹ŸåŒ–æŠ€æœ¯"><a class="header" href="#cpuè™šæ‹ŸåŒ–æŠ€æœ¯">CPUè™šæ‹ŸåŒ–æŠ€æœ¯</a></h4>
<p><strong>Intel VT-xï¼ˆVirtualization Technologyï¼‰</strong></p>
<p>VT-xå¼•å…¥äº†ä¸¤ç§æ“ä½œæ¨¡å¼ï¼š</p>
<ul>
<li><strong>VMX root operation</strong>ï¼šHypervisorè¿è¡Œæ¨¡å¼ï¼ˆRing -1ï¼‰</li>
<li><strong>VMX non-root operation</strong>ï¼šGuestè¿è¡Œæ¨¡å¼ï¼ˆRing 0-3ï¼‰</li>
</ul>
<p><strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong></p>
<ol>
<li><strong>VMCS (Virtual Machine Control Structure)</strong>
<ul>
<li>GuestçŠ¶æ€åŒºï¼šä¿å­˜Guest CPUçŠ¶æ€</li>
<li>HostçŠ¶æ€åŒºï¼šä¿å­˜Host CPUçŠ¶æ€</li>
<li>æ§åˆ¶åŒºï¼šé…ç½®VM Entry/Exitæ¡ä»¶</li>
<li>åªè¯»åŒºï¼šä¿å­˜ExitåŸå› ç­‰ä¿¡æ¯</li>
</ul>
</li>
</ol>
<pre><code>VMCSç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Guest State Area   â”‚  â† Guestå¯„å­˜å™¨ã€CR3ã€IDTRç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Host State Area    â”‚  â† Hostæ¢å¤çŠ¶æ€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VM-Execution       â”‚  â† æ§åˆ¶VM Exitæ¡ä»¶
â”‚  Control Fields     â”‚     (I/Oã€MSRã€å¼‚å¸¸ç­‰)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VM-Exit Control    â”‚  â† Exitæ—¶ä¿å­˜çš„ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VM-Entry Control   â”‚  â† Entryæ—¶åŠ è½½çš„çŠ¶æ€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VM-Exit Info       â”‚  â† ExitåŸå› ã€é”™è¯¯ç 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<ol start="2">
<li><strong>VM Entry/Exitæœºåˆ¶</strong></li>
</ol>
<pre><code>VM Entry (VMLAUNCH/VMRESUME):
  HostçŠ¶æ€ â†’ VMCSä¿å­˜
  â†“
  VMCS GuestçŠ¶æ€ â†’ CPUå¯„å­˜å™¨åŠ è½½
  â†“
  è¿›å…¥VMX non-rootæ¨¡å¼

VM Exit (æ•æ„ŸæŒ‡ä»¤/äº‹ä»¶è§¦å‘):
  GuestçŠ¶æ€ â†’ VMCSä¿å­˜
  â†“
  VMCS HostçŠ¶æ€ â†’ CPUå¯„å­˜å™¨åŠ è½½
  â†“
  è¿”å›VMX rootæ¨¡å¼
  â†“
  KVMå¤„ç†ExitåŸå› 
</code></pre>
<p><strong>è§¦å‘VM Exitçš„å¸¸è§åŸå› ï¼š</strong></p>
<ul>
<li>æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ï¼ˆCPUIDã€HLTã€INVLPGç­‰ï¼‰</li>
<li>è®¿é—®CR0/CR3/CR4å¯„å­˜å™¨</li>
<li>I/Oç«¯å£è®¿é—®</li>
<li>MSRè¯»å†™</li>
<li>ä¸­æ–­çª—å£</li>
<li>EPTè¿è§„ï¼ˆé¡µè¡¨ç¼ºå¤±ï¼‰</li>
<li>å¼‚å¸¸æ³¨å…¥</li>
</ul>
<p><strong>AMD-V (SVM - Secure Virtual Machine)</strong></p>
<p>AMDçš„è™šæ‹ŸåŒ–æŠ€æœ¯ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li><strong>VMCB (Virtual Machine Control Block)</strong>ï¼šç±»ä¼¼VMCS</li>
<li><strong>VMRUNæŒ‡ä»¤</strong>ï¼šè¿›å…¥Guestæ¨¡å¼</li>
<li><strong>#VMEXITäº‹ä»¶</strong>ï¼šé€€å‡ºGuestæ¨¡å¼</li>
<li><strong>NPT (Nested Page Tables)</strong>ï¼šäºŒç»´é¡µè¡¨ï¼Œå¯¹åº”Intel EPT</li>
</ul>
<h4 id="æ£€æŸ¥ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ"><a class="header" href="#æ£€æŸ¥ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ">æ£€æŸ¥ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ</a></h4>
<pre><code class="language-bash"># æ£€æŸ¥CPUæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–
# Intel VT-x
grep -E 'vmx' /proc/cpuinfo

# AMD-V
grep -E 'svm' /proc/cpuinfo

# æŸ¥çœ‹è™šæ‹ŸåŒ–æ ‡å¿—
lscpu | grep Virtualization

# æ£€æŸ¥KVMæ¨¡å—æ˜¯å¦åŠ è½½
lsmod | grep kvm
</code></pre>
<hr />
<h2 id="ç¬¬äºŒç« å†…å­˜è™šæ‹ŸåŒ–æ·±åº¦è§£æ"><a class="header" href="#ç¬¬äºŒç« å†…å­˜è™šæ‹ŸåŒ–æ·±åº¦è§£æ">ç¬¬äºŒç« ï¼šå†…å­˜è™šæ‹ŸåŒ–æ·±åº¦è§£æ</a></h2>
<h3 id="21-å†…å­˜è™šæ‹ŸåŒ–æŒ‘æˆ˜"><a class="header" href="#21-å†…å­˜è™šæ‹ŸåŒ–æŒ‘æˆ˜">2.1 å†…å­˜è™šæ‹ŸåŒ–æŒ‘æˆ˜</a></h3>
<p>è™šæ‹ŸåŒ–ç¯å¢ƒä¸­å­˜åœ¨<strong>ä¸‰å±‚åœ°å€ç©ºé—´</strong>ï¼š</p>
<pre><code>GVA (Guest Virtual Address)     â† Gueståº”ç”¨ç¨‹åºä½¿ç”¨
  â†“ (Guesté¡µè¡¨è½¬æ¢)
GPA (Guest Physical Address)    â† Guest OSçœ‹åˆ°çš„"ç‰©ç†"åœ°å€
  â†“ (Hypervisorè½¬æ¢)
HPA (Host Physical Address)     â† çœŸå®ç‰©ç†åœ°å€
</code></pre>
<p><strong>ä¼ ç»Ÿé—®é¢˜ï¼š</strong></p>
<ol>
<li>Guestä¿®æ”¹é¡µè¡¨æ—¶ï¼ŒHostéœ€è¦éªŒè¯å’ŒåŒæ­¥</li>
<li>æ¯æ¬¡å†…å­˜è®¿é—®å¯èƒ½éœ€è¦å¤šæ¬¡é¡µè¡¨æŸ¥æ‰¾ï¼ˆæœ€å¤š25æ¬¡ï¼ï¼‰</li>
<li>TLBå¤±æ•ˆå’Œåˆ·æ–°é¢‘ç¹</li>
</ol>
<h3 id="22-å½±å­é¡µè¡¨æŠ€æœ¯-shadow-page-tables"><a class="header" href="#22-å½±å­é¡µè¡¨æŠ€æœ¯-shadow-page-tables">2.2 å½±å­é¡µè¡¨æŠ€æœ¯ (Shadow Page Tables)</a></h3>
<h4 id="å·¥ä½œåŸç†"><a class="header" href="#å·¥ä½œåŸç†">å·¥ä½œåŸç†</a></h4>
<p><strong>å½±å­é¡µè¡¨</strong>æ˜¯KVMæ—©æœŸä½¿ç”¨çš„å†…å­˜è™šæ‹ŸåŒ–æŠ€æœ¯ï¼ˆåœ¨EPT/NPTå‡ºç°ä¹‹å‰ï¼‰ï¼š</p>
<pre><code>Guestè¿›ç¨‹:
  GVA â†’ [Guesté¡µè¡¨] â†’ GPA

KVMç»´æŠ¤:
  GVA â†’ [å½±å­é¡µè¡¨] â†’ HPA

ç¡¬ä»¶å®é™…ä½¿ç”¨:
  CR3 â†’ å½±å­é¡µè¡¨åŸºå€
</code></pre>
<p><strong>è¯¦ç»†æµç¨‹ï¼š</strong></p>
<ol>
<li><strong>åˆå§‹çŠ¶æ€</strong>ï¼šGuestå¯åŠ¨æ—¶ï¼Œå½±å­é¡µè¡¨ä¸ºç©º</li>
<li><strong>Guestä¿®æ”¹é¡µè¡¨</strong>ï¼šKVMæ‹¦æˆªCR3å†™å…¥ï¼ˆVM Exitï¼‰</li>
<li><strong>æ„å»ºå½±å­é¡µè¡¨</strong>ï¼š
<ul>
<li>è¯»å–Guesté¡µè¡¨é¡¹ï¼ˆGVAâ†’GPAæ˜ å°„ï¼‰</li>
<li>æŸ¥æ‰¾GPAâ†’HPAæ˜ å°„</li>
<li>åˆ›å»ºå½±å­é¡µè¡¨é¡¹ï¼ˆGVAâ†’HPAæ˜ å°„ï¼‰</li>
</ul>
</li>
<li><strong>ç¡¬ä»¶ä½¿ç”¨å½±å­é¡µè¡¨</strong>ï¼šCPUä½¿ç”¨å½±å­é¡µè¡¨å®Œæˆåœ°å€è½¬æ¢</li>
</ol>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li><strong>æ€§èƒ½å¼€é”€å¤§</strong>ï¼šæ¯æ¬¡Guestä¿®æ”¹é¡µè¡¨éƒ½è§¦å‘VM Exit</li>
<li><strong>å†…å­˜å¼€é”€å¤§</strong>ï¼šæ¯ä¸ªGuesté¡µè¡¨éƒ½éœ€è¦å¯¹åº”çš„å½±å­é¡µè¡¨</li>
<li><strong>å¤æ‚åº¦é«˜</strong>ï¼šéœ€è¦ç»´æŠ¤Guesté¡µè¡¨å’Œå½±å­é¡µè¡¨çš„åŒæ­¥</li>
</ul>
<h4 id="ä»£ç ç¤ºä¾‹ç®€åŒ–"><a class="header" href="#ä»£ç ç¤ºä¾‹ç®€åŒ–">ä»£ç ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰</a></h4>
<pre><code class="language-c">// å½±å­é¡µè¡¨ç›¸å…³æ•°æ®ç»“æ„
struct kvm_mmu_page {
    struct hlist_node hash_link;
    struct list_head link;

    gfn_t gfn;              // Guest Frame Number
    u64 *spt;               // å½±å­é¡µè¡¨æŒ‡é’ˆ
    unsigned role;          // é¡µè¡¨è§’è‰²
    bool unsync;            // æ˜¯å¦æœªåŒæ­¥
};

// å¤„ç†Guesté¡µè¡¨ä¿®æ”¹
static int handle_cr3_write(struct kvm_vcpu *vcpu, unsigned long val) {
    // 1. ä¿å­˜æ–°çš„Guest CR3
    vcpu-&gt;arch.cr3 = val;

    // 2. æŸ¥æ‰¾æˆ–åˆ›å»ºå½±å­é¡µè¡¨
    struct kvm_mmu_page *sp = kvm_mmu_get_page(vcpu, val);

    // 3. åŒæ­¥Guesté¡µè¡¨åˆ°å½±å­é¡µè¡¨
    kvm_mmu_sync_page(vcpu, sp);

    // 4. åŠ è½½å½±å­é¡µè¡¨åˆ°ç¡¬ä»¶CR3
    vcpu-&gt;arch.mmu.root_hpa = __pa(sp-&gt;spt);

    return 0;
}
</code></pre>
<h3 id="23-ç¡¬ä»¶è¾…åŠ©å†…å­˜è™šæ‹ŸåŒ–-eptnpt"><a class="header" href="#23-ç¡¬ä»¶è¾…åŠ©å†…å­˜è™šæ‹ŸåŒ–-eptnpt">2.3 ç¡¬ä»¶è¾…åŠ©å†…å­˜è™šæ‹ŸåŒ– (EPT/NPT)</a></h3>
<h4 id="intel-ept-extended-page-tables"><a class="header" href="#intel-ept-extended-page-tables">Intel EPT (Extended Page Tables)</a></h4>
<p>EPTæ˜¯Intelæä¾›çš„ç¡¬ä»¶äºŒç»´é¡µè¡¨æœºåˆ¶ï¼Œ<strong>å®Œå…¨ç”±ç¡¬ä»¶å®ŒæˆGPAâ†’HPAè½¬æ¢</strong>ã€‚</p>
<p><strong>EPTé¡µè¡¨ç»“æ„ï¼š</strong></p>
<pre><code>å››çº§EPTé¡µè¡¨ç»“æ„ (ç±»ä¼¼x86-64é¡µè¡¨):

EPT PML4 (Page Map Level 4)
  â†“
EPT PDPT (Page Directory Pointer Table)
  â†“
EPT PD (Page Directory)
  â†“
EPT PT (Page Table)
  â†“
HPA (Host Physical Address)
</code></pre>
<p><strong>åœ°å€è½¬æ¢è¿‡ç¨‹ï¼š</strong></p>
<pre><code>æ— EPTæ—¶:
GVA â”€â”€[Guesté¡µè¡¨]â†’ GPA â”€â”€[å½±å­é¡µè¡¨]â†’ HPA
      (4çº§æŸ¥æ‰¾)          (è½¯ä»¶ç»´æŠ¤)

æœ‰EPTå:
GVA â”€â”€[Guesté¡µè¡¨]â†’ GPA â”€â”€[EPTé¡µè¡¨]â†’ HPA
      (4çº§æŸ¥æ‰¾)          (ç¡¬ä»¶æŸ¥æ‰¾)

ä½†æ˜¯ï¼Guesté¡µè¡¨æœ¬èº«å­˜å‚¨åœ¨GPAä¸­ï¼Œæ‰€ä»¥ï¼š
æ¯è®¿é—®ä¸€ä¸ªGuesté¡µè¡¨é¡¹ï¼Œéƒ½éœ€è¦EPTè½¬æ¢ï¼

å®Œæ•´è¿‡ç¨‹ï¼ˆæœ€åæƒ…å†µï¼‰:
GVA â†’ L4(GPA) â”€EPTâ†’ L4(HPA) è¯»å–
    â†’ L3(GPA) â”€EPTâ†’ L3(HPA) è¯»å–
    â†’ L2(GPA) â”€EPTâ†’ L2(HPA) è¯»å–
    â†’ L1(GPA) â”€EPTâ†’ L1(HPA) è¯»å–
    â†’ GPA â”€EPTâ†’ HPA æœ€ç»ˆæ•°æ®

æœ€å¤šéœ€è¦: 4(Guesté¡µè¡¨) Ã— 4(EPT) + 1(æœ€ç»ˆEPT) = 17æ¬¡å†…å­˜è®¿é—®
</code></pre>
<h4 id="ept-violationå¤„ç†"><a class="header" href="#ept-violationå¤„ç†">EPT Violationå¤„ç†</a></h4>
<p>å½“Guestè®¿é—®æœªæ˜ å°„çš„GPAæ—¶ï¼Œè§¦å‘<strong>EPT Violation</strong> VM Exitï¼š</p>
<pre><code class="language-c">// EPT Violationå¤„ç†æµç¨‹
static int handle_ept_violation(struct kvm_vcpu *vcpu) {
    // 1. è·å–å¯¼è‡´Violationçš„GPA
    gpa_t gpa = vmcs_read64(GUEST_PHYSICAL_ADDRESS);

    // 2. è·å–è®¿é—®ç±»å‹ï¼ˆè¯»/å†™/æ‰§è¡Œï¼‰
    u32 exit_qualification = vmcs_read32(EXIT_QUALIFICATION);
    bool write = exit_qualification &amp; EPT_VIOLATION_WRITE;
    bool exec = exit_qualification &amp; EPT_VIOLATION_EXEC;

    // 3. æŸ¥æ‰¾GPAå¯¹åº”çš„HPA
    struct kvm_memory_slot *slot = gfn_to_memslot(vcpu-&gt;kvm, gpa &gt;&gt; PAGE_SHIFT);

    // 4. å»ºç«‹EPTæ˜ å°„
    kvm_mmu_page_fault(vcpu, gpa, write ? PFERR_WRITE_MASK : 0);

    return 1;
}
</code></pre>
<h4 id="amd-npt-nested-page-tables"><a class="header" href="#amd-npt-nested-page-tables">AMD NPT (Nested Page Tables)</a></h4>
<p>AMDçš„NPTä¸Intel EPTæ¦‚å¿µç›¸åŒï¼Œæä¾›ç¡¬ä»¶äºŒç»´é¡µè¡¨ï¼š</p>
<ul>
<li><strong>nCR3å¯„å­˜å™¨</strong>ï¼šæŒ‡å‘NPTåŸºå€</li>
<li><strong>nPTç»“æ„</strong>ï¼š4çº§é¡µè¡¨ç»“æ„</li>
<li><strong>NPT Fault</strong>ï¼šå¯¹åº”EPT Violation</li>
</ul>
<p><strong>EPT vs NPTå¯¹æ¯”ï¼š</strong></p>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>Intel EPT</th><th>AMD NPT</th></tr></thead><tbody>
<tr><td>é¡µè¡¨çº§æ•°</td><td>4çº§</td><td>4çº§</td></tr>
<tr><td>å¤§é¡µæ”¯æŒ</td><td>2MB/1GB</td><td>2MB/1GB</td></tr>
<tr><td>è®¿é—®ä½/è„ä½</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td></tr>
<tr><td>æ§åˆ¶å¯„å­˜å™¨</td><td>EPTP</td><td>nCR3</td></tr>
<tr><td>Faultåç§°</td><td>EPT Violation</td><td>NPT Fault</td></tr>
</tbody></table>
</div>
<h3 id="24-kvmå†…å­˜ç®¡ç†æœºåˆ¶"><a class="header" href="#24-kvmå†…å­˜ç®¡ç†æœºåˆ¶">2.4 KVMå†…å­˜ç®¡ç†æœºåˆ¶</a></h3>
<h4 id="memory-slotæœºåˆ¶"><a class="header" href="#memory-slotæœºåˆ¶">Memory Slotæœºåˆ¶</a></h4>
<p>KVMå°†Guestç‰©ç†å†…å­˜ç»„ç»‡ä¸º<strong>Memory Slot</strong>ï¼š</p>
<pre><code class="language-c">// å†…å­˜æ§½ç»“æ„
struct kvm_memory_slot {
    gfn_t base_gfn;                 // Guestç‰©ç†å¸§å·åŸºå€
    unsigned long npages;            // é¡µæ•°
    unsigned long *dirty_bitmap;     // è„é¡µä½å›¾ï¼ˆç”¨äºçƒ­è¿ç§»ï¼‰
    struct kvm_arch_memory_slot arch; // æ¶æ„ç‰¹å®šæ•°æ®
    unsigned long userspace_addr;    // ç”¨æˆ·ç©ºé—´åœ°å€
    u32 flags;                       // æ ‡å¿—ä½
    short id;                        // æ§½ID
};

// è®¾ç½®å†…å­˜åŒºåŸŸ
struct kvm_userspace_memory_region {
    __u32 slot;                      // æ§½ç¼–å·
    __u32 flags;                     // KVM_MEM_LOG_DIRTY_PAGESç­‰
    __u64 guest_phys_addr;           // Guestç‰©ç†åœ°å€
    __u64 memory_size;               // å¤§å°
    __u64 userspace_addr;            // QEMUè¿›ç¨‹è™šæ‹Ÿåœ°å€
};
</code></pre>
<h4 id="å†…å­˜åˆ†é…æµç¨‹"><a class="header" href="#å†…å­˜åˆ†é…æµç¨‹">å†…å­˜åˆ†é…æµç¨‹</a></h4>
<p><strong>QEMUè§†è§’ï¼š</strong></p>
<pre><code class="language-c">// QEMUåˆ†é…Guestå†…å­˜ï¼ˆç®€åŒ–ï¼‰
void *guest_memory = mmap(NULL, memory_size,
                          PROT_READ | PROT_WRITE,
                          MAP_PRIVATE | MAP_ANONYMOUS,
                          -1, 0);

// æ³¨å†Œåˆ°KVM
struct kvm_userspace_memory_region region = {
    .slot = 0,
    .guest_phys_addr = 0,
    .memory_size = memory_size,
    .userspace_addr = (unsigned long)guest_memory,
};
ioctl(vm_fd, KVM_SET_USER_MEMORY_REGION, &amp;region);
</code></pre>
<p><strong>å†…å­˜å®é™…åˆ†é…ï¼ˆLazy Allocationï¼‰ï¼š</strong></p>
<pre><code>1. QEMUè°ƒç”¨mmap()
   â†“ ä»…åˆ†é…è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ— ç‰©ç†å†…å­˜

2. Guesté¦–æ¬¡è®¿é—®GPA
   â†“ EPT Violation

3. KVMå¤„ç†EPT Violation
   â†“ GPA â†’ QEMUè™šæ‹Ÿåœ°å€

4. è®¿é—®QEMUè™šæ‹Ÿåœ°å€
   â†“ Hostç¼ºé¡µå¼‚å¸¸

5. Linuxå†…æ ¸åˆ†é…ç‰©ç†é¡µ
   â†“ å»ºç«‹QEMUè™šæ‹Ÿåœ°å€ â†’ HPAæ˜ å°„

6. KVMå»ºç«‹EPTæ˜ å°„
   â†“ GPA â†’ HPA

7. è¿”å›Guestç»§ç»­æ‰§è¡Œ
</code></pre>
<h3 id="25-mmu-notifieræœºåˆ¶"><a class="header" href="#25-mmu-notifieræœºåˆ¶">2.5 MMU Notifieræœºåˆ¶</a></h3>
<p><strong>æ ¸å¿ƒé—®é¢˜ï¼š</strong> Host Linuxå¯èƒ½ä¼šå›æ”¶/äº¤æ¢/è¿ç§»Guestçš„ç‰©ç†å†…å­˜ï¼Œä½†è¿™äº›é¡µé¢å¯èƒ½å·²æ˜ å°„åˆ°EPTä¸­ã€‚</p>
<p><strong>MMU Notifierè§£å†³æ–¹æ¡ˆï¼š</strong></p>
<pre><code class="language-c">// MMU Notifierå›è°ƒ
static const struct mmu_notifier_ops kvm_mmu_notifier_ops = {
    .invalidate_range_start = kvm_mmu_notifier_invalidate_range_start,
    .invalidate_range_end   = kvm_mmu_notifier_invalidate_range_end,
    .change_pte             = kvm_mmu_notifier_change_pte,
    .release                = kvm_mmu_notifier_release,
};

// é¡µé¢å¤±æ•ˆå›è°ƒ
static void kvm_mmu_notifier_invalidate_range_start(
    struct mmu_notifier *mn,
    struct mm_struct *mm,
    unsigned long start, unsigned long end)
{
    struct kvm *kvm = mmu_notifier_to_kvm(mn);

    // 1. æ‰¾åˆ°å—å½±å“çš„GPAèŒƒå›´
    // 2. ä½¿å¯¹åº”çš„EPTé¡µè¡¨é¡¹å¤±æ•ˆ
    kvm_unmap_hva_range(kvm, start, end);

    // 3. åˆ·æ–°TLB
    kvm_flush_remote_tlbs(kvm);
}
</code></pre>
<p><strong>å…¸å‹åœºæ™¯ï¼šé¡µé¢äº¤æ¢</strong></p>
<pre><code>1. Hostå†…å­˜å‹åŠ›
   â†“
2. Linuxå†…æ ¸é€‰æ‹©å›æ”¶Guestä½¿ç”¨çš„ç‰©ç†é¡µ
   â†“
3. å†…æ ¸è°ƒç”¨mmu_notifierå›è°ƒ
   â†“
4. KVMä»EPTä¸­ç§»é™¤è¯¥é¡µæ˜ å°„
   â†“
5. å†…æ ¸äº¤æ¢é¡µé¢åˆ°ç£ç›˜
   â†“
6. Guestå†æ¬¡è®¿é—®è¯¥é¡µ
   â†“
7. EPT Violation
   â†“
8. KVMå¤„ç†ç¼ºé¡µ
   â†“
9. Linuxä»ç£ç›˜æ¢å…¥é¡µé¢
   â†“
10. KVMé‡æ–°å»ºç«‹EPTæ˜ å°„
</code></pre>
<p><strong>å†…å­˜è¶…åˆ†é… (Memory Overcommit)ï¼š</strong></p>
<pre><code class="language-bash"># åœºæ™¯ï¼šHostæœ‰8GBç‰©ç†å†…å­˜ï¼Œè¿è¡Œ4ä¸ªè™šæ‹Ÿæœºï¼Œæ¯ä¸ª2GB
# æ€»åˆ†é…ï¼š4 Ã— 2GB = 8GB ï¼ˆå®Œå…¨åˆ†é…ï¼‰
# å®é™…ä½¿ç”¨ï¼šå¯èƒ½åªæœ‰5GB ï¼ˆ30%è¶…åˆ†ï¼‰

# å¯ç”¨KSMï¼ˆKernel Same-page Mergingï¼‰å…±äº«ç›¸åŒé¡µé¢
echo 1 &gt; /sys/kernel/mm/ksm/run

# å¯ç”¨é€æ˜å¤§é¡µ
echo always &gt; /sys/kernel/mm/transparent_hugepage/enabled
</code></pre>
<hr />
<h2 id="ç¬¬ä¸‰ç« cpuè™šæ‹ŸåŒ–æŠ€æœ¯"><a class="header" href="#ç¬¬ä¸‰ç« cpuè™šæ‹ŸåŒ–æŠ€æœ¯">ç¬¬ä¸‰ç« ï¼šCPUè™šæ‹ŸåŒ–æŠ€æœ¯</a></h2>
<h3 id="31-vcpuæ¦‚å¿µä¸å®ç°"><a class="header" href="#31-vcpuæ¦‚å¿µä¸å®ç°">3.1 vCPUæ¦‚å¿µä¸å®ç°</a></h3>
<h4 id="vcpuæ•°æ®ç»“æ„"><a class="header" href="#vcpuæ•°æ®ç»“æ„">vCPUæ•°æ®ç»“æ„</a></h4>
<pre><code class="language-c">// KVM vCPUæ ¸å¿ƒç»“æ„
struct kvm_vcpu {
    struct kvm *kvm;                    // æ‰€å±VM
    int vcpu_id;                        // vCPU ID
    int cpu;                            // å½“å‰ç»‘å®šçš„ç‰©ç†CPU

    struct kvm_run *run;                // è¿è¡Œæ—¶çŠ¶æ€å…±äº«åŒº
    struct mutex mutex;                 // vCPUäº’æ–¥é”

    struct kvm_vcpu_arch arch;          // æ¶æ„ç›¸å…³æ•°æ®
    struct kvm_cpuid_entry2 cpuid_entries[KVM_MAX_CPUID_ENTRIES];

    bool preempted;                     // æ˜¯å¦è¢«æŠ¢å 
    struct kvm_vcpu_stat stat;          // ç»Ÿè®¡ä¿¡æ¯
};

// x86æ¶æ„ç‰¹å®šæ•°æ®
struct kvm_vcpu_arch {
    unsigned long regs[NR_VCPU_REGS];   // é€šç”¨å¯„å­˜å™¨
    unsigned long cr0, cr2, cr3, cr4;   // æ§åˆ¶å¯„å­˜å™¨
    unsigned long efer;                  // EFERå¯„å­˜å™¨

    struct kvm_mmu mmu;                 // MMUçŠ¶æ€
    struct kvm_lapic *apic;             // æœ¬åœ°APIC

    u64 ia32_misc_enable_msr;
    bool nmi_pending;                    // NMIæŒ‚èµ·
    u32 exception_injected;              // æ³¨å…¥çš„å¼‚å¸¸
};
</code></pre>
<h4 id="vcpuçº¿ç¨‹æ¨¡å‹"><a class="header" href="#vcpuçº¿ç¨‹æ¨¡å‹">vCPUçº¿ç¨‹æ¨¡å‹</a></h4>
<pre><code>QEMUè¿›ç¨‹:
  â”œâ”€ ä¸»çº¿ç¨‹ (I/Oã€è®¾å¤‡æ¨¡æ‹Ÿ)
  â”œâ”€ vCPUçº¿ç¨‹0 â”€â”€â”€â”€â†’ ioctl(KVM_RUN) â”€â”€â”€â”€â†’ Guest CPU0
  â”œâ”€ vCPUçº¿ç¨‹1 â”€â”€â”€â”€â†’ ioctl(KVM_RUN) â”€â”€â”€â”€â†’ Guest CPU1
  â”œâ”€ vCPUçº¿ç¨‹2 â”€â”€â”€â”€â†’ ioctl(KVM_RUN) â”€â”€â”€â”€â†’ Guest CPU2
  â””â”€ vCPUçº¿ç¨‹3 â”€â”€â”€â”€â†’ ioctl(KVM_RUN) â”€â”€â”€â”€â†’ Guest CPU3

æ¯ä¸ªvCPUçº¿ç¨‹:
  1. è°ƒç”¨ioctl(KVM_RUN)è¿›å…¥Guestæ¨¡å¼
  2. VM Exitåè¿”å›ç”¨æˆ·ç©ºé—´
  3. å¤„ç†ExitåŸå› 
  4. å†æ¬¡è°ƒç”¨KVM_RUN
</code></pre>
<h3 id="32-cpuidè™šæ‹ŸåŒ–"><a class="header" href="#32-cpuidè™šæ‹ŸåŒ–">3.2 CPUIDè™šæ‹ŸåŒ–</a></h3>
<p><strong>CPUIDæŒ‡ä»¤</strong>ç”¨äºæŸ¥è¯¢CPUç‰¹æ€§ï¼ŒKVMå¿…é¡»è™šæ‹ŸåŒ–CPUIDä»¥ï¼š</p>
<ul>
<li>éšè—Hostç‰¹å®šç‰¹æ€§</li>
<li>æä¾›ç»Ÿä¸€çš„è™šæ‹ŸCPUæ¨¡å‹</li>
<li>æ”¯æŒçƒ­è¿ç§»ï¼ˆCPUå…¼å®¹æ€§ï¼‰</li>
</ul>
<pre><code class="language-c">// è®¾ç½®vCPU CPUID
struct kvm_cpuid2 {
    __u32 nent;                          // æ¡ç›®æ•°
    struct kvm_cpuid_entry2 entries[KVM_MAX_CPUID_ENTRIES];
};

struct kvm_cpuid_entry2 {
    __u32 function;                      // CPUIDåŠŸèƒ½å·
    __u32 index;                         // å­åŠŸèƒ½å·
    __u32 flags;
    __u32 eax, ebx, ecx, edx;           // è¿”å›å€¼
};

// ç¤ºä¾‹ï¼šç¦ç”¨æŸäº›CPUç‰¹æ€§
entry.function = 1;  // åŸºæœ¬CPUä¿¡æ¯
entry.ecx &amp;= ~(1 &lt;&lt; 5);  // ç¦ç”¨VMXæ ‡å¿—ï¼ˆåµŒå¥—è™šæ‹ŸåŒ–ï¼‰
entry.edx &amp;= ~(1 &lt;&lt; 26); // ç¦ç”¨XSAVE
</code></pre>
<p><strong>QEMU CPUæ¨¡å‹ï¼š</strong></p>
<pre><code class="language-bash"># æŸ¥çœ‹å¯ç”¨CPUæ¨¡å‹
qemu-system-x86_64 -cpu help

# å¸¸è§æ¨¡å‹
-cpu host              # é€ä¼ Host CPUç‰¹æ€§ï¼ˆä¸å¯è¿ç§»ï¼‰
-cpu host,migratable=on # Host CPUä½†éšè—ä¸å¯è¿ç§»ç‰¹æ€§
-cpu Skylake-Server    # Intel Skylakeæ¨¡å‹
-cpu EPYC              # AMD EPYCæ¨¡å‹
-cpu qemu64            # é€šç”¨æ¨¡å‹ï¼ˆæœ€å¤§å…¼å®¹æ€§ï¼‰

# è‡ªå®šä¹‰ç‰¹æ€§
-cpu Skylake-Server,+avx512f,+avx512dq  # å¯ç”¨AVX-512
-cpu host,-vmx,-svm    # ç¦ç”¨åµŒå¥—è™šæ‹ŸåŒ–
</code></pre>
<h3 id="33-ä¸­æ–­è™šæ‹ŸåŒ–"><a class="header" href="#33-ä¸­æ–­è™šæ‹ŸåŒ–">3.3 ä¸­æ–­è™šæ‹ŸåŒ–</a></h3>
<h4 id="ä¸­æ–­æºç±»å‹"><a class="header" href="#ä¸­æ–­æºç±»å‹">ä¸­æ–­æºç±»å‹</a></h4>
<pre><code>Guestä¸­æ–­æ¥æº:
â”œâ”€ è™šæ‹Ÿè®¾å¤‡ä¸­æ–­ (QEMUæ¨¡æ‹Ÿ)
â”‚   â””â”€ è™šæ‹Ÿç½‘å¡ã€è™šæ‹Ÿç£ç›˜
â”œâ”€ è®¾å¤‡ç›´é€šä¸­æ–­ (VFIO)
â”‚   â””â”€ ç‰©ç†PCIè®¾å¤‡
â”œâ”€ è™šæ‹Ÿå®šæ—¶å™¨ä¸­æ–­
â”‚   â””â”€ TSCã€APIC Timer
â””â”€ IPIä¸­æ–­ (å¤„ç†å™¨é—´ä¸­æ–­)
    â””â”€ vCPUä¹‹é—´é€šä¿¡
</code></pre>
<h4 id="apicè™šæ‹ŸåŒ–"><a class="header" href="#apicè™šæ‹ŸåŒ–">APICè™šæ‹ŸåŒ–</a></h4>
<p><strong>Local APICè™šæ‹ŸåŒ–ï¼š</strong></p>
<pre><code class="language-c">// è™šæ‹ŸLocal APICç»“æ„
struct kvm_lapic {
    unsigned long base_address;
    struct kvm_io_device dev;
    struct kvm_timer lapic_timer;       // APICå®šæ—¶å™¨
    u32 divide_count;
    struct kvm_vcpu *vcpu;

    // APICå¯„å­˜å™¨é¡µï¼ˆ1KBï¼‰
    struct page *regs_page;
};

// å®šæ—¶å™¨ä¸­æ–­æ³¨å…¥
static void apic_timer_expired(struct kvm_lapic *apic) {
    struct kvm_vcpu *vcpu = apic-&gt;vcpu;

    // è®¾ç½®ä¸­æ–­æŒ‚èµ·æ ‡å¿—
    kvm_apic_set_irq(vcpu, &amp;apic-&gt;lvt_timer);

    // è¯·æ±‚VM Entryæ—¶æ³¨å…¥ä¸­æ–­
    kvm_make_request(KVM_REQ_EVENT, vcpu);
}
</code></pre>
<p><strong>I/O APICè™šæ‹ŸåŒ–ï¼š</strong></p>
<pre><code class="language-c">// I/O APICé‡å®šå‘è¡¨é¡¹
struct kvm_ioapic_redirect_entry {
    u8 vector;              // ä¸­æ–­å‘é‡å·
    u8 delivery_mode:3;     // ä¼ é€’æ¨¡å¼
    u8 dest_mode:1;         // ç›®æ ‡æ¨¡å¼ï¼ˆç‰©ç†/é€»è¾‘ï¼‰
    u8 delivery_status:1;   // ä¼ é€’çŠ¶æ€
    u8 polarity:1;          // ææ€§
    u8 remote_irr:1;        // è¿œç¨‹IRR
    u8 trig_mode:1;         // è§¦å‘æ¨¡å¼ï¼ˆè¾¹æ²¿/ç”µå¹³ï¼‰
    u8 mask:1;              // å±è”½ä½
    u8 dest_id:8;           // ç›®æ ‡APIC ID
};
</code></pre>
<h4 id="ä¸­æ–­æ³¨å…¥æµç¨‹"><a class="header" href="#ä¸­æ–­æ³¨å…¥æµç¨‹">ä¸­æ–­æ³¨å…¥æµç¨‹</a></h4>
<pre><code>1. ä¸­æ–­æºè§¦å‘
   â†“
2. QEMU/KVMè®¾ç½®ä¸­æ–­æŒ‚èµ·
   kvm_set_irq() / kvm_vcpu_kick()
   â†“
3. vCPUä»Guesté€€å‡ºæˆ–ç­‰å¾…VM Entry
   â†“
4. KVMæ£€æŸ¥æŒ‚èµ·ä¸­æ–­
   vcpu_enter_guest() â†’ inject_pending_event()
   â†“
5. è®¾ç½®VMCSä¸­æ–­æ³¨å…¥å­—æ®µ
   VM_ENTRY_INTR_INFO_FIELD
   â†“
6. VM Entry
   â†“
7. ç¡¬ä»¶è‡ªåŠ¨æ³¨å…¥ä¸­æ–­åˆ°Guest
   â†“
8. Guest IDTå¤„ç†ä¸­æ–­
</code></pre>
<p><strong>Posted Interruptï¼ˆé«˜çº§ç‰¹æ€§ï¼‰ï¼š</strong></p>
<p>å…è®¸åœ¨Guestè¿è¡Œæ—¶ç›´æ¥æ³¨å…¥ä¸­æ–­ï¼Œæ— éœ€VM Exitï¼š</p>
<pre><code>ä¼ ç»Ÿä¸­æ–­æ³¨å…¥:
  ä¸­æ–­äº§ç”Ÿ â†’ VM Exit â†’ KVMæ³¨å…¥ â†’ VM Entry â†’ Guestå¤„ç†

Posted Interrupt:
  ä¸­æ–­äº§ç”Ÿ â†’ å†™å…¥Posted Interrupt Descriptor
           â†’ å‘é€Notification Vector
           â†’ ç¡¬ä»¶ç›´æ¥æ³¨å…¥Guestï¼ˆæ— VM Exitï¼ï¼‰
</code></pre>
<h3 id="34-vcpuè°ƒåº¦ä¸äº²å’Œæ€§"><a class="header" href="#34-vcpuè°ƒåº¦ä¸äº²å’Œæ€§">3.4 vCPUè°ƒåº¦ä¸äº²å’Œæ€§</a></h3>
<h4 id="vcpuè°ƒåº¦æ¨¡å‹"><a class="header" href="#vcpuè°ƒåº¦æ¨¡å‹">vCPUè°ƒåº¦æ¨¡å‹</a></h4>
<p>KVM vCPUæœ¬è´¨ä¸Šæ˜¯Linuxçº¿ç¨‹ï¼Œå—Linuxè°ƒåº¦å™¨ç®¡ç†ï¼š</p>
<pre><code class="language-bash"># æŸ¥çœ‹vCPUçº¿ç¨‹
ps -eLf | grep qemu-system-x86
# PID  PPID  LWP  ... CMD
# 1234 1    1234  ... qemu-system-x86_64 (ä¸»çº¿ç¨‹)
# 1234 1    1235  ... qemu-system-x86_64 (vCPU 0)
# 1234 1    1236  ... qemu-system-x86_64 (vCPU 1)

# è®¾ç½®vCPU CPUäº²å’Œæ€§ï¼ˆç»‘å®šï¼‰
taskset -cp 0 1235  # vCPU 0ç»‘å®šåˆ°ç‰©ç†CPU 0
taskset -cp 1 1236  # vCPU 1ç»‘å®šåˆ°ç‰©ç†CPU 1

# è®¾ç½®å®æ—¶ä¼˜å…ˆçº§
chrt -f -p 50 1235  # FIFOç­–ç•¥ï¼Œä¼˜å…ˆçº§50
</code></pre>
<p><strong>CPUè¿‡è½½æ‰¿è¯º (Overcommit)ï¼š</strong></p>
<pre><code>åœºæ™¯1ï¼š1:1æ˜ å°„ï¼ˆæœ€ä½³æ€§èƒ½ï¼‰
  Host: 8æ ¸
  VM1: 2æ ¸
  VM2: 2æ ¸
  VM3: 2æ ¸
  VM4: 2æ ¸
  æ€»è®¡: 8æ ¸ï¼ˆæ— è¶…åˆ†ï¼‰

åœºæ™¯2ï¼š2:1è¶…åˆ†ï¼ˆå¹³è¡¡ï¼‰
  Host: 8æ ¸
  VM1: 4æ ¸
  VM2: 4æ ¸
  VM3: 4æ ¸
  VM4: 4æ ¸
  æ€»è®¡: 16æ ¸ï¼ˆ2å€è¶…åˆ†ï¼‰

åœºæ™¯3ï¼š4:1è¶…åˆ†ï¼ˆé«˜å¯†åº¦ï¼‰
  å¤šä¸ªè™šæ‹Ÿæœºï¼Œæ€»vCPUæ•°æ˜¯ç‰©ç†æ ¸æ•°çš„4å€
  æ€§èƒ½ä¸‹é™æ˜æ˜¾ï¼Œé€‚åˆä½è´Ÿè½½åœºæ™¯
</code></pre>
<h3 id="35-ç‰¹æƒæŒ‡ä»¤å¤„ç†"><a class="header" href="#35-ç‰¹æƒæŒ‡ä»¤å¤„ç†">3.5 ç‰¹æƒæŒ‡ä»¤å¤„ç†</a></h3>
<p>æŸäº›æŒ‡ä»¤åœ¨Guestæ‰§è¡Œæ—¶å¿…é¡»å¼•å‘VM Exitï¼š</p>
<pre><code class="language-c">// å¸¸è§ç‰¹æƒæŒ‡ä»¤åŠå¤„ç†
switch (exit_reason) {
    case EXIT_REASON_CPUID:
        // CPUIDæŒ‡ä»¤
        kvm_emulate_cpuid(vcpu);
        break;

    case EXIT_REASON_HLT:
        // HLTæŒ‡ä»¤ï¼ˆCPUä¼‘çœ ï¼‰
        kvm_vcpu_halt(vcpu);
        break;

    case EXIT_REASON_RDMSR:
        // è¯»MSRå¯„å­˜å™¨
        kvm_emulate_rdmsr(vcpu);
        break;

    case EXIT_REASON_WRMSR:
        // å†™MSRå¯„å­˜å™¨
        kvm_emulate_wrmsr(vcpu);
        break;

    case EXIT_REASON_CR_ACCESS:
        // è®¿é—®æ§åˆ¶å¯„å­˜å™¨ï¼ˆCR0/CR3/CR4ï¼‰
        handle_cr(vcpu);
        break;

    case EXIT_REASON_IO_INSTRUCTION:
        // IN/OUTæŒ‡ä»¤
        return handle_io(vcpu);
}
</code></pre>
<hr />
<h2 id="ç¬¬å››ç« ioè™šæ‹ŸåŒ–ä¸virtio"><a class="header" href="#ç¬¬å››ç« ioè™šæ‹ŸåŒ–ä¸virtio">ç¬¬å››ç« ï¼šI/Oè™šæ‹ŸåŒ–ä¸Virtio</a></h2>
<h3 id="41-ioè™šæ‹ŸåŒ–æ¨¡å‹"><a class="header" href="#41-ioè™šæ‹ŸåŒ–æ¨¡å‹">4.1 I/Oè™šæ‹ŸåŒ–æ¨¡å‹</a></h3>
<h4 id="ä¸‰ç§ioè™šæ‹ŸåŒ–æ–¹å¼"><a class="header" href="#ä¸‰ç§ioè™šæ‹ŸåŒ–æ–¹å¼">ä¸‰ç§I/Oè™šæ‹ŸåŒ–æ–¹å¼</a></h4>
<p><strong>1. è®¾å¤‡æ¨¡æ‹Ÿï¼ˆFull Emulationï¼‰</strong></p>
<pre><code>Guesté©±åŠ¨ â†’ æ¨¡æ‹Ÿè®¾å¤‡å¯„å­˜å™¨(MMIO/PIO)
         â†“ (VM Exit)
     QEMUæ¨¡æ‹Ÿå™¨ â†’ è½¯ä»¶æ¨¡æ‹Ÿç¡¬ä»¶è¡Œä¸º
         â†“
     Hosté©±åŠ¨ â†’ çœŸå®ç¡¬ä»¶

ä¼˜ç‚¹: å…¼å®¹æ€§å¥½ï¼ŒGuestæ— éœ€ä¿®æ”¹
ç¼ºç‚¹: æ€§èƒ½å·®ï¼Œé¢‘ç¹VM Exit
ç¤ºä¾‹: e1000ç½‘å¡ã€IDEç¡¬ç›˜
</code></pre>
<p><strong>2. åŠè™šæ‹ŸåŒ–ï¼ˆParavirtualizationï¼‰</strong></p>
<pre><code>Guest Virtioé©±åŠ¨ â†’ Virtioè§„èŒƒæ¥å£
         â†“
     Virtioåç«¯(QEMU) â†’ ä¼˜åŒ–çš„æ•°æ®é€šé“
         â†“
     Hosté©±åŠ¨ â†’ çœŸå®ç¡¬ä»¶

ä¼˜ç‚¹: é«˜æ€§èƒ½ï¼Œå‡å°‘VM Exit
ç¼ºç‚¹: éœ€è¦Guestå®‰è£…ä¸“ç”¨é©±åŠ¨
ç¤ºä¾‹: virtio-netã€virtio-blk
</code></pre>
<p><strong>3. è®¾å¤‡ç›´é€šï¼ˆDevice Passthroughï¼‰</strong></p>
<pre><code>Guesté©±åŠ¨ â†’ ç›´æ¥è®¿é—®ç‰©ç†è®¾å¤‡
         â†“ (IOMMUä¿æŠ¤)
     ç‰©ç†è®¾å¤‡ â†’ DMAç›´è¾¾Guestå†…å­˜

ä¼˜ç‚¹: æ¥è¿‘åŸç”Ÿæ€§èƒ½
ç¼ºç‚¹: è®¾å¤‡ç‹¬å ï¼Œå¯ç§»æ¤æ€§å·®
æŠ€æœ¯: VFIOã€SR-IOV
</code></pre>
<h3 id="42-virtioæ¶æ„æ·±åº¦è§£æ"><a class="header" href="#42-virtioæ¶æ„æ·±åº¦è§£æ">4.2 Virtioæ¶æ„æ·±åº¦è§£æ</a></h3>
<h4 id="virtioæ ¸å¿ƒæ¦‚å¿µ"><a class="header" href="#virtioæ ¸å¿ƒæ¦‚å¿µ">Virtioæ ¸å¿ƒæ¦‚å¿µ</a></h4>
<p><strong>Virtio = è™šæ‹ŸåŒ–I/Oæ ‡å‡†æ¥å£</strong></p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Guest OS                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  åº”ç”¨ç¨‹åº               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Virtioå‰ç«¯é©±åŠ¨          â”‚    â”‚
â”‚  â”‚  (virtio-net/blk/scsi)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Virtioä¼ è¾“å±‚            â”‚    â”‚
â”‚  â”‚  (Virtqueueæœºåˆ¶)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“ (å…±äº«å†…å­˜)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Virtioåç«¯ (QEMU)       â”‚    â”‚
â”‚  â”‚  (virtio-net-pciåç«¯)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚      Host OS â†“                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  TAPè®¾å¤‡/çœŸå®ç½‘å¡         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="virtqueueæœºåˆ¶"><a class="header" href="#virtqueueæœºåˆ¶">Virtqueueæœºåˆ¶</a></h4>
<p><strong>Virtqueue = Virtioçš„æ•°æ®ä¼ è¾“é˜Ÿåˆ—</strong></p>
<pre><code class="language-c">// Virtqueueç»“æ„
struct virtqueue {
    struct virtio_device *vdev;
    unsigned int index;
    unsigned int num_free;

    // ä¸‰ä¸ªç¯å½¢é˜Ÿåˆ—
    struct vring vring;
};

// Vringç»“æ„ï¼ˆSplit Virtqueueï¼‰
struct vring {
    unsigned int num;               // é˜Ÿåˆ—å¤§å°

    // 1. Descriptor Tableï¼ˆæè¿°ç¬¦è¡¨ï¼‰
    struct vring_desc *desc;

    // 2. Available Ringï¼ˆå¯ç”¨ç¯ï¼‰
    struct vring_avail *avail;

    // 3. Used Ringï¼ˆå·²ç”¨ç¯ï¼‰
    struct vring_used *used;
};

// æè¿°ç¬¦é¡¹
struct vring_desc {
    __le64 addr;                    // æ•°æ®ç¼“å†²åŒºç‰©ç†åœ°å€ï¼ˆGPAï¼‰
    __le32 len;                     // é•¿åº¦
    __le16 flags;                   // æ ‡å¿—ï¼ˆNEXT/WRITE/INDIRECTï¼‰
    __le16 next;                    // ä¸‹ä¸€ä¸ªæè¿°ç¬¦ç´¢å¼•
};

// Available Ring
struct vring_avail {
    __le16 flags;
    __le16 idx;                     // å†™å…¥ä½ç½®
    __le16 ring[num];               // å¯ç”¨æè¿°ç¬¦ç´¢å¼•æ•°ç»„
};

// Used Ring
struct vring_used {
    __le16 flags;
    __le16 idx;                     // å†™å…¥ä½ç½®
    struct vring_used_elem ring[num];
};

struct vring_used_elem {
    __le32 id;                      // æè¿°ç¬¦ç´¢å¼•
    __le32 len;                     // å·²ç”¨é•¿åº¦
};
</code></pre>
<p><strong>Virtqueueå·¥ä½œæµç¨‹ï¼ˆä»¥ç½‘ç»œå‘é€ä¸ºä¾‹ï¼‰ï¼š</strong></p>
<pre><code>Guestå‘é€æ•°æ®åŒ…:

1. Guesté©±åŠ¨å¡«å……Descriptor
   desc[0].addr = GPA(skbæ•°æ®)
   desc[0].len = skb-&gt;len
   desc[0].flags = 0

2. Guestæ›´æ–°Available Ring
   avail-&gt;ring[avail-&gt;idx % queue_size] = 0
   avail-&gt;idx++

3. Guesté€šçŸ¥åç«¯ï¼ˆKickï¼‰
   iowrite16(queue_index, virtio_pci_device-&gt;notify_addr)
   â†“ (VM Exit - PIOå†™å…¥)

4. QEMUåç«¯å¤„ç†
   - è¯»å–avail-&gt;idxï¼Œå‘ç°æ–°è¯·æ±‚
   - ä»desc[0]è¯»å–GPAï¼Œè½¬æ¢ä¸ºHVA
   - å°†æ•°æ®å‘é€åˆ°TAPè®¾å¤‡
   - æ›´æ–°Used Ring
     used-&gt;ring[used-&gt;idx % queue_size].id = 0
     used-&gt;idx++

5. QEMUæ³¨å…¥ä¸­æ–­é€šçŸ¥Guest
   - è§¦å‘vCPUä¸­æ–­

6. Guestä¸­æ–­å¤„ç†
   - æ£€æŸ¥used-&gt;idx
   - å›æ”¶desc[0]
   - é‡Šæ”¾skb
</code></pre>
<p><strong>æ€§èƒ½ä¼˜åŒ–ï¼šä¸­æ–­æŠ‘åˆ¶</strong></p>
<pre><code class="language-c">// Guestç«¯ï¼šç¦ç”¨Used Ringé€šçŸ¥
avail-&gt;flags |= VRING_AVAIL_F_NO_INTERRUPT;

// è½®è¯¢æ¨¡å¼ï¼ˆNAPIï¼‰
while (budget--) {
    if (avail-&gt;idx == last_used_idx)
        break;  // æ— æ–°æ•°æ®

    // å¤„ç†æ•°æ®åŒ…
    process_packet();
}

// åç«¯ï¼šæ‰¹é‡å¤„ç†
while (avail-&gt;idx - last_avail_idx &gt; 0) {
    // æ‰¹é‡å¤„ç†å¤šä¸ªè¯·æ±‚
    process_multiple_requests();
}

// åªåœ¨æ‰¹é‡æœ«å°¾æ³¨å…¥ä¸€æ¬¡ä¸­æ–­
inject_interrupt();
</code></pre>
<h4 id="virtioè®¾å¤‡ç±»å‹"><a class="header" href="#virtioè®¾å¤‡ç±»å‹">Virtioè®¾å¤‡ç±»å‹</a></h4>
<p><strong>1. virtio-netï¼ˆç½‘ç»œï¼‰</strong></p>
<pre><code class="language-bash"># QEMUé…ç½®virtio-net
-device virtio-net-pci,netdev=net0,mac=52:54:00:12:34:56 \
-netdev tap,id=net0,ifname=tap0,script=no,downscript=no

# å¤šé˜Ÿåˆ—virtio-netï¼ˆæå‡å¤šæ ¸æ€§èƒ½ï¼‰
-device virtio-net-pci,netdev=net0,mq=on,vectors=10 \
-netdev tap,id=net0,vhost=on,queues=4
</code></pre>
<p><strong>Guestå†…æ ¸å‚æ•°ï¼š</strong></p>
<pre><code class="language-bash"># å¯ç”¨å¤šé˜Ÿåˆ—
ethtool -L eth0 combined 4

# æŸ¥çœ‹virtio-netç»Ÿè®¡
ethtool -S eth0 | grep virtio
</code></pre>
<p><strong>2. virtio-blkï¼ˆå—è®¾å¤‡ï¼‰</strong></p>
<pre><code class="language-bash"># QEMUé…ç½®virtio-blk
-drive file=/data/disk.qcow2,if=none,id=drive0 \
-device virtio-blk-pci,drive=drive0,scsi=off

# æ€§èƒ½è°ƒä¼˜å‚æ•°
-device virtio-blk-pci,drive=drive0,\
        num-queues=4,\              # å¤šé˜Ÿåˆ—
        ioeventfd=on,\              # å¼‚æ­¥äº‹ä»¶é€šçŸ¥
        iothread=iothread0          # ç‹¬ç«‹I/Oçº¿ç¨‹
</code></pre>
<p><strong>3. virtio-scsiï¼ˆSCSIæ§åˆ¶å™¨ï¼‰</strong></p>
<pre><code class="language-bash"># æ”¯æŒTRIMã€çƒ­æ’æ‹”ç­‰é«˜çº§ç‰¹æ€§
-device virtio-scsi-pci,id=scsi0 \
-drive file=/data/disk1.qcow2,if=none,id=hd0 \
-device scsi-hd,drive=hd0,bus=scsi0.0
</code></pre>
<h3 id="43-vhoståŠ é€ŸæŠ€æœ¯"><a class="header" href="#43-vhoståŠ é€ŸæŠ€æœ¯">4.3 VhoståŠ é€ŸæŠ€æœ¯</a></h3>
<p><strong>é—®é¢˜ï¼š</strong> Virtioåç«¯åœ¨QEMUç”¨æˆ·ç©ºé—´ï¼Œæ¯æ¬¡I/Oéƒ½è¦é™·å…¥ç”¨æˆ·æ€å¤„ç†ã€‚</p>
<p><strong>Vhostè§£å†³æ–¹æ¡ˆï¼š</strong> å°†Virtioåç«¯ç§»åˆ°å†…æ ¸ç©ºé—´ã€‚</p>
<pre><code>æ— Vhost:
Guesté©±åŠ¨ â†’ Virtqueue
         â†“ (VM Exit)
     QEMUç”¨æˆ·ç©ºé—´ â†’ å¤„ç†I/O
         â†“ (ç³»ç»Ÿè°ƒç”¨)
     å†…æ ¸TAPè®¾å¤‡

æœ‰Vhost:
Guesté©±åŠ¨ â†’ Virtqueue
         â†“ (å…±äº«å†…å­˜ï¼Œæå°‘VM Exit)
     Vhostå†…æ ¸çº¿ç¨‹ â†’ ç›´æ¥å¤„ç†
         â†“
     å†…æ ¸TAPè®¾å¤‡ï¼ˆé›¶æ‹·è´ï¼‰
</code></pre>
<h4 id="vhost-netå®ç°"><a class="header" href="#vhost-netå®ç°">Vhost-netå®ç°</a></h4>
<pre><code class="language-c">// Vhost-netå†…æ ¸æ¨¡å—
static const struct file_operations vhost_net_fops = {
    .owner          = THIS_MODULE,
    .open           = vhost_net_open,
    .release        = vhost_net_release,
    .unlocked_ioctl = vhost_net_ioctl,
};

// Vhost workerçº¿ç¨‹
static int vhost_worker(void *data) {
    struct vhost_dev *dev = data;

    while (!kthread_should_stop()) {
        // 1. æ£€æŸ¥Virtqueue
        // 2. å¤„ç†Available Ring
        // 3. æ‰§è¡ŒI/Oæ“ä½œ
        // 4. æ›´æ–°Used Ring
        // 5. æ³¨å…¥ä¸­æ–­

        vhost_work_flush(dev, work);
    }
    return 0;
}
</code></pre>
<p><strong>ä½¿ç”¨Vhost-netï¼š</strong></p>
<pre><code class="language-bash"># QEMUé…ç½®
-netdev tap,id=net0,vhost=on,vhostforce=on \
-device virtio-net-pci,netdev=net0

# æ£€æŸ¥vhostæ˜¯å¦å¯ç”¨
lsmod | grep vhost
# vhost_net
# vhost

# æŸ¥çœ‹vhostçº¿ç¨‹
ps aux | grep vhost
</code></pre>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>
<pre><code>åŸºå‡†æµ‹è¯•ï¼šiperf3ç½‘ç»œååé‡

1. e1000æ¨¡æ‹Ÿç½‘å¡ï¼š      ~1 Gbps
2. virtio-netï¼ˆQEMUï¼‰ï¼š  ~8 Gbps
3. virtio-netï¼ˆvhostï¼‰ï¼š ~25 Gbps
4. SR-IOVç›´é€šï¼š         ~40 Gbpsï¼ˆæ¥è¿‘ç‰©ç†ç½‘å¡ï¼‰
</code></pre>
<h3 id="44-vfioè®¾å¤‡ç›´é€š"><a class="header" href="#44-vfioè®¾å¤‡ç›´é€š">4.4 VFIOè®¾å¤‡ç›´é€š</a></h3>
<p><strong>VFIO (Virtual Function I/O)</strong> å…è®¸Guestç›´æ¥è®¿é—®ç‰©ç†PCIè®¾å¤‡ã€‚</p>
<h4 id="iommuä¸dmaå®‰å…¨"><a class="header" href="#iommuä¸dmaå®‰å…¨">IOMMUä¸DMAå®‰å…¨</a></h4>
<pre><code>æ— IOMMU:
Guest DMA â†’ å¯è®¿é—®ä»»æ„ç‰©ç†å†…å­˜ âš ï¸ å®‰å…¨é£é™©

æœ‰IOMMU:
Guest DMA â†’ IOMMUè½¬æ¢ â†’ é™å®šåœ¨Guestå†…å­˜èŒƒå›´
</code></pre>
<p><strong>Intel VT-d / AMD-Viï¼š</strong> æä¾›DMAé‡æ˜ å°„å’Œä¸­æ–­é‡æ˜ å°„ã€‚</p>
<h4 id="sr-iovæŠ€æœ¯"><a class="header" href="#sr-iovæŠ€æœ¯">SR-IOVæŠ€æœ¯</a></h4>
<p><strong>SR-IOV (Single Root I/O Virtualization)</strong> å°†ä¸€ä¸ªç‰©ç†ç½‘å¡è™šæ‹Ÿä¸ºå¤šä¸ªè™šæ‹ŸåŠŸèƒ½ï¼ˆVFï¼‰ã€‚</p>
<pre><code>ç‰©ç†ç½‘å¡ï¼ˆPF - Physical Functionï¼‰
  â”œâ”€ VF0 â†’ Guest1ï¼ˆç›´é€šï¼‰
  â”œâ”€ VF1 â†’ Guest2ï¼ˆç›´é€šï¼‰
  â”œâ”€ VF2 â†’ Guest3ï¼ˆç›´é€šï¼‰
  â””â”€ VF3 â†’ Guest4ï¼ˆç›´é€šï¼‰
</code></pre>
<p><strong>é…ç½®SR-IOVï¼š</strong></p>
<pre><code class="language-bash"># 1. å¯ç”¨SR-IOV
echo 4 &gt; /sys/class/net/eth0/device/sriov_numvfs

# 2. æŸ¥çœ‹VF
lspci | grep Virtual
# 01:10.0 Ethernet controller: Intel Virtual Function
# 01:10.1 Ethernet controller: Intel Virtual Function

# 3. ç»‘å®šVFIOé©±åŠ¨
modprobe vfio-pci
echo "8086 10ed" &gt; /sys/bus/pci/drivers/vfio-pci/new_id

# 4. QEMUç›´é€šVF
-device vfio-pci,host=01:10.0
</code></pre>
<hr />
<h2 id="ç¬¬äº”ç« ç¯å¢ƒæ­å»ºä¸å®æˆ˜"><a class="header" href="#ç¬¬äº”ç« ç¯å¢ƒæ­å»ºä¸å®æˆ˜">ç¬¬äº”ç« ï¼šç¯å¢ƒæ­å»ºä¸å®æˆ˜</a></h2>
<h3 id="51-ç¯å¢ƒå‡†å¤‡"><a class="header" href="#51-ç¯å¢ƒå‡†å¤‡">5.1 ç¯å¢ƒå‡†å¤‡</a></h3>
<h4 id="ç¡¬ä»¶è¦æ±‚"><a class="header" href="#ç¡¬ä»¶è¦æ±‚">ç¡¬ä»¶è¦æ±‚</a></h4>
<pre><code class="language-bash"># 1. æ£€æŸ¥CPUè™šæ‹ŸåŒ–æ”¯æŒ
egrep -c '(vmx|svm)' /proc/cpuinfo
# è¾“å‡º &gt; 0 è¡¨ç¤ºæ”¯æŒ

# 2. æ£€æŸ¥BIOSæ˜¯å¦å¯ç”¨
# è¿›å…¥BIOSè®¾ç½®
# Intel: å¯ç”¨ "Intel Virtualization Technology"
# AMD: å¯ç”¨ "SVM Mode"

# 3. æ£€æŸ¥IOMMUæ”¯æŒï¼ˆè®¾å¤‡ç›´é€šéœ€è¦ï¼‰
dmesg | grep -e DMAR -e IOMMU
</code></pre>
<h4 id="è½¯ä»¶å®‰è£…"><a class="header" href="#è½¯ä»¶å®‰è£…">è½¯ä»¶å®‰è£…</a></h4>
<p><strong>Ubuntu/Debianï¼š</strong></p>
<pre><code class="language-bash"># å®‰è£…KVMå’ŒQEMU
sudo apt update
sudo apt install -y qemu-kvm libvirt-daemon-system \
                    libvirt-clients bridge-utils \
                    virt-manager ovmf

# æ£€æŸ¥KVMæ¨¡å—
lsmod | grep kvm
# kvm_intel (Intel) æˆ– kvm_amd (AMD)
# kvm

# æ·»åŠ ç”¨æˆ·åˆ°kvmå’Œlibvirtç»„
sudo usermod -aG kvm $USER
sudo usermod -aG libvirt $USER

# å¯åŠ¨libvirtdæœåŠ¡
sudo systemctl enable --now libvirtd
</code></pre>
<p><strong>CentOS/RHELï¼š</strong></p>
<pre><code class="language-bash">sudo yum install -y qemu-kvm libvirt virt-install \
                    virt-manager virt-viewer

sudo systemctl enable --now libvirtd
</code></pre>
<h3 id="52-å®æˆ˜æ¡ˆä¾‹1å‘½ä»¤è¡Œåˆ›å»ºè™šæ‹Ÿæœº"><a class="header" href="#52-å®æˆ˜æ¡ˆä¾‹1å‘½ä»¤è¡Œåˆ›å»ºè™šæ‹Ÿæœº">5.2 å®æˆ˜æ¡ˆä¾‹1ï¼šå‘½ä»¤è¡Œåˆ›å»ºè™šæ‹Ÿæœº</a></h3>
<h4 id="å‡†å¤‡ç³»ç»Ÿé•œåƒ"><a class="header" href="#å‡†å¤‡ç³»ç»Ÿé•œåƒ">å‡†å¤‡ç³»ç»Ÿé•œåƒ</a></h4>
<pre><code class="language-bash"># ä¸‹è½½Ubuntu Server ISO
wget https://releases.ubuntu.com/22.04/ubuntu-22.04-live-server-amd64.iso

# åˆ›å»ºè™šæ‹Ÿç£ç›˜ï¼ˆqcow2æ ¼å¼ï¼‰
qemu-img create -f qcow2 /data/vms/ubuntu-vm.qcow2 20G

# æŸ¥çœ‹é•œåƒä¿¡æ¯
qemu-img info /data/vms/ubuntu-vm.qcow2
</code></pre>
<h4 id="å¯åŠ¨è™šæ‹Ÿæœºå®Œæ•´å‘½ä»¤"><a class="header" href="#å¯åŠ¨è™šæ‹Ÿæœºå®Œæ•´å‘½ä»¤">å¯åŠ¨è™šæ‹Ÿæœºï¼ˆå®Œæ•´å‘½ä»¤ï¼‰</a></h4>
<pre><code class="language-bash">qemu-system-x86_64 \
  -enable-kvm \                                    # å¯ç”¨KVMåŠ é€Ÿ
  -m 4G \                                          # å†…å­˜4GB
  -smp cpus=2,cores=2,threads=1,sockets=1 \       # 2ä¸ªvCPU
  -cpu host \                                      # CPUé€ä¼ 
  -drive file=/data/vms/ubuntu-vm.qcow2,format=qcow2,if=virtio \  # Virtioç£ç›˜
  -cdrom ubuntu-22.04-live-server-amd64.iso \     # ISOå®‰è£…ä»‹è´¨
  -boot order=dc \                                 # å¯åŠ¨é¡ºåºï¼šå…‰ç›˜ã€ç¡¬ç›˜
  -device virtio-net-pci,netdev=net0,mac=52:54:00:12:34:56 \  # Virtioç½‘å¡
  -netdev user,id=net0,hostfwd=tcp::2222-:22 \    # ç”¨æˆ·æ¨¡å¼ç½‘ç»œï¼Œç«¯å£è½¬å‘
  -vga virtio \                                    # Virtioæ˜¾å¡
  -display gtk \                                   # GTKæ˜¾ç¤º
  -name ubuntu-vm \                                # è™šæ‹Ÿæœºåç§°
  -daemonize                                       # åå°è¿è¡Œ
</code></pre>
<p><strong>å‚æ•°è¯¦è§£ï¼š</strong></p>
<div class="table-wrapper"><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>æ€§èƒ½å½±å“</th></tr></thead><tbody>
<tr><td><code>-enable-kvm</code></td><td>å¯ç”¨KVMç¡¬ä»¶åŠ é€Ÿ</td><td>â­â­â­â­â­ å¿…é¡»</td></tr>
<tr><td><code>-cpu host</code></td><td>é€ä¼ Host CPUç‰¹æ€§</td><td>â­â­â­â­ é«˜æ€§èƒ½</td></tr>
<tr><td><code>if=virtio</code></td><td>Virtioå—è®¾å¤‡</td><td>â­â­â­â­ vs IDE/SATA</td></tr>
<tr><td><code>virtio-net</code></td><td>Virtioç½‘å¡</td><td>â­â­â­â­ vs e1000</td></tr>
<tr><td><code>-smp</code></td><td>å¤šæ ¸vCPU</td><td>â­â­â­ æŒ‰éœ€é…ç½®</td></tr>
</tbody></table>
</div>
<h3 id="53-å®æˆ˜æ¡ˆä¾‹2libvirtç®¡ç†è™šæ‹Ÿæœº"><a class="header" href="#53-å®æˆ˜æ¡ˆä¾‹2libvirtç®¡ç†è™šæ‹Ÿæœº">5.3 å®æˆ˜æ¡ˆä¾‹2ï¼šLibvirtç®¡ç†è™šæ‹Ÿæœº</a></h3>
<h4 id="åˆ›å»ºè™šæ‹Ÿæœºvirt-install"><a class="header" href="#åˆ›å»ºè™šæ‹Ÿæœºvirt-install">åˆ›å»ºè™šæ‹Ÿæœºï¼ˆvirt-installï¼‰</a></h4>
<pre><code class="language-bash">virt-install \
  --name ubuntu-vm \
  --memory 4096 \
  --vcpus 2 \
  --disk path=/data/vms/ubuntu-vm.qcow2,size=20,format=qcow2 \
  --cdrom /data/iso/ubuntu-22.04-server-amd64.iso \
  --os-variant ubuntu22.04 \
  --network network=default,model=virtio \
  --graphics vnc,listen=0.0.0.0,port=5900 \
  --console pty,target_type=serial \
  --boot uefi
</code></pre>
<h4 id="libvirtå¸¸ç”¨å‘½ä»¤"><a class="header" href="#libvirtå¸¸ç”¨å‘½ä»¤">Libvirtå¸¸ç”¨å‘½ä»¤</a></h4>
<pre><code class="language-bash"># åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº
virsh list --all

# å¯åŠ¨è™šæ‹Ÿæœº
virsh start ubuntu-vm

# è¿æ¥æ§åˆ¶å°
virsh console ubuntu-vm

# å…³é—­è™šæ‹Ÿæœº
virsh shutdown ubuntu-vm

# å¼ºåˆ¶å…³é—­
virsh destroy ubuntu-vm

# è‡ªåŠ¨å¯åŠ¨
virsh autostart ubuntu-vm

# æŸ¥çœ‹è™šæ‹Ÿæœºä¿¡æ¯
virsh dominfo ubuntu-vm

# ç¼–è¾‘é…ç½®
virsh edit ubuntu-vm

# åˆ›å»ºå¿«ç…§
virsh snapshot-create-as ubuntu-vm snap1 "Before update"

# æ¢å¤å¿«ç…§
virsh snapshot-revert ubuntu-vm snap1

# åˆ é™¤è™šæ‹Ÿæœºï¼ˆä¿ç•™ç£ç›˜ï¼‰
virsh undefine ubuntu-vm

# åˆ é™¤è™šæ‹Ÿæœºï¼ˆåŒ…å«ç£ç›˜ï¼‰
virsh undefine ubuntu-vm --remove-all-storage
</code></pre>
<h3 id="54-å®æˆ˜æ¡ˆä¾‹3ç½‘ç»œé…ç½®"><a class="header" href="#54-å®æˆ˜æ¡ˆä¾‹3ç½‘ç»œé…ç½®">5.4 å®æˆ˜æ¡ˆä¾‹3ï¼šç½‘ç»œé…ç½®</a></h3>
<h4 id="1-natæ¨¡å¼é»˜è®¤"><a class="header" href="#1-natæ¨¡å¼é»˜è®¤">1. NATæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰</a></h4>
<pre><code class="language-bash"># æŸ¥çœ‹é»˜è®¤ç½‘ç»œ
virsh net-list
# Name      State    Autostart   Persistent
# default   active   yes         yes

# æŸ¥çœ‹ç½‘ç»œé…ç½®
virsh net-dumpxml default
</code></pre>
<p><strong>é»˜è®¤NATç½‘ç»œé…ç½®ï¼š</strong></p>
<pre><code class="language-xml">&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;bridge name='virbr0'/&gt;
  &lt;forward mode='nat'/&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.122.2' end='192.168.122.254'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre>
<h4 id="2-æ¡¥æ¥æ¨¡å¼"><a class="header" href="#2-æ¡¥æ¥æ¨¡å¼">2. æ¡¥æ¥æ¨¡å¼</a></h4>
<pre><code class="language-bash"># åˆ›å»ºLinuxç½‘æ¡¥
sudo nmcli connection add type bridge ifname br0
sudo nmcli connection add type ethernet slave-type bridge \
     con-name bridge-br0 ifname eth0 master br0
sudo nmcli connection up bridge-br0

# æˆ–ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
sudo brctl addbr br0
sudo brctl addif br0 eth0
sudo ip link set br0 up
</code></pre>
<p><strong>Libvirtæ¡¥æ¥ç½‘ç»œé…ç½®ï¼š</strong></p>
<pre><code class="language-xml">&lt;!-- /etc/libvirt/qemu/networks/bridged.xml --&gt;
&lt;network&gt;
  &lt;name&gt;br0&lt;/name&gt;
  &lt;forward mode="bridge"/&gt;
  &lt;bridge name="br0"/&gt;
&lt;/network&gt;
</code></pre>
<pre><code class="language-bash"># å®šä¹‰å¹¶å¯åŠ¨ç½‘ç»œ
virsh net-define /etc/libvirt/qemu/networks/bridged.xml
virsh net-start br0
virsh net-autostart br0

# è™šæ‹Ÿæœºä½¿ç”¨æ¡¥æ¥ç½‘ç»œ
virt-install ... --network bridge=br0,model=virtio
</code></pre>
<h4 id="3-sr-iovç›´é€šç½‘ç»œ"><a class="header" href="#3-sr-iovç›´é€šç½‘ç»œ">3. SR-IOVç›´é€šç½‘ç»œ</a></h4>
<pre><code class="language-bash"># å‰é¢å·²é…ç½®SR-IOV VF

# Libvirté…ç½®ç›´é€š
virsh edit ubuntu-vm
</code></pre>
<pre><code class="language-xml">&lt;interface type='hostdev' managed='yes'&gt;
  &lt;source&gt;
    &lt;address type='pci' domain='0x0000' bus='0x01'
             slot='0x10' function='0x0'/&gt;
  &lt;/source&gt;
  &lt;mac address='52:54:00:6d:90:02'/&gt;
&lt;/interface&gt;
</code></pre>
<h3 id="55-å®æˆ˜æ¡ˆä¾‹4æ€§èƒ½ç›‘æ§"><a class="header" href="#55-å®æˆ˜æ¡ˆä¾‹4æ€§èƒ½ç›‘æ§">5.5 å®æˆ˜æ¡ˆä¾‹4ï¼šæ€§èƒ½ç›‘æ§</a></h3>
<h4 id="kvmç»Ÿè®¡ä¿¡æ¯"><a class="header" href="#kvmç»Ÿè®¡ä¿¡æ¯">KVMç»Ÿè®¡ä¿¡æ¯</a></h4>
<pre><code class="language-bash"># vCPUç»Ÿè®¡
virsh vcpuinfo ubuntu-vm

# å†…å­˜ç»Ÿè®¡
virsh dommemstat ubuntu-vm

# å—è®¾å¤‡I/Oç»Ÿè®¡
virsh domblkstat ubuntu-vm vda

# ç½‘ç»œI/Oç»Ÿè®¡
virsh domifstat ubuntu-vm vnet0

# å®æ—¶ç›‘æ§
virt-top
</code></pre>
<h4 id="perf-eventsè·Ÿè¸ª"><a class="header" href="#perf-eventsè·Ÿè¸ª">Perf Eventsè·Ÿè¸ª</a></h4>
<pre><code class="language-bash"># å¯ç”¨KVMè·Ÿè¸ªç‚¹
perf list | grep kvm
# kvm:kvm_entry
# kvm:kvm_exit
# kvm:kvm_mmio
# kvm:kvm_pio

# è·Ÿè¸ªVM Exit
sudo perf record -e kvm:kvm_exit -a -g sleep 10
sudo perf report

# ç»Ÿè®¡VM ExitåŸå› 
sudo perf stat -e 'kvm:kvm_exit' \
               -e 'kvm:kvm_entry' \
               -e 'kvm:kvm_mmio' \
               -a sleep 10
</code></pre>
<hr />
<h2 id="ç¬¬å…­ç« æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜"><a class="header" href="#ç¬¬å…­ç« æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜">ç¬¬å…­ç« ï¼šæ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜</a></h2>
<h3 id="61-cpuè°ƒä¼˜"><a class="header" href="#61-cpuè°ƒä¼˜">6.1 CPUè°ƒä¼˜</a></h3>
<h4 id="cpu-pinningç»‘æ ¸"><a class="header" href="#cpu-pinningç»‘æ ¸">CPU Pinningï¼ˆç»‘æ ¸ï¼‰</a></h4>
<pre><code class="language-xml">&lt;!-- ç»‘å®švCPUåˆ°ç‰©ç†CPU --&gt;
&lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;
&lt;cputune&gt;
  &lt;vcpupin vcpu='0' cpuset='0'/&gt;
  &lt;vcpupin vcpu='1' cpuset='1'/&gt;
  &lt;vcpupin vcpu='2' cpuset='2'/&gt;
  &lt;vcpupin vcpu='3' cpuset='3'/&gt;

  &lt;!-- QEMU emulatorçº¿ç¨‹ç»‘å®š --&gt;
  &lt;emulatorpin cpuset='4-5'/&gt;

  &lt;!-- I/Oçº¿ç¨‹ç»‘å®š --&gt;
  &lt;iothreadpin iothread='1' cpuset='6'/&gt;
  &lt;iothreadpin iothread='2' cpuset='7'/&gt;
&lt;/cputune&gt;
</code></pre>
<p><strong>NUMAæ‹“æ‰‘ä¼˜åŒ–ï¼š</strong></p>
<pre><code class="language-bash"># æŸ¥çœ‹NUMAæ‹“æ‰‘
numactl --hardware

# é…ç½®NUMAäº²å’Œæ€§
</code></pre>
<pre><code class="language-xml">&lt;numatune&gt;
  &lt;memory mode='strict' nodeset='0'/&gt;
&lt;/numatune&gt;

&lt;cpu mode='host-passthrough'&gt;
  &lt;topology sockets='1' cores='4' threads='1'/&gt;
  &lt;numa&gt;
    &lt;cell id='0' cpus='0-3' memory='4194304' unit='KiB'/&gt;
  &lt;/numa&gt;
&lt;/cpu&gt;
</code></pre>
<h4 id="cpuæ¨¡å¼é€‰æ‹©"><a class="header" href="#cpuæ¨¡å¼é€‰æ‹©">CPUæ¨¡å¼é€‰æ‹©</a></h4>
<pre><code class="language-xml">&lt;!-- 1. host-passthrough: æœ€é«˜æ€§èƒ½ï¼Œä½†ä¸å¯è¿ç§» --&gt;
&lt;cpu mode='host-passthrough'/&gt;

&lt;!-- 2. host-model: å¹³è¡¡æ€§èƒ½å’Œå…¼å®¹æ€§ --&gt;
&lt;cpu mode='host-model'/&gt;

&lt;!-- 3. custom: æœ€å¤§å…¼å®¹æ€§ --&gt;
&lt;cpu mode='custom' match='exact'&gt;
  &lt;model&gt;Skylake-Server&lt;/model&gt;
&lt;/cpu&gt;
</code></pre>
<h3 id="62-å†…å­˜è°ƒä¼˜"><a class="header" href="#62-å†…å­˜è°ƒä¼˜">6.2 å†…å­˜è°ƒä¼˜</a></h3>
<h4 id="å¤§é¡µå†…å­˜-hugepages"><a class="header" href="#å¤§é¡µå†…å­˜-hugepages">å¤§é¡µå†…å­˜ (Hugepages)</a></h4>
<pre><code class="language-bash"># é…ç½®2MBå¤§é¡µ
echo 2048 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

# æˆ–æŒä¹…åŒ–é…ç½®
sudo vi /etc/sysctl.conf
# vm.nr_hugepages = 2048
sudo sysctl -p

# é…ç½®1GBå¤§é¡µï¼ˆéœ€å¯åŠ¨å‚æ•°ï¼‰
# åœ¨GRUBä¸­æ·»åŠ ï¼šdefault_hugepagesz=1G hugepagesz=1G hugepages=4
</code></pre>
<p><strong>Libvirtä½¿ç”¨å¤§é¡µï¼š</strong></p>
<pre><code class="language-xml">&lt;memoryBacking&gt;
  &lt;hugepages&gt;
    &lt;page size='2048' unit='KiB'/&gt;
  &lt;/hugepages&gt;
&lt;/memoryBacking&gt;
</code></pre>
<p><strong>å¤§é¡µæ€§èƒ½æå‡åŸç†ï¼š</strong></p>
<pre><code>æ ‡å‡†4KBé¡µ:
- è™šæ‹Ÿæœº4GBå†…å­˜ = 1048576ä¸ªé¡µ
- EPTé¡µè¡¨å±‚çº§: 4çº§ Ã— 1048576 = æµ·é‡TLB miss

2MBå¤§é¡µ:
- è™šæ‹Ÿæœº4GBå†…å­˜ = 2048ä¸ªé¡µ
- TLBè¦†ç›–ç‡æå‡512å€
- æ€§èƒ½æå‡: 5-30%ï¼ˆå–å†³äºå·¥ä½œè´Ÿè½½ï¼‰
</code></pre>
<h4 id="ksm-kernel-same-page-merging"><a class="header" href="#ksm-kernel-same-page-merging">KSM (Kernel Same-page Merging)</a></h4>
<pre><code class="language-bash"># å¯ç”¨KSM
echo 1 &gt; /sys/kernel/mm/ksm/run

# é…ç½®æ‰«æå‚æ•°
echo 100 &gt; /sys/kernel/mm/ksm/pages_to_scan  # æ¯æ¬¡æ‰«æé¡µæ•°
echo 20 &gt; /sys/kernel/mm/ksm/sleep_millisecs  # æ‰«æé—´éš”

# æŸ¥çœ‹KSMç»Ÿè®¡
cat /sys/kernel/mm/ksm/pages_sharing  # å…±äº«é¡µæ•°
cat /sys/kernel/mm/ksm/pages_shared   # è¢«å…±äº«é¡µæ•°
</code></pre>
<h3 id="63-ioè°ƒä¼˜"><a class="header" href="#63-ioè°ƒä¼˜">6.3 I/Oè°ƒä¼˜</a></h3>
<h4 id="ioçº¿ç¨‹ä¸å¤šé˜Ÿåˆ—"><a class="header" href="#ioçº¿ç¨‹ä¸å¤šé˜Ÿåˆ—">I/Oçº¿ç¨‹ä¸å¤šé˜Ÿåˆ—</a></h4>
<pre><code class="language-xml">&lt;!-- é…ç½®I/Oçº¿ç¨‹ --&gt;
&lt;iothreads&gt;4&lt;/iothreads&gt;

&lt;disk type='file' device='disk'&gt;
  &lt;driver name='qemu' type='qcow2' iothread='1'/&gt;
  &lt;source file='/data/vms/disk.qcow2'/&gt;
  &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;

&lt;!-- å¤šé˜Ÿåˆ—å—è®¾å¤‡ --&gt;
&lt;disk type='file' device='disk'&gt;
  &lt;driver name='qemu' type='raw' cache='none' io='native'
          queues='4'/&gt;
  &lt;source file='/data/vms/disk.raw'/&gt;
  &lt;target dev='vdb' bus='virtio'/&gt;
&lt;/disk&gt;

&lt;!-- å¤šé˜Ÿåˆ—ç½‘å¡ --&gt;
&lt;interface type='bridge'&gt;
  &lt;source bridge='br0'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;driver name='vhost' queues='4'/&gt;
&lt;/interface&gt;
</code></pre>
<h4 id="ç¼“å­˜æ¨¡å¼"><a class="header" href="#ç¼“å­˜æ¨¡å¼">ç¼“å­˜æ¨¡å¼</a></h4>
<pre><code class="language-bash"># cache=none: ç›´æ¥I/Oï¼Œç»•è¿‡Hostç¼“å­˜ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
-drive file=disk.qcow2,cache=none

# cache=writethrough: å†™ç©¿ï¼Œå®‰å…¨ä½†æ…¢
-drive file=disk.qcow2,cache=writethrough

# cache=writeback: å†™å›ï¼Œå¿«ä½†æœ‰æ•°æ®ä¸¢å¤±é£é™©
-drive file=disk.qcow2,cache=writeback

# cache=unsafe: æœ€å¿«ï¼Œä»…ç”¨äºæµ‹è¯•
-drive file=disk.qcow2,cache=unsafe
</code></pre>
<h4 id="é•œåƒæ ¼å¼é€‰æ‹©"><a class="header" href="#é•œåƒæ ¼å¼é€‰æ‹©">é•œåƒæ ¼å¼é€‰æ‹©</a></h4>
<pre><code class="language-bash"># qcow2: åŠŸèƒ½ä¸°å¯Œï¼ˆå¿«ç…§ã€å‹ç¼©ã€åŠ å¯†ï¼‰ï¼Œæ€§èƒ½ç•¥ä½
qemu-img create -f qcow2 disk.qcow2 100G

# raw: åŸå§‹æ ¼å¼ï¼Œæ€§èƒ½æœ€ä½³
qemu-img create -f raw disk.raw 100G

# è½¬æ¢æ ¼å¼
qemu-img convert -f qcow2 -O raw disk.qcow2 disk.raw

# qcow2æ€§èƒ½ä¼˜åŒ–ï¼šé¢„åˆ†é…
qemu-img create -f qcow2 -o preallocation=metadata disk.qcow2 100G
</code></pre>
<h3 id="64-ç½‘ç»œè°ƒä¼˜"><a class="header" href="#64-ç½‘ç»œè°ƒä¼˜">6.4 ç½‘ç»œè°ƒä¼˜</a></h3>
<pre><code class="language-xml">&lt;!-- Vhostç½‘å¡ä¼˜åŒ– --&gt;
&lt;interface type='network'&gt;
  &lt;source network='default'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;driver name='vhost' queues='4'&gt;
    &lt;host csum='off' gso='off' tso4='off' tso6='off'/&gt;
    &lt;guest csum='off' tso4='off' tso6='off'/&gt;
  &lt;/driver&gt;
&lt;/interface&gt;
</code></pre>
<p><strong>Guestå†…ä¼˜åŒ–ï¼š</strong></p>
<pre><code class="language-bash"># å¯ç”¨å¤šé˜Ÿåˆ—
ethtool -L eth0 combined 4

# è°ƒæ•´ring buffer
ethtool -G eth0 rx 4096 tx 4096

# ç¦ç”¨æ ¡éªŒå’Œå¸è½½ï¼ˆå·²åœ¨hostç¦ç”¨æ—¶ï¼‰
ethtool -K eth0 tx off rx off
</code></pre>
<h3 id="65-ç»¼åˆè°ƒä¼˜æ£€æŸ¥æ¸…å•"><a class="header" href="#65-ç»¼åˆè°ƒä¼˜æ£€æŸ¥æ¸…å•">6.5 ç»¼åˆè°ƒä¼˜æ£€æŸ¥æ¸…å•</a></h3>
<pre><code class="language-markdown">## CPUè°ƒä¼˜
- [ ] å¯ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ– (VT-x/AMD-V)
- [ ] ä½¿ç”¨host-passthrough CPUæ¨¡å¼
- [ ] vCPUç»‘æ ¸ï¼ˆé¿å…è¶…åˆ†ï¼‰
- [ ] NUMAäº²å’Œæ€§é…ç½®
- [ ] é¢„ç•™CPUç»™Host

## å†…å­˜è°ƒä¼˜
- [ ] å¯ç”¨å¤§é¡µï¼ˆ2MBæˆ–1GBï¼‰
- [ ] KSMé€‚åº¦å¯ç”¨ï¼ˆæ ¹æ®åœºæ™¯ï¼‰
- [ ] é¿å…è¿‡åº¦è¶…åˆ†
- [ ] NUMAå†…å­˜ç»‘å®š

## å­˜å‚¨è°ƒä¼˜
- [ ] ä½¿ç”¨virtio-blkæˆ–virtio-scsi
- [ ] cache=none + io=native
- [ ] å¤šé˜Ÿåˆ—å—è®¾å¤‡
- [ ] ç‹¬ç«‹I/Oçº¿ç¨‹
- [ ] ä½¿ç”¨rawæ ¼å¼æˆ–é¢„åˆ†é…qcow2
- [ ] SSD/NVMeå­˜å‚¨

## ç½‘ç»œè°ƒä¼˜
- [ ] ä½¿ç”¨virtio-net
- [ ] å¯ç”¨vhost-net
- [ ] å¤šé˜Ÿåˆ—ç½‘å¡
- [ ] SR-IOVï¼ˆéœ€è¦æ—¶ï¼‰
- [ ] æ¡¥æ¥æ¨¡å¼ï¼ˆé¿å…NATï¼‰

## å…¶ä»–
- [ ] å®æ—¶å†…æ ¸ï¼ˆå»¶è¿Ÿæ•æ„Ÿåº”ç”¨ï¼‰
- [ ] CPUéš”ç¦»ï¼ˆisolcpusï¼‰
- [ ] ä¸­æ–­äº²å’Œæ€§
- [ ] ç¦ç”¨é€æ˜å¤§é¡µï¼ˆæŸäº›åœºæ™¯ï¼‰
</code></pre>
<hr />
<h2 id="ç¬¬ä¸ƒç« é«˜çº§ä¸»é¢˜"><a class="header" href="#ç¬¬ä¸ƒç« é«˜çº§ä¸»é¢˜">ç¬¬ä¸ƒç« ï¼šé«˜çº§ä¸»é¢˜</a></h2>
<h3 id="71-åµŒå¥—è™šæ‹ŸåŒ–"><a class="header" href="#71-åµŒå¥—è™šæ‹ŸåŒ–">7.1 åµŒå¥—è™šæ‹ŸåŒ–</a></h3>
<p><strong>åµŒå¥—è™šæ‹ŸåŒ–</strong>å…è®¸è™šæ‹Ÿæœºå†…éƒ¨å†è¿è¡Œè™šæ‹Ÿæœºï¼ˆL2 Guestï¼‰ã€‚</p>
<pre><code class="language-bash"># å¯ç”¨åµŒå¥—è™šæ‹ŸåŒ–ï¼ˆIntelï¼‰
sudo modprobe -r kvm_intel
sudo modprobe kvm_intel nested=1

# æ°¸ä¹…å¯ç”¨
echo "options kvm_intel nested=1" | sudo tee /etc/modprobe.d/kvm.conf

# éªŒè¯
cat /sys/module/kvm_intel/parameters/nested
# Y
</code></pre>
<p><strong>Libvirté…ç½®ï¼š</strong></p>
<pre><code class="language-xml">&lt;cpu mode='host-passthrough'&gt;
  &lt;feature policy='require' name='vmx'/&gt;  &lt;!-- Intel --&gt;
  &lt;!-- æˆ– --&gt;
  &lt;feature policy='require' name='svm'/&gt;  &lt;!-- AMD --&gt;
&lt;/cpu&gt;
</code></pre>
<h3 id="72-pciç›´é€šgpuç›´é€š"><a class="header" href="#72-pciç›´é€šgpuç›´é€š">7.2 PCIç›´é€šï¼ˆGPUç›´é€šï¼‰</a></h3>
<pre><code class="language-bash"># 1. å¯ç”¨IOMMU
# ç¼–è¾‘GRUB: /etc/default/grub
# Intel: intel_iommu=on iommu=pt
# AMD: amd_iommu=on iommu=pt

sudo update-grub
sudo reboot

# 2. æŸ¥æ‰¾GPU PCIåœ°å€
lspci -nn | grep -i nvidia
# 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation ...
# 01:00.1 Audio device [0403]: NVIDIA Corporation ...

# 3. ç»‘å®šVFIOé©±åŠ¨
echo "options vfio-pci ids=10de:1b80,10de:10f0" | sudo tee /etc/modprobe.d/vfio.conf
sudo update-initramfs -u

# 4. Libvirté…ç½®
virsh edit ubuntu-vm
</code></pre>
<pre><code class="language-xml">&lt;hostdev mode='subsystem' type='pci' managed='yes'&gt;
  &lt;source&gt;
    &lt;address domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
  &lt;/source&gt;
&lt;/hostdev&gt;
</code></pre>
<h3 id="73-çƒ­è¿ç§»-live-migration"><a class="header" href="#73-çƒ­è¿ç§»-live-migration">7.3 çƒ­è¿ç§» (Live Migration)</a></h3>
<pre><code class="language-bash"># å‡†å¤‡ï¼šå…±äº«å­˜å‚¨ï¼ˆNFS/iSCSI/Cephï¼‰
# æºä¸»æœºå’Œç›®æ ‡ä¸»æœºéƒ½èƒ½è®¿é—®åŒä¸€è™šæ‹Ÿç£ç›˜

# æ‰§è¡Œè¿ç§»
virsh migrate --live --persistent \
              ubuntu-vm \
              qemu+ssh://destination-host/system

# å¸¦å®½é™åˆ¶
virsh migrate-setmaxdowntime ubuntu-vm 500  # 500msæœ€å¤§åœæœºæ—¶é—´

# æŸ¥çœ‹è¿ç§»è¿›åº¦
virsh domjobinfo ubuntu-vm
</code></pre>
<p><strong>è¿ç§»è¿‡ç¨‹ï¼š</strong></p>
<pre><code>1. Pre-migration:
   - æ£€æŸ¥ç›®æ ‡ä¸»æœºå…¼å®¹æ€§

2. Reservation:
   - åœ¨ç›®æ ‡ä¸»æœºé¢„ç•™èµ„æº

3. Iterative Pre-Copy:
   - æŒç»­å¤åˆ¶å†…å­˜é¡µ
   - Guestç»§ç»­è¿è¡Œ
   - è„é¡µè¿½è¸ªå’Œå†ä¼ è¾“

4. Stop-and-Copy:
   - æš‚åœGuestï¼ˆå‡ ååˆ°å‡ ç™¾æ¯«ç§’ï¼‰
   - ä¼ è¾“æœ€åçš„è„é¡µ
   - ä¼ è¾“CPUçŠ¶æ€

5. Resume:
   - åœ¨ç›®æ ‡ä¸»æœºæ¢å¤è¿è¡Œ
   - é‡Šæ”¾æºä¸»æœºèµ„æº
</code></pre>
<h3 id="74-å®‰å…¨éš”ç¦»-selinuxapparmor"><a class="header" href="#74-å®‰å…¨éš”ç¦»-selinuxapparmor">7.4 å®‰å…¨éš”ç¦» (SELinux/AppArmor)</a></h3>
<pre><code class="language-bash"># SELinuxè™šæ‹ŸåŒ–ä¸Šä¸‹æ–‡
ls -Z /var/lib/libvirt/images/
# system_u:object_r:virt_image_t:s0 disk.qcow2

# ä¿®å¤SELinuxä¸Šä¸‹æ–‡
sudo restorecon -R /data/vms/

# AppArmoré…ç½®
sudo aa-status | grep libvirt
</code></pre>
<hr />
<h2 id="ç¬¬å…«ç« æ•…éšœæ’æŸ¥ä¸æœ€ä½³å®è·µ"><a class="header" href="#ç¬¬å…«ç« æ•…éšœæ’æŸ¥ä¸æœ€ä½³å®è·µ">ç¬¬å…«ç« ï¼šæ•…éšœæ’æŸ¥ä¸æœ€ä½³å®è·µ</a></h2>
<h3 id="81-å¸¸è§é—®é¢˜æ’æŸ¥"><a class="header" href="#81-å¸¸è§é—®é¢˜æ’æŸ¥">8.1 å¸¸è§é—®é¢˜æ’æŸ¥</a></h3>
<h4 id="é—®é¢˜1è™šæ‹Ÿæœºæ— æ³•å¯åŠ¨"><a class="header" href="#é—®é¢˜1è™šæ‹Ÿæœºæ— æ³•å¯åŠ¨">é—®é¢˜1ï¼šè™šæ‹Ÿæœºæ— æ³•å¯åŠ¨</a></h4>
<pre><code class="language-bash"># æŸ¥çœ‹è¯¦ç»†é”™è¯¯
virsh start ubuntu-vm --console

# æŸ¥çœ‹libvirtæ—¥å¿—
sudo journalctl -u libvirtd -xe

# æŸ¥çœ‹QEMUæ—¥å¿—
sudo cat /var/log/libvirt/qemu/ubuntu-vm.log

# æ£€æŸ¥KVMæ¨¡å—
lsmod | grep kvm
sudo dmesg | grep kvm
</code></pre>
<h4 id="é—®é¢˜2æ€§èƒ½é—®é¢˜"><a class="header" href="#é—®é¢˜2æ€§èƒ½é—®é¢˜">é—®é¢˜2ï¼šæ€§èƒ½é—®é¢˜</a></h4>
<pre><code class="language-bash"># æ£€æŸ¥æ˜¯å¦ä½¿ç”¨KVMåŠ é€Ÿ
ps aux | grep qemu | grep -c "\-enable-kvm"

# æ£€æŸ¥CPUæ¨¡å‹
virsh capabilities | grep -A 5 '&lt;model&gt;'

# ç›‘æ§VM Exitæ¯”ç‡ï¼ˆé«˜æ¯”ç‡è¡¨ç¤ºæ€§èƒ½é—®é¢˜ï¼‰
sudo perf kvm stat live
</code></pre>
<h4 id="é—®é¢˜3ç½‘ç»œä¸é€š"><a class="header" href="#é—®é¢˜3ç½‘ç»œä¸é€š">é—®é¢˜3ï¼šç½‘ç»œä¸é€š</a></h4>
<pre><code class="language-bash"># æ£€æŸ¥ç½‘æ¡¥çŠ¶æ€
brctl show

# æ£€æŸ¥iptablesè§„åˆ™
sudo iptables -L -n -v

# æ£€æŸ¥Guestç½‘å¡
virsh domiflist ubuntu-vm

# Guestå†…æ£€æŸ¥
ip addr show
ip route show
</code></pre>
<h3 id="82-æœ€ä½³å®è·µæ€»ç»“"><a class="header" href="#82-æœ€ä½³å®è·µæ€»ç»“">8.2 æœ€ä½³å®è·µæ€»ç»“</a></h3>
<ol>
<li>
<p><strong>èµ„æºè§„åˆ’</strong></p>
<ul>
<li>é¿å…CPUå’Œå†…å­˜è¿‡åº¦è¶…åˆ†</li>
<li>é¢„ç•™20-30%èµ„æºç»™Host</li>
<li>ä½¿ç”¨NUMAç»‘å®šä¼˜åŒ–å¤šæ’æ§½æœåŠ¡å™¨</li>
</ul>
</li>
<li>
<p><strong>å­˜å‚¨æœ€ä½³å®è·µ</strong></p>
<ul>
<li>ç”Ÿäº§ç¯å¢ƒä½¿ç”¨virtio-scsiæˆ–virtio-blk</li>
<li>ä½¿ç”¨åŸç”Ÿæ ¼å¼ï¼ˆrawï¼‰æˆ–é¢„åˆ†é…qcow2</li>
<li>åˆ†ç¦»ç³»ç»Ÿç›˜å’Œæ•°æ®ç›˜</li>
</ul>
</li>
<li>
<p><strong>ç½‘ç»œæœ€ä½³å®è·µ</strong></p>
<ul>
<li>å¯ç”¨vhostå’Œå¤šé˜Ÿåˆ—</li>
<li>é«˜æ€§èƒ½åœºæ™¯è€ƒè™‘SR-IOV</li>
<li>ä½¿ç”¨æ¡¥æ¥è€ŒéNAT</li>
</ul>
</li>
<li>
<p><strong>å¤‡ä»½ç­–ç•¥</strong></p>
<ul>
<li>å®šæœŸåˆ›å»ºå¿«ç…§</li>
<li>ä½¿ç”¨virsh backupæˆ–ç¬¬ä¸‰æ–¹å·¥å…·</li>
<li>æµ‹è¯•æ¢å¤æµç¨‹</li>
</ul>
</li>
<li>
<p><strong>ç›‘æ§ä¸å‘Šè­¦</strong></p>
<ul>
<li>ç›‘æ§vCPUä½¿ç”¨ç‡</li>
<li>ç›‘æ§å†…å­˜ballooning</li>
<li>ç›‘æ§I/Oå»¶è¿Ÿ</li>
</ul>
</li>
</ol>
<hr />
<h2 id="ç¬¬ä¹ç« å­¦ä¹ éªŒè¯æ ‡å‡†"><a class="header" href="#ç¬¬ä¹ç« å­¦ä¹ éªŒè¯æ ‡å‡†">ç¬¬ä¹ç« ï¼šå­¦ä¹ éªŒè¯æ ‡å‡†</a></h2>
<h3 id="éªŒè¯æ ‡å‡†1åŸºç¡€ç¯å¢ƒæ­å»º"><a class="header" href="#éªŒè¯æ ‡å‡†1åŸºç¡€ç¯å¢ƒæ­å»º">éªŒè¯æ ‡å‡†1ï¼šåŸºç¡€ç¯å¢ƒæ­å»º</a></h3>
<p><strong>ç›®æ ‡ï¼š</strong> æˆåŠŸæ­å»ºKVMè™šæ‹ŸåŒ–ç¯å¢ƒå¹¶åˆ›å»ºç¬¬ä¸€ä¸ªè™šæ‹Ÿæœº</p>
<p><strong>æ£€éªŒæ–¹æ³•ï¼š</strong></p>
<pre><code class="language-bash"># 1. KVMæ¨¡å—å·²åŠ è½½
lsmod | grep kvm

# 2. æˆåŠŸåˆ›å»ºè™šæ‹Ÿæœº
virsh list --all | grep running

# 3. è™šæ‹Ÿæœºå¯SSHè®¿é—®
ssh user@guest-ip
</code></pre>
<h3 id="éªŒè¯æ ‡å‡†2å†…å­˜è™šæ‹ŸåŒ–ç†è§£"><a class="header" href="#éªŒè¯æ ‡å‡†2å†…å­˜è™šæ‹ŸåŒ–ç†è§£">éªŒè¯æ ‡å‡†2ï¼šå†…å­˜è™šæ‹ŸåŒ–ç†è§£</a></h3>
<p><strong>ç›®æ ‡ï¼š</strong> ç†è§£EPT/NPTå·¥ä½œåŸç†å’Œå½±å­é¡µè¡¨æœºåˆ¶</p>
<p><strong>æ£€éªŒæ–¹æ³•ï¼š</strong></p>
<ul>
<li>èƒ½è§£é‡ŠGVAâ†’GPAâ†’HPAä¸‰å±‚è½¬æ¢</li>
<li>èƒ½è¯´æ˜EPTå¦‚ä½•å‡å°‘VM Exit</li>
<li>èƒ½é…ç½®å¤§é¡µå¹¶è§‚å¯Ÿæ€§èƒ½æå‡</li>
</ul>
<h3 id="éªŒè¯æ ‡å‡†3ioè™šæ‹ŸåŒ–å®è·µ"><a class="header" href="#éªŒè¯æ ‡å‡†3ioè™šæ‹ŸåŒ–å®è·µ">éªŒè¯æ ‡å‡†3ï¼šI/Oè™šæ‹ŸåŒ–å®è·µ</a></h3>
<p><strong>ç›®æ ‡ï¼š</strong> é…ç½®å¹¶ä¼˜åŒ–Virtioè®¾å¤‡</p>
<p><strong>æ£€éªŒæ–¹æ³•ï¼š</strong></p>
<pre><code class="language-bash"># 1. é…ç½®å¤šé˜Ÿåˆ—virtio-net
ethtool -l eth0

# 2. å¯ç”¨vhost-net
lsmod | grep vhost_net

# 3. æµ‹è¯•ç½‘ç»œæ€§èƒ½
iperf3 -c server-ip
</code></pre>
<h3 id="éªŒè¯æ ‡å‡†4æ€§èƒ½è°ƒä¼˜èƒ½åŠ›"><a class="header" href="#éªŒè¯æ ‡å‡†4æ€§èƒ½è°ƒä¼˜èƒ½åŠ›">éªŒè¯æ ‡å‡†4ï¼šæ€§èƒ½è°ƒä¼˜èƒ½åŠ›</a></h3>
<p><strong>ç›®æ ‡ï¼š</strong> èƒ½å¤Ÿè¯Šæ–­æ€§èƒ½ç“¶é¢ˆå¹¶åº”ç”¨ä¼˜åŒ–æªæ–½</p>
<p><strong>æ£€éªŒæ–¹æ³•ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨perfè·Ÿè¸ªVM Exit</li>
<li>é…ç½®CPU Pinningå’ŒNUMA</li>
<li>å¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½æŒ‡æ ‡</li>
</ul>
<h3 id="éªŒè¯æ ‡å‡†5ç”Ÿäº§éƒ¨ç½²èƒ½åŠ›"><a class="header" href="#éªŒè¯æ ‡å‡†5ç”Ÿäº§éƒ¨ç½²èƒ½åŠ›">éªŒè¯æ ‡å‡†5ï¼šç”Ÿäº§éƒ¨ç½²èƒ½åŠ›</a></h3>
<p><strong>ç›®æ ‡ï¼š</strong> èƒ½å¤Ÿè§„åˆ’å’Œéƒ¨ç½²ç”Ÿäº§çº§KVMç¯å¢ƒ</p>
<p><strong>æ£€éªŒæ–¹æ³•ï¼š</strong></p>
<ul>
<li>è®¾è®¡èµ„æºåˆ†é…æ–¹æ¡ˆ</li>
<li>é…ç½®é«˜å¯ç”¨å’Œçƒ­è¿ç§»</li>
<li>åˆ¶å®šå¤‡ä»½å’Œç¾éš¾æ¢å¤è®¡åˆ’</li>
</ul>
<hr />
<h2 id="ç¬¬åç« æ‰©å±•å­¦ä¹ èµ„æº"><a class="header" href="#ç¬¬åç« æ‰©å±•å­¦ä¹ èµ„æº">ç¬¬åç« ï¼šæ‰©å±•å­¦ä¹ èµ„æº</a></h2>
<h3 id="å®˜æ–¹æ–‡æ¡£"><a class="header" href="#å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</a></h3>
<ol>
<li><strong>KVMå®˜ç½‘ï¼š</strong> https://linux-kvm.org/</li>
<li><strong>QEMUæ–‡æ¡£ï¼š</strong> https://www.qemu.org/documentation/</li>
<li><strong>Libvirtæ–‡æ¡£ï¼š</strong> https://libvirt.org/docs.html</li>
</ol>
<h3 id="å†…æ ¸æºç "><a class="header" href="#å†…æ ¸æºç ">å†…æ ¸æºç </a></h3>
<pre><code class="language-bash"># ä¸‹è½½Linuxå†…æ ¸æºç 
git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

# KVMæ ¸å¿ƒä»£ç è·¯å¾„
cd linux
ls virt/kvm/          # KVMæ ¸å¿ƒ
ls arch/x86/kvm/      # x86ç‰¹å®šä»£ç 
</code></pre>
<h3 id="æ¨èä¹¦ç±"><a class="header" href="#æ¨èä¹¦ç±">æ¨èä¹¦ç±</a></h3>
<ol>
<li><strong>ã€ŠMastering KVM Virtualizationã€‹</strong> - ç³»ç»Ÿæ€§KVMæŒ‡å—</li>
<li><strong>ã€ŠQEMU/KVMæºç è§£æä¸åº”ç”¨ã€‹</strong> - ä¸­æ–‡æ·±åº¦è§£æ</li>
<li><strong>ã€Šç³»ç»Ÿè™šæ‹ŸåŒ–ï¼šåŸç†ä¸å®ç°ã€‹</strong> - Intelå·¥ç¨‹å¸ˆç¼–å†™</li>
</ol>
<h3 id="è¿›é˜¶æ–¹å‘"><a class="header" href="#è¿›é˜¶æ–¹å‘">è¿›é˜¶æ–¹å‘</a></h3>
<ol>
<li><strong>å®¹å™¨è™šæ‹ŸåŒ–ï¼š</strong> Kata Containersã€gVisor</li>
<li><strong>Unikernelï¼š</strong> OSvã€MirageOS</li>
<li><strong>è½»é‡çº§è™šæ‹ŸåŒ–ï¼š</strong> Firecrackerã€Cloud Hypervisor</li>
<li><strong>DPDKç½‘ç»œåŠ é€Ÿï¼š</strong> ç”¨æˆ·æ€é«˜æ€§èƒ½åŒ…å¤„ç†</li>
<li><strong>GPUè™šæ‹ŸåŒ–ï¼š</strong> vGPUã€GVT-g</li>
</ol>
<hr />
<h2 id="é™„å½•å¿«é€Ÿå‚è€ƒ"><a class="header" href="#é™„å½•å¿«é€Ÿå‚è€ƒ">é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ</a></h2>
<h3 id="a-å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥"><a class="header" href="#a-å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥">A. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥</a></h3>
<pre><code class="language-bash"># KVMæ¨¡å—ç®¡ç†
modprobe kvm_intel           # åŠ è½½Intelæ¨¡å—
modprobe kvm_amd             # åŠ è½½AMDæ¨¡å—
lsmod | grep kvm             # æŸ¥çœ‹KVMæ¨¡å—

# è™šæ‹Ÿæœºç®¡ç†
virsh list --all             # åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœº
virsh start &lt;vm&gt;             # å¯åŠ¨è™šæ‹Ÿæœº
virsh shutdown &lt;vm&gt;          # å…³é—­è™šæ‹Ÿæœº
virsh destroy &lt;vm&gt;           # å¼ºåˆ¶å…³é—­
virsh console &lt;vm&gt;           # è¿æ¥æ§åˆ¶å°

# é•œåƒç®¡ç†
qemu-img create -f qcow2 disk.qcow2 10G      # åˆ›å»ºé•œåƒ
qemu-img info disk.qcow2                     # æŸ¥çœ‹ä¿¡æ¯
qemu-img convert -f qcow2 -O raw a.qcow2 b.raw  # è½¬æ¢æ ¼å¼
qemu-img snapshot -c snap1 disk.qcow2        # åˆ›å»ºå¿«ç…§

# ç½‘ç»œç®¡ç†
virsh net-list               # åˆ—å‡ºè™šæ‹Ÿç½‘ç»œ
virsh net-start default      # å¯åŠ¨ç½‘ç»œ
brctl show                   # æŸ¥çœ‹ç½‘æ¡¥
</code></pre>
<h3 id="b-æ€§èƒ½åŸºå‡†å‚è€ƒ"><a class="header" href="#b-æ€§èƒ½åŸºå‡†å‚è€ƒ">B. æ€§èƒ½åŸºå‡†å‚è€ƒ</a></h3>
<pre><code>CPUå¯†é›†å‹ï¼ˆSPEC CPUï¼‰:
- KVMè™šæ‹ŸåŒ–å¼€é”€ï¼š2-5%
- åµŒå¥—è™šæ‹ŸåŒ–å¼€é”€ï¼š10-15%

å†…å­˜è®¿é—®ï¼ˆSTREAMï¼‰:
- æ ‡å‡†é¡µï¼šåŸºå‡†æ€§èƒ½
- 2MBå¤§é¡µï¼š+5-10%
- 1GBå¤§é¡µï¼š+10-15%

å­˜å‚¨I/Oï¼ˆfioï¼‰:
- IDEæ¨¡æ‹Ÿï¼š~50 MB/s
- virtio-blkï¼š~500 MB/s
- virtio-scsiï¼š~800 MB/s
- VFIOç›´é€šï¼š~1200 MB/sï¼ˆæ¥è¿‘ç‰©ç†ï¼‰

ç½‘ç»œååï¼ˆiperf3ï¼‰:
- e1000ï¼š~1 Gbps
- virtio-netï¼š~8 Gbps
- virtio-net+vhostï¼š~25 Gbps
- SR-IOVï¼š~40 Gbps
</code></pre>
<hr />
<p><strong>ğŸ“Œ å­¦ä¹ å»ºè®®ï¼š</strong></p>
<ol>
<li><strong>å¾ªåºæ¸è¿›ï¼š</strong> ä»åŸºç¡€æ¦‚å¿µâ†’ç¯å¢ƒæ­å»ºâ†’æ€§èƒ½ä¼˜åŒ–â†’é«˜çº§ç‰¹æ€§</li>
<li><strong>åŠ¨æ‰‹å®è·µï¼š</strong> æ¯ä¸ªç« èŠ‚éƒ½é…åˆå®é™…æ“ä½œåŠ æ·±ç†è§£</li>
<li><strong>é˜…è¯»æºç ï¼š</strong> æ·±å…¥ç†è§£åŸç†éœ€è¦é˜…è¯»KVMå’ŒQEMUæºç </li>
<li><strong>å…³æ³¨ç¤¾åŒºï¼š</strong> è·Ÿè¸ªKVMé‚®ä»¶åˆ—è¡¨å’Œå¼€å‘åŠ¨æ€</li>
<li><strong>ç”Ÿäº§åº”ç”¨ï¼š</strong> å°†çŸ¥è¯†åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­</li>
</ol>
<p><strong>ğŸ¯ å­¦ä¹ ç›®æ ‡æ£€éªŒï¼š</strong></p>
<ul>
<li>âœ… èƒ½å¤Ÿç‹¬ç«‹æ­å»ºKVMç¯å¢ƒ</li>
<li>âœ… ç†è§£è™šæ‹ŸåŒ–æ ¸å¿ƒæŠ€æœ¯åŸç†</li>
<li>âœ… èƒ½å¤Ÿè¯Šæ–­å’Œè§£å†³å¸¸è§é—®é¢˜</li>
<li>âœ… èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½è°ƒä¼˜</li>
<li>âœ… èƒ½å¤Ÿè®¾è®¡ç”Ÿäº§çº§è™šæ‹ŸåŒ–æ–¹æ¡ˆ</li>
</ul>
<hr />
<p><strong>ç‰ˆæœ¬ä¿¡æ¯ï¼š</strong></p>
<ul>
<li>æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0</li>
<li>é€‚ç”¨KVMç‰ˆæœ¬ï¼š5.x+</li>
<li>é€‚ç”¨QEMUç‰ˆæœ¬ï¼š6.x+</li>
<li>æœ€åæ›´æ–°ï¼š2025-01</li>
</ul>
<p>ç¥å­¦ä¹ é¡ºåˆ©ï¼ğŸš€</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ç¼–ç¨‹/paas/k8s.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../ç¼–ç¨‹/paas/OpenFunction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ç¼–ç¨‹/paas/k8s.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../ç¼–ç¨‹/paas/OpenFunction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

