<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>虚拟机 Live Migration 学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="虚拟机-live-migration-学习笔记"><a class="header" href="#虚拟机-live-migration-学习笔记">虚拟机 Live Migration 学习笔记</a></h1>
<blockquote>
<p>面向 0-5 年经验的虚拟化、云平台、SRE 与运维工程师，系统掌握 KVM/libvirt/OpenStack 等环境中的虚拟机实时迁移（Live Migration）原理、实现机制、配置实践、性能调优与运维治理。</p>
</blockquote>
<hr />
<h2 id="学习定位与总体目标"><a class="header" href="#学习定位与总体目标">学习定位与总体目标</a></h2>
<ul>
<li><strong>学习者画像</strong>：熟悉 Linux、KVM/libvirt、虚拟化基本操作，需要在企业云平台或虚拟化集群中实现不停机的虚拟机迁移，以支持容量扩展、维护窗口、灾备切换、自动调度。</li>
<li><strong>技术定位</strong>：Live Migration 允许在虚拟机运行状态下将其内存、CPU 状态、设备上下文从一台宿主机迁移到另一台宿主机，保证业务连续性，是高可用架构、容量调度、能源优化、在线维护的关键能力。</li>
<li><strong>学习目标</strong>：
<ol>
<li>理解 Live Migration 工作流程、内存复制机制（pre-copy、post-copy、stop-and-copy）及条件限制；</li>
<li>掌握 KVM/libvirt 环境下的配置、命令、核对清单、网络/存储要求；</li>
<li>熟悉 OpenStack、oVirt、Harvester 等平台的 Live Migration 策略、调度器与自动化；</li>
<li>能够设计性能调优方案（带宽控制、脏页率、压缩、HugePages、CPU pinning 调整）；</li>
<li>建立监控、告警、安全审计、故障排查与回滚流程；</li>
<li>形成实战案例、培训资料、验证标准，纳入团队运维体系。</li>
</ol>
</li>
<li><strong>成果要求</strong>：
<ul>
<li>完成至少两种平台的 Live Migration 实验并记录步骤、验证结果；</li>
<li>输出迁移前检查表、失败排查流程、性能曲线；</li>
<li>实施自动化脚本或策略，实现批量迁移或动态调度；</li>
<li>制定安全策略、网络规划、故障应急方案；</li>
<li>通过团队评审形成标准化操作手册与知识库。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="核心模块结构"><a class="header" href="#核心模块结构">核心模块结构</a></h2>
<ol>
<li><strong>模块一：Live Migration 原理与流程</strong> —— 架构、阶段、协议、模式。</li>
<li><strong>模块二：KVM/libvirt 环境准备与配置实践</strong> —— 前提条件、网络存储、命令操作。</li>
<li><strong>模块三：进阶功能与平台集成</strong> —— OpenStack、oVirt、Harvester、Kubernetes/KubeVirt。</li>
<li><strong>模块四：性能调优、监控与自动化</strong> —— 带宽、脏页率、压缩、迁移策略、检测。</li>
<li><strong>模块五：故障诊断、安全治理与最佳实践</strong> —— 常见问题、排查流程、安全控制。</li>
<li><strong>模块六：学习路径、实战案例与验证标准</strong> —— 路径规划、项目案例、成果验证、扩展资源。</li>
</ol>
<hr />
<h2 id="模块一live-migration-原理与流程"><a class="header" href="#模块一live-migration-原理与流程">模块一：Live Migration 原理与流程</a></h2>
<h3 id="11-架构要素"><a class="header" href="#11-架构要素">1.1 架构要素</a></h3>
<ul>
<li><strong>源宿主机 (Source Host)</strong>：运行虚拟机的宿主机。</li>
<li><strong>目标宿主机 (Destination Host)</strong>：接收虚拟机的宿主机。</li>
<li><strong>共享存储或块复制</strong>：虚拟机磁盘可被目标访问（NFS、iSCSI、Ceph RBD、GlusterFS、共享 LVM）。</li>
<li><strong>管理层</strong>：libvirt、OpenStack、oVirt、Harvester 调度迁移工作。</li>
<li><strong>网络通道</strong>：迁移流量通道（TCP，默认 49152-49216 端口），可使用 TLS/SSH。</li>
</ul>
<h3 id="12-关键阶段"><a class="header" href="#12-关键阶段">1.2 关键阶段</a></h3>
<ol>
<li><strong>预检查 (Pre-check)</strong>：验证 CPU 兼容、网络连通、存储共享、权限。</li>
<li><strong>预拷贝 (Pre-copy)</strong>：在 VM 运行状态下迭代复制内存页面，脏页会在下一轮重传。</li>
<li><strong>停机 (Stop-and-copy)</strong>：暂停虚拟机，复制剩余脏页、CPU 状态、设备状态。</li>
<li><strong>恢复 (Resume)</strong>：在目标节点恢复虚拟机，释放源节点资源。</li>
<li><strong>清理 (Cleanup)</strong>：更新元数据，释放临时资源。</li>
</ol>
<h3 id="13-迁移模式"><a class="header" href="#13-迁移模式">1.3 迁移模式</a></h3>
<ul>
<li><strong>Pre-copy</strong>（默认）：多轮迭代，最后短暂停机。</li>
<li><strong>Post-copy</strong>：先暂停并启动目标节点，在源节点按需拉取剩余内存。优点：停机更短；缺点：对网络稳定性要求高，失败风险大。</li>
<li><strong>Hybrid</strong>：结合 pre-copy + post-copy，先拷贝一部分，再 post-copy。</li>
<li><strong>Block migration</strong>：在无共享存储情况下，复制磁盘（<code>--copy-storage-all</code>），耗时长、不推荐生产使用。</li>
<li><strong>Compression</strong>：压缩内存传输，减少带宽需求（QEMU 支持 XBZRLE, zlib, multifd）。</li>
</ul>
<h3 id="14-迁移条件"><a class="header" href="#14-迁移条件">1.4 迁移条件</a></h3>
<ul>
<li>CPU 特性兼容（相同或可兼容 CPU；<code>cpu mode=host-model/host-passthrough</code>）</li>
<li>目标 host 加载内核模块、启用 KVM；</li>
<li>同一架构（x86_64 ↔ x86_64）；</li>
<li>网络互通，无防火墙阻挡 16509、49152-49216；</li>
<li>共享存储或 enable block migration；</li>
<li>libvirt 与 QEMU 版本兼容；</li>
<li>虚拟机配置（设备、PCI、SR-IOV、HugePages）与目标节点匹配。</li>
</ul>
<h3 id="15-内存复制机制"><a class="header" href="#15-内存复制机制">1.5 内存复制机制</a></h3>
<ul>
<li><strong>脏页率</strong> ：虚拟机写入内存的速度。脏页率高 → 迁移时间长。</li>
<li><strong>收敛条件</strong>：当剩余脏页 &lt; 阈值时执行停机阶段；</li>
<li><strong>auto-converge</strong>：自动降低虚拟机 CPU，以减少脏页率；</li>
<li><strong>dirty rate throttling</strong>：<code>virsh migrate --dparams dirty-limit=64</code> 控制。</li>
<li><strong>XBZRLE</strong>：增量编码压缩脏页；</li>
<li><strong>multifd</strong>：多线程并发复制；</li>
<li><strong>HugePages</strong>：大页内存需要 special 支持；</li>
<li><strong>NUMA</strong>：目标 host NUMA 拓扑需兼容。</li>
</ul>
<h3 id="16-学习重点与易错点"><a class="header" href="#16-学习重点与易错点">1.6 学习重点与易错点</a></h3>
<ul>
<li><strong>重点</strong>：理解 pre-copy 流程、条件、限制；</li>
<li><strong>易错点</strong>：
<ol>
<li>忽略共享存储 → 迁移失败；</li>
<li>CPU 指令不兼容 → <code>Error: requested feature not available</code>;</li>
<li>防火墙阻挡迁移端口；</li>
<li>HugePages 未配 → 目标宿主无法恢复；</li>
<li>SR-IOV/GPU 直通 → 默认不支持迁移；</li>
<li>无自动收敛 → 迁移长时间 hang；</li>
<li>Post-copy 未设置网络冗余 → 失败导致 VM 崩溃。</li>
</ol>
</li>
</ul>
<h3 id="17-预习材料"><a class="header" href="#17-预习材料">1.7 预习材料</a></h3>
<ul>
<li>参考 QEMU 官方文档：<code>docs/devel/migration.rst</code>；</li>
<li>libvirt Migration Guide；</li>
<li>OpenStack Compute Service (Nova) 迁移章节；</li>
<li>RHEL Virtualization Tuning Guide 中 Live Migration 部分。</li>
</ul>
<hr />
<h2 id="模块二kvmlibvirt-环境准备与配置实践"><a class="header" href="#模块二kvmlibvirt-环境准备与配置实践">模块二：KVM/libvirt 环境准备与配置实践</a></h2>
<h3 id="21-前置检查清单"><a class="header" href="#21-前置检查清单">2.1 前置检查清单</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
CPU 支持虚拟化、目标节点 CPU 兼容；</li>
<li><input disabled="" type="checkbox"/>
<code>libvirtd</code>, <code>virtlogd</code>, <code>virtlockd</code> 服务运行；</li>
<li><input disabled="" type="checkbox"/>
源、目标节点访问同一共享存储（NFS, iSCSI, Ceph）；</li>
<li><input disabled="" type="checkbox"/>
虚拟机磁盘以共享方式挂载（<code>cache=none</code> 推荐）；</li>
<li><input disabled="" type="checkbox"/>
网络配置一致，支持 <code>bridge</code> 或 <code>VXLAN</code>；</li>
<li><input disabled="" type="checkbox"/>
配置 SSH/TLS 信任；</li>
<li><input disabled="" type="checkbox"/>
打开防火墙端口：<code>16509/tcp</code>, <code>49152-49216/tcp</code>；</li>
<li><input disabled="" type="checkbox"/>
安装匹配版本的 qemu-kvm, libvirt；</li>
<li><input disabled="" type="checkbox"/>
设置 <code>listen_tls=1</code> 或 <code>listen_tcp=1</code> （选择）；</li>
<li><input disabled="" type="checkbox"/>
目标节点具备足够 CPU、内存资源；</li>
<li><input disabled="" type="checkbox"/>
HugePages/NUMA/QoS 配置一致；</li>
<li><input disabled="" type="checkbox"/>
无非共享设备（SR-IOV、PCI Passthrough）或启用 vGPU 支持。</li>
</ul>
<h3 id="22-libvirt-配置"><a class="header" href="#22-libvirt-配置">2.2 libvirt 配置</a></h3>
<ul>
<li><code>/etc/libvirt/libvirtd.conf</code>：
<pre><code>listen_tls = 1
listen_tcp = 0
auth_tls = "none"   # 实验环境
auth_unix_ro = "polkit"
migrate_hypervisor = 1
</code></pre>
</li>
<li><code>/etc/libvirt/qemu.conf</code>：
<pre><code># 迁移时 NFS 共享
user = "qemu"
group = "qemu"
dynamic_ownership = 1
max_files = 1024
</code></pre>
</li>
<li><code>systemctl restart libvirtd</code>；</li>
<li>证书配置（TLS）：<code>/etc/pki/libvirt</code>。</li>
</ul>
<h3 id="23-存储要求"><a class="header" href="#23-存储要求">2.3 存储要求</a></h3>
<ul>
<li><strong>共享存储</strong>（推荐）：
<ul>
<li>NFS：<code>/etc/fstab</code> 中挂载共享目录；</li>
<li>iSCSI：<code>multipath</code> + LVM；</li>
<li>Ceph RBD：libvirt Secret + pool；</li>
<li>GlusterFS，MooseFS；</li>
</ul>
</li>
<li><strong>块迁移</strong>：<code>virsh migrate --copy-storage-all</code>（慢，谨慎）；</li>
<li>VM 磁盘 xml：<code>&lt;source file='/var/lib/libvirt/images/...'&gt;</code> 指向共享路径。</li>
</ul>
<h3 id="24-网络配置"><a class="header" href="#24-网络配置">2.4 网络配置</a></h3>
<ul>
<li>迁移网络：建议独立网段（1-10 Gbps）；</li>
<li><code>virsh migrate --migrateuri tcp://dest:49152</code> 指定；</li>
<li><code>migration bandwidth</code> 设定：<code>virsh migrate --bandwidth 4096</code>（Mbps）；</li>
<li>避免与业务网络争用；</li>
<li>使用 QoS / Traffic Shaping；</li>
<li>支持 RDMA（<code>--rdma</code>）。</li>
</ul>
<h3 id="25-操作命令示例"><a class="header" href="#25-操作命令示例">2.5 操作命令示例</a></h3>
<ul>
<li>基本迁移：
<pre><code class="language-bash">virsh migrate --live --persistent --undefinesource vm1 qemu+ssh://dest/system
</code></pre>
</li>
<li>指定端口/带宽/auto-converge：
<pre><code class="language-bash">virsh migrate --live --persistent --bandwidth 4096 --auto-converge --timeout 120 vm1 qemu+tls://dest/system tcp://dest:49152
</code></pre>
</li>
<li>Post-copy：
<pre><code class="language-bash">virsh migrate --live --postcopy --timeout 120 vm1 qemu+ssh://dest/system
</code></pre>
</li>
<li>Block migration：
<pre><code class="language-bash">virsh migrate --live --copy-storage-all --persistent vm1 qemu+ssh://dest/system
</code></pre>
</li>
<li>迁移参数：<code>--compressed</code>, <code>--tls</code>, <code>--p2p</code>, <code>--parallel</code>, <code>--rdma</code>, <code>--postcopy</code>, <code>--abort-on-error</code>。</li>
</ul>
<h3 id="26-状态与监控"><a class="header" href="#26-状态与监控">2.6 状态与监控</a></h3>
<ul>
<li>查看迁移进度：<code>virsh domjobinfo vm1</code>；</li>
<li><code>virsh domjobabort</code> 中断；</li>
<li><code>virsh domjobinfo --completed vm1</code> 记录；</li>
<li><code>virsh event --domain vm1</code> 监听；</li>
<li>系统日志：<code>journalctl -u libvirtd</code>；</li>
<li>QEMU 日志：<code>/var/log/libvirt/qemu/vm1.log</code>。</li>
</ul>
<h3 id="27-迁移前后验证"><a class="header" href="#27-迁移前后验证">2.7 迁移前后验证</a></h3>
<ul>
<li>迁移前：<code>virsh domstats</code>, <code>virsh domifaddr</code>, <code>virsh domblklist</code>；</li>
<li>迁移后：
<ul>
<li>虚拟机在目标节点 <code>virsh list</code>；</li>
<li>业务服务可访问；</li>
<li><code>ping</code>, <code>curl</code> 服务验证；</li>
<li><code>dmesg</code> 检查；</li>
<li>CPU/NUMA 绑定正确；</li>
<li>释放源节点资源。</li>
</ul>
</li>
</ul>
<h3 id="28-常见优化"><a class="header" href="#28-常见优化">2.8 常见优化</a></h3>
<ul>
<li><code>--auto-converge</code>：减少暴力换机；</li>
<li><code>--compress</code> + <code>--parallel</code>（QEMU 2.12+）；</li>
<li><code>--postcopy-after-precopy</code>（Hybrid）；</li>
<li><code>--timeout N</code>：超时自动断开；</li>
<li><code>--migrate-disks</code> 指定磁盘；</li>
<li><code>--abort-on-error</code>：防止脏数据。</li>
</ul>
<h3 id="29-自动化脚本示例"><a class="header" href="#29-自动化脚本示例">2.9 自动化脚本示例</a></h3>
<pre><code class="language-bash">#!/bin/bash
vm=$1
dest=$2
virsh migrate --live --persistent --auto-converge --bandwidth 8192 --compressed \
  --parallel 4 --timeout 180 "$vm" qemu+ssh://$dest/system | tee /tmp/migrate_$vm.log
if [ $? -eq 0 ]; then
  echo "Migration success" | mail -s "Live Migration" ops@example.com
else
  echo "Migration failed" | mail -s "Live Migration" ops@example.com
fi
</code></pre>
<h3 id="210-实践练习"><a class="header" href="#210-实践练习">2.10 实践练习</a></h3>
<ul>
<li>配置两台节点共享存储（NFS/Ceph），测试 live migration；</li>
<li>使用 <code>domjobinfo</code> 观察迁移进度；</li>
<li>启用 <code>--auto-converge</code> 与 <code>--compress</code> 对比迁移时长；</li>
<li>实验 post-copy 模式，测试网络中断时的影响；</li>
<li>编写迁移前检查脚本，检查 CPU/存储/网络；</li>
<li>记录迁移前后性能指标。</li>
</ul>
<hr />
<h2 id="模块三进阶功能与平台集成"><a class="header" href="#模块三进阶功能与平台集成">模块三：进阶功能与平台集成</a></h2>
<h3 id="31-openstack-nova"><a class="header" href="#31-openstack-nova">3.1 OpenStack (Nova)</a></h3>
<ul>
<li><strong>迁移类型</strong>：
<ul>
<li><code>nova live-migration &lt;server&gt;</code>：共享存储迁移；</li>
<li><code>nova live-migration --block-migrate</code>：无共享存储（慢）；</li>
<li><code>nova live-migration --host dest-node</code>；</li>
<li><code>auto-schedule</code> 调度；</li>
</ul>
</li>
<li><strong>配置文件</strong>：<code>/etc/nova/nova.conf</code>：
<pre><code class="language-ini">[libvirt]
live_migration_flag = VIR_MIGRATE_UNDEFINE_SOURCE, VIR_MIGRATE_LIVE, VIR_MIGRATE_PERSIST_DEST
live_migration_bandwidth = 64
live_migration_completion_timeout = 800

[compute]
live_migration_retry_count = 3
</code></pre>
</li>
<li><code>nova.conf</code> CPU/NUMA/hugepages 与目标一致；</li>
<li><code>neutron</code> 网络保持一致；</li>
<li>迁移流程：API → Conductor → Scheduler → Compute；</li>
<li><code>nova live-migration-force-complete &lt;server&gt; &lt;dest&gt;</code>；</li>
<li><code>Placement</code> 调度资源；</li>
<li><code>resource provider traits</code>；</li>
<li><code>Cell</code> 数据库更新；</li>
<li>CLI: <code>openstack server migrate --live dest</code>.</li>
</ul>
<h3 id="32-ovirt--red-hat-virtualization"><a class="header" href="#32-ovirt--red-hat-virtualization">3.2 oVirt / Red Hat Virtualization</a></h3>
<ul>
<li>Web 界面支持实时迁移；</li>
<li><code>Migration Policies</code>: automatically, only-hosts-in-cluster;</li>
<li>网络：<code>ovirtmgmt</code>；</li>
<li><code>Engine</code> 调度；</li>
<li>支持自动迁移（HA）；</li>
<li>整合置换策略（Maintenance Mode）；</li>
<li><code>API/Ansible</code> control；</li>
<li><code>vdsm</code> 负责底层操作。</li>
</ul>
<h3 id="33-harvester--rancher-kubevirt"><a class="header" href="#33-harvester--rancher-kubevirt">3.3 Harvester / Rancher KubeVirt</a></h3>
<ul>
<li>KubeVirt <code>VirtualMachineInstanceMigration</code> CRD；</li>
<li>YAML：
<pre><code class="language-yaml">apiVersion: kubevirt.io/v1
kind: VirtualMachineInstanceMigration
metadata:
  name: migrate-vmi
spec:
  vmiName: test-vmi
</code></pre>
</li>
<li>使用 <code>virtctl migrate</code>；</li>
<li><code>KubeVirt</code> 调度 <code>virt-launcher</code> Pod 到新节点；</li>
<li>依赖共享存储 (Longhorn, Ceph-RBD)；</li>
<li>migration bandwidth/policies via annotations。</li>
</ul>
<h3 id="34-vmware-vsphere"><a class="header" href="#34-vmware-vsphere">3.4 VMware vSphere</a></h3>
<ul>
<li>概念：vMotion；</li>
<li>与 KVM Live Migration 类似，借助 vCenter；</li>
<li>需要 vMotion 网络、许可证；</li>
<li>CPU EVC 模式；</li>
<li>参考 vsphere 文档（可对比学习）。</li>
</ul>
<h3 id="35-hyper-v"><a class="header" href="#35-hyper-v">3.5 Hyper-V</a></h3>
<ul>
<li>支持 live migration, storage migration；</li>
<li>依赖 Failover Cluster；</li>
<li>Windows：配置 Kerberos/证书；</li>
<li>了解 cross-platform 差异。</li>
</ul>
<h3 id="36-storage-live-migration"><a class="header" href="#36-storage-live-migration">3.6 Storage Live Migration</a></h3>
<ul>
<li>仅迁移磁盘，VM 仍运行；</li>
<li>KVM：<code>virsh blockcopy</code>, <code>virsh blockcommit</code>；</li>
<li>OpenStack：<code>nova live-migration --block-migrate</code>; <code>cinder volume-migrate</code>；</li>
<li><code>blockjob</code> 监控；</li>
<li>适用：迁移磁盘到更快存储。</li>
</ul>
<h3 id="37-网络考虑"><a class="header" href="#37-网络考虑">3.7 网络考虑</a></h3>
<ul>
<li>静态 MAC/IP：保持一致；</li>
<li>VXLAN/OVS/OVN → 允许不同宿主机网络；</li>
<li>校验 mtu/QoS；</li>
<li>DHCP：需网络支持；</li>
<li>安全组规则同步；</li>
<li>VIP/负载均衡的配合。</li>
</ul>
<h3 id="38-跨版本跨集群迁移"><a class="header" href="#38-跨版本跨集群迁移">3.8 跨版本/跨集群迁移</a></h3>
<ul>
<li>迁移源目标 libvirt 版本差异；</li>
<li>CPU EVC/Model；</li>
<li>Conversion：<code>virt-v2v</code> 转换平台；</li>
<li>跨机房：需 WAN 加速、压缩、带宽规划。</li>
</ul>
<h3 id="39-自动化调度策略"><a class="header" href="#39-自动化调度策略">3.9 自动化调度策略</a></h3>
<ul>
<li>OpenStack <code>nova-scheduler</code>；</li>
<li><code>OpenNebula</code>, <code>CloudStack</code> Policy；</li>
<li><code>Harvester</code> <code>Longhorn</code> 冗余；</li>
<li>自定义 Scheduler：结合 Prometheus 指标，触发 <code>virsh migrate</code>；</li>
<li>Auto-scaling, energy-saving（夜间合并负载）。</li>
</ul>
<h3 id="310-实践练习"><a class="header" href="#310-实践练习">3.10 实践练习</a></h3>
<ul>
<li>在 OpenStack 中执行 live migration 并分析 nova 日志；</li>
<li>在 KubeVirt 创建 Migration CRD；</li>
<li>使用 Ansible 自动化迁移 oVirt 虚拟机；</li>
<li>完成 storage live migration (blockcopy)；</li>
<li>编写跨集群迁移计划文档；</li>
<li>模拟自动调度策略（Prometheus -&gt; alert -&gt; script）。</li>
</ul>
<hr />
<h2 id="模块四性能调优监控与自动化"><a class="header" href="#模块四性能调优监控与自动化">模块四：性能调优、监控与自动化</a></h2>
<h3 id="41-带宽与压缩"><a class="header" href="#41-带宽与压缩">4.1 带宽与压缩</a></h3>
<ul>
<li><code>--bandwidth</code> (Mbps) 控制；</li>
<li><code>--compress</code> + <code>--parallel N</code>；</li>
<li>QEMU参数：<code>migrate_set_speed</code>, <code>migrate_set_downtime</code>, <code>migrate_set_capability compress</code>;</li>
<li><code>XBZRLE</code>：针对重复内容，<code>--compressed</code>；</li>
<li><code>multifd</code>（&gt;= QEMU 4.0）多线程；</li>
<li><code>--migrate-disks</code> + <code>--copy-storage-{all,inc}</code> 影响带宽。</li>
</ul>
<h3 id="42-脏页率控制"><a class="header" href="#42-脏页率控制">4.2 脏页率控制</a></h3>
<ul>
<li><code>--auto-converge</code>：逐渐限制 vCPU；</li>
<li><code>virsh migrate-setmaxdowntime vm1 500</code>（ms）；</li>
<li><code>virsh migrate-setmaxspeed vm1 1G</code>；</li>
<li>QEMU Monitor：<code>migrate-set-parameters</code>；</li>
<li>应用级控制：降低写操作；</li>
<li>Pre-copy 失败 fallback post-copy。</li>
</ul>
<h3 id="43-迁移监控指标"><a class="header" href="#43-迁移监控指标">4.3 迁移监控指标</a></h3>
<ul>
<li><code>virsh domjobinfo</code> outputs：<code>Data total</code>, <code>Memory processed</code>, <code>Memory remaining</code>, <code>Time elapsed</code>, <code>Time remaining</code>；</li>
<li>Exporter：<code>libvirt_exporter</code> (Prometheus) 采集 <code>domain_migrate_total</code>, <code>domain_migrate_duration_seconds</code>；</li>
<li><code>Nova</code> DB 记录 <code>migration</code> 表；</li>
<li>Grafana 可视化；</li>
<li>观察 CPU steal, network throughput, disk I/O。</li>
</ul>
<h3 id="44-自动化流程"><a class="header" href="#44-自动化流程">4.4 自动化流程</a></h3>
<ul>
<li>脚本 + cron + condition；</li>
<li>Ansible playbook with <code>virt</code> module: <code>state: live_migrate</code>;</li>
<li>OpenStack：Auto-healing (Masakari)；</li>
<li>Kubernetes：Operator 监听节点维护事件 -&gt; 触发 KubeVirt migration；</li>
<li>GitOps：PR -&gt; pipeline -&gt; migration；</li>
<li>ChatOps：Slack 命令 <code>!migrate vm1 dest</code> 调用 API。</li>
</ul>
<h3 id="45-性能测试方法"><a class="header" href="#45-性能测试方法">4.5 性能测试方法</a></h3>
<ul>
<li>生成高负载 VM（写内存/Net）；</li>
<li>使用 <code>stress-ng</code>, <code>fio</code>；</li>
<li>测量迁移时间、停机时间、带宽消耗；</li>
<li>记录 <code>downtime</code>, <code>total_data</code>；</li>
<li>对比不同参数：<code>bandwidth</code>, <code>auto-converge</code>, <code>compress</code>；</li>
<li>编制实验报告。</li>
</ul>
<h3 id="46-调优策略表"><a class="header" href="#46-调优策略表">4.6 调优策略表</a></h3>
<div class="table-wrapper"><table><thead><tr><th>调优项</th><th>参数</th><th>适用场景</th></tr></thead><tbody>
<tr><td>限制停机时间</td><td><code>virsh migrate-setmaxdowntime</code></td><td>SLA 严格</td></tr>
<tr><td>降低脏页</td><td><code>--auto-converge</code>, 应用限速</td><td>高写入应用</td></tr>
<tr><td>压缩传输</td><td><code>--compress</code>, <code>XBZRLE</code></td><td>带宽低</td></tr>
<tr><td>并行传输</td><td><code>--parallel</code>, <code>multifd</code></td><td>高带宽多核</td></tr>
<tr><td>断点恢复</td><td><code>--postcopy</code>, <code>--postcopy-after-precopy</code></td><td>高脏页</td></tr>
<tr><td>存储压缩</td><td><code>--copy-storage-inc</code></td><td>增量存储迁移</td></tr>
<tr><td>QoS</td><td><code>tc</code>, <code>libvirt</code> QoS</td><td>与业务共网</td></tr>
</tbody></table>
</div>
<h3 id="47-迁移窗口与计划"><a class="header" href="#47-迁移窗口与计划">4.7 迁移窗口与计划</a></h3>
<ul>
<li>维护窗口：批量迁移；</li>
<li>排序策略：先低负载，后高负载；</li>
<li>记录计划 vs 实际时间；</li>
<li>Batching：限制并发数；</li>
<li>回滚策略：迁移失败回退；</li>
<li>业务负责人通知。</li>
</ul>
<h3 id="48-监控与告警"><a class="header" href="#48-监控与告警">4.8 监控与告警</a></h3>
<ul>
<li>告警条件：迁移失败（<code>virsh domjobinfo Type</code> error）、超时、带宽不足；</li>
<li>Prometheus Alert: <code>increase(libvirt_domain_migrate_failed_total[5m]) &gt; 0</code>;</li>
<li>Slack/邮件通知；</li>
<li>日志：<code>/var/log/nova/nova-compute.log</code>, <code>libvirtd.log</code>;</li>
<li>Ops dashboard with statuses.</li>
</ul>
<h3 id="49-自动化报告"><a class="header" href="#49-自动化报告">4.9 自动化报告</a></h3>
<ul>
<li>迁移完成后生成报告（VM 名称、源/目标、时间、停机、原因）；</li>
<li>存入数据仓库；</li>
<li>可视化迁移热力图；</li>
<li>统计每月迁移数量、失败率。</li>
</ul>
<h3 id="410-实践练习"><a class="header" href="#410-实践练习">4.10 实践练习</a></h3>
<ul>
<li>对比不同带宽限制下的迁移耗时；</li>
<li>启用 <code>multifd</code> 并测量性能；</li>
<li>编写脚本自动生成迁移报告；</li>
<li>使用 Prometheus 监控迁移事件；</li>
<li>模拟多 VM 同时迁移，调度限流；</li>
<li>记录 CPU/内存/网络使用情况。</li>
</ul>
<hr />
<h2 id="模块五故障诊断安全治理与最佳实践"><a class="header" href="#模块五故障诊断安全治理与最佳实践">模块五：故障诊断、安全治理与最佳实践</a></h2>
<h3 id="51-常见故障与排查"><a class="header" href="#51-常见故障与排查">5.1 常见故障与排查</a></h3>
<div class="table-wrapper"><table><thead><tr><th>问题</th><th>现象</th><th>排查</th><th>解决</th></tr></thead><tbody>
<tr><td><code>unable to connect to server</code></td><td>迁移初始化失败</td><td>检查 libvirtd, TLS/SSH, 防火墙</td><td>开放端口, 配置证书</td></tr>
<tr><td><code>unsupported configuration</code></td><td>目标启动失败</td><td>检查 CPU 模式, 设备</td><td>调整 CPU model, 删除不兼容设备</td></tr>
<tr><td><code>No space left on device</code></td><td>共享存储满</td><td><code>df -h</code>, <code>virsh vol-list</code></td><td>清理空间</td></tr>
<tr><td><code>Operation timed out</code></td><td>迁移长时间未完成</td><td>监控脏页率, 带宽</td><td><code>--auto-converge</code>, 提高带宽</td></tr>
<tr><td>Post-copy 网络中断</td><td>VM 崩溃</td><td>日志, 网络质量</td><td>启用冗余网络, 避免 post-copy 无监护</td></tr>
<tr><td><code>Failed to resume</code></td><td>目标恢复失败</td><td>SELinux context, HugePages</td><td><code>restorecon</code>, 预留 HugePages</td></tr>
<tr><td><code>virsh domjobabort</code> 失败</td><td>无法取消</td><td>检查 job state</td><td>QEMU monitor <code>migrate_cancel</code></td></tr>
<tr><td>OpenStack <code>MigrationPreCheckError</code></td><td>预检失败</td><td>nova-scheduler/nova-compute log</td><td>修复兼容性</td></tr>
<tr><td>KubeVirt <code>640</code></td><td>Pod pending</td><td>节点资源, 固定 CPU</td><td>扩容资源</td></tr>
<tr><td>Ceph 秘钥缺失</td><td><code>permission denied</code></td><td><code>virsh secret-list</code></td><td>同步 secret</td></tr>
</tbody></table>
</div>
<h3 id="52-排查流程模板"><a class="header" href="#52-排查流程模板">5.2 排查流程模板</a></h3>
<ol>
<li>收集日志 (<code>journalctl -u libvirtd</code>, <code>nova-compute.log</code>, <code>virt-launcher</code> logs)；</li>
<li><code>virsh domjobinfo</code> 查看状态；</li>
<li>检查网络连通 (<code>telnet dest 16509</code>, <code>nc -z dest 49152</code>);</li>
<li><code>virsh domcapabilities</code> compare CPU;</li>
<li><code>ls -l</code> 检查共享存储权限；</li>
<li><code>semanage fcontext</code>/<code>sVirt</code>；</li>
<li>监控 <code>sar -n DEV,DEV</code>, <code>iftop</code>；</li>
<li>评估脏页：<code>virsh qemu-monitor-command vm1 --hmp "info migrate"</code>;</li>
<li>记录所有步骤，形成 RCA。</li>
</ol>
<h3 id="53-安全控制"><a class="header" href="#53-安全控制">5.3 安全控制</a></h3>
<ul>
<li>TLS/SSH 加密迁移通道；</li>
<li>Polkit 控制 <code>virsh migrate</code> 权限；</li>
<li>审计：<code>auditd</code> 记录操作；</li>
<li>网络隔离：迁移网络与业务网络分离；</li>
<li>对迁移操作启用审批/自动化流程；</li>
<li>迁移日志存档；</li>
<li>迁移目标验证（避免 rogue hosts）。</li>
</ul>
<h3 id="54-最佳实践清单"><a class="header" href="#54-最佳实践清单">5.4 最佳实践清单</a></h3>
<ul>
<li>构建迁移前检查脚本，自动验证条件；</li>
<li>使用共享存储 + 相同配置集群；</li>
<li>规划独立迁移网络，高带宽低延迟；</li>
<li>定期测试迁移能力（演练）；</li>
<li>监控迁移指标，告警及时；</li>
<li>结合自动化工具管理批量迁移；</li>
<li>记录迁移操作，建立审批；</li>
<li>集群内 CPU/BIOS 固件保持一致；</li>
<li>迁移窗口与回滚策略；</li>
<li>文档化：SOP、FAQ、RCA 模板；</li>
<li>关注 QEMU/libvirt 更新，测试新特性（post-copy, multifd）。</li>
</ul>
<h3 id="55-安全合规考虑"><a class="header" href="#55-安全合规考虑">5.5 安全合规考虑</a></h3>
<ul>
<li>迁移过程中数据加密；</li>
<li>记录操作人、操作时间、原因；</li>
<li>防止超权限执行；</li>
<li>迁移失败需回滚/停止；</li>
<li>数据隐私：共享存储访问控制；</li>
<li>故障演练与外交响应流程。</li>
</ul>
<h3 id="56-灾备策略"><a class="header" href="#56-灾备策略">5.6 灾备策略</a></h3>
<ul>
<li>结合 Live Migration 与快照/备份；</li>
<li>机房维护：提前迁移出受影响节点；</li>
<li>自动 Failover：Masakari, Pacemaker；</li>
<li>跨机房迁移：需高带宽/低延迟，可能使用复制 + 短停机；</li>
<li>迁移后验证负载均衡/HA 状态。</li>
</ul>
<h3 id="57-审计与记录"><a class="header" href="#57-审计与记录">5.7 审计与记录</a></h3>
<ul>
<li><code>virsh session log</code>，<code>auditctl -w /usr/bin/virsh</code>；</li>
<li>OpenStack <code>nova</code> DB <code>migrations</code> 表；</li>
<li>生成报告：时间、源/目标、结果、操作者、命令；</li>
<li>存档在 CMDB / ITSM 系统。</li>
</ul>
<h3 id="58-操作流程示例"><a class="header" href="#58-操作流程示例">5.8 操作流程示例</a></h3>
<ol>
<li>计划迁移（确定目标、时间、影响）；</li>
<li>执行前检查（脚本 + 手动确认）；</li>
<li>通知业务方，执行迁移；</li>
<li>监控进度与结果；</li>
<li>验证业务；</li>
<li>更新 CMDB；</li>
<li>记录经验、问题；</li>
<li>归档日志。</li>
</ol>
<h3 id="59-风险与应对"><a class="header" href="#59-风险与应对">5.9 风险与应对</a></h3>
<ul>
<li><strong>网络抖动</strong>：使用冗余链路、QoS；</li>
<li><strong>共享存储性能不足</strong>：提前检测 I/O；</li>
<li><strong>CPU 不兼容</strong>：统一硬件平台或 EVC；</li>
<li><strong>迁移风暴</strong>：限制并发，分批；</li>
<li><strong>脚本误操作</strong>：启用审批/回滚；</li>
<li><strong>日志缺失</strong>：统一日志收集；</li>
<li><strong>高负载业务</strong>：迁移期间临时限流/调整；</li>
<li><strong>版本更新</strong>：测试后部署。</li>
</ul>
<h3 id="510-实践练习"><a class="header" href="#510-实践练习">5.10 实践练习</a></h3>
<ul>
<li>制作迁移前检查脚本，集成 <code>virsh</code> 命令；</li>
<li>使用 auditd 审计迁移命令；</li>
<li>规划一次维护窗口迁移，执行并记录；</li>
<li>处理一次故障案例（模拟）；</li>
<li>生成迁移报告并分享给团队；</li>
<li>更新最佳实践清单。</li>
</ul>
<hr />
<h2 id="模块六学习路径实战案例与验证标准"><a class="header" href="#模块六学习路径实战案例与验证标准">模块六：学习路径、实战案例与验证标准</a></h2>
<h3 id="61-学习路径"><a class="header" href="#61-学习路径">6.1 学习路径</a></h3>
<div class="table-wrapper"><table><thead><tr><th>阶段</th><th>时间</th><th>目标</th><th>行动</th><th>产出</th></tr></thead><tbody>
<tr><td>阶段 0：准备</td><td>1 天</td><td>了解原理、搭建实验环境</td><td>阅读本文、部署两节点 KVM</td><td>环境记录</td></tr>
<tr><td>阶段 1：基础实践</td><td>3 天</td><td>掌握 libvirt 迁移命令、检查流程</td><td>完成共享存储搭建、执行迁移</td><td>操作手册、检查脚本</td></tr>
<tr><td>阶段 2：平台集成</td><td>4-5 天</td><td>OpenStack/oVirt/KubeVirt 迁移练习</td><td>运行平台迁移并记录日志</td><td>平台实践报告</td></tr>
<tr><td>阶段 3：调优监控</td><td>4 天</td><td>带宽控制、压缩、监控指标</td><td>实施调优测试、搭建 Grafana</td><td>调优报告、监控仪表</td></tr>
<tr><td>阶段 4：安全运维</td><td>5 天</td><td>故障诊断、安全审计、自动化</td><td>演练故障、配置 TLS、自动化脚本</td><td>故障手册、安全策略</td></tr>
<tr><td>阶段 5：沉淀推广</td><td>持续</td><td>文档化、培训、持续改进</td><td>编写 SOP、培训、复盘</td><td>知识库、迭代计划</td></tr>
</tbody></table>
</div>
<h3 id="62-实战案例"><a class="header" href="#62-实战案例">6.2 实战案例</a></h3>
<h4 id="案例一数据中心维护迁移计划"><a class="header" href="#案例一数据中心维护迁移计划">案例一：数据中心维护迁移计划</a></h4>
<ul>
<li>背景：对机架进行电力维护，需要迁移 50 台虚拟机。</li>
<li>步骤：
<ol>
<li>编写迁移批次计划；</li>
<li>自动脚本执行 <code>virsh migrate</code>，控制并发 5；</li>
<li>监控迁移进度（Prometheus）；</li>
<li>完成后在目标节点验证；</li>
<li>生成报告；</li>
</ol>
</li>
<li>成果：迁移脚本、监控仪表、报告模板。</li>
</ul>
<h4 id="案例二openstack-自动化迁移"><a class="header" href="#案例二openstack-自动化迁移">案例二：OpenStack 自动化迁移</a></h4>
<ul>
<li>背景：节点 CPU 温度过高，需自动迁移热度最高的虚拟机。</li>
<li>实现：
<ol>
<li>Prometheus 收集节点温度；</li>
<li>Alertmanager 触发 webhook；</li>
<li>Webhook 调用脚本 <code>openstack server migrate --live</code>;</li>
<li>迁移后确认；</li>
</ol>
</li>
<li>成果：告警策略、Webhook 脚本、验证记录。</li>
</ul>
<h4 id="案例三kubevirt-ha-演练"><a class="header" href="#案例三kubevirt-ha-演练">案例三：KubeVirt HA 演练</a></h4>
<ul>
<li>背景：Edge 集群，需验证节点故障时 VM 自动迁移。</li>
<li>步骤：
<ol>
<li>部署 KubeVirt + Longhorn；</li>
<li>创建 VirtualMachineInstance；</li>
<li>触发节点 cordon/drain；</li>
<li>观察 VirtualMachineInstanceMigration；</li>
<li>记录停机时间；</li>
</ol>
</li>
<li>成果：YAML 模板、监控仪表、RCA。</li>
</ul>
<h4 id="案例四迁移性能调优报告"><a class="header" href="#案例四迁移性能调优报告">案例四：迁移性能调优报告</a></h4>
<ul>
<li>背景：数据库 VM 迁移时间过长。</li>
<li>调优：
<ol>
<li>使用 <code>--auto-converge</code>, <code>--bandwidth 8192</code>, <code>--compress</code>;</li>
<li>升级到 QEMU 支持 <code>multifd</code>;</li>
<li>实测时间由 120s 降到 45s；</li>
<li>输出报告与建议。</li>
</ol>
</li>
</ul>
<h4 id="案例五跨机房迁移项目"><a class="header" href="#案例五跨机房迁移项目">案例五：跨机房迁移项目</a></h4>
<ul>
<li>背景：迁移至新数据中心。</li>
<li>手段：
<ol>
<li>使用同步存储；</li>
<li>计划停机窗口；</li>
<li>分批迁移；</li>
<li>验证服务；</li>
</ol>
</li>
<li>成果：迁移计划、风险评估、RCA。</li>
</ul>
<h3 id="63-学习成果验证标准"><a class="header" href="#63-学习成果验证标准">6.3 学习成果验证标准</a></h3>
<ol>
<li><strong>操作能力</strong>：成功在实验环境完成 Live Migration（带参数）、记录停机时间；</li>
<li><strong>平台实践</strong>：完成 OpenStack/KubeVirt 等平台迁移，并提供日志、截图；</li>
<li><strong>调优效果</strong>：通过性能测试报告展示带宽/压缩/auto-converge 等效果；</li>
<li><strong>监控安全</strong>：搭建迁移监控仪表、启用 TLS/审计；</li>
<li><strong>故障演练</strong>：模拟至少 3 种迁移失败场景并完成 RCA；</li>
<li><strong>文档沉淀</strong>：编写迁移 SOP、最佳实践、FAQ；</li>
<li><strong>自动化脚本</strong>：交付迁移脚本或 Ansible/CI pipeline；</li>
<li><strong>迭代计划</strong>：列出下一步策划（post-copy, rdma, auto scheduling）。</li>
</ol>
<h3 id="64-扩展资源与进阶建议"><a class="header" href="#64-扩展资源与进阶建议">6.4 扩展资源与进阶建议</a></h3>
<ul>
<li><strong>官方文档</strong>：
<ul>
<li>Libvirt Migration Guide: https://libvirt.org/migration.html</li>
<li>QEMU Migration docs: https://qemu.readthedocs.io/en/latest</li>
<li>OpenStack Nova Live Migration: https://docs.openstack.org/nova/latest/admin/migration.html</li>
<li>KubeVirt Migration: https://kubevirt.io</li>
</ul>
</li>
<li><strong>博客/案例</strong>：Red Hat、SUSE、VMware、Cloud Native 社区文章；</li>
<li><strong>工具</strong>：<code>virt-manager</code> live migrate UI; <code>Harvester</code> Rancher UI; <code>OpenNebula</code> Sunstone; <code>Proxmox VE</code>；</li>
<li><strong>进阶建议</strong>：
<ol>
<li>研究 QEMU 内部迁移状态机；</li>
<li>探索 RDMA, Post-copy 优化；</li>
<li>结合 GPU/vGPU 的迁移方案；</li>
<li>实现跨云迁移策略；</li>
<li>与能源优化、容量调度结合；</li>
<li>参与社区贡献、分享经验。</li>
</ol>
</li>
</ul>
<hr />
<h2 id="附录"><a class="header" href="#附录">附录</a></h2>
<h3 id="a-迁移命令速查"><a class="header" href="#a-迁移命令速查">A. 迁移命令速查</a></h3>
<pre><code class="language-bash">virsh migrate --live vm1 qemu+ssh://dest/system
virsh migrate --live --persistent vm1 qemu+tls://dest/system tcp://dest:49152
virsh migrate --live --bandwidth 4096 --auto-converge vm1 qemu+ssh://dest/system
virsh migrate --live --postcopy vm1 qemu+ssh://dest/system
virsh migrate --live --copy-storage-all vm1 qemu+ssh://dest/system
virsh domjobinfo vm1
virsh domjobabort vm1
virsh migrate-setmaxdowntime vm1 300
virsh migrate-setmaxspeed vm1 8G
</code></pre>
<h3 id="b-迁移前检查脚本模板"><a class="header" href="#b-迁移前检查脚本模板">B. 迁移前检查脚本模板</a></h3>
<pre><code class="language-bash">#!/bin/bash
vm=$1
host=$2

check_cpu() {
  virsh domcapabilities --machine "$(virsh dominfo $vm | awk '/Machine/{print $2}')" --virttype kvm | grep -q "&lt;model&gt;"
}

check_storage() {
  virsh domxml-to-native qemu-argv "&lt;domain&gt;...&lt;/domain&gt;"  # placeholder
}

check_network() {
  nc -z $host 16509 &amp;&amp; nc -z $host 49152
}

check_cpu &amp;&amp; check_storage &amp;&amp; check_network || { echo "check failed"; exit 1; }
</code></pre>
<h3 id="c-迁移日志路径"><a class="header" href="#c-迁移日志路径">C. 迁移日志路径</a></h3>
<ul>
<li><code>/var/log/libvirt/libvirtd.log</code></li>
<li><code>/var/log/libvirt/qemu/&lt;domain&gt;.log</code></li>
<li><code>/var/log/nova/nova-compute.log</code></li>
<li>KubeVirt: <code>kubectl logs virt-launcher-...</code></li>
</ul>
<h3 id="d-指标与告警建议"><a class="header" href="#d-指标与告警建议">D. 指标与告警建议</a></h3>
<ul>
<li>迁移执行次数：<code>libvirt_domain_migrate_total</code></li>
<li>成功/失败率：<code>libvirt_domain_migrate_failed_total</code></li>
<li>平均迁移时间：<code>histogram</code></li>
<li>停机时间统计：<code>downtime_ms</code></li>
<li>带宽消耗：<code>node_network_transmit_bytes_total</code></li>
<li>脏页率：QEMU monitor <code>info migrate</code> 中 <code>dirty pages rate</code></li>
</ul>
<h3 id="e-故障记录模板"><a class="header" href="#e-故障记录模板">E. 故障记录模板</a></h3>
<pre><code>事件编号：LM-2024-11
时间：2024-09-28 01:30
虚拟机：prod-db-07
源节点：kvm-node-3
目标节点：kvm-node-5
操作：virsh migrate --live --bandwidth 8192 --auto-converge
结果：失败 (timed out)
排查：
1. domjobinfo 显示 Memory remaining 4GB, 数据传输停滞
2. iftop 检查迁移网络拥塞
3. 调整 --bandwidth 12288, --auto-converge 加快收敛
4. 再次迁移成功
输出：迁移耗时 65s, downtime 320ms
预防：为迁移网络配置 QoS, 定期监测带宽
</code></pre>
<blockquote>
<p>Live Migration 是虚拟化平台高可用与运维敏捷的重要保障。掌握其原理、实践、调优与治理流程，持续优化迁移效率与安全性，能够显著提升云平台在资源调度、故障恢复、弹性伸缩方面的能力。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/云计算/libvirt.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/云计算/numa.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/云计算/libvirt.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/云计算/numa.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

