<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>qemu-img 虚拟磁盘管理学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="qemu-img-虚拟磁盘管理学习笔记"><a class="header" href="#qemu-img-虚拟磁盘管理学习笔记">qemu-img 虚拟磁盘管理学习笔记</a></h1>
<blockquote>
<p>面向 0-5 年经验的虚拟化、云平台、存储运维工程师，系统掌握 qemu-img 工具的镜像创建、转换、校验、快照、调优与自动化实践。</p>
</blockquote>
<hr />
<h2 id="学习定位与总体目标"><a class="header" href="#学习定位与总体目标">学习定位与总体目标</a></h2>
<ul>
<li><strong>学习者画像</strong>：使用 KVM/libvirt/OpenStack/KubeVirt 等虚拟化平台，需要管理虚拟磁盘镜像的工程师。</li>
<li><strong>技术定位</strong>：<code>qemu-img</code> 是 QEMU/KVM 生态中用于创建、转换、修改、检查虚拟磁盘镜像的命令行工具，支持多种格式（qcow2、raw、vmdk、vdi、vhdx 等），是镜像生命周期管理、自动化流水线、备份恢复的重要工具。</li>
<li><strong>学习目标</strong>：
<ol>
<li>理解 qemu-img 的核心功能、镜像格式与差异；</li>
<li>熟悉镜像创建、转换、压缩、快照、校验、修复操作；</li>
<li>在虚拟化部署、镜像仓库、备份恢复、性能调优、故障排查场景中灵活应用；</li>
<li>构建自动化脚本、CI/CD 流水线；</li>
<li>输出操作手册、最佳实践、验证标准，纳入团队规范。</li>
</ol>
</li>
<li><strong>成果要求</strong>：
<ul>
<li>构建多格式镜像转换与优化流程；</li>
<li>实施镜像扩容、精简、快照、校验操作，并提供结果记录；</li>
<li>在自动化流水线或批处理脚本中调用 qemu-img；</li>
<li>编写故障排查与修复案例；</li>
<li>形成文档、培训材料，团队评审通过。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="核心模块结构"><a class="header" href="#核心模块结构">核心模块结构</a></h2>
<ol>
<li><strong>模块一：qemu-img 基础概念与镜像格式</strong> —— 工具概览、磁盘格式、使用场景。</li>
<li><strong>模块二：常用命令与操作实践</strong> —— 创建、查看、转换、扩容、快照、校验。</li>
<li><strong>模块三：高级功能与性能调优</strong> —— 压缩、差分镜像、预分配、加密、配合 libvirt。</li>
<li><strong>模块四：典型应用场景与自动化集成</strong> —— 镜像仓库、CI/CD、备份恢复、云平台、容器。</li>
<li><strong>模块五：故障诊断、安全治理与最佳实践</strong> —— 常见问题、排查、审计、安全策略。</li>
<li><strong>模块六：学习路径、实战案例与验证标准</strong> —— 学习计划、项目案例、成功标准、资源扩展。</li>
</ol>
<hr />
<h2 id="模块一qemu-img-基础概念与镜像格式"><a class="header" href="#模块一qemu-img-基础概念与镜像格式">模块一：qemu-img 基础概念与镜像格式</a></h2>
<h3 id="11-qemu-img-简介"><a class="header" href="#11-qemu-img-简介">1.1 qemu-img 简介</a></h3>
<ul>
<li>QEMU/KVM 虚拟磁盘管理工具；</li>
<li>支持创建、转换、校验、快照、信息查询；</li>
<li>不依赖 libvirt，可独立操作镜像文件；</li>
<li>适用于虚拟化平台、自动化镜像工厂、快速测试。</li>
</ul>
<h3 id="12-支持的镜像格式"><a class="header" href="#12-支持的镜像格式">1.2 支持的镜像格式</a></h3>
<div class="table-wrapper"><table><thead><tr><th>格式</th><th>特性</th><th>场景</th></tr></thead><tbody>
<tr><td>raw</td><td>无额外开销，高性能，占用空间大</td><td>生产、高性能存储</td></tr>
<tr><td>qcow2</td><td>支持压缩、快照、加密、稀疏</td><td>默认 KVM 镜像</td></tr>
<tr><td>qed</td><td>旧格式，已弃用</td><td>不推荐</td></tr>
<tr><td>vmdk</td><td>VMware 磁盘格式</td><td>跨平台</td></tr>
<tr><td>vhd/vhdx</td><td>Hyper-V</td><td>迁移</td></tr>
<tr><td>vdi</td><td>VirtualBox</td><td>迁移</td></tr>
<tr><td>luks</td><td>加密磁盘</td><td>安全</td></tr>
<tr><td>nbd</td><td>Network Block Device</td><td>热插拔</td></tr>
</tbody></table>
</div>
<h3 id="13-qcow2-关键特性"><a class="header" href="#13-qcow2-关键特性">1.3 qcow2 关键特性</a></h3>
<ul>
<li>稀疏文件（只占用实际数据）；</li>
<li>支持内部/外部快照；</li>
<li>可压缩；</li>
<li>支持加密（AES-CBC）；</li>
<li>支持 backing file（差分）；</li>
<li>Cluster size 影响性能；</li>
<li>Metadata overhead；</li>
<li>在高性能场景可转换为 raw。</li>
</ul>
<h3 id="14-qcow2-与-raw-比较"><a class="header" href="#14-qcow2-与-raw-比较">1.4 qcow2 与 raw 比较</a></h3>
<div class="table-wrapper"><table><thead><tr><th>特性</th><th>qcow2</th><th>raw</th></tr></thead><tbody>
<tr><td>空间占用</td><td>稀疏，按需增长</td><td>固定大小</td></tr>
<tr><td>功能</td><td>快照、压缩、加密</td><td>简单</td></tr>
<tr><td>性能</td><td>略低</td><td>高</td></tr>
<tr><td>管理</td><td>需要维护 metadata</td><td>简单</td></tr>
<tr><td>备份</td><td>支持差分</td><td>与底层存储配合</td></tr>
</tbody></table>
</div>
<ul>
<li>适合场景：qcow2（开发、模板、云平台）、raw（高性能存储、Ceph RBD）</li>
</ul>
<h3 id="15-镜像-lifecycle"><a class="header" href="#15-镜像-lifecycle">1.5 镜像 lifecycle</a></h3>
<ul>
<li>创建 -&gt; 定制 -&gt; 快照 -&gt; 扩容/缩小 -&gt; 转换 -&gt; 备份 -&gt; 校验；</li>
<li>与 libvirt、virt-install、virt-customize、cloud-init 结合；</li>
<li>自动化流水线：packer + qemu-img。</li>
</ul>
<h3 id="16-学习重点与易错点"><a class="header" href="#16-学习重点与易错点">1.6 学习重点与易错点</a></h3>
<ul>
<li><strong>重点</strong>：格式特性、稀疏 vs 预分配、差分镜像、快照；</li>
<li><strong>易错点</strong>：
<ol>
<li>转换导致 backing file 丢失；</li>
<li><code>qemu-img convert</code> 覆盖原镜像；</li>
<li>扩容后未扩展文件系统；</li>
<li><code>resize</code> 缩小导致数据丢失；</li>
<li>QCOW2 metadata损坏未备份；</li>
<li>外部快照链未合并导致性能下降；</li>
<li>在生产中使用 block migration + qcow2 影响性能。</li>
</ol>
</li>
</ul>
<h3 id="17-工具版本"><a class="header" href="#17-工具版本">1.7 工具版本</a></h3>
<ul>
<li><code>qemu-img --version</code>；</li>
<li>与 QEMU 版本对应；</li>
<li>新版本支持 <code>--target-image-opts</code>, <code>--image-opts</code>；</li>
<li>OpenStack 依赖常见版本 4.x/5.x/6.x。</li>
</ul>
<hr />
<h2 id="模块二常用命令与操作实践"><a class="header" href="#模块二常用命令与操作实践">模块二：常用命令与操作实践</a></h2>
<h3 id="21-镜像信息"><a class="header" href="#21-镜像信息">2.1 镜像信息</a></h3>
<ul>
<li><code>qemu-img info disk.qcow2</code>
<ul>
<li>输出格式、虚拟大小、实际大小、backing file、cluster size；</li>
<li><code>--output json</code>；</li>
</ul>
<pre><code class="language-bash">qemu-img info --backing-chain vm.qcow2
</code></pre>
</li>
</ul>
<h3 id="22-创建镜像"><a class="header" href="#22-创建镜像">2.2 创建镜像</a></h3>
<ul>
<li><code>qemu-img create -f qcow2 disk.qcow2 40G</code>
<ul>
<li><code>-o preallocation=metadata</code>, <code>lazy_refcounts=on</code>, <code>compat=1.1</code>；</li>
<li>创建 raw：<code>qemu-img create -f raw disk.raw 20G</code>；</li>
<li><code>-o cluster_size=1M</code> 调整。</li>
</ul>
</li>
</ul>
<h3 id="23-转换镜像"><a class="header" href="#23-转换镜像">2.3 转换镜像</a></h3>
<ul>
<li><code>qemu-img convert -f raw -O qcow2 disk.raw disk.qcow2</code></li>
<li><code>qemu-img convert -p -O raw disk.qcow2 disk.raw</code></li>
<li>选择参数：<code>-c</code> 压缩、<code>-S 0</code> 去掉稀疏；</li>
<li>保留 backing：<code>--backing-chain</code>；</li>
<li><code>--target-image-opts</code>：转换到 Ceph RBD: <code>qemu-img convert -O raw disk.qcow2 rbd:pool/image</code>；</li>
<li>VMware -&gt; qcow2:
<pre><code class="language-bash">qemu-img convert -f vmdk source.vmdk -O qcow2 target.qcow2
</code></pre>
</li>
</ul>
<h3 id="24-扩容与缩小"><a class="header" href="#24-扩容与缩小">2.4 扩容与缩小</a></h3>
<ul>
<li><code>qemu-img resize disk.qcow2 +10G</code></li>
<li><code>qemu-img resize disk.qcow2 50G</code></li>
<li>raw 扩容：<code>truncate -s +10G disk.raw</code></li>
<li>缩小：<code>qemu-img resize disk.qcow2 -10G</code> (危险，需先缩小 FS);</li>
<li>需要在 guest 系统内扩展分区/FS (<code>growpart</code>, <code>resize2fs</code>, <code>xfs_growfs</code>)。</li>
</ul>
<h3 id="25-快照管理"><a class="header" href="#25-快照管理">2.5 快照管理</a></h3>
<ul>
<li><strong>内部快照</strong>：
<ul>
<li><code>qemu-img snapshot -c snap1 disk.qcow2</code></li>
<li><code>qemu-img snapshot -l disk.qcow2</code></li>
<li><code>qemu-img snapshot -a snap1 disk.qcow2</code></li>
<li><code>qemu-img snapshot -d snap1 disk.qcow2</code></li>
</ul>
</li>
<li><strong>外部快照</strong>（配合 <code>qemu-img</code> / <code>qemu-system</code>），libvirt <code>virsh snapshot-create --disk-only</code>。</li>
</ul>
<h3 id="26-精简与压缩"><a class="header" href="#26-精简与压缩">2.6 精简与压缩</a></h3>
<ul>
<li><code>qemu-img convert -O qcow2 -c disk.qcow2 new.qcow2</code></li>
<li><code>qemu-img convert -O qcow2 -S 0 disk.qcow2 new.qcow2</code></li>
<li><code>qemu-img convert -O qcow2 -p disk.qcow2 /tmp/disk-slim.qcow2</code></li>
<li><code>qemu-img amend</code> 调整 qcow2 元数据：<code>qemu-img amend -f qcow2 -o compat=1.1 disk.qcow2</code></li>
</ul>
<h3 id="27-校验与修复"><a class="header" href="#27-校验与修复">2.7 校验与修复</a></h3>
<ul>
<li><code>qemu-img check disk.qcow2</code></li>
<li><code>qemu-img check --repair disk.qcow2</code>（尽量备份后使用）</li>
<li><code>qemu-img check --output=json</code></li>
</ul>
<h3 id="28-比较"><a class="header" href="#28-比较">2.8 比较</a></h3>
<ul>
<li><code>qemu-img compare disk1.qcow2 disk2.qcow2</code></li>
<li><code>--format</code>, <code>--parallel=N</code></li>
<li><code>--dirty-bitmap</code> (Live compare with NBD)</li>
</ul>
<h3 id="29-加密与解密"><a class="header" href="#29-加密与解密">2.9 加密与解密</a></h3>
<ul>
<li>创建加密 qcow2：<code>qemu-img create -f qcow2 -o encryption=on,luks-format=luks1,luks-key-secret=mysecret disk.qcow2 20G</code></li>
<li><code>qemu-img convert --target-image-opts -O qcow2 disk.qcow2 'json:{"file.driver":"file", "file.filename":"cipher.qcow2", "encryption":{...}}'</code></li>
<li>配合 <code>libvirt secret</code>。</li>
</ul>
<h3 id="210-实践练习"><a class="header" href="#210-实践练习">2.10 实践练习</a></h3>
<ul>
<li>创建 qcow2 镜像并转换为 raw；</li>
<li>对镜像扩容 + 使用 guest 扩展文件系统；</li>
<li>制作内部快照并恢复；</li>
<li>使用 <code>check</code> 检查镜像；</li>
<li>压缩镜像并比较大小；</li>
<li>编写脚本批量转换；</li>
<li>输出操作记录与命令说明。</li>
</ul>
<hr />
<h2 id="模块三高级功能与性能调优"><a class="header" href="#模块三高级功能与性能调优">模块三：高级功能与性能调优</a></h2>
<h3 id="31-预分配策略"><a class="header" href="#31-预分配策略">3.1 预分配策略</a></h3>
<ul>
<li><code>preallocation=off</code>, <code>metadata</code>, <code>falloc</code>, <code>full</code>；</li>
<li><code>metadata</code>: 预分配 metadata，写入时性能更稳定；</li>
<li><code>falloc</code>：使用 <code>fallocate</code> 预分配数据；</li>
<li><code>full</code>: 完全预分配，空间占用大，但性能好；</li>
<li><code>lazy_refcounts=on</code> 改善 snapshot 删除性能；</li>
<li><code>compat=1.1</code> 支持 lazy refcounts, metadata overlap。</li>
</ul>
<h3 id="32-cluster-size"><a class="header" href="#32-cluster-size">3.2 cluster size</a></h3>
<ul>
<li><code>cluster_size</code> 默认 64K；</li>
<li>调整: <code>-o cluster_size=1M</code>；</li>
<li>较大 cluster：更好的 sequential I/O, 但 metadata overhead；</li>
<li>需平衡 I/O 模式（随机 vs 顺序）。</li>
</ul>
<h3 id="33-差分镜像backing-files"><a class="header" href="#33-差分镜像backing-files">3.3 差分镜像（backing files）</a></h3>
<ul>
<li><code>qemu-img create -f qcow2 -b base.qcow2 overlay.qcow2</code></li>
<li><code>qemu-img info overlay.qcow2</code> -&gt; backing file chain；</li>
<li><code>qemu-img rebase -b newbase.qcow2 overlay.qcow2</code>；</li>
<li><code>-u</code> 选项禁止检查；</li>
<li>外部快照链 -&gt; 需定期合并 <code>qemu-img commit</code>；</li>
<li><code>qemu-img convert -O qcow2 overlay.qcow2 new.qcow2</code> flatten。</li>
</ul>
<h3 id="34-commit--rebase"><a class="header" href="#34-commit--rebase">3.4 commit &amp; rebase</a></h3>
<ul>
<li><code>qemu-img commit overlay.qcow2</code> -&gt; 将数据写入 backing；</li>
<li><code>--active</code> commit running image；</li>
<li><code>qemu-img rebase -b '' overlay.qcow2</code> -&gt; remove backing；</li>
<li>结合 libvirt <code>blockcommit</code>, <code>blockpull</code>。</li>
</ul>
<h3 id="35-nbdnetwork-block-device"><a class="header" href="#35-nbdnetwork-block-device">3.5 NBD（Network Block Device）</a></h3>
<ul>
<li><code>qemu-nbd --connect=/dev/nbd0 disk.qcow2</code></li>
<li><code>qemu-img convert --image-opts driver=nbd,export=sda,server.type=tcp,server.host=... -O qcow2 new.qcow2</code></li>
<li>Live backup/compare；</li>
<li>Danger: pay attention to concurrency.</li>
</ul>
<h3 id="36-与-cephgluster-集成"><a class="header" href="#36-与-cephgluster-集成">3.6 与 Ceph/Gluster 集成</a></h3>
<ul>
<li><code>qemu-img convert disk.qcow2 rbd:pool/image</code> (Ceph)；</li>
<li><code>qemu-img map</code> to view extents;</li>
<li>Ceph features (thick thin) align;</li>
<li>Gluster: use <code>json:{"file.driver":"gluster"...}</code>.</li>
</ul>
<h3 id="37-性能测试与优化"><a class="header" href="#37-性能测试与优化">3.7 性能测试与优化</a></h3>
<ul>
<li><code>qemu-img bench</code> (QEMU 5+): Benchmark read/write;</li>
<li>Evaluate conversion speed;</li>
<li>Use <code>--object iothread</code>;</li>
<li>Align with storage features: <code>cache=none</code>, <code>directsync</code>;</li>
<li>Avoid long chain of overlays;</li>
<li>For OpenStack: convert to raw on Ceph for performance.</li>
</ul>
<h3 id="38-安全加固"><a class="header" href="#38-安全加固">3.8 安全加固</a></h3>
<ul>
<li>QCOW2 encryption via LUKS;</li>
<li><code>qemu-img info</code> hide passwords;</li>
<li>Manage key with libvirt secret;</li>
<li>Ensure conversions with encrypted data keep security (use <code>--passphrase</code>).</li>
</ul>
<h3 id="39-多线程转换"><a class="header" href="#39-多线程转换">3.9 多线程转换</a></h3>
<ul>
<li><code>--target-image-opts driver=...)</code> combined with <code>--multifd</code>? (Long term QEMU);</li>
<li><code>qemu-img convert -W</code> avoid write cache (danger);</li>
<li><code>--parallel=N</code> for compare.</li>
</ul>
<h3 id="310-实践练习"><a class="header" href="#310-实践练习">3.10 实践练习</a></h3>
<ul>
<li>创建 backing chain, rebase/commit ;</li>
<li>Convert qcow2 -&gt; raw -&gt; Ceph;</li>
<li>Preallocate metadata vs full, compare size/time;</li>
<li>Use <code>qemu-img amend</code> to change metadata;</li>
<li>Evaluate <code>qemu-img bench</code> ;</li>
<li>Document performance results.</li>
</ul>
<hr />
<h2 id="模块四典型应用场景与自动化集成"><a class="header" href="#模块四典型应用场景与自动化集成">模块四：典型应用场景与自动化集成</a></h2>
<h3 id="41-镜像模板与云平台"><a class="header" href="#41-镜像模板与云平台">4.1 镜像模板与云平台</a></h3>
<ul>
<li>OpenStack Glance: <code>openstack image create --file</code> uses qemu-img;</li>
<li>Packer + qemu builder;</li>
<li>Cloud-init base image customizing with <code>qemu-img</code> convert/resize;</li>
<li>Harvester/KubeVirt image registry；</li>
<li>Image factory: <code>virt-builder + qemu-img</code> pipeline。</li>
</ul>
<h3 id="42-cicd-流水线集成"><a class="header" href="#42-cicd-流水线集成">4.2 CI/CD 流水线集成</a></h3>
<ul>
<li>Jenkins/GitLab CI: use <code>qemu-img</code> in stage to build/test images;</li>
<li>Steps: 1) Build base image (virt-builder/pb), 2) qemu-img convert/resize/compress, 3) Upload to repository;</li>
<li><code>Makefile</code> wrappers;</li>
<li>Tagging &amp; versioning;</li>
<li>Validate via <code>qemu-img check</code> before publishing.</li>
</ul>
<h3 id="43-备份与恢复"><a class="header" href="#43-备份与恢复">4.3 备份与恢复</a></h3>
<ul>
<li>Create snapshots (external) + use <code>qemu-img convert</code> for backup;</li>
<li><code>qemu-img convert -n</code> incremental backup;</li>
<li>With <code>qemu-nbd</code> + <code>rsync</code>;</li>
<li>Ceph RBD snapshots -&gt; export via qemu-img;</li>
<li>Ensure data consistency (freeze FS before snapshot).</li>
</ul>
<h3 id="44-迁移与转换"><a class="header" href="#44-迁移与转换">4.4 迁移与转换</a></h3>
<ul>
<li>VMware/Hyper-V -&gt; KVM: <code>qemu-img convert -f vmdk -O qcow2</code> ;</li>
<li><code>virt-v2v</code> uses qemu-img internally;</li>
<li>Convert for backup to AWS/Azure;</li>
<li>Flatten snapshot chains before migration.</li>
</ul>
<h3 id="45-容器虚拟化混合场景"><a class="header" href="#45-容器虚拟化混合场景">4.5 容器虚拟化混合场景</a></h3>
<ul>
<li>Build VM images for container runtime (Kata, KubeVirt) ;</li>
<li><code>qemu-img</code> shrink raw images embedded into container images;</li>
<li><code>buildah</code> + <code>qemu-img</code> for multi-arch.</li>
</ul>
<h3 id="46-脚本化与任务编排"><a class="header" href="#46-脚本化与任务编排">4.6 脚本化与任务编排</a></h3>
<ul>
<li>Bash scripts for mass conversion;</li>
<li>Python <code>subprocess</code> calling qemu-img;</li>
<li>Ansible <code>qemu_img</code> module (community.general);</li>
<li>Terraform <code>external</code> data source;</li>
<li>Cron jobs (e.g., nightly optimize images).</li>
</ul>
<h3 id="47-镜像仓库管理"><a class="header" href="#47-镜像仓库管理">4.7 镜像仓库管理</a></h3>
<ul>
<li>Maintain metadata (size, format, checksum);</li>
<li>Use <code>qemu-img info --output=json</code> to create inventory;</li>
<li>Version control images (Git LFS, S3);</li>
<li>Ensure naming conventions;</li>
<li>Integrate with CMDB.</li>
</ul>
<h3 id="48-自动化示例"><a class="header" href="#48-自动化示例">4.8 自动化示例</a></h3>
<pre><code class="language-bash">#!/bin/bash
SRC=$1
DEST_DIR=/var/lib/glance/images

NAME=$(basename $SRC .qcow2)
DATE=$(date +%Y%m%d)

qemu-img check $SRC || { echo "check failed"; exit 1; }

qemu-img convert -O qcow2 -c -p $SRC $DEST_DIR/${NAME}_${DATE}.qcow2
sha256sum $DEST_DIR/${NAME}_${DATE}.qcow2 &gt; $DEST_DIR/${NAME}_${DATE}.sha256
</code></pre>
<h3 id="49-与-libvirtlibguestfs-协同"><a class="header" href="#49-与-libvirtlibguestfs-协同">4.9 与 libvirt/libguestfs 协同</a></h3>
<ul>
<li><code>virt-sysprep</code> -&gt; <code>qemu-img convert</code>;</li>
<li><code>libguestfs</code> tools for customizing;</li>
<li><code>virsh snapshot</code> -&gt; <code>qemu-img commit</code> ;</li>
<li><code>virsh blockpull</code>, <code>blockcommit</code> -&gt; qemu-img advanced operations.</li>
</ul>
<h3 id="410-实践练习"><a class="header" href="#410-实践练习">4.10 实践练习</a></h3>
<ul>
<li>在 CI 中构建 &amp; 压缩 qcow2 后推送;</li>
<li>设计脚本生成 metadata JSON；</li>
<li>执行跨平台转换 VMDK -&gt; qcow2 -&gt; raw;</li>
<li>使用 qemu-img + NBD 备份 Ceph RBD volume;</li>
<li>编写 Makefile encapsulating operations;</li>
<li>记录操作日志、报告。</li>
</ul>
<hr />
<h2 id="模块五故障诊断安全治理与最佳实践"><a class="header" href="#模块五故障诊断安全治理与最佳实践">模块五：故障诊断、安全治理与最佳实践</a></h2>
<h3 id="51-常见问题"><a class="header" href="#51-常见问题">5.1 常见问题</a></h3>
<div class="table-wrapper"><table><thead><tr><th>问题</th><th>现象</th><th>排查</th><th>解决</th></tr></thead><tbody>
<tr><td>转换失败</td><td><code>Could not open</code></td><td>检查路径、权限</td><td>修正路径、sudo</td></tr>
<tr><td>backing file 丢失</td><td><code>No such file</code></td><td><code>qemu-img info</code></td><td>恢复 backing, rebase</td></tr>
<tr><td>元数据损坏</td><td><code>qemu-img check</code> 错误</td><td><code>check --repair</code></td><td>恢复备份</td></tr>
<tr><td>扩容后空间未变化</td><td>Guest 内未扩展</td><td>FS 扩展</td><td><code>growpart</code>, <code>resize2fs</code></td></tr>
<tr><td>缩小导致数据丢失</td><td>FS 超出</td><td>检查 FS</td><td>先缩小 FS 再 resize</td></tr>
<tr><td>性能差</td><td>写延迟高</td><td>检查 cluster, preallocation</td><td>转换格式，预分配</td></tr>
<tr><td>快照链过长</td><td>启动慢</td><td><code>qemu-img info --backing-chain</code></td><td>合并快照</td></tr>
<tr><td>加密转换失败</td><td>未提供 key</td><td><code>--object</code> secret</td><td>提供 passphrase</td></tr>
<tr><td>多线程冲突</td><td>同时操作</td><td>检查锁</td><td>使用 <code>virtlockd</code>, 避免并发</td></tr>
<tr><td>checksum mismatch</td><td>备份损坏</td><td><code>sha256sum</code></td><td>重新备份</td></tr>
</tbody></table>
</div>
<h3 id="52-排查流程"><a class="header" href="#52-排查流程">5.2 排查流程</a></h3>
<ol>
<li><code>qemu-img info</code> 获取镜像详情；</li>
<li><code>qemu-img check</code> 检测；</li>
<li>检查 backing chain；</li>
<li>查看 FS 使用 (<code>guestmount</code>);</li>
<li>分析日志/命令记录；</li>
<li>评估转换/resize步骤是否正确；</li>
<li>如果损坏，使用备份覆盖；</li>
<li>记录 RCA</li>
</ol>
<h3 id="53-安全与合规"><a class="header" href="#53-安全与合规">5.3 安全与合规</a></h3>
<ul>
<li>管理镜像加密 (LUKS)；</li>
<li>镜像访问权限（chmod/chown）；</li>
<li>Shred 移除 sensitive data；</li>
<li>Checksum &amp; signing (GPG)；</li>
<li>审计 qemu-img 操作 (<code>auditd -w /usr/bin/qemu-img</code>)；</li>
<li>接口控制（只允许运维执行）。</li>
</ul>
<h3 id="54-最佳实践"><a class="header" href="#54-最佳实践">5.4 最佳实践</a></h3>
<ul>
<li>镜像命名规范、版本标签；</li>
<li>使用 <code>qemu-img info</code>/<code>checksum</code> 记录 metadata；</li>
<li>定期运行 <code>check</code>；</li>
<li>控制快照层数；</li>
<li>生产使用 raw on Ceph, qcow2 for templates；</li>
<li>Automation for conversion/sparsify;</li>
<li>Document operations;</li>
<li>Always backup before repair/resize.</li>
</ul>
<h3 id="55-监控与审计"><a class="header" href="#55-监控与审计">5.5 监控与审计</a></h3>
<ul>
<li>logging: <code>script</code> command output;</li>
<li>Use <code>promtail</code> to collect logs;</li>
<li><code>auditd</code> record;</li>
<li>Track disk usage (real vs virtual) for capacity planning;</li>
<li>Alert when chain depth &gt; threshold.</li>
</ul>
<h3 id="56-灾难恢复策略"><a class="header" href="#56-灾难恢复策略">5.6 灾难恢复策略</a></h3>
<ul>
<li>Keep golden images offline;</li>
<li>Maintain incremental backups (overlay) with schedule;</li>
<li>Use qemu-img to clone quickly;</li>
<li>Test restore procedure regularly;</li>
<li>Document recovery steps.</li>
</ul>
<h3 id="57-自动化安全检查脚本"><a class="header" href="#57-自动化安全检查脚本">5.7 自动化安全检查脚本</a></h3>
<pre><code class="language-bash">#!/bin/bash
IMG=$1
qemu-img info --output=json $IMG | jq '.[
#!/bin/bash
IMG=$1
if [[ -z "$IMG" || ! -f "$IMG" ]]; then
  echo "Usage: $0 &lt;image&gt;" &gt;&amp;2
  exit 1
fi

info=$(qemu-img info --output=json "$IMG")
format=$(echo "$info" | jq -r '.format')
actual_size=$(echo "$info" | jq -r '."actual-size"')
virtual_size=$(echo "$info" | jq -r '."virtual-size"')
backing=$(echo "$info" | jq -r '.backing-filename // "&lt;none&gt;"')

printf "Image: %s\nFormat: %s\nActual size: %s\nVirtual size: %s\nBacking: %s\n" \
  "$IMG" "$format" "$actual_size" "$virtual_size" "$backing"

if [[ "$backing" != "&lt;none&gt;" ]]; then
  echo "WARN: Image depends on backing file $backing"
fi

### 5.8 文档化与SOP
- 为常用场景（创建、转换、扩容、快照合并）编写标准操作步骤；
- 记录命令、参数、前置检查、后续验证；
- 将脚本与模板存入版本库，添加说明；
- 为关键操作设计审批流程与回滚方案。

### 5.9 实践练习
- 排查一次 backing file 丢失问题并恢复；
- 设计安全检查脚本并纳入 CI；
- 编写 SOP，包含失败案例和预案；
- 模拟加密镜像转换与恢复；
- 记录操作日志并分享团队经验。

---

## 模块六：学习路径、实战案例与验证标准

### 6.1 学习路径

| 阶段 | 时间 | 目标 | 行动 | 产出 |
| --- | --- | --- | --- | --- |
| 阶段 0：准备 | 1 天 | 安装 qemu-img，了解格式 | 阅读文档、准备测试镜像 | 环境记录 |
| 阶段 1：基础实践 | 3 天 | 掌握创建、转换、扩容、快照 | 完成练习并记录命令 | 操作手册 |
| 阶段 2：高级功能 | 4 天 | 压缩、差分、rebase、commit | 实验性能对比 | 调优报告 |
| 阶段 3：自动化 | 4 天 | 集成脚本/CI/CD、镜像仓库 | 编写脚本、流水线 | 自动化仓库 |
| 阶段 4：安全治理 | 3 天 | 检查、审计、备份恢复 | 实施安全策略、演练 | SOP、审计记录 |
| 阶段 5：推广沉淀 | 持续 | 分享经验、维护知识库 | 组织培训、评审 | 知识库、迭代计划 |

### 6.2 实战案例

#### 案例一：OpenStack 镜像工厂
- 使用 Packer 构建基础镜像 → qemu-img 压缩 → 上传 Glance；
- 每次构建自动生成 metadata (格式、大小、checksum)；
- 结果：镜像体积缩减 35%，上线时间缩短。

#### 案例二：跨平台迁移
- VMware VMDK → qcow2 → raw (Ceph)；
- 执行 `qemu-img convert`、`virt-v2v`；
- 验证 `check`、`compare` 确认一致；
- 结果：成功迁移 200+ VM，无数据丢失。

#### 案例三：差分备份与恢复
- 定期创建 overlay snapshot，使用 `qemu-img convert -n` 备份增量；
- 故障时合并快照链恢复；
- 编写自动化脚本生成备份日志；
- 结果：恢复时间从 2 小时缩短到 20 分钟。

#### 案例四：镜像瘦身与成本优化
- 对历史镜像执行 `convert -c`、`-S 0`；
- 删除无效快照，合并链；
- 存储占用减少 40%，备份窗口缩短。

#### 案例五：CI/CD 自动化验证
- 在 Jenkins pipeline 中使用 qemu-img 生成测试镜像；
- 自动执行 `check`、`compare` 确保一致；
- 推送镜像并写入 CMDB；
- 结果：镜像质量一致，可追溯。

### 6.3 学习成果验证标准
1. **操作熟练度**：完成创建、转换、扩容、快照、压缩等操作并记录命令；
2. **自动化能力**：开发脚本或流水线，实现镜像处理自动化；
3. **性能优化**：提供至少一份调优报告，量化镜像优化收益；
4. **安全与合规**：实施镜像校验、权限控制、审计策略并验证；
5. **故障演练**：模拟至少 2 种镜像故障并成功恢复；
6. **文档沉淀**：交付操作手册、FAQ、案例库；
7. **团队协作**：完成知识分享并获得反馈；
8. **持续迭代**：制定镜像管理改进计划（版本更新、格式演进）。

### 6.4 扩展资源与进阶建议
- **官方文档**：
  - https://qemu.readthedocs.io/en/latest/tools/qemu-img.html
  - QEMU Wiki: Disk Image Formats &amp; qcow2
- **社区资料**：
  - OpenStack Image Guide
  - Libvirt Storage Management
  - Proxmox/Wiki 镜像管理文章
- **工具链**：
  - `virt-sysprep`, `virt-builder`, `virt-resize`
  - `qemu-nbd`, `nbdkit`, `libguestfs`
  - `ansible.builtin.command` + `community.general.qemu_img`
- **进阶建议**：
  1. 深入理解 qcow2 元数据结构，研究性能特性；
  2. 结合 Ceph、Gluster 等分布式存储进行镜像优化；
  3. 构建镜像签名与发布流程，强化供应链安全；
  4. 探索容器镜像与虚拟机镜像的混合发布；
  5. 持续追踪 QEMU 版本更新与新特性（multifd、luks2 等）；
  6. 参与社区贡献，分享最佳实践。

---

## 附录

### A. 常用命令速查
```bash
qemu-img info vm.qcow2
qemu-img create -f qcow2 vm.qcow2 40G
qemu-img convert -f qcow2 -O raw vm.qcow2 vm.raw
qemu-img resize vm.qcow2 +20G
qemu-img snapshot -c pre-upgrade vm.qcow2
qemu-img snapshot -a pre-upgrade vm.qcow2
qemu-img check --repair vm.qcow2
qemu-img compare --format=qcow2 old.qcow2 new.qcow2
qemu-img convert -O qcow2 -c vm.qcow2 vm-slim.qcow2
qemu-img create -f qcow2 -b base.qcow2 overlay.qcow2
</code></pre>
<h3 id="b-元数据提取模板-json"><a class="header" href="#b-元数据提取模板-json">B. 元数据提取模板 (JSON)</a></h3>
<pre><code class="language-bash">qemu-img info --output=json vm.qcow2 | jq '{
  name: "vm.qcow2",
  format,
  virtual_size: .["virtual-size"],
  actual_size: .["actual-size"],
  backing_file: .["backing-filename"],
  dirty_flag: .dirty_flag
}'
</code></pre>
<h3 id="c-审计规则示例"><a class="header" href="#c-审计规则示例">C. 审计规则示例</a></h3>
<pre><code class="language-bash">auditctl -w /usr/bin/qemu-img -p x -k qemu-img-ops
ausearch -k qemu-img-ops --format=raw | aureport -i
</code></pre>
<h3 id="d-故障记录模板"><a class="header" href="#d-故障记录模板">D. 故障记录模板</a></h3>
<pre><code>事件编号：QIMG-2024-02
时间：2024-07-12 10:45
操作：qemu-img convert -O raw app.qcow2 app.raw
现象：转换后磁盘容量错误
排查：
1. qemu-img info 显示 backing file 链
2. 发现未指定 --backing-chain，转换未包含差分数据
处理：
1. 使用 qemu-img convert --backing-chain
2. 核对 checksum
预防：
- 在 SOP 中增加 backing 检查
- 自动化脚本加入提示
</code></pre>
<blockquote>
<p>熟练掌握 qemu-img，可极大提升虚拟磁盘管理、自动化交付与灾备恢复效率。结合标准化流程、自动化脚本与性能调优策略，构建高效、安全、可追溯的镜像管理体系。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/云计算/numa.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/云计算/qemu.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/云计算/numa.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/云计算/qemu.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

