<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>TCP/IPç½‘ç»œç¼–ç¨‹å®æˆ˜ - å¼€å‘</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å¼€å‘</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="æœç´¢æœ¬ä¹¦å†…å®¹..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="tcpipç½‘ç»œç¼–ç¨‹å®æˆ˜"><a class="header" href="#tcpipç½‘ç»œç¼–ç¨‹å®æˆ˜">TCP/IPç½‘ç»œç¼–ç¨‹å®æˆ˜</a></h1>
<blockquote>
<p>æœ¬ç¬”è®°æ˜¯<a href="tcpip.html">TCP/IPåè®®å­¦ä¹ ç¬”è®°</a>çš„æ‰©å±•éƒ¨åˆ†ï¼Œä¸“æ³¨äºé«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹çš„å®æˆ˜æŠ€å·§</p>
</blockquote>
<h2 id="-ç›®å½•"><a class="header" href="#-ç›®å½•">ğŸ“‹ ç›®å½•</a></h2>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E7%AB%A0io%E6%A8%A1%E5%9E%8B">ç¬¬ä¸€ç« ï¼šI/Oæ¨¡å‹</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">ç¬¬äºŒç« ï¼šI/Oå¤šè·¯å¤ç”¨</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%E5%BC%82%E6%AD%A5%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B">ç¬¬ä¸‰ç« ï¼šå¼‚æ­¥ç½‘ç»œç¼–ç¨‹</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%B6%E6%9E%84">ç¬¬å››ç« ï¼šé«˜æ€§èƒ½æœåŠ¡å™¨æ¶æ„</a></li>
<li><a href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1">ç¬¬äº”ç« ï¼šåè®®è®¾è®¡</a></li>
</ul>
<hr />
<h2 id="ç¬¬ä¸€ç« ioæ¨¡å‹"><a class="header" href="#ç¬¬ä¸€ç« ioæ¨¡å‹">ç¬¬ä¸€ç« ï¼šI/Oæ¨¡å‹</a></h2>
<h3 id="11-äº”ç§ioæ¨¡å‹"><a class="header" href="#11-äº”ç§ioæ¨¡å‹">1.1 äº”ç§I/Oæ¨¡å‹</a></h3>
<h4 id="ioæ¨¡å‹åˆ†ç±»"><a class="header" href="#ioæ¨¡å‹åˆ†ç±»">I/Oæ¨¡å‹åˆ†ç±»</a></h4>
<pre><code>1. é˜»å¡I/O (Blocking I/O)
   - è¿›ç¨‹é˜»å¡ç›´åˆ°I/Oæ“ä½œå®Œæˆ
   - æœ€ç®€å•ä½†æ•ˆç‡æœ€ä½

2. éé˜»å¡I/O (Non-blocking I/O)
   - ç«‹å³è¿”å›ï¼Œéœ€è¦è½®è¯¢
   - CPUå ç”¨é«˜

3. I/Oå¤šè·¯å¤ç”¨ (I/O Multiplexing)
   - select/poll/epoll
   - ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦

4. ä¿¡å·é©±åŠ¨I/O (Signal-driven I/O)
   - æ•°æ®å‡†å¤‡å¥½æ—¶å‘é€ä¿¡å·
   - è¾ƒå°‘ä½¿ç”¨

5. å¼‚æ­¥I/O (Asynchronous I/O)
   - å†…æ ¸å®ŒæˆI/Oåé€šçŸ¥åº”ç”¨
   - æ€§èƒ½æœ€é«˜
</code></pre>
<h4 id="é˜»å¡ioç¤ºä¾‹"><a class="header" href="#é˜»å¡ioç¤ºä¾‹">é˜»å¡I/Oç¤ºä¾‹</a></h4>
<pre><code class="language-python">import socket

def blocking_io_server():
    """é˜»å¡I/OæœåŠ¡å™¨"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(5)

    print("é˜»å¡I/OæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8888")

    while True:
        # é˜»å¡ç­‰å¾…è¿æ¥
        client_socket, client_address = server_socket.accept()
        print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")

        # é˜»å¡è¯»å–æ•°æ®
        data = client_socket.recv(1024)
        if data:
            print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
            # é˜»å¡å‘é€æ•°æ®
            client_socket.sendall(b"Echo: " + data)

        client_socket.close()

# ä½¿ç”¨ç¤ºä¾‹
# blocking_io_server()
</code></pre>
<h4 id="éé˜»å¡ioç¤ºä¾‹"><a class="header" href="#éé˜»å¡ioç¤ºä¾‹">éé˜»å¡I/Oç¤ºä¾‹</a></h4>
<pre><code class="language-python">import socket
import errno

def non_blocking_io_server():
    """éé˜»å¡I/OæœåŠ¡å™¨ï¼ˆè½®è¯¢æ¨¡å¼ï¼‰"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.setblocking(False)  # è®¾ç½®ä¸ºéé˜»å¡
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(5)

    print("éé˜»å¡I/OæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8888")

    client_sockets = []

    while True:
        # å°è¯•æ¥å—è¿æ¥ï¼ˆä¸é˜»å¡ï¼‰
        try:
            client_socket, client_address = server_socket.accept()
            client_socket.setblocking(False)
            client_sockets.append(client_socket)
            print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")
        except BlockingIOError:
            pass  # æ²¡æœ‰æ–°è¿æ¥ï¼Œç»§ç»­

        # è½®è¯¢æ‰€æœ‰å®¢æˆ·ç«¯socket
        for client_socket in client_sockets[:]:  # ä½¿ç”¨åˆ‡ç‰‡å¤åˆ¶åˆ—è¡¨
            try:
                data = client_socket.recv(1024)
                if data:
                    print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
                    client_socket.sendall(b"Echo: " + data)
                else:
                    # å®¢æˆ·ç«¯å…³é—­è¿æ¥
                    client_socket.close()
                    client_sockets.remove(client_socket)
            except BlockingIOError:
                pass  # æ²¡æœ‰æ•°æ®å¯è¯»
            except Exception as e:
                print(f"é”™è¯¯: {e}")
                client_socket.close()
                client_sockets.remove(client_socket)

# ä½¿ç”¨ç¤ºä¾‹
# non_blocking_io_server()
</code></pre>
<hr />
<h2 id="ç¬¬äºŒç« ioå¤šè·¯å¤ç”¨"><a class="header" href="#ç¬¬äºŒç« ioå¤šè·¯å¤ç”¨">ç¬¬äºŒç« ï¼šI/Oå¤šè·¯å¤ç”¨</a></h2>
<h3 id="21-selectå®ç°"><a class="header" href="#21-selectå®ç°">2.1 selectå®ç°</a></h3>
<h4 id="selectåŸºç¡€"><a class="header" href="#selectåŸºç¡€">selectåŸºç¡€</a></h4>
<pre><code class="language-python">import socket
import select

def select_server():
    """ä½¿ç”¨selectå®ç°çš„æœåŠ¡å™¨"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(5)
    server_socket.setblocking(False)

    print("SelectæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8888")

    # ç»´æŠ¤è¦ç›‘æ§çš„socketåˆ—è¡¨
    inputs = [server_socket]
    outputs = []

    while inputs:
        # selectç›‘æ§ï¼šå¯è¯»ã€å¯å†™ã€å¼‚å¸¸
        readable, writable, exceptional = select.select(inputs, outputs, inputs)

        # å¤„ç†å¯è¯»çš„socket
        for s in readable:
            if s is server_socket:
                # æœåŠ¡å™¨socketå¯è¯»ï¼Œè¡¨ç¤ºæœ‰æ–°è¿æ¥
                client_socket, client_address = s.accept()
                print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")
                client_socket.setblocking(False)
                inputs.append(client_socket)
            else:
                # å®¢æˆ·ç«¯socketå¯è¯»ï¼Œè¡¨ç¤ºæœ‰æ•°æ®
                try:
                    data = s.recv(1024)
                    if data:
                        print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
                        # å›æ˜¾æ•°æ®
                        s.sendall(b"Echo: " + data)
                    else:
                        # å®¢æˆ·ç«¯å…³é—­è¿æ¥
                        print(f"å®¢æˆ·ç«¯æ–­å¼€è¿æ¥")
                        inputs.remove(s)
                        if s in outputs:
                            outputs.remove(s)
                        s.close()
                except Exception as e:
                    print(f"é”™è¯¯: {e}")
                    inputs.remove(s)
                    if s in outputs:
                        outputs.remove(s)
                    s.close()

        # å¤„ç†å¼‚å¸¸çš„socket
        for s in exceptional:
            print(f"Socketå¼‚å¸¸")
            inputs.remove(s)
            if s in outputs:
                outputs.remove(s)
            s.close()

# ä½¿ç”¨ç¤ºä¾‹
# select_server()
</code></pre>
<p><strong>selectçš„å±€é™æ€§</strong></p>
<pre><code>1. æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼ˆLinuxé»˜è®¤1024ï¼‰
2. æ¯æ¬¡è°ƒç”¨éœ€è¦å°†fdé›†åˆä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´
3. éœ€è¦è½®è¯¢æ‰€æœ‰fdæ‰èƒ½æ‰¾åˆ°å°±ç»ªçš„fd
4. ä¸èƒ½è·¨å¹³å°ï¼ˆWindowså®ç°ä¸åŒï¼‰

æ€§èƒ½ï¼šO(n) - éœ€è¦éå†æ‰€æœ‰fd
</code></pre>
<h3 id="22-pollå®ç°"><a class="header" href="#22-pollå®ç°">2.2 pollå®ç°</a></h3>
<h4 id="pollåŸºç¡€"><a class="header" href="#pollåŸºç¡€">pollåŸºç¡€</a></h4>
<pre><code class="language-python">import socket
import select

def poll_server():
    """ä½¿ç”¨pollå®ç°çš„æœåŠ¡å™¨"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(5)
    server_socket.setblocking(False)

    print("PollæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8888")

    # åˆ›å»ºpollå¯¹è±¡
    poller = select.poll()

    # æ³¨å†ŒæœåŠ¡å™¨socketï¼Œç›‘å¬å¯è¯»äº‹ä»¶
    poller.register(server_socket, select.POLLIN)

    # æ–‡ä»¶æè¿°ç¬¦åˆ°socketå¯¹è±¡çš„æ˜ å°„
    fd_to_socket = {server_socket.fileno(): server_socket}

    while True:
        # ç­‰å¾…äº‹ä»¶ï¼ˆè¶…æ—¶1ç§’ï¼‰
        events = poller.poll(1000)

        for fd, event in events:
            s = fd_to_socket[fd]

            if event &amp; select.POLLIN:
                # å¯è¯»äº‹ä»¶
                if s is server_socket:
                    # æ–°è¿æ¥
                    client_socket, client_address = s.accept()
                    print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")
                    client_socket.setblocking(False)
                    fd_to_socket[client_socket.fileno()] = client_socket
                    poller.register(client_socket, select.POLLIN)
                else:
                    # æ•°æ®åˆ°è¾¾
                    try:
                        data = s.recv(1024)
                        if data:
                            print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
                            s.sendall(b"Echo: " + data)
                        else:
                            # å®¢æˆ·ç«¯å…³é—­
                            print("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥")
                            poller.unregister(s)
                            del fd_to_socket[s.fileno()]
                            s.close()
                    except Exception as e:
                        print(f"é”™è¯¯: {e}")
                        poller.unregister(s)
                        del fd_to_socket[s.fileno()]
                        s.close()

            elif event &amp; select.POLLHUP:
                # è¿æ¥æŒ‚èµ·
                print("è¿æ¥æŒ‚èµ·")
                poller.unregister(s)
                del fd_to_socket[s.fileno()]
                s.close()

            elif event &amp; select.POLLERR:
                # é”™è¯¯äº‹ä»¶
                print("Socketé”™è¯¯")
                poller.unregister(s)
                del fd_to_socket[s.fileno()]
                s.close()

# ä½¿ç”¨ç¤ºä¾‹
# poll_server()
</code></pre>
<p><strong>pollçš„æ”¹è¿›</strong></p>
<pre><code>1. æ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶
2. ä½¿ç”¨é“¾è¡¨å­˜å‚¨ï¼Œä¸éœ€è¦éå†æ•´ä¸ªé›†åˆ
3. ä»éœ€è¦å°†fdé›†åˆæ‹·è´åˆ°å†…æ ¸ç©ºé—´

æ€§èƒ½ï¼šO(n) - ä»éœ€éå†æ‰€æœ‰fd
</code></pre>
<h3 id="23-epollå®ç°linux"><a class="header" href="#23-epollå®ç°linux">2.3 epollå®ç°ï¼ˆLinuxï¼‰</a></h3>
<h4 id="epollåŸºç¡€"><a class="header" href="#epollåŸºç¡€">epollåŸºç¡€</a></h4>
<pre><code class="language-python">import socket
import select

def epoll_server():
    """ä½¿ç”¨epollå®ç°çš„é«˜æ€§èƒ½æœåŠ¡å™¨ï¼ˆä»…Linuxï¼‰"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(5)
    server_socket.setblocking(False)

    print("EpollæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8888")

    # åˆ›å»ºepollå¯¹è±¡
    epoll = select.epoll()

    # æ³¨å†ŒæœåŠ¡å™¨socket
    epoll.register(server_socket.fileno(), select.EPOLLIN)

    # æ–‡ä»¶æè¿°ç¬¦åˆ°socketå¯¹è±¡çš„æ˜ å°„
    fd_to_socket = {server_socket.fileno(): server_socket}

    try:
        while True:
            # ç­‰å¾…äº‹ä»¶ï¼ˆè¶…æ—¶1ç§’ï¼‰
            events = epoll.poll(1)

            for fd, event in events:
                s = fd_to_socket[fd]

                if event &amp; select.EPOLLIN:
                    # å¯è¯»äº‹ä»¶
                    if s is server_socket:
                        # æ–°è¿æ¥
                        try:
                            while True:
                                client_socket, client_address = s.accept()
                                print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")
                                client_socket.setblocking(False)
                                fd = client_socket.fileno()
                                fd_to_socket[fd] = client_socket
                                # EPOLLET: è¾¹ç¼˜è§¦å‘æ¨¡å¼
                                epoll.register(fd, select.EPOLLIN | select.EPOLLET)
                        except BlockingIOError:
                            pass  # æ²¡æœ‰æ›´å¤šè¿æ¥
                    else:
                        # æ•°æ®åˆ°è¾¾
                        try:
                            data = s.recv(1024)
                            if data:
                                print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
                                s.sendall(b"Echo: " + data)
                            else:
                                # å®¢æˆ·ç«¯å…³é—­
                                print("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥")
                                epoll.unregister(s.fileno())
                                del fd_to_socket[s.fileno()]
                                s.close()
                        except Exception as e:
                            print(f"é”™è¯¯: {e}")
                            epoll.unregister(s.fileno())
                            del fd_to_socket[s.fileno()]
                            s.close()

                elif event &amp; select.EPOLLHUP:
                    # è¿æ¥æŒ‚èµ·
                    print("è¿æ¥æŒ‚èµ·")
                    epoll.unregister(s.fileno())
                    del fd_to_socket[s.fileno()]
                    s.close()

                elif event &amp; select.EPOLLERR:
                    # é”™è¯¯äº‹ä»¶
                    print("Socketé”™è¯¯")
                    epoll.unregister(s.fileno())
                    del fd_to_socket[s.fileno()]
                    s.close()

    finally:
        epoll.unregister(server_socket.fileno())
        epoll.close()
        server_socket.close()

# ä½¿ç”¨ç¤ºä¾‹
# epoll_server()
</code></pre>
<p><strong>epollçš„ä¼˜åŠ¿</strong></p>
<pre><code>1. æ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶
2. ä¸éœ€è¦æ¯æ¬¡éƒ½æ‹·è´fdé›†åˆï¼ˆä½¿ç”¨å†…æ ¸äº‹ä»¶è¡¨ï¼‰
3. åªè¿”å›å°±ç»ªçš„fdï¼Œæ— éœ€éå†
4. æ”¯æŒè¾¹ç¼˜è§¦å‘ï¼ˆETï¼‰å’Œæ°´å¹³è§¦å‘ï¼ˆLTï¼‰

æ€§èƒ½ï¼šO(1) - ç›´æ¥è·å–å°±ç»ªçš„fd

epollæ¨¡å¼ï¼š
- LTï¼ˆLevel Triggerï¼‰æ°´å¹³è§¦å‘ï¼š
  åªè¦æœ‰æ•°æ®å°±ä¸€ç›´é€šçŸ¥ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰

- ETï¼ˆEdge Triggerï¼‰è¾¹ç¼˜è§¦å‘ï¼š
  åªåœ¨çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥ä¸€æ¬¡ï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰
</code></pre>
<h4 id="epollå·¥ä½œæ¨¡å¼å¯¹æ¯”"><a class="header" href="#epollå·¥ä½œæ¨¡å¼å¯¹æ¯”">epollå·¥ä½œæ¨¡å¼å¯¹æ¯”</a></h4>
<pre><code class="language-python">import socket
import select

def epoll_lt_server():
    """æ°´å¹³è§¦å‘æ¨¡å¼ï¼ˆLevel Triggerï¼‰"""
    # ä»£ç åŒä¸Šï¼Œä¸ä½¿ç”¨EPOLLETæ ‡å¿—
    epoll.register(fd, select.EPOLLIN)  # LTæ¨¡å¼

def epoll_et_server():
    """è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼ˆEdge Triggerï¼‰"""
    # å¿…é¡»å¾ªç¯è¯»å–ç›´åˆ°EAGAIN
    epoll.register(fd, select.EPOLLIN | select.EPOLLET)  # ETæ¨¡å¼

    # ETæ¨¡å¼å¿…é¡»ä¸€æ¬¡æ€§è¯»å®Œæ‰€æœ‰æ•°æ®
    while True:
        try:
            data = s.recv(1024)
            if not data:
                break
            buffer += data
        except BlockingIOError:
            break  # è¯»å–å®Œæ¯•
</code></pre>
<h3 id="24-é€‰æ‹©åˆé€‚çš„ioæ¨¡å‹"><a class="header" href="#24-é€‰æ‹©åˆé€‚çš„ioæ¨¡å‹">2.4 é€‰æ‹©åˆé€‚çš„I/Oæ¨¡å‹</a></h3>
<h4 id="å¯¹æ¯”è¡¨"><a class="header" href="#å¯¹æ¯”è¡¨">å¯¹æ¯”è¡¨</a></h4>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>select</th><th>poll</th><th>epoll (Linux)</th><th>kqueue (BSD)</th></tr></thead><tbody>
<tr><td><strong>æœ€å¤§è¿æ¥æ•°</strong></td><td>1024</td><td>æ— é™åˆ¶</td><td>æ— é™åˆ¶</td><td>æ— é™åˆ¶</td></tr>
<tr><td><strong>æ€§èƒ½</strong></td><td>O(n)</td><td>O(n)</td><td>O(1)</td><td>O(1)</td></tr>
<tr><td><strong>è·¨å¹³å°</strong></td><td>æ˜¯</td><td>æ˜¯</td><td>å¦</td><td>å¦</td></tr>
<tr><td><strong>è¾¹ç¼˜è§¦å‘</strong></td><td>å¦</td><td>å¦</td><td>æ˜¯</td><td>æ˜¯</td></tr>
<tr><td><strong>å†…å­˜æ‹·è´</strong></td><td>æ¯æ¬¡</td><td>æ¯æ¬¡</td><td>ä»…æ³¨å†Œæ—¶</td><td>ä»…æ³¨å†Œæ—¶</td></tr>
</tbody></table>
</div>
<h4 id="æ¨èé€‰æ‹©"><a class="header" href="#æ¨èé€‰æ‹©">æ¨èé€‰æ‹©</a></h4>
<pre><code class="language-python"># è·¨å¹³å°æ–¹æ¡ˆï¼šä½¿ç”¨selectorsæ¨¡å—
import selectors
import socket

def universal_server():
    """ä½¿ç”¨selectorsçš„è·¨å¹³å°æœåŠ¡å™¨"""
    # selectorsè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜I/Oå¤šè·¯å¤ç”¨æœºåˆ¶
    # Linux: epoll
    # BSD: kqueue
    # Windows: select
    sel = selectors.DefaultSelector()

    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(5)
    server_socket.setblocking(False)

    def accept_connection(sock):
        """æ¥å—æ–°è¿æ¥"""
        client_socket, client_address = sock.accept()
        print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")
        client_socket.setblocking(False)
        sel.register(client_socket, selectors.EVENT_READ, read_data)

    def read_data(sock):
        """è¯»å–æ•°æ®"""
        try:
            data = sock.recv(1024)
            if data:
                print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
                sock.sendall(b"Echo: " + data)
            else:
                print("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥")
                sel.unregister(sock)
                sock.close()
        except Exception as e:
            print(f"é”™è¯¯: {e}")
            sel.unregister(sock)
            sock.close()

    # æ³¨å†ŒæœåŠ¡å™¨socket
    sel.register(server_socket, selectors.EVENT_READ, accept_connection)

    print("æœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8888")

    try:
        while True:
            # ç­‰å¾…äº‹ä»¶
            events = sel.select(timeout=1)
            for key, mask in events:
                callback = key.data
                callback(key.fileobj)
    except KeyboardInterrupt:
        print("\næœåŠ¡å™¨å…³é—­")
    finally:
        sel.close()
        server_socket.close()

# ä½¿ç”¨ç¤ºä¾‹
# universal_server()
</code></pre>
<hr />
<h2 id="ç¬¬ä¸‰ç« å¼‚æ­¥ç½‘ç»œç¼–ç¨‹"><a class="header" href="#ç¬¬ä¸‰ç« å¼‚æ­¥ç½‘ç»œç¼–ç¨‹">ç¬¬ä¸‰ç« ï¼šå¼‚æ­¥ç½‘ç»œç¼–ç¨‹</a></h2>
<h3 id="31-asyncioåŸºç¡€"><a class="header" href="#31-asyncioåŸºç¡€">3.1 asyncioåŸºç¡€</a></h3>
<h4 id="asyncioæ¦‚è¿°"><a class="header" href="#asyncioæ¦‚è¿°">asyncioæ¦‚è¿°</a></h4>
<pre><code class="language-python">import asyncio

# åç¨‹å‡½æ•°
async def hello_world():
    """ç®€å•çš„å¼‚æ­¥å‡½æ•°"""
    print("Hello")
    await asyncio.sleep(1)  # å¼‚æ­¥ç­‰å¾…1ç§’
    print("World")
    return "Done"

# è¿è¡Œåç¨‹
# Python 3.7+
asyncio.run(hello_world())

# Python 3.6
# loop = asyncio.get_event_loop()
# loop.run_until_complete(hello_world())
</code></pre>
<h4 id="asyncio-tcpæœåŠ¡å™¨"><a class="header" href="#asyncio-tcpæœåŠ¡å™¨">asyncio TCPæœåŠ¡å™¨</a></h4>
<pre><code class="language-python">import asyncio

async def handle_client(reader, writer):
    """å¤„ç†å®¢æˆ·ç«¯è¿æ¥"""
    addr = writer.get_extra_info('peername')
    print(f"æ–°è¿æ¥æ¥è‡ª: {addr}")

    try:
        while True:
            # å¼‚æ­¥è¯»å–æ•°æ®
            data = await reader.read(1024)
            if not data:
                break

            message = data.decode('utf-8')
            print(f"æ”¶åˆ°æ¥è‡ª {addr} çš„æ•°æ®: {message}")

            # å¼‚æ­¥å‘é€æ•°æ®
            response = f"Echo: {message}"
            writer.write(response.encode('utf-8'))
            await writer.drain()  # ç¡®ä¿æ•°æ®å‘é€å®Œæ¯•
    except Exception as e:
        print(f"é”™è¯¯: {e}")
    finally:
        print(f"å®¢æˆ·ç«¯ {addr} æ–­å¼€è¿æ¥")
        writer.close()
        await writer.wait_closed()

async def run_server():
    """å¯åŠ¨å¼‚æ­¥TCPæœåŠ¡å™¨"""
    server = await asyncio.start_server(
        handle_client,
        '0.0.0.0',
        8888
    )

    addr = server.sockets[0].getsockname()
    print(f"æœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ {addr}")

    async with server:
        await server.serve_forever()

# ä½¿ç”¨ç¤ºä¾‹
# asyncio.run(run_server())
</code></pre>
<h4 id="asyncio-tcpå®¢æˆ·ç«¯"><a class="header" href="#asyncio-tcpå®¢æˆ·ç«¯">asyncio TCPå®¢æˆ·ç«¯</a></h4>
<pre><code class="language-python">import asyncio

async def tcp_client():
    """å¼‚æ­¥TCPå®¢æˆ·ç«¯"""
    # è¿æ¥æœåŠ¡å™¨
    reader, writer = await asyncio.open_connection('127.0.0.1', 8888)

    print("è¿æ¥æˆåŠŸ")

    # å‘é€å¤šæ¡æ¶ˆæ¯
    messages = ['Hello', 'World', 'Python', 'asyncio']

    for message in messages:
        print(f"å‘é€: {message}")
        writer.write(message.encode('utf-8'))
        await writer.drain()

        # æ¥æ”¶å“åº”
        data = await reader.read(1024)
        print(f"æ”¶åˆ°: {data.decode('utf-8')}")

        await asyncio.sleep(1)

    # å…³é—­è¿æ¥
    print("å…³é—­è¿æ¥")
    writer.close()
    await writer.wait_closed()

# ä½¿ç”¨ç¤ºä¾‹
# asyncio.run(tcp_client())
</code></pre>
<h3 id="32-å¼‚æ­¥å¹¶å‘å¤„ç†"><a class="header" href="#32-å¼‚æ­¥å¹¶å‘å¤„ç†">3.2 å¼‚æ­¥å¹¶å‘å¤„ç†</a></h3>
<h4 id="å¹¶å‘å¤šä¸ªä»»åŠ¡"><a class="header" href="#å¹¶å‘å¤šä¸ªä»»åŠ¡">å¹¶å‘å¤šä¸ªä»»åŠ¡</a></h4>
<pre><code class="language-python">import asyncio
import time

async def fetch_data(name, delay):
    """æ¨¡æ‹Ÿå¼‚æ­¥è·å–æ•°æ®"""
    print(f"{name}: å¼€å§‹è·å–æ•°æ®")
    await asyncio.sleep(delay)
    print(f"{name}: æ•°æ®è·å–å®Œæˆ")
    return f"{name} çš„æ•°æ®"

async def main():
    """å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡"""
    start_time = time.time()

    # æ–¹æ³•1: ä½¿ç”¨gather
    results = await asyncio.gather(
        fetch_data("ä»»åŠ¡1", 2),
        fetch_data("ä»»åŠ¡2", 1),
        fetch_data("ä»»åŠ¡3", 3)
    )
    print(f"ç»“æœ: {results}")

    # æ–¹æ³•2: ä½¿ç”¨create_task
    task1 = asyncio.create_task(fetch_data("ä»»åŠ¡A", 2))
    task2 = asyncio.create_task(fetch_data("ä»»åŠ¡B", 1))
    task3 = asyncio.create_task(fetch_data("ä»»åŠ¡C", 3))

    result1 = await task1
    result2 = await task2
    result3 = await task3

    elapsed = time.time() - start_time
    print(f"æ€»è€—æ—¶: {elapsed:.2f}ç§’")

# ä½¿ç”¨ç¤ºä¾‹
# asyncio.run(main())
</code></pre>
<h4 id="å¼‚æ­¥httpè¯·æ±‚aiohttp"><a class="header" href="#å¼‚æ­¥httpè¯·æ±‚aiohttp">å¼‚æ­¥HTTPè¯·æ±‚ï¼ˆaiohttpï¼‰</a></h4>
<pre><code class="language-python">import asyncio
import aiohttp

async def fetch_url(session, url):
    """å¼‚æ­¥è·å–URLå†…å®¹"""
    async with session.get(url) as response:
        return await response.text()

async def fetch_multiple_urls():
    """å¹¶å‘è·å–å¤šä¸ªURL"""
    urls = [
        'https://httpbin.org/delay/1',
        'https://httpbin.org/delay/2',
        'https://httpbin.org/delay/1',
    ]

    async with aiohttp.ClientSession() as session:
        tasks = [fetch_url(session, url) for url in urls]
        results = await asyncio.gather(*tasks)

        for i, result in enumerate(results):
            print(f"URL {i+1} å“åº”é•¿åº¦: {len(result)}")

# ä½¿ç”¨ç¤ºä¾‹
# asyncio.run(fetch_multiple_urls())
</code></pre>
<h3 id="33-å¼‚æ­¥é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼"><a class="header" href="#33-å¼‚æ­¥é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼">3.3 å¼‚æ­¥é˜Ÿåˆ—å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</a></h3>
<pre><code class="language-python">import asyncio
import random

async def producer(queue, producer_id):
    """ç”Ÿäº§è€…"""
    for i in range(5):
        item = f"Producer-{producer_id}-Item-{i}"
        await queue.put(item)
        print(f"ç”Ÿäº§: {item}")
        await asyncio.sleep(random.uniform(0.1, 0.5))

    await queue.put(None)  # å‘é€ç»“æŸä¿¡å·

async def consumer(queue, consumer_id):
    """æ¶ˆè´¹è€…"""
    while True:
        item = await queue.get()
        if item is None:
            queue.task_done()
            await queue.put(None)  # ä¼ é€’ç»“æŸä¿¡å·
            break

        print(f"æ¶ˆè´¹è€…-{consumer_id} å¤„ç†: {item}")
        await asyncio.sleep(random.uniform(0.2, 0.8))
        queue.task_done()

async def main():
    """ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼"""
    queue = asyncio.Queue(maxsize=10)

    # åˆ›å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
    producers = [asyncio.create_task(producer(queue, i)) for i in range(2)]
    consumers = [asyncio.create_task(consumer(queue, i)) for i in range(3)]

    # ç­‰å¾…ç”Ÿäº§è€…å®Œæˆ
    await asyncio.gather(*producers)

    # ç­‰å¾…é˜Ÿåˆ—å¤„ç†å®Œæ¯•
    await queue.join()

    # ç­‰å¾…æ¶ˆè´¹è€…å®Œæˆ
    await asyncio.gather(*consumers)

# ä½¿ç”¨ç¤ºä¾‹
# asyncio.run(main())
</code></pre>
<hr />
<h2 id="ç¬¬å››ç« é«˜æ€§èƒ½æœåŠ¡å™¨æ¶æ„"><a class="header" href="#ç¬¬å››ç« é«˜æ€§èƒ½æœåŠ¡å™¨æ¶æ„">ç¬¬å››ç« ï¼šé«˜æ€§èƒ½æœåŠ¡å™¨æ¶æ„</a></h2>
<h3 id="41-å¤šè¿›ç¨‹æ¶æ„"><a class="header" href="#41-å¤šè¿›ç¨‹æ¶æ„">4.1 å¤šè¿›ç¨‹æ¶æ„</a></h3>
<h4 id="é¢„æ´¾ç”Ÿè¿›ç¨‹æ± "><a class="header" href="#é¢„æ´¾ç”Ÿè¿›ç¨‹æ± ">é¢„æ´¾ç”Ÿè¿›ç¨‹æ± </a></h4>
<pre><code class="language-python">import socket
import multiprocessing
import signal
import os

def worker_process(server_socket, worker_id):
    """å·¥ä½œè¿›ç¨‹"""
    print(f"Worker {worker_id} (PID: {os.getpid()}) å¯åŠ¨")

    # å¿½ç•¥SIGINTï¼Œç”±ä¸»è¿›ç¨‹å¤„ç†
    signal.signal(signal.SIGINT, signal.SIG_IGN)

    while True:
        try:
            client_socket, client_address = server_socket.accept()
            print(f"Worker {worker_id} å¤„ç†æ¥è‡ª {client_address} çš„è¿æ¥")

            with client_socket:
                data = client_socket.recv(1024)
                if data:
                    response = f"Worker {worker_id} Echo: {data.decode('utf-8')}"
                    client_socket.sendall(response.encode('utf-8'))
        except KeyboardInterrupt:
            break
        except Exception as e:
            print(f"Worker {worker_id} é”™è¯¯: {e}")

    print(f"Worker {worker_id} é€€å‡º")

def multi_process_server(num_workers=4):
    """å¤šè¿›ç¨‹æœåŠ¡å™¨"""
    # åˆ›å»ºç›‘å¬socket
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind(('0.0.0.0', 8888))
    server_socket.listen(128)

    print(f"å¤šè¿›ç¨‹æœåŠ¡å™¨å¯åŠ¨ï¼Œ{num_workers} ä¸ªå·¥ä½œè¿›ç¨‹")

    # åˆ›å»ºå·¥ä½œè¿›ç¨‹æ± 
    workers = []
    for i in range(num_workers):
        p = multiprocessing.Process(target=worker_process, args=(server_socket, i))
        p.start()
        workers.append(p)

    try:
        # ä¸»è¿›ç¨‹ç­‰å¾…
        for worker in workers:
            worker.join()
    except KeyboardInterrupt:
        print("\nå…³é—­æœåŠ¡å™¨...")
        for worker in workers:
            worker.terminate()
        for worker in workers:
            worker.join()

    server_socket.close()

# ä½¿ç”¨ç¤ºä¾‹
# if __name__ == '__main__':
#     multi_process_server(num_workers=4)
</code></pre>
<h3 id="42-å¤šçº¿ç¨‹æ¶æ„"><a class="header" href="#42-å¤šçº¿ç¨‹æ¶æ„">4.2 å¤šçº¿ç¨‹æ¶æ„</a></h3>
<h4 id="çº¿ç¨‹æ± æœåŠ¡å™¨"><a class="header" href="#çº¿ç¨‹æ± æœåŠ¡å™¨">çº¿ç¨‹æ± æœåŠ¡å™¨</a></h4>
<pre><code class="language-python">import socket
import threading
from concurrent.futures import ThreadPoolExecutor

class ThreadPoolServer:
    def __init__(self, host='0.0.0.0', port=8888, max_workers=10):
        self.host = host
        self.port = port
        self.max_workers = max_workers
        self.server_socket = None
        self.executor = None

    def handle_client(self, client_socket, client_address):
        """å¤„ç†å®¢æˆ·ç«¯è¿æ¥"""
        thread_id = threading.current_thread().name
        print(f"[{thread_id}] å¤„ç†æ¥è‡ª {client_address} çš„è¿æ¥")

        try:
            while True:
                data = client_socket.recv(1024)
                if not data:
                    break

                message = data.decode('utf-8')
                print(f"[{thread_id}] æ”¶åˆ°: {message}")

                response = f"[{thread_id}] Echo: {message}"
                client_socket.sendall(response.encode('utf-8'))
        except Exception as e:
            print(f"[{thread_id}] é”™è¯¯: {e}")
        finally:
            print(f"[{thread_id}] å®¢æˆ·ç«¯ {client_address} æ–­å¼€è¿æ¥")
            client_socket.close()

    def start(self):
        """å¯åŠ¨æœåŠ¡å™¨"""
        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        self.server_socket.bind((self.host, self.port))
        self.server_socket.listen(128)

        print(f"çº¿ç¨‹æ± æœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ {self.host}:{self.port}")
        print(f"çº¿ç¨‹æ± å¤§å°: {self.max_workers}")

        # åˆ›å»ºçº¿ç¨‹æ± 
        self.executor = ThreadPoolExecutor(max_workers=self.max_workers)

        try:
            while True:
                client_socket, client_address = self.server_socket.accept()
                # æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
                self.executor.submit(self.handle_client, client_socket, client_address)
        except KeyboardInterrupt:
            print("\nå…³é—­æœåŠ¡å™¨...")
        finally:
            self.executor.shutdown(wait=True)
            self.server_socket.close()

# ä½¿ç”¨ç¤ºä¾‹
# server = ThreadPoolServer(max_workers=10)
# server.start()
</code></pre>
<h3 id="43-reactoræ¨¡å¼"><a class="header" href="#43-reactoræ¨¡å¼">4.3 Reactoræ¨¡å¼</a></h3>
<h4 id="å•reactorå•çº¿ç¨‹"><a class="header" href="#å•reactorå•çº¿ç¨‹">å•Reactorå•çº¿ç¨‹</a></h4>
<pre><code class="language-python">import socket
import selectors

class Reactor:
    """Reactoræ¨¡å¼å®ç°"""
    def __init__(self, host='0.0.0.0', port=8888):
        self.host = host
        self.port = port
        self.selector = selectors.DefaultSelector()
        self.server_socket = None

    def accept_handler(self, sock):
        """æ¥å—è¿æ¥å¤„ç†å™¨"""
        client_socket, client_address = sock.accept()
        print(f"æ–°è¿æ¥æ¥è‡ª: {client_address}")
        client_socket.setblocking(False)
        self.selector.register(client_socket, selectors.EVENT_READ, self.read_handler)

    def read_handler(self, sock):
        """è¯»æ•°æ®å¤„ç†å™¨"""
        try:
            data = sock.recv(1024)
            if data:
                print(f"æ”¶åˆ°æ•°æ®: {data.decode('utf-8')}")
                # ä¿®æ”¹ä¸ºå†™äº‹ä»¶
                self.selector.modify(sock, selectors.EVENT_WRITE,
                                    lambda s: self.write_handler(s, data))
            else:
                print("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥")
                self.selector.unregister(sock)
                sock.close()
        except Exception as e:
            print(f"è¯»å–é”™è¯¯: {e}")
            self.selector.unregister(sock)
            sock.close()

    def write_handler(self, sock, data):
        """å†™æ•°æ®å¤„ç†å™¨"""
        try:
            response = b"Echo: " + data
            sock.sendall(response)
            # ä¿®æ”¹å›è¯»äº‹ä»¶
            self.selector.modify(sock, selectors.EVENT_READ, self.read_handler)
        except Exception as e:
            print(f"å‘é€é”™è¯¯: {e}")
            self.selector.unregister(sock)
            sock.close()

    def start(self):
        """å¯åŠ¨Reactor"""
        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        self.server_socket.bind((self.host, self.port))
        self.server_socket.listen(128)
        self.server_socket.setblocking(False)

        self.selector.register(self.server_socket, selectors.EVENT_READ, self.accept_handler)

        print(f"ReactoræœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ {self.host}:{self.port}")

        try:
            while True:
                events = self.selector.select(timeout=1)
                for key, mask in events:
                    callback = key.data
                    callback(key.fileobj)
        except KeyboardInterrupt:
            print("\nå…³é—­æœåŠ¡å™¨...")
        finally:
            self.selector.close()
            self.server_socket.close()

# ä½¿ç”¨ç¤ºä¾‹
# reactor = Reactor()
# reactor.start()
</code></pre>
<hr />
<h2 id="ç¬¬äº”ç« åè®®è®¾è®¡"><a class="header" href="#ç¬¬äº”ç« åè®®è®¾è®¡">ç¬¬äº”ç« ï¼šåè®®è®¾è®¡</a></h2>
<h3 id="51-è‡ªå®šä¹‰åè®®è®¾è®¡åŸåˆ™"><a class="header" href="#51-è‡ªå®šä¹‰åè®®è®¾è®¡åŸåˆ™">5.1 è‡ªå®šä¹‰åè®®è®¾è®¡åŸåˆ™</a></h3>
<h4 id="åè®®è®¾è®¡è¦ç´ "><a class="header" href="#åè®®è®¾è®¡è¦ç´ ">åè®®è®¾è®¡è¦ç´ </a></h4>
<pre><code>1. æ¶ˆæ¯æ ¼å¼
   - å®šé•¿ vs å˜é•¿
   - æ–‡æœ¬ vs äºŒè¿›åˆ¶
   - å¤§ç«¯ vs å°ç«¯

2. æ¶ˆæ¯è¾¹ç•Œ
   - å›ºå®šé•¿åº¦
   - ç‰¹æ®Šåˆ†éš”ç¬¦ï¼ˆå¦‚\r\nï¼‰
   - é•¿åº¦å‰ç¼€

3. é”™è¯¯å¤„ç†
   - æ ¡éªŒå’Œ/CRC
   - è¶…æ—¶é‡è¯•
   - é”™è¯¯ç 

4. æ‰©å±•æ€§
   - ç‰ˆæœ¬å·
   - é¢„ç•™å­—æ®µ
   - å¯é€‰å­—æ®µ
</code></pre>
<h3 id="52-ç®€å•æ–‡æœ¬åè®®å®ç°"><a class="header" href="#52-ç®€å•æ–‡æœ¬åè®®å®ç°">5.2 ç®€å•æ–‡æœ¬åè®®å®ç°</a></h3>
<pre><code class="language-python">import socket
import json

class SimpleProtocol:
    """ç®€å•çš„åŸºäºJSONçš„æ–‡æœ¬åè®®"""

    DELIMITER = b'\n'

    @staticmethod
    def encode(data):
        """ç¼–ç æ¶ˆæ¯"""
        json_str = json.dumps(data)
        return json_str.encode('utf-8') + SimpleProtocol.DELIMITER

    @staticmethod
    def decode(buffer):
        """è§£ç æ¶ˆæ¯"""
        messages = []
        while SimpleProtocol.DELIMITER in buffer:
            idx = buffer.find(SimpleProtocol.DELIMITER)
            message_data = buffer[:idx]
            buffer = buffer[idx + 1:]

            try:
                message = json.loads(message_data.decode('utf-8'))
                messages.append(message)
            except json.JSONDecodeError:
                pass  # å¿½ç•¥æ— æ•ˆæ¶ˆæ¯

        return messages, buffer

# ä½¿ç”¨ç¤ºä¾‹
protocol = SimpleProtocol()

# ç¼–ç 
message = {'type': 'chat', 'user': 'Alice', 'content': 'Hello'}
encoded = protocol.encode(message)
print(f"ç¼–ç å: {encoded}")

# è§£ç 
buffer = encoded
messages, remaining = protocol.decode(buffer)
print(f"è§£ç å: {messages}")
</code></pre>
<h3 id="53-äºŒè¿›åˆ¶åè®®å®ç°"><a class="header" href="#53-äºŒè¿›åˆ¶åè®®å®ç°">5.3 äºŒè¿›åˆ¶åè®®å®ç°</a></h3>
<pre><code class="language-python">import struct

class BinaryProtocol:
    """
    äºŒè¿›åˆ¶åè®®æ ¼å¼ï¼š
    +--------+--------+--------+--------+
    | Magic  | Length | Type   | Data   |
    | 2 bytes| 4 bytes| 2 bytes| N bytes|
    +--------+--------+--------+--------+
    """

    MAGIC = 0xABCD
    HEADER_SIZE = 8  # 2 + 4 + 2

    @staticmethod
    def encode(message_type, data):
        """ç¼–ç æ¶ˆæ¯"""
        data_bytes = data.encode('utf-8') if isinstance(data, str) else data
        length = len(data_bytes)

        # ç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯ï¼‰: !
        # H: unsigned short (2 bytes)
        # I: unsigned int (4 bytes)
        header = struct.pack('!HIH', BinaryProtocol.MAGIC, length, message_type)
        return header + data_bytes

    @staticmethod
    def decode(buffer):
        """è§£ç æ¶ˆæ¯"""
        messages = []

        while len(buffer) &gt;= BinaryProtocol.HEADER_SIZE:
            # è§£æå¤´éƒ¨
            magic, length, message_type = struct.unpack('!HIH', buffer[:BinaryProtocol.HEADER_SIZE])

            # éªŒè¯é­”æ•°
            if magic != BinaryProtocol.MAGIC:
                # åè®®é”™è¯¯ï¼Œä¸¢å¼ƒæ•°æ®
                buffer = buffer[1:]
                continue

            # æ£€æŸ¥æ˜¯å¦æ¥æ”¶å®Œæ•´æ¶ˆæ¯
            total_size = BinaryProtocol.HEADER_SIZE + length
            if len(buffer) &lt; total_size:
                break  # ç­‰å¾…æ›´å¤šæ•°æ®

            # æå–æ•°æ®
            data = buffer[BinaryProtocol.HEADER_SIZE:total_size]
            buffer = buffer[total_size:]

            messages.append({
                'type': message_type,
                'data': data
            })

        return messages, buffer

# ä½¿ç”¨ç¤ºä¾‹
protocol = BinaryProtocol()

# ç¼–ç 
encoded = protocol.encode(message_type=1, data="Hello World")
print(f"ç¼–ç å: {encoded.hex()}")

# è§£ç 
messages, remaining = protocol.decode(encoded)
print(f"è§£ç å: {messages}")
print(f"æ•°æ®: {messages[0]['data'].decode('utf-8')}")
</code></pre>
<hr />
<p><strong>è¿”å›</strong>: <a href="tcpip.html">TCP/IPåè®®å­¦ä¹ ç¬”è®°ä¸»æ–‡æ¡£</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ç¼–ç¨‹/network/tcpip-cases.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../ç¼–ç¨‹/network/tcpip-protocols.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ç¼–ç¨‹/network/tcpip-cases.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../ç¼–ç¨‹/network/tcpip-protocols.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

