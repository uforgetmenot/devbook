<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ClickHouse å­¦ä¹ ç¬”è®° - å¼€å‘</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å¼€å‘</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="æœç´¢æœ¬ä¹¦å†…å®¹..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="clickhouse-å­¦ä¹ ç¬”è®°"><a class="header" href="#clickhouse-å­¦ä¹ ç¬”è®°">ClickHouse å­¦ä¹ ç¬”è®°</a></h1>
<h2 id="-å­¦ä¹ ç›®æ ‡"><a class="header" href="#-å­¦ä¹ ç›®æ ‡">ğŸ“‹ å­¦ä¹ ç›®æ ‡</a></h2>
<ul>
<li>æ·±å…¥ç†è§£ClickHouseåˆ—å¼å­˜å‚¨åŸç†</li>
<li>æŒæ¡ClickHouseè¡¨å¼•æ“å’Œç´¢å¼•æœºåˆ¶</li>
<li>ç†Ÿç»ƒä½¿ç”¨ClickHouse SQLæŸ¥è¯¢</li>
<li>ç†è§£ClickHouseåˆ†å¸ƒå¼æ¶æ„</li>
<li>æŒæ¡ClickHouseæ€§èƒ½ä¼˜åŒ–æŠ€å·§</li>
<li>å…·å¤‡ClickHouseè¿ç»´å’Œç›‘æ§èƒ½åŠ›</li>
</ul>
<h2 id="1-clickhouse-åŸºç¡€æ¦‚å¿µ"><a class="header" href="#1-clickhouse-åŸºç¡€æ¦‚å¿µ">1. ClickHouse åŸºç¡€æ¦‚å¿µ</a></h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-clickhouse"><a class="header" href="#11-ä»€ä¹ˆæ˜¯-clickhouse">1.1 ä»€ä¹ˆæ˜¯ ClickHouse</a></h3>
<p>ClickHouseæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ—å¼æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ï¼Œä¸“ä¸ºåœ¨çº¿åˆ†æå¤„ç†ï¼ˆOLAPï¼‰è€Œè®¾è®¡ã€‚</p>
<p><strong>æ ¸å¿ƒç‰¹ç‚¹:</strong></p>
<ul>
<li>çœŸæ­£çš„åˆ—å¼å­˜å‚¨</li>
<li>å‘é‡åŒ–æŸ¥è¯¢æ‰§è¡Œ</li>
<li>æ•°æ®å‹ç¼©æ¯”é«˜ï¼ˆ10-100å€ï¼‰</li>
<li>æ”¯æŒSQLæ ‡å‡†</li>
<li>åˆ†å¸ƒå¼æŸ¥è¯¢</li>
<li>å®æ—¶æ•°æ®æ›´æ–°</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯:</strong></p>
<ul>
<li>å®æ—¶æ•°æ®åˆ†æ</li>
<li>ç”¨æˆ·è¡Œä¸ºåˆ†æ</li>
<li>æ—¥å¿—åˆ†æ</li>
<li>å¹¿å‘Šç»Ÿè®¡</li>
<li>ç›‘æ§ç³»ç»Ÿ</li>
<li>å•†ä¸šæ™ºèƒ½ï¼ˆBIï¼‰</li>
</ul>
<h3 id="12-clickhouse-vs-ä¼ ç»Ÿæ•°æ®åº“"><a class="header" href="#12-clickhouse-vs-ä¼ ç»Ÿæ•°æ®åº“">1.2 ClickHouse vs ä¼ ç»Ÿæ•°æ®åº“</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>ClickHouse</th><th>MySQL</th><th>PostgreSQL</th></tr></thead><tbody>
<tr><td>å­˜å‚¨æ¨¡å‹</td><td>åˆ—å¼å­˜å‚¨</td><td>è¡Œå¼å­˜å‚¨</td><td>è¡Œå¼å­˜å‚¨</td></tr>
<tr><td>æŸ¥è¯¢æ€§èƒ½</td><td>æå¿«(OLAP)</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td></tr>
<tr><td>å†™å…¥æ€§èƒ½</td><td>æ‰¹é‡å¿«</td><td>å•æ¡å¿«</td><td>å•æ¡å¿«</td></tr>
<tr><td>å‹ç¼©æ¯”</td><td>10-100x</td><td>2-5x</td><td>2-5x</td></tr>
<tr><td>é€‚ç”¨åœºæ™¯</td><td>OLAP</td><td>OLTP</td><td>OLTP</td></tr>
<tr><td>äº‹åŠ¡æ”¯æŒ</td><td>å¼±</td><td>å¼º</td><td>å¼º</td></tr>
</tbody></table>
</div>
<h3 id="13-åˆ—å¼å­˜å‚¨ä¼˜åŠ¿"><a class="header" href="#13-åˆ—å¼å­˜å‚¨ä¼˜åŠ¿">1.3 åˆ—å¼å­˜å‚¨ä¼˜åŠ¿</a></h3>
<p><strong>è¡Œå¼å­˜å‚¨ vs åˆ—å¼å­˜å‚¨:</strong></p>
<pre><code>è¡Œå¼å­˜å‚¨ (MySQL):
Row1: [id=1, name="Alice", age=25, city="Beijing"]
Row2: [id=2, name="Bob",   age=30, city="Shanghai"]
Row3: [id=3, name="Carol", age=28, city="Beijing"]

åˆ—å¼å­˜å‚¨ (ClickHouse):
Column[id]:   [1, 2, 3]
Column[name]: ["Alice", "Bob", "Carol"]
Column[age]:  [25, 30, 28]
Column[city]: ["Beijing", "Shanghai", "Beijing"]
</code></pre>
<p><strong>ä¼˜åŠ¿:</strong></p>
<ul>
<li>åªè¯»å–éœ€è¦çš„åˆ—</li>
<li>æ›´é«˜çš„å‹ç¼©æ¯”</li>
<li>å‘é‡åŒ–æ‰§è¡Œ</li>
<li>CPUç¼“å­˜å‹å¥½</li>
</ul>
<h2 id="2-clickhouse-æ¶æ„"><a class="header" href="#2-clickhouse-æ¶æ„">2. ClickHouse æ¶æ„</a></h2>
<h3 id="21-å•èŠ‚ç‚¹æ¶æ„"><a class="header" href="#21-å•èŠ‚ç‚¹æ¶æ„">2.1 å•èŠ‚ç‚¹æ¶æ„</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ClickHouse Server          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Query Processor                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Parser   â”‚  â”‚ Analyzer â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Optimizer â”‚  â”‚ Executor â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Storage Engine                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MergeTree Family         â”‚  â”‚
â”‚  â”‚ - MergeTree              â”‚  â”‚
â”‚  â”‚ - ReplacingMergeTree     â”‚  â”‚
â”‚  â”‚ - SummingMergeTree       â”‚  â”‚
â”‚  â”‚ - AggregatingMergeTree   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="22-åˆ†å¸ƒå¼æ¶æ„"><a class="header" href="#22-åˆ†å¸ƒå¼æ¶æ„">2.2 åˆ†å¸ƒå¼æ¶æ„</a></h3>
<pre><code>          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Client   â”‚
          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”    â”Œâ”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â–¼â”€â”€â”€â”
â”‚Shard1â”‚    â”‚Shard2â”‚    â”‚Shard3â”‚
â”‚Rep1  â”‚    â”‚Rep1  â”‚    â”‚Rep1  â”‚
â”‚Rep2  â”‚    â”‚Rep2  â”‚    â”‚Rep2  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>æ ¸å¿ƒæ¦‚å¿µ:</strong></p>
<ul>
<li><strong>Shard</strong>: æ•°æ®åˆ†ç‰‡</li>
<li><strong>Replica</strong>: æ•°æ®å‰¯æœ¬</li>
<li><strong>Distributed Table</strong>: åˆ†å¸ƒå¼è¡¨</li>
<li><strong>Local Table</strong>: æœ¬åœ°è¡¨</li>
<li><strong>ZooKeeper</strong>: åè°ƒæœåŠ¡</li>
</ul>
<h2 id="3-è¡¨å¼•æ“"><a class="header" href="#3-è¡¨å¼•æ“">3. è¡¨å¼•æ“</a></h2>
<h3 id="31-mergetree-å¼•æ“æ—"><a class="header" href="#31-mergetree-å¼•æ“æ—">3.1 MergeTree å¼•æ“æ—</a></h3>
<p><strong>MergeTree (æœ€å¸¸ç”¨):</strong></p>
<pre><code class="language-sql">CREATE TABLE events (
    date Date,
    user_id UInt32,
    event_type String,
    value Float64
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (user_id, date)
SETTINGS index_granularity = 8192;
</code></pre>
<p><strong>å…³é”®å‚æ•°:</strong></p>
<ul>
<li><code>PARTITION BY</code>: åˆ†åŒºé”®ï¼ˆæŒ‰æœˆã€æŒ‰å¤©ç­‰ï¼‰</li>
<li><code>ORDER BY</code>: æ’åºé”®ï¼ˆä¸»é”®ï¼‰</li>
<li><code>index_granularity</code>: ç´¢å¼•ç²’åº¦ï¼ˆé»˜è®¤8192è¡Œï¼‰</li>
</ul>
<p><strong>ReplacingMergeTree (æ•°æ®å»é‡):</strong></p>
<pre><code class="language-sql">CREATE TABLE user_profile (
    user_id UInt32,
    name String,
    age UInt8,
    update_time DateTime
) ENGINE = ReplacingMergeTree(update_time)
PARTITION BY toYYYYMM(update_time)
ORDER BY user_id;
</code></pre>
<p><strong>SummingMergeTree (è‡ªåŠ¨æ±‚å’Œ):</strong></p>
<pre><code class="language-sql">CREATE TABLE analytics (
    date Date,
    user_id UInt32,
    clicks UInt32,
    cost Float64
) ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (user_id, date);
</code></pre>
<p><strong>AggregatingMergeTree (é¢„èšåˆ):</strong></p>
<pre><code class="language-sql">CREATE TABLE analytics_agg (
    date Date,
    user_id UInt32,
    clicks AggregateFunction(sum, UInt32),
    avg_value AggregateFunction(avg, Float64)
) ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (user_id, date);
</code></pre>
<h3 id="32-å…¶ä»–å¸¸ç”¨å¼•æ“"><a class="header" href="#32-å…¶ä»–å¸¸ç”¨å¼•æ“">3.2 å…¶ä»–å¸¸ç”¨å¼•æ“</a></h3>
<p><strong>Memory (å†…å­˜è¡¨):</strong></p>
<pre><code class="language-sql">CREATE TABLE temp_data (
    id UInt32,
    value String
) ENGINE = Memory;
</code></pre>
<p><strong>Distributed (åˆ†å¸ƒå¼è¡¨):</strong></p>
<pre><code class="language-sql">CREATE TABLE events_dist AS events
ENGINE = Distributed(
    cluster_name,      -- é›†ç¾¤åç§°
    database_name,     -- æ•°æ®åº“å
    events,            -- æœ¬åœ°è¡¨å
    rand()             -- åˆ†ç‰‡é”®
);
</code></pre>
<p><strong>Dictionary (å­—å…¸):</strong></p>
<pre><code class="language-sql">CREATE DICTIONARY user_dict (
    user_id UInt32,
    name String,
    age UInt8
) PRIMARY KEY user_id
SOURCE(CLICKHOUSE(
    HOST 'localhost'
    PORT 9000
    USER 'default'
    PASSWORD ''
    DB 'default'
    TABLE 'users'
))
LAYOUT(FLAT())
LIFETIME(300);
</code></pre>
<h2 id="4-æ•°æ®ç±»å‹"><a class="header" href="#4-æ•°æ®ç±»å‹">4. æ•°æ®ç±»å‹</a></h2>
<h3 id="41-åŸºç¡€æ•°æ®ç±»å‹"><a class="header" href="#41-åŸºç¡€æ•°æ®ç±»å‹">4.1 åŸºç¡€æ•°æ®ç±»å‹</a></h3>
<pre><code class="language-sql">-- æ•´æ•°ç±»å‹
Int8, Int16, Int32, Int64
UInt8, UInt16, UInt32, UInt64

-- æµ®ç‚¹ç±»å‹
Float32, Float64
Decimal(P, S)  -- Decimal(18, 2)

-- å­—ç¬¦ä¸²ç±»å‹
String         -- ä»»æ„é•¿åº¦
FixedString(N) -- å›ºå®šé•¿åº¦

-- æ—¥æœŸæ—¶é—´ç±»å‹
Date           -- æ—¥æœŸ (YYYY-MM-DD)
DateTime       -- æ—¥æœŸæ—¶é—´
DateTime64(3)  -- æ¯«ç§’ç²¾åº¦

-- å¸ƒå°”ç±»å‹
UInt8          -- 0æˆ–1è¡¨ç¤ºå¸ƒå°”å€¼
</code></pre>
<h3 id="42-å¤åˆæ•°æ®ç±»å‹"><a class="header" href="#42-å¤åˆæ•°æ®ç±»å‹">4.2 å¤åˆæ•°æ®ç±»å‹</a></h3>
<pre><code class="language-sql">-- æ•°ç»„
Array(T)
-- ç¤ºä¾‹
column_name Array(String)
column_name Array(UInt32)

-- å…ƒç»„
Tuple(T1, T2, ...)
-- ç¤ºä¾‹
column_name Tuple(String, UInt32)

-- åµŒå¥—
Nested(
    name1 Type1,
    name2 Type2
)
-- ç¤ºä¾‹
user_events Nested(
    event_type String,
    timestamp DateTime
)
</code></pre>
<h3 id="43-ç‰¹æ®Šæ•°æ®ç±»å‹"><a class="header" href="#43-ç‰¹æ®Šæ•°æ®ç±»å‹">4.3 ç‰¹æ®Šæ•°æ®ç±»å‹</a></h3>
<pre><code class="language-sql">-- Nullable (å…è®¸NULL)
Nullable(String)
Nullable(UInt32)

-- Enum (æšä¸¾)
Enum8('active' = 1, 'inactive' = 2)
Enum16('status1' = 1, 'status2' = 2)

-- LowCardinality (ä½åŸºæ•°ä¼˜åŒ–)
LowCardinality(String)  -- é€‚åˆé‡å¤å€¼å¤šçš„åˆ—

-- UUID
UUID

-- IPv4/IPv6
IPv4
IPv6
</code></pre>
<h2 id="5-sql-æŸ¥è¯¢"><a class="header" href="#5-sql-æŸ¥è¯¢">5. SQL æŸ¥è¯¢</a></h2>
<h3 id="51-åŸºç¡€æŸ¥è¯¢"><a class="header" href="#51-åŸºç¡€æŸ¥è¯¢">5.1 åŸºç¡€æŸ¥è¯¢</a></h3>
<pre><code class="language-sql">-- åŸºæœ¬æŸ¥è¯¢
SELECT user_id, count() as cnt
FROM events
WHERE date &gt;= '2024-01-01'
GROUP BY user_id
ORDER BY cnt DESC
LIMIT 10;

-- å¤šè¡¨JOIN
SELECT
    e.user_id,
    u.name,
    count() as event_count
FROM events e
INNER JOIN users u ON e.user_id = u.user_id
WHERE e.date &gt;= '2024-01-01'
GROUP BY e.user_id, u.name;

-- å­æŸ¥è¯¢
SELECT user_id, total
FROM (
    SELECT user_id, sum(value) as total
    FROM events
    GROUP BY user_id
)
WHERE total &gt; 1000;
</code></pre>
<h3 id="52-èšåˆå‡½æ•°"><a class="header" href="#52-èšåˆå‡½æ•°">5.2 èšåˆå‡½æ•°</a></h3>
<pre><code class="language-sql">-- åŸºç¡€èšåˆ
SELECT
    count() as total,           -- è®¡æ•°
    sum(value) as total_value,  -- æ±‚å’Œ
    avg(value) as avg_value,    -- å¹³å‡å€¼
    min(value) as min_value,    -- æœ€å°å€¼
    max(value) as max_value     -- æœ€å¤§å€¼
FROM events;

-- å»é‡è®¡æ•°
SELECT
    uniq(user_id) as unique_users,           -- ç²¾ç¡®å»é‡
    uniqExact(user_id) as exact_unique,      -- ç²¾ç¡®å»é‡
    uniqCombined(user_id) as combined_unique -- HyperLogLogè¿‘ä¼¼
FROM events;

-- åˆ†ä½æ•°
SELECT
    quantile(0.5)(value) as median,      -- ä¸­ä½æ•°
    quantile(0.95)(value) as p95,        -- 95åˆ†ä½æ•°
    quantiles(0.5, 0.95, 0.99)(value)    -- å¤šä¸ªåˆ†ä½æ•°
FROM events;

-- TopK
SELECT
    topK(10)(user_id) as top_users,      -- Top 10ç”¨æˆ·
    topKWeighted(10)(user_id, value)     -- å¸¦æƒé‡çš„Top 10
FROM events;
</code></pre>
<h3 id="53-çª—å£å‡½æ•°"><a class="header" href="#53-çª—å£å‡½æ•°">5.3 çª—å£å‡½æ•°</a></h3>
<pre><code class="language-sql">-- ROW_NUMBER
SELECT
    user_id,
    date,
    value,
    ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY date) as rn
FROM events;

-- RANK/DENSE_RANK
SELECT
    user_id,
    value,
    RANK() OVER (ORDER BY value DESC) as rank,
    DENSE_RANK() OVER (ORDER BY value DESC) as dense_rank
FROM events;

-- LAG/LEAD
SELECT
    date,
    value,
    LAG(value, 1) OVER (ORDER BY date) as prev_value,
    LEAD(value, 1) OVER (ORDER BY date) as next_value
FROM events;

-- ç§»åŠ¨å¹³å‡
SELECT
    date,
    value,
    AVG(value) OVER (
        ORDER BY date
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) as moving_avg_3
FROM events;
</code></pre>
<h3 id="54-æ•°ç»„å‡½æ•°"><a class="header" href="#54-æ•°ç»„å‡½æ•°">5.4 æ•°ç»„å‡½æ•°</a></h3>
<pre><code class="language-sql">-- æ•°ç»„æ“ä½œ
SELECT
    arrayMap(x -&gt; x * 2, [1,2,3]) as doubled,          -- [2,4,6]
    arrayFilter(x -&gt; x &gt; 2, [1,2,3,4]) as filtered,    -- [3,4]
    arrayReduce('sum', [1,2,3,4]) as sum_array,        -- 10
    arrayJoin([1,2,3]) as element;                     -- å±•å¼€æ•°ç»„

-- æ•°ç»„èšåˆ
SELECT
    groupArray(user_id) as user_list,      -- æ”¶é›†ä¸ºæ•°ç»„
    groupUniqArray(user_id) as unique_users -- å»é‡æ”¶é›†
FROM events
GROUP BY date;
</code></pre>
<h2 id="6-æ•°æ®æ“ä½œ"><a class="header" href="#6-æ•°æ®æ“ä½œ">6. æ•°æ®æ“ä½œ</a></h2>
<h3 id="61-æ’å…¥æ•°æ®"><a class="header" href="#61-æ’å…¥æ•°æ®">6.1 æ’å…¥æ•°æ®</a></h3>
<pre><code class="language-sql">-- å•è¡Œæ’å…¥
INSERT INTO events VALUES
    ('2024-01-01', 100, 'click', 1.5);

-- æ‰¹é‡æ’å…¥
INSERT INTO events VALUES
    ('2024-01-01', 100, 'click', 1.5),
    ('2024-01-01', 101, 'view', 2.0),
    ('2024-01-01', 102, 'purchase', 50.0);

-- ä»æŸ¥è¯¢æ’å…¥
INSERT INTO events
SELECT * FROM temp_events WHERE date &gt;= '2024-01-01';

-- ä»æ–‡ä»¶å¯¼å…¥
cat data.csv | clickhouse-client --query="INSERT INTO events FORMAT CSV"
</code></pre>
<h3 id="62-æ›´æ–°å’Œåˆ é™¤"><a class="header" href="#62-æ›´æ–°å’Œåˆ é™¤">6.2 æ›´æ–°å’Œåˆ é™¤</a></h3>
<p><strong>è½»é‡çº§åˆ é™¤ (Lightweight Delete):</strong></p>
<pre><code class="language-sql">-- ClickHouse 22.8+æ”¯æŒ
DELETE FROM events WHERE date &lt; '2023-01-01';
</code></pre>
<p><strong>ä¼ ç»Ÿæ–¹å¼ (ALTER DELETE):</strong></p>
<pre><code class="language-sql">-- å¼‚æ­¥åˆ é™¤ï¼Œç”Ÿæˆæ–°çš„æ•°æ®éƒ¨åˆ†
ALTER TABLE events DELETE WHERE date &lt; '2023-01-01';
</code></pre>
<p><strong>è½»é‡çº§æ›´æ–°:</strong></p>
<pre><code class="language-sql">-- ClickHouse 22.8+æ”¯æŒ
UPDATE events SET value = value * 2 WHERE user_id = 100;
</code></pre>
<p><strong>ä¼ ç»Ÿæ–¹å¼ (ALTER UPDATE):</strong></p>
<pre><code class="language-sql">ALTER TABLE events UPDATE value = value * 2 WHERE user_id = 100;
</code></pre>
<h3 id="63-æ•°æ®å¯¼å…¥å¯¼å‡º"><a class="header" href="#63-æ•°æ®å¯¼å…¥å¯¼å‡º">6.3 æ•°æ®å¯¼å…¥å¯¼å‡º</a></h3>
<p><strong>å¯¼å‡ºæ•°æ®:</strong></p>
<pre><code class="language-bash"># å¯¼å‡ºä¸ºCSV
clickhouse-client --query="SELECT * FROM events FORMAT CSV" &gt; events.csv

# å¯¼å‡ºä¸ºJSON
clickhouse-client --query="SELECT * FROM events FORMAT JSONEachRow" &gt; events.json

# å¯¼å‡ºä¸ºParquet
clickhouse-client --query="SELECT * FROM events FORMAT Parquet" &gt; events.parquet
</code></pre>
<p><strong>å¯¼å…¥æ•°æ®:</strong></p>
<pre><code class="language-bash"># ä»CSVå¯¼å…¥
cat events.csv | clickhouse-client --query="INSERT INTO events FORMAT CSV"

# ä»JSONå¯¼å…¥
cat events.json | clickhouse-client --query="INSERT INTO events FORMAT JSONEachRow"
</code></pre>
<h2 id="7-åˆ†å¸ƒå¼éƒ¨ç½²"><a class="header" href="#7-åˆ†å¸ƒå¼éƒ¨ç½²">7. åˆ†å¸ƒå¼éƒ¨ç½²</a></h2>
<h3 id="71-é›†ç¾¤é…ç½®"><a class="header" href="#71-é›†ç¾¤é…ç½®">7.1 é›†ç¾¤é…ç½®</a></h3>
<p><strong>config.xmlé…ç½®:</strong></p>
<pre><code class="language-xml">&lt;clickhouse&gt;
    &lt;remote_servers&gt;
        &lt;my_cluster&gt;
            &lt;shard&gt;
                &lt;replica&gt;
                    &lt;host&gt;node1&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;node2&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
            &lt;shard&gt;
                &lt;replica&gt;
                    &lt;host&gt;node3&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
                &lt;replica&gt;
                    &lt;host&gt;node4&lt;/host&gt;
                    &lt;port&gt;9000&lt;/port&gt;
                &lt;/replica&gt;
            &lt;/shard&gt;
        &lt;/my_cluster&gt;
    &lt;/remote_servers&gt;

    &lt;zookeeper&gt;
        &lt;node&gt;
            &lt;host&gt;zk1&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zk2&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
        &lt;node&gt;
            &lt;host&gt;zk3&lt;/host&gt;
            &lt;port&gt;2181&lt;/port&gt;
        &lt;/node&gt;
    &lt;/zookeeper&gt;

    &lt;macros&gt;
        &lt;shard&gt;01&lt;/shard&gt;
        &lt;replica&gt;replica1&lt;/replica&gt;
    &lt;/macros&gt;
&lt;/clickhouse&gt;
</code></pre>
<h3 id="72-åˆ›å»ºåˆ†å¸ƒå¼è¡¨"><a class="header" href="#72-åˆ›å»ºåˆ†å¸ƒå¼è¡¨">7.2 åˆ›å»ºåˆ†å¸ƒå¼è¡¨</a></h3>
<pre><code class="language-sql">-- 1. åˆ›å»ºæœ¬åœ°è¡¨
CREATE TABLE events_local ON CLUSTER my_cluster (
    date Date,
    user_id UInt32,
    event_type String,
    value Float64
) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/events', '{replica}')
PARTITION BY toYYYYMM(date)
ORDER BY (user_id, date);

-- 2. åˆ›å»ºåˆ†å¸ƒå¼è¡¨
CREATE TABLE events_dist ON CLUSTER my_cluster AS events_local
ENGINE = Distributed(my_cluster, default, events_local, rand());

-- 3. å†™å…¥åˆ†å¸ƒå¼è¡¨
INSERT INTO events_dist VALUES ('2024-01-01', 100, 'click', 1.5);

-- 4. æŸ¥è¯¢åˆ†å¸ƒå¼è¡¨
SELECT count() FROM events_dist;
</code></pre>
<h3 id="73-å‰¯æœ¬åŒæ­¥"><a class="header" href="#73-å‰¯æœ¬åŒæ­¥">7.3 å‰¯æœ¬åŒæ­¥</a></h3>
<p><strong>æ£€æŸ¥å‰¯æœ¬çŠ¶æ€:</strong></p>
<pre><code class="language-sql">SELECT
    database,
    table,
    is_leader,
    total_replicas,
    active_replicas
FROM system.replicas;
</code></pre>
<p><strong>åŒæ­¥å‰¯æœ¬:</strong></p>
<pre><code class="language-sql">-- åŒæ­¥æŒ‡å®šè¡¨
SYSTEM SYNC REPLICA events_local;

-- åŒæ­¥æ‰€æœ‰å‰¯æœ¬
SYSTEM SYNC REPLICA;
</code></pre>
<h2 id="8-æ€§èƒ½ä¼˜åŒ–"><a class="header" href="#8-æ€§èƒ½ä¼˜åŒ–">8. æ€§èƒ½ä¼˜åŒ–</a></h2>
<h3 id="81-è¡¨è®¾è®¡ä¼˜åŒ–"><a class="header" href="#81-è¡¨è®¾è®¡ä¼˜åŒ–">8.1 è¡¨è®¾è®¡ä¼˜åŒ–</a></h3>
<p><strong>é€‰æ‹©åˆé€‚çš„æ’åºé”®:</strong></p>
<pre><code class="language-sql">-- å¥½çš„æ’åºé”®ï¼šé«˜åŸºæ•°åœ¨å‰
ORDER BY (user_id, date, event_type)

-- ä¸å¥½çš„æ’åºé”®ï¼šä½åŸºæ•°åœ¨å‰
ORDER BY (event_type, date, user_id)
</code></pre>
<p><strong>ä½¿ç”¨åˆ†åŒº:</strong></p>
<pre><code class="language-sql">-- æŒ‰æœˆåˆ†åŒº
PARTITION BY toYYYYMM(date)

-- æŒ‰å¤©åˆ†åŒºï¼ˆæ•°æ®é‡å¤§æ—¶ï¼‰
PARTITION BY toYYYYMMDD(date)

-- å¤šçº§åˆ†åŒº
PARTITION BY (toYear(date), toMonth(date))
</code></pre>
<p><strong>ä½¿ç”¨ä½åŸºæ•°ç±»å‹:</strong></p>
<pre><code class="language-sql">CREATE TABLE events (
    date Date,
    user_id UInt32,
    country LowCardinality(String),  -- å›½å®¶ä»£ç ï¼ˆé‡å¤å¤šï¼‰
    city LowCardinality(String),     -- åŸå¸‚ï¼ˆé‡å¤å¤šï¼‰
    event_type Enum8('click'=1, 'view'=2, 'purchase'=3)
) ENGINE = MergeTree()
ORDER BY (user_id, date);
</code></pre>
<h3 id="82-æŸ¥è¯¢ä¼˜åŒ–"><a class="header" href="#82-æŸ¥è¯¢ä¼˜åŒ–">8.2 æŸ¥è¯¢ä¼˜åŒ–</a></h3>
<p><strong>ä½¿ç”¨PREWHERE:</strong></p>
<pre><code class="language-sql">-- PREWHEREåœ¨WHEREä¹‹å‰è¿‡æ»¤ï¼Œå‡å°‘æ•°æ®è¯»å–
SELECT user_id, sum(value)
FROM events
PREWHERE date &gt;= '2024-01-01'  -- å…ˆè¿‡æ»¤æ—¥æœŸ
WHERE event_type = 'purchase'   -- å†è¿‡æ»¤ç±»å‹
GROUP BY user_id;
</code></pre>
<p>*<em>é¿å…SELECT <em>:</em></em></p>
<pre><code class="language-sql">-- ä¸å¥½
SELECT * FROM events WHERE date = '2024-01-01';

-- å¥½
SELECT user_id, event_type FROM events WHERE date = '2024-01-01';
</code></pre>
<p><strong>ä½¿ç”¨ç‰©åŒ–è§†å›¾:</strong></p>
<pre><code class="language-sql">-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW events_daily
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (date, user_id)
AS SELECT
    date,
    user_id,
    count() as event_count,
    sum(value) as total_value
FROM events
GROUP BY date, user_id;

-- æŸ¥è¯¢ç‰©åŒ–è§†å›¾ï¼ˆé€Ÿåº¦å¿«ï¼‰
SELECT * FROM events_daily WHERE date = '2024-01-01';
</code></pre>
<h3 id="83-é…ç½®ä¼˜åŒ–"><a class="header" href="#83-é…ç½®ä¼˜åŒ–">8.3 é…ç½®ä¼˜åŒ–</a></h3>
<p><strong>config.xmlä¼˜åŒ–:</strong></p>
<pre><code class="language-xml">&lt;clickhouse&gt;
    &lt;!-- æœ€å¤§å†…å­˜ä½¿ç”¨ --&gt;
    &lt;max_memory_usage&gt;10000000000&lt;/max_memory_usage&gt;

    &lt;!-- æœ€å¤§çº¿ç¨‹æ•° --&gt;
    &lt;max_threads&gt;8&lt;/max_threads&gt;

    &lt;!-- åå°ä»»åŠ¡çº¿ç¨‹ --&gt;
    &lt;background_pool_size&gt;16&lt;/background_pool_size&gt;
    &lt;background_schedule_pool_size&gt;16&lt;/background_schedule_pool_size&gt;

    &lt;!-- åˆå¹¶è®¾ç½® --&gt;
    &lt;merge_tree&gt;
        &lt;max_bytes_to_merge_at_max_space_in_pool&gt;161061273600&lt;/max_bytes_to_merge_at_max_space_in_pool&gt;
        &lt;parts_to_throw_insert&gt;300&lt;/parts_to_throw_insert&gt;
    &lt;/merge_tree&gt;

    &lt;!-- æŸ¥è¯¢ç¼“å­˜ --&gt;
    &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt;
    &lt;uncompressed_cache_size&gt;8589934592&lt;/uncompressed_cache_size&gt;
&lt;/clickhouse&gt;
</code></pre>
<h2 id="9-ç›‘æ§ä¸è¿ç»´"><a class="header" href="#9-ç›‘æ§ä¸è¿ç»´">9. ç›‘æ§ä¸è¿ç»´</a></h2>
<h3 id="91-ç³»ç»Ÿè¡¨"><a class="header" href="#91-ç³»ç»Ÿè¡¨">9.1 ç³»ç»Ÿè¡¨</a></h3>
<p><strong>æŸ¥è¯¢ç»Ÿè®¡:</strong></p>
<pre><code class="language-sql">-- æŸ¥çœ‹å½“å‰æŸ¥è¯¢
SELECT query_id, user, query, elapsed
FROM system.processes;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    query_duration_ms,
    read_rows,
    result_rows
FROM system.query_log
WHERE query_duration_ms &gt; 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    database,
    table,
    formatReadableSize(sum(bytes)) as size,
    sum(rows) as rows
FROM system.parts
WHERE active
GROUP BY database, table
ORDER BY sum(bytes) DESC;
</code></pre>
<p><strong>é›†ç¾¤çŠ¶æ€:</strong></p>
<pre><code class="language-sql">-- æŸ¥çœ‹å‰¯æœ¬çŠ¶æ€
SELECT * FROM system.replicas;

-- æŸ¥çœ‹åˆ†å¸ƒå¼è¡¨ä¿¡æ¯
SELECT * FROM system.clusters;

-- æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
SELECT
    name,
    path,
    formatReadableSize(free_space) as free,
    formatReadableSize(total_space) as total
FROM system.disks;
</code></pre>
<h3 id="92-æ€§èƒ½æŒ‡æ ‡"><a class="header" href="#92-æ€§èƒ½æŒ‡æ ‡">9.2 æ€§èƒ½æŒ‡æ ‡</a></h3>
<pre><code class="language-sql">-- æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
SELECT
    event_time,
    ProfileEvent_Query,
    ProfileEvent_SelectQuery,
    ProfileEvent_InsertQuery
FROM system.metric_log
WHERE event_time &gt; now() - INTERVAL 1 HOUR
ORDER BY event_time;

-- èµ„æºä½¿ç”¨
SELECT
    metric,
    value
FROM system.metrics
WHERE metric IN (
    'MemoryTracking',
    'BackgroundPoolTask',
    'TCPConnection'
);
</code></pre>
<h3 id="93-æ—¥å¿—åˆ†æ"><a class="header" href="#93-æ—¥å¿—åˆ†æ">9.3 æ—¥å¿—åˆ†æ</a></h3>
<pre><code class="language-bash"># æŸ¥çœ‹ClickHouseæ—¥å¿—
tail -f /var/log/clickhouse-server/clickhouse-server.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/clickhouse-server/clickhouse-server.err.log

# æŸ¥è¯¢æ—¥å¿—
tail -f /var/log/clickhouse-server/query_log.log
</code></pre>
<h2 id="10-å®æˆ˜æ¡ˆä¾‹"><a class="header" href="#10-å®æˆ˜æ¡ˆä¾‹">10. å®æˆ˜æ¡ˆä¾‹</a></h2>
<h3 id="101-ç”¨æˆ·è¡Œä¸ºåˆ†æ"><a class="header" href="#101-ç”¨æˆ·è¡Œä¸ºåˆ†æ">10.1 ç”¨æˆ·è¡Œä¸ºåˆ†æ</a></h3>
<pre><code class="language-sql">-- åˆ›å»ºç”¨æˆ·è¡Œä¸ºè¡¨
CREATE TABLE user_behavior (
    user_id UInt32,
    item_id UInt32,
    category_id UInt16,
    behavior LowCardinality(String),
    timestamp DateTime
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (user_id, timestamp);

-- ç»Ÿè®¡æ—¥æ´»ç”¨æˆ·
SELECT
    toDate(timestamp) as date,
    uniq(user_id) as dau
FROM user_behavior
WHERE timestamp &gt;= today() - 7
GROUP BY date
ORDER BY date;

-- ç”¨æˆ·ç•™å­˜åˆ†æ
SELECT
    registration_date,
    day_diff,
    count(DISTINCT user_id) as retained_users,
    retained_users / first_value(retained_users) OVER (
        PARTITION BY registration_date ORDER BY day_diff
    ) as retention_rate
FROM (
    SELECT
        toDate(min(timestamp)) OVER (PARTITION BY user_id) as registration_date,
        user_id,
        dateDiff('day', registration_date, toDate(timestamp)) as day_diff
    FROM user_behavior
)
GROUP BY registration_date, day_diff
ORDER BY registration_date, day_diff;
</code></pre>
<h3 id="102-å®æ—¶çœ‹æ¿"><a class="header" href="#102-å®æ—¶çœ‹æ¿">10.2 å®æ—¶çœ‹æ¿</a></h3>
<pre><code class="language-sql">-- åˆ›å»ºå®æ—¶ç»Ÿè®¡ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW realtime_stats
ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMMDD(timestamp)
ORDER BY (minute, category_id)
AS SELECT
    toStartOfMinute(timestamp) as minute,
    category_id,
    uniqState(user_id) as unique_users,
    countState() as event_count,
    sumState(price) as total_revenue
FROM user_behavior
GROUP BY minute, category_id;

-- æŸ¥è¯¢æœ€è¿‘1å°æ—¶æ•°æ®
SELECT
    minute,
    category_id,
    uniqMerge(unique_users) as users,
    countMerge(event_count) as events,
    sumMerge(total_revenue) as revenue
FROM realtime_stats
WHERE minute &gt;= now() - INTERVAL 1 HOUR
GROUP BY minute, category_id
ORDER BY minute DESC;
</code></pre>
<h3 id="103-æ¼æ–—åˆ†æ"><a class="header" href="#103-æ¼æ–—åˆ†æ">10.3 æ¼æ–—åˆ†æ</a></h3>
<pre><code class="language-sql">-- è½¬åŒ–æ¼æ–—
SELECT
    sum(step &gt;= 1) as view,
    sum(step &gt;= 2) as click,
    sum(step &gt;= 3) as cart,
    sum(step &gt;= 4) as purchase,
    click / view as view_to_click,
    cart / click as click_to_cart,
    purchase / cart as cart_to_purchase
FROM (
    SELECT
        user_id,
        max(multiIf(
            behavior = 'view', 1,
            behavior = 'click', 2,
            behavior = 'cart', 3,
            behavior = 'purchase', 4,
            0
        )) as step
    FROM user_behavior
    WHERE timestamp &gt;= today()
    GROUP BY user_id
);
</code></pre>
<h2 id="11-å­¦ä¹ éªŒè¯æ ‡å‡†"><a class="header" href="#11-å­¦ä¹ éªŒè¯æ ‡å‡†">11. å­¦ä¹ éªŒè¯æ ‡å‡†</a></h2>
<h3 id="-åŸºç¡€èƒ½åŠ›éªŒè¯"><a class="header" href="#-åŸºç¡€èƒ½åŠ›éªŒè¯">âœ… åŸºç¡€èƒ½åŠ›éªŒè¯</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
ç†è§£ClickHouseåˆ—å¼å­˜å‚¨åŸç†</li>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿåˆ›å»ºå’Œä½¿ç”¨MergeTreeè¡¨</li>
<li><input disabled="" type="checkbox"/>
æŒæ¡åŸºæœ¬SQLæŸ¥è¯¢å’Œèšåˆ</li>
<li><input disabled="" type="checkbox"/>
ç†è§£åˆ†åŒºå’Œæ’åºé”®çš„ä½œç”¨</li>
</ul>
<h3 id="-è¿›é˜¶èƒ½åŠ›éªŒè¯"><a class="header" href="#-è¿›é˜¶èƒ½åŠ›éªŒè¯">âœ… è¿›é˜¶èƒ½åŠ›éªŒè¯</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿè®¾è®¡é«˜æ•ˆçš„è¡¨ç»“æ„</li>
<li><input disabled="" type="checkbox"/>
æŒæ¡å„ç§è¡¨å¼•æ“çš„ä½¿ç”¨åœºæ™¯</li>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿä½¿ç”¨ç‰©åŒ–è§†å›¾ä¼˜åŒ–æŸ¥è¯¢</li>
<li><input disabled="" type="checkbox"/>
ç†è§£åˆ†å¸ƒå¼è¡¨çš„å·¥ä½œåŸç†</li>
</ul>
<h3 id="-é«˜çº§èƒ½åŠ›éªŒè¯"><a class="header" href="#-é«˜çº§èƒ½åŠ›éªŒè¯">âœ… é«˜çº§èƒ½åŠ›éªŒè¯</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿéƒ¨ç½²å’Œç®¡ç†ClickHouseé›†ç¾¤</li>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½è°ƒä¼˜å’Œæ•…éšœæ’æŸ¥</li>
<li><input disabled="" type="checkbox"/>
æŒæ¡å¤æ‚çš„åˆ†ææŸ¥è¯¢ç¼–å†™</li>
<li><input disabled="" type="checkbox"/>
å…·å¤‡ç”Ÿäº§ç¯å¢ƒè¿ç»´èƒ½åŠ›</li>
</ul>
<h2 id="12-æ‰©å±•èµ„æº"><a class="header" href="#12-æ‰©å±•èµ„æº">12. æ‰©å±•èµ„æº</a></h2>
<h3 id="å®˜æ–¹èµ„æº"><a class="header" href="#å®˜æ–¹èµ„æº">å®˜æ–¹èµ„æº</a></h3>
<ul>
<li>å®˜ç½‘: https://clickhouse.com/</li>
<li>æ–‡æ¡£: https://clickhouse.com/docs/</li>
<li>GitHub: https://github.com/ClickHouse/ClickHouse</li>
</ul>
<h3 id="å­¦ä¹ å»ºè®®"><a class="header" href="#å­¦ä¹ å»ºè®®">å­¦ä¹ å»ºè®®</a></h3>
<ol>
<li>ä»å•æœºç¯å¢ƒå¼€å§‹å­¦ä¹ </li>
<li>ç†è§£åˆ—å¼å­˜å‚¨å’ŒMergeTreeåŸç†</li>
<li>å®è·µå„ç§æŸ¥è¯¢å’Œèšåˆ</li>
<li>å­¦ä¹ è¡¨è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–</li>
<li>æŒæ¡åˆ†å¸ƒå¼éƒ¨ç½²</li>
</ol>
<h3 id="è¿›é˜¶æ–¹å‘"><a class="header" href="#è¿›é˜¶æ–¹å‘">è¿›é˜¶æ–¹å‘</a></h3>
<ul>
<li>ClickHouseå†…æ ¸åŸç†</li>
<li>è‡ªå®šä¹‰å‡½æ•°å¼€å‘</li>
<li>å®æ—¶æ•°æ®åˆ†ææ¶æ„</li>
<li>ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ</li>
<li>å¤§è§„æ¨¡é›†ç¾¤è¿ç»´</li>
</ul>
<h3 id="ç›¸å…³å·¥å…·"><a class="header" href="#ç›¸å…³å·¥å…·">ç›¸å…³å·¥å…·</a></h3>
<ul>
<li>ClickHouse Operator for Kubernetes</li>
<li>Tabix - Webç•Œé¢</li>
<li>DBeaver - æ•°æ®åº“å®¢æˆ·ç«¯</li>
<li>Grafana - ç›‘æ§å¯è§†åŒ–</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ç¼–ç¨‹/bigdata/3-Spark.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../ç¼–ç¨‹/bigdata/4-Hive.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ç¼–ç¨‹/bigdata/3-Spark.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../ç¼–ç¨‹/bigdata/4-Hive.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

