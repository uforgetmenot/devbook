<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Apache MapReduce å­¦ä¹ ç¬”è®° - å¼€å‘</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å¼€å‘</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="æœç´¢æœ¬ä¹¦å†…å®¹..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="apache-mapreduce-å­¦ä¹ ç¬”è®°"><a class="header" href="#apache-mapreduce-å­¦ä¹ ç¬”è®°">Apache MapReduce å­¦ä¹ ç¬”è®°</a></h1>
<h2 id="-å­¦ä¹ ç›®æ ‡"><a class="header" href="#-å­¦ä¹ ç›®æ ‡">ğŸ“‹ å­¦ä¹ ç›®æ ‡</a></h2>
<ul>
<li>æ·±å…¥ç†è§£MapReduceç¼–ç¨‹æ¨¡å‹å’ŒåŸç†</li>
<li>æŒæ¡Mapã€Shuffleã€Reduceå„é˜¶æ®µè¯¦ç»†æµç¨‹</li>
<li>ç†Ÿç»ƒä½¿ç”¨Javaå¼€å‘MapReduceç¨‹åº</li>
<li>ç†è§£YARNèµ„æºè°ƒåº¦æœºåˆ¶</li>
<li>æŒæ¡MapReduceæ€§èƒ½ä¼˜åŒ–æŠ€å·§</li>
<li>å…·å¤‡MapReduceç¨‹åºè°ƒè¯•å’Œæ•…éšœæ’æŸ¥èƒ½åŠ›</li>
</ul>
<h2 id="1-mapreduce-åŸºç¡€æ¦‚å¿µ"><a class="header" href="#1-mapreduce-åŸºç¡€æ¦‚å¿µ">1. MapReduce åŸºç¡€æ¦‚å¿µ</a></h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-mapreduce"><a class="header" href="#11-ä»€ä¹ˆæ˜¯-mapreduce">1.1 ä»€ä¹ˆæ˜¯ MapReduce</a></h3>
<p>MapReduceæ˜¯Googleæå‡ºçš„ä¸€ç§ç¼–ç¨‹æ¨¡å‹,ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†çš„å¹¶è¡Œè¿ç®—ã€‚Hadoop MapReduceæ˜¯å…¶å¼€æºå®ç°ã€‚</p>
<p><strong>æ ¸å¿ƒç‰¹ç‚¹:</strong></p>
<ul>
<li>ç®€åŒ–çš„ç¼–ç¨‹æ¨¡å‹</li>
<li>è‡ªåŠ¨å¹¶è¡ŒåŒ–</li>
<li>å®¹é”™æ€§å¼º</li>
<li>æµ·é‡æ•°æ®å¤„ç†</li>
<li>åˆ†å¸ƒå¼è®¡ç®—</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯:</strong></p>
<ul>
<li>å¤§è§„æ¨¡æ•°æ®ç»Ÿè®¡</li>
<li>æ—¥å¿—åˆ†æ</li>
<li>æ•°æ®æ¸…æ´—å’Œè½¬æ¢</li>
<li>æœºå™¨å­¦ä¹ è®­ç»ƒ</li>
<li>ç´¢å¼•æ„å»º</li>
</ul>
<h3 id="12-mapreduce-æ ¸å¿ƒæ€æƒ³"><a class="header" href="#12-mapreduce-æ ¸å¿ƒæ€æƒ³">1.2 MapReduce æ ¸å¿ƒæ€æƒ³</a></h3>
<pre><code>æ ¸å¿ƒæ€æƒ³: åˆ†è€Œæ²»ä¹‹ (Divide and Conquer)

1. Mapé˜¶æ®µ: å°†å¤§ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå°ä»»åŠ¡
2. Shuffleé˜¶æ®µ: å¯¹Mapè¾“å‡ºè¿›è¡Œæ’åºå’Œåˆ†ç»„
3. Reduceé˜¶æ®µ: å¯¹Shuffleç»“æœè¿›è¡Œæ±‡æ€»
</code></pre>
<p><strong>ç®€å•ç¤ºä¾‹ - WordCount:</strong></p>
<pre><code>è¾“å…¥æ–‡æœ¬:
  "hello world"
  "hello hadoop"

Mapé˜¶æ®µ:
  (hello, 1), (world, 1)
  (hello, 1), (hadoop, 1)

Shuffleé˜¶æ®µ:
  (hadoop, [1])
  (hello, [1, 1])
  (world, [1])

Reduceé˜¶æ®µ:
  (hadoop, 1)
  (hello, 2)
  (world, 1)
</code></pre>
<h3 id="13-mapreduce-vs-å…¶ä»–è®¡ç®—æ¡†æ¶"><a class="header" href="#13-mapreduce-vs-å…¶ä»–è®¡ç®—æ¡†æ¶">1.3 MapReduce vs å…¶ä»–è®¡ç®—æ¡†æ¶</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>MapReduce</th><th>Spark</th><th>Flink</th></tr></thead><tbody>
<tr><td>è®¡ç®—æ¨¡å‹</td><td>æ‰¹å¤„ç†</td><td>å†…å­˜è®¡ç®—</td><td>æµæ‰¹ä¸€ä½“</td></tr>
<tr><td>é€Ÿåº¦</td><td>æ…¢</td><td>å¿«(100x)</td><td>å¿«</td></tr>
<tr><td>å®æ—¶æ€§</td><td>ä¸æ”¯æŒ</td><td>å‡†å®æ—¶</td><td>å®æ—¶</td></tr>
<tr><td>å®¹é”™</td><td>é‡æ–°æ‰§è¡Œ</td><td>RDDè¡€ç¼˜</td><td>Checkpoint</td></tr>
<tr><td>æ˜“ç”¨æ€§</td><td>ä¸­ç­‰</td><td>ç®€å•</td><td>ä¸­ç­‰</td></tr>
<tr><td>é€‚ç”¨åœºæ™¯</td><td>å¤§æ‰¹é‡æ•°æ®</td><td>è¿­ä»£è®¡ç®—</td><td>æµå¤„ç†</td></tr>
</tbody></table>
</div>
<h2 id="2-mapreduce-æ¶æ„"><a class="header" href="#2-mapreduce-æ¶æ„">2. MapReduce æ¶æ„</a></h2>
<h3 id="21-mrv1-æ¶æ„-ç»å…¸æ¶æ„"><a class="header" href="#21-mrv1-æ¶æ„-ç»å…¸æ¶æ„">2.1 MRv1 æ¶æ„ (ç»å…¸æ¶æ„)</a></h3>
<pre><code>         Client
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚JobTrackerâ”‚ (å•ç‚¹,è´Ÿè´£ä½œä¸šè°ƒåº¦å’Œç›‘æ§)
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
    â”‚     â”‚     â”‚     â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ–¼â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”
â”‚Task  â”‚ â”‚Taskâ”‚ â”‚Taskâ”‚
â”‚Trackerâ”‚ â”‚Trackerâ”‚ â”‚Trackerâ”‚
â”‚      â”‚ â”‚    â”‚ â”‚    â”‚
â”‚Map  â”‚ â”‚Map â”‚ â”‚Map â”‚
â”‚Reduceâ”‚ â”‚Reduceâ”‚ â”‚Reduceâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>ç»„ä»¶èŒè´£:</strong></p>
<ul>
<li>
<p><strong>JobTracker</strong>:</p>
<ul>
<li>ä½œä¸šè°ƒåº¦</li>
<li>ä»»åŠ¡åˆ†é…</li>
<li>ç›‘æ§TaskTracker</li>
<li>å®¹é”™å¤„ç†</li>
</ul>
</li>
<li>
<p><strong>TaskTracker</strong>:</p>
<ul>
<li>æ‰§è¡ŒMap/Reduceä»»åŠ¡</li>
<li>å‘JobTrackeræ±‡æŠ¥çŠ¶æ€</li>
<li>ç®¡ç†æœ¬åœ°èµ„æº</li>
</ul>
</li>
</ul>
<p><strong>MRv1çš„é—®é¢˜:</strong></p>
<ul>
<li>JobTrackerå•ç‚¹æ•…éšœ</li>
<li>æ‰©å±•æ€§å·®(æœ€å¤š4000èŠ‚ç‚¹)</li>
<li>èµ„æºåˆ©ç”¨ç‡ä½</li>
</ul>
<h3 id="22-yarn-æ¶æ„-mrv2"><a class="header" href="#22-yarn-æ¶æ„-mrv2">2.2 YARN æ¶æ„ (MRv2)</a></h3>
<pre><code>        Client
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ResourceManagerâ”‚ (å…¨å±€èµ„æºç®¡ç†)
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚      â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ–¼â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”
â”‚Node  â”‚ â”‚Nodeâ”‚ â”‚Nodeâ”‚
â”‚Managerâ”‚ â”‚Managerâ”‚ â”‚Managerâ”‚
â”‚      â”‚ â”‚    â”‚ â”‚    â”‚
â”‚Containerâ”‚ â”‚Containerâ”‚ â”‚Containerâ”‚
â”‚(App  â”‚ â”‚(Map)â”‚ â”‚(Reduce)â”‚
â”‚Master)â”‚ â”‚    â”‚ â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>YARNç»„ä»¶:</strong></p>
<ul>
<li><strong>ResourceManager</strong>: å…¨å±€èµ„æºç®¡ç†å’Œè°ƒåº¦</li>
<li><strong>NodeManager</strong>: å•èŠ‚ç‚¹èµ„æºç®¡ç†</li>
<li><strong>ApplicationMaster</strong>: å•ä¸ªåº”ç”¨çš„ä»»åŠ¡è°ƒåº¦å’Œç›‘æ§</li>
<li><strong>Container</strong>: èµ„æºæŠ½è±¡(CPU + å†…å­˜)</li>
</ul>
<p><strong>YARNä¼˜åŠ¿:</strong></p>
<ul>
<li>èµ„æºç»Ÿä¸€ç®¡ç†</li>
<li>æ”¯æŒå¤šç§è®¡ç®—æ¡†æ¶</li>
<li>é«˜å¯ç”¨æ€§</li>
<li>æ›´å¥½çš„æ‰©å±•æ€§(&gt;10000èŠ‚ç‚¹)</li>
</ul>
<h2 id="3-mapreduce-ç¼–ç¨‹æ¨¡å‹"><a class="header" href="#3-mapreduce-ç¼–ç¨‹æ¨¡å‹">3. MapReduce ç¼–ç¨‹æ¨¡å‹</a></h2>
<h3 id="31-map-é˜¶æ®µ"><a class="header" href="#31-map-é˜¶æ®µ">3.1 Map é˜¶æ®µ</a></h3>
<p><strong>èŒè´£:</strong></p>
<ul>
<li>è¯»å–è¾“å…¥æ•°æ®</li>
<li>è§£ææ•°æ®ä¸ºé”®å€¼å¯¹</li>
<li>åº”ç”¨Mapå‡½æ•°å¤„ç†</li>
<li>è¾“å‡ºä¸­é—´ç»“æœ</li>
</ul>
<p><strong>Mapå‡½æ•°ç­¾å:</strong></p>
<pre><code class="language-java">void map(K1 key, V1 value, Context context)
    throws IOException, InterruptedException
</code></pre>
<p><strong>ç¤ºä¾‹:</strong></p>
<pre><code class="language-java">// è¾“å…¥: (è¡Œå·, è¡Œå†…å®¹)
// è¾“å‡º: (å•è¯, 1)
public class WordCountMapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    private Text word = new Text();
    private IntWritable one = new IntWritable(1);

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String line = value.toString();
        String[] words = line.split("\\s+");

        for (String w : words) {
            word.set(w);
            context.write(word, one);
        }
    }
}
</code></pre>
<h3 id="32-shuffle-é˜¶æ®µ"><a class="header" href="#32-shuffle-é˜¶æ®µ">3.2 Shuffle é˜¶æ®µ</a></h3>
<p><strong>Shuffleæµç¨‹:</strong></p>
<pre><code>Mapè¾“å‡º â†’ åˆ†åŒº â†’ æ’åº â†’ åˆå¹¶ â†’ ä¼ è¾“ â†’ å½’å¹¶ â†’ Reduceè¾“å…¥
</code></pre>
<p><strong>è¯¦ç»†æ­¥éª¤:</strong></p>
<p><strong>1. Mapç«¯Shuffle:</strong></p>
<pre><code>a. åˆ†åŒº (Partition)
   - æ ¹æ®keyçš„hashå€¼åˆ†åŒº
   - å†³å®šæ•°æ®å‘é€åˆ°å“ªä¸ªReduce

b. æ’åº (Sort)
   - ç¯å½¢ç¼“å†²åŒºæº¢å†™å‰æ’åº
   - æŒ‰keyæ’åº

c. åˆå¹¶ (Combine)
   - å¯é€‰çš„æœ¬åœ°èšåˆ
   - å‡å°‘æ•°æ®ä¼ è¾“é‡

d. æº¢å†™ (Spill)
   - ç¼“å†²åŒºè¾¾åˆ°é˜ˆå€¼å†™ç£ç›˜
   - ç”Ÿæˆå¤šä¸ªæº¢å†™æ–‡ä»¶

e. å½’å¹¶ (Merge)
   - åˆå¹¶å¤šä¸ªæº¢å†™æ–‡ä»¶
   - ç”Ÿæˆæœ€ç»ˆMapè¾“å‡ºæ–‡ä»¶
</code></pre>
<p><strong>2. Reduceç«¯Shuffle:</strong></p>
<pre><code>a. æ‹‰å– (Fetch)
   - ä»å„MapèŠ‚ç‚¹æ‹‰å–æ•°æ®
   - é€šè¿‡HTTPæ–¹å¼

b. å½’å¹¶ (Merge)
   - åˆå¹¶æ¥è‡ªå¤šä¸ªMapçš„æ•°æ®
   - ä¿æŒæœ‰åº

c. åˆ†ç»„ (Group)
   - ç›¸åŒkeyçš„valueæ”¾åœ¨ä¸€èµ·
   - ä¼ ç»™Reduceå‡½æ•°
</code></pre>
<p><strong>Shuffleé…ç½®ä¼˜åŒ–:</strong></p>
<pre><code class="language-xml">&lt;!-- ç¯å½¢ç¼“å†²åŒºå¤§å° --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.task.io.sort.mb&lt;/name&gt;
  &lt;value&gt;200&lt;/value&gt; &lt;!-- 200MB --&gt;
&lt;/property&gt;

&lt;!-- æº¢å†™é˜ˆå€¼ --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.map.sort.spill.percent&lt;/name&gt;
  &lt;value&gt;0.8&lt;/value&gt; &lt;!-- 80% --&gt;
&lt;/property&gt;

&lt;!-- Shuffleå¹¶è¡Œåº¦ --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.reduce.shuffle.parallelcopies&lt;/name&gt;
  &lt;value&gt;10&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<h3 id="33-reduce-é˜¶æ®µ"><a class="header" href="#33-reduce-é˜¶æ®µ">3.3 Reduce é˜¶æ®µ</a></h3>
<p><strong>èŒè´£:</strong></p>
<ul>
<li>æ¥æ”¶åˆ†ç»„åçš„æ•°æ®</li>
<li>åº”ç”¨Reduceå‡½æ•°</li>
<li>è¾“å‡ºæœ€ç»ˆç»“æœ</li>
</ul>
<p><strong>Reduceå‡½æ•°ç­¾å:</strong></p>
<pre><code class="language-java">void reduce(K2 key, Iterable&lt;V2&gt; values, Context context)
    throws IOException, InterruptedException
</code></pre>
<p><strong>ç¤ºä¾‹:</strong></p>
<pre><code class="language-java">// è¾“å…¥: (å•è¯, [1, 1, 1, ...])
// è¾“å‡º: (å•è¯, æ€»æ•°)
public class WordCountReducer extends Reducer&lt;Text, IntWritable, Text, IntWritable&gt; {

    private IntWritable result = new IntWritable();

    @Override
    protected void reduce(Text key, Iterable&lt;IntWritable&gt; values, Context context)
            throws IOException, InterruptedException {

        int sum = 0;
        for (IntWritable val : values) {
            sum += val.get();
        }

        result.set(sum);
        context.write(key, result);
    }
}
</code></pre>
<h2 id="4-mapreduce-ç¼–ç¨‹å®ç°"><a class="header" href="#4-mapreduce-ç¼–ç¨‹å®ç°">4. MapReduce ç¼–ç¨‹å®ç°</a></h2>
<h3 id="41-å®Œæ•´çš„wordcountç¨‹åº"><a class="header" href="#41-å®Œæ•´çš„wordcountç¨‹åº">4.1 å®Œæ•´çš„WordCountç¨‹åº</a></h3>
<p><strong>1. Mapperç±»:</strong></p>
<pre><code class="language-java">import org.apache.hadoop.io.IntWritable;
import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Mapper;

import java.io.IOException;

public class WordCountMapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    private Text word = new Text();
    private final static IntWritable one = new IntWritable(1);

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String line = value.toString();
        String[] words = line.split("\\s+");

        for (String w : words) {
            if (w.length() &gt; 0) {
                word.set(w.toLowerCase());
                context.write(word, one);
            }
        }
    }
}
</code></pre>
<p><strong>2. Reducerç±»:</strong></p>
<pre><code class="language-java">import org.apache.hadoop.io.IntWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Reducer;

import java.io.IOException;

public class WordCountReducer extends Reducer&lt;Text, IntWritable, Text, IntWritable&gt; {

    private IntWritable result = new IntWritable();

    @Override
    protected void reduce(Text key, Iterable&lt;IntWritable&gt; values, Context context)
            throws IOException, InterruptedException {

        int sum = 0;
        for (IntWritable val : values) {
            sum += val.get();
        }

        result.set(sum);
        context.write(key, result);
    }
}
</code></pre>
<p><strong>3. Driverç±»:</strong></p>
<pre><code class="language-java">import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.IntWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;

public class WordCountDriver {

    public static void main(String[] args) throws Exception {

        if (args.length != 2) {
            System.err.println("Usage: WordCount &lt;input path&gt; &lt;output path&gt;");
            System.exit(-1);
        }

        Configuration conf = new Configuration();
        Job job = Job.getInstance(conf, "word count");

        // è®¾ç½®JaråŒ…
        job.setJarByClass(WordCountDriver.class);

        // è®¾ç½®Mapperå’ŒReducer
        job.setMapperClass(WordCountMapper.class);
        job.setReducerClass(WordCountReducer.class);

        // è®¾ç½®Mapperè¾“å‡ºç±»å‹
        job.setMapOutputKeyClass(Text.class);
        job.setMapOutputValueClass(IntWritable.class);

        // è®¾ç½®æœ€ç»ˆè¾“å‡ºç±»å‹
        job.setOutputKeyClass(Text.class);
        job.setOutputValueClass(IntWritable.class);

        // è®¾ç½®è¾“å…¥è¾“å‡ºè·¯å¾„
        FileInputFormat.addInputPath(job, new Path(args[0]));
        FileOutputFormat.setOutputPath(job, new Path(args[1]));

        // æäº¤ä½œä¸š
        System.exit(job.waitForCompletion(true) ? 0 : 1);
    }
}
</code></pre>
<p><strong>4. Mavenä¾èµ–:</strong></p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;
        &lt;artifactId&gt;hadoop-client&lt;/artifactId&gt;
        &lt;version&gt;3.3.4&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;
        &lt;artifactId&gt;hadoop-common&lt;/artifactId&gt;
        &lt;version&gt;3.3.4&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;
        &lt;artifactId&gt;hadoop-hdfs&lt;/artifactId&gt;
        &lt;version&gt;3.3.4&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p><strong>5. æ‰“åŒ…è¿è¡Œ:</strong></p>
<pre><code class="language-bash"># æ‰“åŒ…
mvn clean package

# ä¸Šä¼ åˆ°HDFS
hadoop fs -put input.txt /input/

# è¿è¡Œä½œä¸š
hadoop jar wordcount.jar com.example.WordCountDriver /input /output

# æŸ¥çœ‹ç»“æœ
hadoop fs -cat /output/part-r-00000
</code></pre>
<h3 id="42-æ•°æ®ç±»å‹-writable"><a class="header" href="#42-æ•°æ®ç±»å‹-writable">4.2 æ•°æ®ç±»å‹ (Writable)</a></h3>
<p><strong>å¸¸ç”¨Writableç±»å‹:</strong></p>
<pre><code class="language-java">// åŸºæœ¬ç±»å‹
IntWritable      // int
LongWritable     // long
FloatWritable    // float
DoubleWritable   // double
BooleanWritable  // boolean
Text             // String
NullWritable     // null

// æ•°ç»„ç±»å‹
ArrayWritable
IntArrayWritable
</code></pre>
<p><strong>è‡ªå®šä¹‰Writableç±»å‹:</strong></p>
<pre><code class="language-java">import org.apache.hadoop.io.Writable;
import org.apache.hadoop.io.WritableComparable;

import java.io.DataInput;
import java.io.DataOutput;
import java.io.IOException;

public class UserWritable implements WritableComparable&lt;UserWritable&gt; {

    private String username;
    private int age;
    private double salary;

    // é»˜è®¤æ„é€ å‡½æ•°(å¿…é¡»)
    public UserWritable() {
    }

    public UserWritable(String username, int age, double salary) {
        this.username = username;
        this.age = age;
        this.salary = salary;
    }

    // åºåˆ—åŒ–
    @Override
    public void write(DataOutput out) throws IOException {
        out.writeUTF(username);
        out.writeInt(age);
        out.writeDouble(salary);
    }

    // ååºåˆ—åŒ–
    @Override
    public void readFields(DataInput in) throws IOException {
        this.username = in.readUTF();
        this.age = in.readInt();
        this.salary = in.readDouble();
    }

    // æ¯”è¾ƒ
    @Override
    public int compareTo(UserWritable o) {
        return this.username.compareTo(o.username);
    }

    // Getters and Setters
    // toString(), hashCode(), equals()...
}
</code></pre>
<h3 id="43-combiner-ä¼˜åŒ–"><a class="header" href="#43-combiner-ä¼˜åŒ–">4.3 Combiner ä¼˜åŒ–</a></h3>
<p><strong>Combinerä½œç”¨:</strong></p>
<ul>
<li>Mapç«¯æœ¬åœ°èšåˆ</li>
<li>å‡å°‘ç½‘ç»œä¼ è¾“</li>
<li>æé«˜æ€§èƒ½</li>
</ul>
<p><strong>ä½¿ç”¨Combiner:</strong></p>
<pre><code class="language-java">// åœ¨Driverä¸­è®¾ç½®
job.setCombinerClass(WordCountReducer.class);

// Combineré€šå¸¸å’ŒReducerä½¿ç”¨ç›¸åŒçš„ç±»
// è¦æ±‚: Combinerè¾“å‡ºç±»å‹å¿…é¡»å’ŒReduceè¾“å…¥ç±»å‹ä¸€è‡´
</code></pre>
<p><strong>é€‚åˆä½¿ç”¨Combinerçš„åœºæ™¯:</strong></p>
<pre><code>âœ“ æ±‚å’Œæ“ä½œ: SUM
âœ“ è®¡æ•°æ“ä½œ: COUNT
âœ“ æœ€å¤§/æœ€å°å€¼: MAX/MIN

âœ— æ±‚å¹³å‡å€¼: AVG (ä¸èƒ½ç›´æ¥ä½¿ç”¨)
</code></pre>
<p><strong>æ±‚å¹³å‡å€¼çš„æ­£ç¡®åšæ³•:</strong></p>
<pre><code class="language-java">public class AvgCombiner extends Reducer&lt;Text, IntWritable, Text, Text&gt; {

    @Override
    protected void reduce(Text key, Iterable&lt;IntWritable&gt; values, Context context)
            throws IOException, InterruptedException {

        int sum = 0;
        int count = 0;

        for (IntWritable val : values) {
            sum += val.get();
            count++;
        }

        // è¾“å‡º: key, "sum:count"
        context.write(key, new Text(sum + ":" + count));
    }
}

public class AvgReducer extends Reducer&lt;Text, Text, Text, DoubleWritable&gt; {

    @Override
    protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context)
            throws IOException, InterruptedException {

        int totalSum = 0;
        int totalCount = 0;

        for (Text val : values) {
            String[] parts = val.toString().split(":");
            totalSum += Integer.parseInt(parts[0]);
            totalCount += Integer.parseInt(parts[1]);
        }

        double avg = (double) totalSum / totalCount;
        context.write(key, new DoubleWritable(avg));
    }
}
</code></pre>
<h3 id="44-partitioner-åˆ†åŒº"><a class="header" href="#44-partitioner-åˆ†åŒº">4.4 Partitioner åˆ†åŒº</a></h3>
<p><strong>é»˜è®¤åˆ†åŒº:</strong></p>
<pre><code class="language-java">// HashPartitioner (é»˜è®¤)
int partition = (key.hashCode() &amp; Integer.MAX_VALUE) % numReduceTasks;
</code></pre>
<p><strong>è‡ªå®šä¹‰Partitioner:</strong></p>
<pre><code class="language-java">import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Partitioner;

public class CustomPartitioner extends Partitioner&lt;Text, IntWritable&gt; {

    @Override
    public int getPartition(Text key, IntWritable value, int numPartitions) {

        String word = key.toString();

        // æŒ‰é¦–å­—æ¯åˆ†åŒº
        char firstChar = word.charAt(0);

        if (firstChar &gt;= 'a' &amp;&amp; firstChar &lt;= 'm') {
            return 0 % numPartitions;
        } else if (firstChar &gt;= 'n' &amp;&amp; firstChar &lt;= 'z') {
            return 1 % numPartitions;
        } else {
            return 2 % numPartitions;
        }
    }
}

// åœ¨Driverä¸­ä½¿ç”¨
job.setPartitionerClass(CustomPartitioner.class);
job.setNumReduceTasks(3);  // å¿…é¡»åŒ¹é…åˆ†åŒºæ•°
</code></pre>
<h3 id="45-inputformat-å’Œ-outputformat"><a class="header" href="#45-inputformat-å’Œ-outputformat">4.5 InputFormat å’Œ OutputFormat</a></h3>
<p><strong>InputFormatç±»å‹:</strong></p>
<pre><code class="language-java">// æ–‡æœ¬æ–‡ä»¶(é»˜è®¤)
TextInputFormat

// SequenceFile
SequenceFileInputFormat

// è‡ªå®šä¹‰åˆ†éš”ç¬¦
KeyValueTextInputFormat

// å°æ–‡ä»¶åˆå¹¶
CombineTextInputFormat

// å¤šè·¯å¾„è¾“å…¥
MultipleInputs.addInputPath(job, path1, TextInputFormat.class, Mapper1.class);
MultipleInputs.addInputPath(job, path2, TextInputFormat.class, Mapper2.class);
</code></pre>
<p><strong>OutputFormatç±»å‹:</strong></p>
<pre><code class="language-java">// æ–‡æœ¬æ–‡ä»¶(é»˜è®¤)
TextOutputFormat

// SequenceFile
SequenceFileOutputFormat

// å¤šæ–‡ä»¶è¾“å‡º
MultipleOutputs.addNamedOutput(job, "output1", TextOutputFormat.class,
    Text.class, IntWritable.class);
</code></pre>
<p><strong>è‡ªå®šä¹‰InputFormat:</strong></p>
<pre><code class="language-java">public class WholeFileInputFormat extends FileInputFormat&lt;NullWritable, BytesWritable&gt; {

    @Override
    public RecordReader&lt;NullWritable, BytesWritable&gt; createRecordReader(
            InputSplit split, TaskAttemptContext context) {
        return new WholeFileRecordReader();
    }

    @Override
    protected boolean isSplitable(JobContext context, Path filename) {
        return false;  // ä¸åˆ†å‰²æ–‡ä»¶
    }
}

class WholeFileRecordReader extends RecordReader&lt;NullWritable, BytesWritable&gt; {

    private FileSplit fileSplit;
    private Configuration conf;
    private BytesWritable value = new BytesWritable();
    private boolean processed = false;

    @Override
    public void initialize(InputSplit split, TaskAttemptContext context) {
        this.fileSplit = (FileSplit) split;
        this.conf = context.getConfiguration();
    }

    @Override
    public boolean nextKeyValue() throws IOException {
        if (!processed) {
            byte[] contents = new byte[(int) fileSplit.getLength()];
            Path file = fileSplit.getPath();
            FileSystem fs = file.getFileSystem(conf);

            FSDataInputStream in = null;
            try {
                in = fs.open(file);
                IOUtils.readFully(in, contents, 0, contents.length);
                value.set(contents, 0, contents.length);
            } finally {
                IOUtils.closeStream(in);
            }

            processed = true;
            return true;
        }
        return false;
    }

    @Override
    public NullWritable getCurrentKey() {
        return NullWritable.get();
    }

    @Override
    public BytesWritable getCurrentValue() {
        return value;
    }

    @Override
    public float getProgress() {
        return processed ? 1.0f : 0.0f;
    }

    @Override
    public void close() {
        // cleanup
    }
}
</code></pre>
<h2 id="5-mapreduce-é«˜çº§ç‰¹æ€§"><a class="header" href="#5-mapreduce-é«˜çº§ç‰¹æ€§">5. MapReduce é«˜çº§ç‰¹æ€§</a></h2>
<h3 id="51-è®¡æ•°å™¨-counter"><a class="header" href="#51-è®¡æ•°å™¨-counter">5.1 è®¡æ•°å™¨ (Counter)</a></h3>
<pre><code class="language-java">public class CounterMapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    // å®šä¹‰æšä¸¾ç±»å‹è®¡æ•°å™¨
    enum MyCounter {
        EMPTY_LINE,
        INVALID_RECORD
    }

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String line = value.toString();

        if (line.isEmpty()) {
            // è®¡æ•°å™¨åŠ 1
            context.getCounter(MyCounter.EMPTY_LINE).increment(1);
            return;
        }

        String[] fields = line.split(",");
        if (fields.length &lt; 2) {
            // åŠ¨æ€è®¡æ•°å™¨
            context.getCounter("ErrorGroup", "InvalidRecord").increment(1);
            return;
        }

        // æ­£å¸¸å¤„ç†
        context.write(new Text(fields[0]), new IntWritable(Integer.parseInt(fields[1])));
    }
}

// è·å–è®¡æ•°å™¨å€¼
Counters counters = job.getCounters();
long emptyLines = counters.findCounter(CounterMapper.MyCounter.EMPTY_LINE).getValue();
System.out.println("Empty lines: " + emptyLines);
</code></pre>
<h3 id="52-åˆ†å¸ƒå¼ç¼“å­˜-distributedcache"><a class="header" href="#52-åˆ†å¸ƒå¼ç¼“å­˜-distributedcache">5.2 åˆ†å¸ƒå¼ç¼“å­˜ (DistributedCache)</a></h3>
<pre><code class="language-java">// åœ¨Driverä¸­æ·»åŠ ç¼“å­˜æ–‡ä»¶
job.addCacheFile(new URI("/cache/dict.txt"));

// åœ¨Mapperçš„setup()ä¸­è¯»å–ç¼“å­˜æ–‡ä»¶
public class CacheMapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    private Set&lt;String&gt; stopWords = new HashSet&lt;&gt;();

    @Override
    protected void setup(Context context) throws IOException {

        URI[] cacheFiles = context.getCacheFiles();

        if (cacheFiles != null &amp;&amp; cacheFiles.length &gt; 0) {
            Path path = new Path(cacheFiles[0]);
            FileSystem fs = FileSystem.get(context.getConfiguration());

            BufferedReader reader = new BufferedReader(
                new InputStreamReader(fs.open(path))
            );

            String line;
            while ((line = reader.readLine()) != null) {
                stopWords.add(line.trim());
            }
            reader.close();
        }
    }

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] words = value.toString().split("\\s+");

        for (String word : words) {
            if (!stopWords.contains(word)) {
                context.write(new Text(word), new IntWritable(1));
            }
        }
    }
}
</code></pre>
<h3 id="53-å¤šè¡¨join"><a class="header" href="#53-å¤šè¡¨join">5.3 å¤šè¡¨Join</a></h3>
<p><strong>Map-side Join (é€‚ç”¨äºå°è¡¨joinå¤§è¡¨):</strong></p>
<pre><code class="language-java">public class MapJoinMapper extends Mapper&lt;LongWritable, Text, Text, Text&gt; {

    private Map&lt;String, String&gt; smallTable = new HashMap&lt;&gt;();

    @Override
    protected void setup(Context context) throws IOException {
        // ä»DistributedCacheåŠ è½½å°è¡¨
        URI[] cacheFiles = context.getCacheFiles();
        Path path = new Path(cacheFiles[0]);
        FileSystem fs = FileSystem.get(context.getConfiguration());

        BufferedReader reader = new BufferedReader(
            new InputStreamReader(fs.open(path))
        );

        String line;
        while ((line = reader.readLine()) != null) {
            String[] fields = line.split(",");
            smallTable.put(fields[0], fields[1]);
        }
        reader.close();
    }

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] fields = value.toString().split(",");
        String id = fields[0];
        String name = fields[1];

        // Joinæ“ä½œ
        String info = smallTable.get(id);
        if (info != null) {
            context.write(new Text(id), new Text(name + "\t" + info));
        }
    }
}
</code></pre>
<p><strong>Reduce-side Join (é€‚ç”¨äºå¤§è¡¨joinå¤§è¡¨):</strong></p>
<pre><code class="language-java">// æ ‡è®°æ•°æ®æ¥æºçš„Writable
public class JoinWritable implements Writable {
    private String flag;  // "order" or "user"
    private String data;

    // åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•
    // ...
}

public class ReduceJoinMapper extends Mapper&lt;LongWritable, Text, Text, JoinWritable&gt; {

    private String filename;

    @Override
    protected void setup(Context context) {
        FileSplit split = (FileSplit) context.getInputSplit();
        filename = split.getPath().getName();
    }

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] fields = value.toString().split(",");
        String id = fields[0];

        JoinWritable writable = new JoinWritable();

        if (filename.contains("order")) {
            writable.setFlag("order");
            writable.setData(fields[1] + "," + fields[2]);
        } else {
            writable.setFlag("user");
            writable.setData(fields[1]);
        }

        context.write(new Text(id), writable);
    }
}

public class ReduceJoinReducer extends Reducer&lt;Text, JoinWritable, Text, Text&gt; {

    @Override
    protected void reduce(Text key, Iterable&lt;JoinWritable&gt; values, Context context)
            throws IOException, InterruptedException {

        List&lt;String&gt; orders = new ArrayList&lt;&gt;();
        String userName = "";

        for (JoinWritable val : values) {
            if ("order".equals(val.getFlag())) {
                orders.add(val.getData());
            } else {
                userName = val.getData();
            }
        }

        // ç¬›å¡å°”ç§¯
        for (String order : orders) {
            context.write(key, new Text(userName + "\t" + order));
        }
    }
}
</code></pre>
<h2 id="6-mapreduce-æ€§èƒ½ä¼˜åŒ–"><a class="header" href="#6-mapreduce-æ€§èƒ½ä¼˜åŒ–">6. MapReduce æ€§èƒ½ä¼˜åŒ–</a></h2>
<h3 id="61-æ•°æ®å‹ç¼©"><a class="header" href="#61-æ•°æ®å‹ç¼©">6.1 æ•°æ®å‹ç¼©</a></h3>
<pre><code class="language-xml">&lt;!-- Mapè¾“å‡ºå‹ç¼© --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.map.output.compress&lt;/name&gt;
  &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;mapreduce.map.output.compress.codec&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.io.compress.SnappyCodec&lt;/value&gt;
&lt;/property&gt;

&lt;!-- æœ€ç»ˆè¾“å‡ºå‹ç¼© --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.output.fileoutputformat.compress&lt;/name&gt;
  &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;mapreduce.output.fileoutputformat.compress.codec&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.io.compress.GzipCodec&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<p><strong>å‹ç¼©ç®—æ³•å¯¹æ¯”:</strong></p>
<div class="table-wrapper"><table><thead><tr><th>ç®—æ³•</th><th>å‹ç¼©æ¯”</th><th>å‹ç¼©é€Ÿåº¦</th><th>è§£å‹é€Ÿåº¦</th><th>å¯åˆ†å‰²</th></tr></thead><tbody>
<tr><td>Gzip</td><td>é«˜</td><td>ä¸­</td><td>ä¸­</td><td>å¦</td></tr>
<tr><td>Bzip2</td><td>å¾ˆé«˜</td><td>æ…¢</td><td>æ…¢</td><td>æ˜¯</td></tr>
<tr><td>Snappy</td><td>ä¸­</td><td>å¾ˆå¿«</td><td>å¾ˆå¿«</td><td>å¦</td></tr>
<tr><td>LZO</td><td>ä¸­</td><td>å¿«</td><td>å¿«</td><td>æ˜¯(éœ€ç´¢å¼•)</td></tr>
</tbody></table>
</div>
<h3 id="62-å°æ–‡ä»¶ä¼˜åŒ–"><a class="header" href="#62-å°æ–‡ä»¶ä¼˜åŒ–">6.2 å°æ–‡ä»¶ä¼˜åŒ–</a></h3>
<p><strong>æ–¹æ³•1: ä½¿ç”¨CombineTextInputFormat</strong></p>
<pre><code class="language-java">job.setInputFormatClass(CombineTextInputFormat.class);
CombineTextInputFormat.setMaxInputSplitSize(job, 4194304);  // 4MB
CombineTextInputFormat.setMinInputSplitSize(job, 2097152);  // 2MB
</code></pre>
<p><strong>æ–¹æ³•2: ä½¿ç”¨SequenceFileåˆå¹¶å°æ–‡ä»¶</strong></p>
<pre><code class="language-java">// åˆå¹¶å°æ–‡ä»¶
public class SmallFilesToSequenceFile {

    public static void main(String[] args) throws IOException {

        Configuration conf = new Configuration();
        FileSystem fs = FileSystem.get(conf);

        Path inputDir = new Path("/input");
        Path outputFile = new Path("/output/merged.seq");

        SequenceFile.Writer writer = SequenceFile.createWriter(
            fs, conf, outputFile, Text.class, BytesWritable.class
        );

        FileStatus[] files = fs.listStatus(inputDir);

        for (FileStatus file : files) {
            if (!file.isFile()) continue;

            Path path = file.getPath();
            byte[] content = new byte[(int) file.getLen()];

            FSDataInputStream in = fs.open(path);
            IOUtils.readFully(in, content, 0, content.length);
            in.close();

            writer.append(new Text(path.getName()), new BytesWritable(content));
        }

        writer.close();
    }
}
</code></pre>
<h3 id="63-æ•°æ®å€¾æ–œä¼˜åŒ–"><a class="header" href="#63-æ•°æ®å€¾æ–œä¼˜åŒ–">6.3 æ•°æ®å€¾æ–œä¼˜åŒ–</a></h3>
<p><strong>æ–¹æ³•1: è‡ªå®šä¹‰Partitioner</strong></p>
<pre><code class="language-java">public class BalancedPartitioner extends Partitioner&lt;Text, IntWritable&gt; {

    @Override
    public int getPartition(Text key, IntWritable value, int numPartitions) {
        // ä½¿ç”¨æ›´å‡åŒ€çš„hashç®—æ³•
        return Math.abs(key.hashCode() * 31) % numPartitions;
    }
}
</code></pre>
<p><strong>æ–¹æ³•2: å¢åŠ Reduceæ•°é‡</strong></p>
<pre><code class="language-java">job.setNumReduceTasks(20);  // å¢åŠ Reduceä»»åŠ¡æ•°
</code></pre>
<p><strong>æ–¹æ³•3: ä¸¤é˜¶æ®µèšåˆ</strong></p>
<pre><code class="language-java">// ç¬¬ä¸€é˜¶æ®µ: åŠ éšæœºå‰ç¼€
public class Stage1Mapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] fields = value.toString().split(",");
        String word = fields[0];

        // æ·»åŠ éšæœºå‰ç¼€
        int random = (int) (Math.random() * 10);
        String newKey = random + "_" + word;

        context.write(new Text(newKey), new IntWritable(1));
    }
}

// ç¬¬äºŒé˜¶æ®µ: å»é™¤å‰ç¼€èšåˆ
public class Stage2Mapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] fields = value.toString().split("\\t");
        String keyWithPrefix = fields[0];
        int count = Integer.parseInt(fields[1]);

        // å»é™¤å‰ç¼€
        String word = keyWithPrefix.substring(keyWithPrefix.indexOf("_") + 1);

        context.write(new Text(word), new IntWritable(count));
    }
}
</code></pre>
<h3 id="64-å†…å­˜ä¼˜åŒ–"><a class="header" href="#64-å†…å­˜ä¼˜åŒ–">6.4 å†…å­˜ä¼˜åŒ–</a></h3>
<pre><code class="language-xml">&lt;!-- Mapä»»åŠ¡å†…å­˜ --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.map.memory.mb&lt;/name&gt;
  &lt;value&gt;2048&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;mapreduce.map.java.opts&lt;/name&gt;
  &lt;value&gt;-Xmx1638m&lt;/value&gt;
&lt;/property&gt;

&lt;!-- Reduceä»»åŠ¡å†…å­˜ --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.reduce.memory.mb&lt;/name&gt;
  &lt;value&gt;4096&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
  &lt;name&gt;mapreduce.reduce.java.opts&lt;/name&gt;
  &lt;value&gt;-Xmx3276m&lt;/value&gt;
&lt;/property&gt;

&lt;!-- Shuffleå†…å­˜ --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.reduce.shuffle.input.buffer.percent&lt;/name&gt;
  &lt;value&gt;0.7&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<h2 id="7-mapreduce-å®æˆ˜æ¡ˆä¾‹"><a class="header" href="#7-mapreduce-å®æˆ˜æ¡ˆä¾‹">7. MapReduce å®æˆ˜æ¡ˆä¾‹</a></h2>
<h3 id="71-æ—¥å¿—åˆ†æ"><a class="header" href="#71-æ—¥å¿—åˆ†æ">7.1 æ—¥å¿—åˆ†æ</a></h3>
<pre><code class="language-java">// æ—¥å¿—æ ¼å¼: IP timestamp method url status
public class LogAnalysisMapper extends Mapper&lt;LongWritable, Text, Text, IntWritable&gt; {

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String line = value.toString();
        String[] fields = line.split("\\s+");

        if (fields.length &lt; 5) return;

        String ip = fields[0];
        String url = fields[3];
        String status = fields[4];

        // ç»Ÿè®¡å„IPè®¿é—®æ¬¡æ•°
        context.write(new Text("IP_" + ip), new IntWritable(1));

        // ç»Ÿè®¡å„URLè®¿é—®æ¬¡æ•°
        context.write(new Text("URL_" + url), new IntWritable(1));

        // ç»Ÿè®¡å„çŠ¶æ€ç æ•°é‡
        context.write(new Text("STATUS_" + status), new IntWritable(1));
    }
}
</code></pre>
<h3 id="72-topné—®é¢˜"><a class="header" href="#72-topné—®é¢˜">7.2 TopNé—®é¢˜</a></h3>
<pre><code class="language-java">// Mapper: ä½¿ç”¨TreeMapä¿å­˜Top N
public class TopNMapper extends Mapper&lt;LongWritable, Text, NullWritable, Text&gt; {

    private TreeMap&lt;Integer, String&gt; topMap = new TreeMap&lt;&gt;();
    private int N = 10;

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] fields = value.toString().split("\\t");
        String word = fields[0];
        int count = Integer.parseInt(fields[1]);

        topMap.put(count, word);

        if (topMap.size() &gt; N) {
            topMap.remove(topMap.firstKey());
        }
    }

    @Override
    protected void cleanup(Context context)
            throws IOException, InterruptedException {

        for (Map.Entry&lt;Integer, String&gt; entry : topMap.entrySet()) {
            context.write(NullWritable.get(),
                new Text(entry.getValue() + "\t" + entry.getKey()));
        }
    }
}

// Reducer: å…¨å±€TopN
public class TopNReducer extends Reducer&lt;NullWritable, Text, Text, IntWritable&gt; {

    private TreeMap&lt;Integer, String&gt; topMap = new TreeMap&lt;&gt;();
    private int N = 10;

    @Override
    protected void reduce(NullWritable key, Iterable&lt;Text&gt; values, Context context)
            throws IOException, InterruptedException {

        for (Text val : values) {
            String[] fields = val.toString().split("\\t");
            String word = fields[0];
            int count = Integer.parseInt(fields[1]);

            topMap.put(count, word);

            if (topMap.size() &gt; N) {
                topMap.remove(topMap.firstKey());
            }
        }

        // è¾“å‡ºç»“æœ(å€’åº)
        for (Map.Entry&lt;Integer, String&gt; entry : topMap.descendingMap().entrySet()) {
            context.write(new Text(entry.getValue()), new IntWritable(entry.getKey()));
        }
    }
}
</code></pre>
<h3 id="73-å€’æ’ç´¢å¼•"><a class="header" href="#73-å€’æ’ç´¢å¼•">7.3 å€’æ’ç´¢å¼•</a></h3>
<pre><code class="language-java">// è¾“å…¥: å¤šä¸ªæ–‡æ¡£,æ¯è¡Œä¸€ä¸ªå•è¯
// è¾“å‡º: word -&gt; doc1:3,doc2:1,doc3:2
public class InvertedIndexMapper extends Mapper&lt;LongWritable, Text, Text, Text&gt; {

    private String filename;

    @Override
    protected void setup(Context context) {
        FileSplit split = (FileSplit) context.getInputSplit();
        filename = split.getPath().getName();
    }

    @Override
    protected void map(LongWritable key, Text value, Context context)
            throws IOException, InterruptedException {

        String[] words = value.toString().split("\\s+");

        for (String word : words) {
            // è¾“å‡º: (word, filename)
            context.write(new Text(word), new Text(filename));
        }
    }
}

// Combiner: æœ¬åœ°èšåˆ
public class InvertedIndexCombiner extends Reducer&lt;Text, Text, Text, Text&gt; {

    @Override
    protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context)
            throws IOException, InterruptedException {

        Map&lt;String, Integer&gt; countMap = new HashMap&lt;&gt;();

        for (Text val : values) {
            String filename = val.toString();
            countMap.put(filename, countMap.getOrDefault(filename, 0) + 1);
        }

        for (Map.Entry&lt;String, Integer&gt; entry : countMap.entrySet()) {
            context.write(key, new Text(entry.getKey() + ":" + entry.getValue()));
        }
    }
}

// Reducer: å…¨å±€èšåˆ
public class InvertedIndexReducer extends Reducer&lt;Text, Text, Text, Text&gt; {

    @Override
    protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context)
            throws IOException, InterruptedException {

        Map&lt;String, Integer&gt; countMap = new HashMap&lt;&gt;();

        for (Text val : values) {
            String[] parts = val.toString().split(":");
            String filename = parts[0];
            int count = Integer.parseInt(parts[1]);

            countMap.put(filename, countMap.getOrDefault(filename, 0) + count);
        }

        StringBuilder result = new StringBuilder();
        for (Map.Entry&lt;String, Integer&gt; entry : countMap.entrySet()) {
            if (result.length() &gt; 0) {
                result.append(",");
            }
            result.append(entry.getKey()).append(":").append(entry.getValue());
        }

        context.write(key, new Text(result.toString()));
    }
}
</code></pre>
<h2 id="8-æ•…éšœæ’æŸ¥ä¸è°ƒè¯•"><a class="header" href="#8-æ•…éšœæ’æŸ¥ä¸è°ƒè¯•">8. æ•…éšœæ’æŸ¥ä¸è°ƒè¯•</a></h2>
<h3 id="81-å¸¸è§é—®é¢˜"><a class="header" href="#81-å¸¸è§é—®é¢˜">8.1 å¸¸è§é—®é¢˜</a></h3>
<p><strong>é—®é¢˜1: ä½œä¸šä¸€ç›´å¤„äºACCEPTEDçŠ¶æ€</strong></p>
<pre><code class="language-bash"># åŸå› : èµ„æºä¸è¶³
# è§£å†³:
# 1. æ£€æŸ¥YARNèµ„æºä½¿ç”¨æƒ…å†µ
yarn application -list

# 2. æŸ¥çœ‹ResourceManageræ—¥å¿—
tail -f $HADOOP_HOME/logs/yarn-*-resourcemanager-*.log

# 3. å¢åŠ é›†ç¾¤èµ„æºæˆ–å‡å°‘ä»»åŠ¡èµ„æºéœ€æ±‚
</code></pre>
<p><strong>é—®é¢˜2: Map/Reduceä»»åŠ¡å¤±è´¥</strong></p>
<pre><code class="language-bash"># æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—
yarn logs -applicationId application_xxx_xxx

# æŸ¥çœ‹ç‰¹å®šä»»åŠ¡æ—¥å¿—
hadoop job -logs &lt;job-id&gt;

# å¸¸è§åŸå› :
# - æ•°æ®æ ¼å¼é”™è¯¯
# - å†…å­˜ä¸è¶³
# - ä»£ç å¼‚å¸¸
</code></pre>
<p><strong>é—®é¢˜3: Shuffleé˜¶æ®µæ…¢</strong></p>
<pre><code class="language-bash"># ä¼˜åŒ–å»ºè®®:
# 1. å¯ç”¨Mapè¾“å‡ºå‹ç¼©
# 2. ä½¿ç”¨Combiner
# 3. å¢åŠ Shuffleå¹¶è¡Œåº¦
# 4. è°ƒæ•´æº¢å†™é˜ˆå€¼
</code></pre>
<h3 id="82-æ€§èƒ½åˆ†æ"><a class="header" href="#82-æ€§èƒ½åˆ†æ">8.2 æ€§èƒ½åˆ†æ</a></h3>
<pre><code class="language-bash"># æŸ¥çœ‹ä½œä¸šå†å²
mapred job -history &lt;job-output-dir&gt;

# æŸ¥çœ‹ä½œä¸šè®¡æ•°å™¨
yarn logs -applicationId &lt;app-id&gt; | grep -A 20 "Counters"

# å…³é”®æŒ‡æ ‡:
# - Map/Reduceä»»åŠ¡æ•°é‡
# - Shuffleæ•°æ®é‡
# - GCæ—¶é—´
# - Spilled Records
</code></pre>
<h3 id="83-è°ƒè¯•æŠ€å·§"><a class="header" href="#83-è°ƒè¯•æŠ€å·§">8.3 è°ƒè¯•æŠ€å·§</a></h3>
<p><strong>æœ¬åœ°è°ƒè¯•:</strong></p>
<pre><code class="language-java">// è®¾ç½®ä¸ºæœ¬åœ°æ¨¡å¼
Configuration conf = new Configuration();
conf.set("mapreduce.framework.name", "local");
conf.set("fs.defaultFS", "file:///");

Job job = Job.getInstance(conf);
// ...è®¾ç½®jobå‚æ•°

// è¿è¡Œ
job.waitForCompletion(true);
</code></pre>
<p><strong>è¿œç¨‹è°ƒè¯•:</strong></p>
<pre><code class="language-xml">&lt;!-- åœ¨mapred-site.xmlä¸­è®¾ç½® --&gt;
&lt;property&gt;
  &lt;name&gt;mapreduce.map.java.opts&lt;/name&gt;
  &lt;value&gt;-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8888&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<h2 id="9-å­¦ä¹ éªŒè¯æ ‡å‡†"><a class="header" href="#9-å­¦ä¹ éªŒè¯æ ‡å‡†">9. å­¦ä¹ éªŒè¯æ ‡å‡†</a></h2>
<h3 id="-åŸºç¡€èƒ½åŠ›éªŒè¯"><a class="header" href="#-åŸºç¡€èƒ½åŠ›éªŒè¯">âœ… åŸºç¡€èƒ½åŠ›éªŒè¯</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
ç†è§£MapReduceç¼–ç¨‹æ¨¡å‹å’Œæ‰§è¡Œæµç¨‹</li>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿç¼–å†™ç®€å•çš„WordCountç¨‹åº</li>
<li><input disabled="" type="checkbox"/>
æŒæ¡Mapperã€Reducerã€Driverçš„å¼€å‘</li>
<li><input disabled="" type="checkbox"/>
ç†è§£Shuffleè¿‡ç¨‹</li>
</ul>
<h3 id="-è¿›é˜¶èƒ½åŠ›éªŒè¯"><a class="header" href="#-è¿›é˜¶èƒ½åŠ›éªŒè¯">âœ… è¿›é˜¶èƒ½åŠ›éªŒè¯</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿä½¿ç”¨Combinerå’ŒPartitionerä¼˜åŒ–</li>
<li><input disabled="" type="checkbox"/>
æŒæ¡è‡ªå®šä¹‰Writableç±»å‹</li>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿå¤„ç†å¤šè¡¨Join</li>
<li><input disabled="" type="checkbox"/>
ç†è§£æ•°æ®å‹ç¼©å’Œåºåˆ—åŒ–</li>
</ul>
<h3 id="-é«˜çº§èƒ½åŠ›éªŒè¯"><a class="header" href="#-é«˜çº§èƒ½åŠ›éªŒè¯">âœ… é«˜çº§èƒ½åŠ›éªŒè¯</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½è°ƒä¼˜</li>
<li><input disabled="" type="checkbox"/>
èƒ½å¤Ÿå¤„ç†æ•°æ®å€¾æ–œé—®é¢˜</li>
<li><input disabled="" type="checkbox"/>
æŒæ¡å¤æ‚ä¸šåŠ¡åœºæ™¯å¼€å‘</li>
<li><input disabled="" type="checkbox"/>
å…·å¤‡æ•…éšœæ’æŸ¥å’Œè°ƒè¯•èƒ½åŠ›</li>
</ul>
<h2 id="10-æ‰©å±•èµ„æº"><a class="header" href="#10-æ‰©å±•èµ„æº">10. æ‰©å±•èµ„æº</a></h2>
<h3 id="å®˜æ–¹èµ„æº"><a class="header" href="#å®˜æ–¹èµ„æº">å®˜æ–¹èµ„æº</a></h3>
<ul>
<li>å®˜ç½‘: https://hadoop.apache.org/</li>
<li>æ–‡æ¡£: https://hadoop.apache.org/docs/stable/</li>
<li>GitHub: https://github.com/apache/hadoop</li>
</ul>
<h3 id="å­¦ä¹ å»ºè®®"><a class="header" href="#å­¦ä¹ å»ºè®®">å­¦ä¹ å»ºè®®</a></h3>
<ol>
<li>ä»WordCountå…¥é—¨ç†è§£MapReduce</li>
<li>æŒæ¡Mapã€Shuffleã€Reduceå„é˜¶æ®µ</li>
<li>å®è·µå„ç§ä¼˜åŒ–æŠ€å·§</li>
<li>å­¦ä¹ å¤æ‚ä¸šåŠ¡åœºæ™¯å¤„ç†</li>
<li>æ·±å…¥YARNèµ„æºè°ƒåº¦æœºåˆ¶</li>
</ol>
<h3 id="è¿›é˜¶æ–¹å‘"><a class="header" href="#è¿›é˜¶æ–¹å‘">è¿›é˜¶æ–¹å‘</a></h3>
<ul>
<li>Hadoopæºç åˆ†æ</li>
<li>YARNèµ„æºè°ƒåº¦ç®—æ³•</li>
<li>MapReduceä¼˜åŒ–å®æˆ˜</li>
<li>å‡çº§åˆ°Spark/Flink</li>
<li>å®æ—¶è®¡ç®—æ¶æ„è®¾è®¡</li>
</ul>
<h3 id="ç›¸å…³æŠ€æœ¯"><a class="header" href="#ç›¸å…³æŠ€æœ¯">ç›¸å…³æŠ€æœ¯</a></h3>
<ul>
<li>Apache Spark: å†…å­˜è®¡ç®—æ¡†æ¶</li>
<li>Apache Flink: æµæ‰¹ä¸€ä½“è®¡ç®—</li>
<li>Apache Hive: SQL on Hadoop</li>
<li>Apache Pig: æ•°æ®æµè¯­è¨€</li>
</ul>
<h3 id="æ¨èä¹¦ç±"><a class="header" href="#æ¨èä¹¦ç±">æ¨èä¹¦ç±</a></h3>
<ul>
<li>Hadoopæƒå¨æŒ‡å—</li>
<li>MapReduceè®¾è®¡æ¨¡å¼</li>
<li>Hadoopå®æˆ˜</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ç¼–ç¨‹/bigdata/7-HBase.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../ç¼–ç¨‹/c++/cmake.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ç¼–ç¨‹/bigdata/7-HBase.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../ç¼–ç¨‹/c++/cmake.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

