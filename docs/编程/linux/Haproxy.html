<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>HAProxy 负载均衡器学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="haproxy-负载均衡器学习笔记"><a class="header" href="#haproxy-负载均衡器学习笔记">HAProxy 负载均衡器学习笔记</a></h1>
<blockquote>
<p><strong>学习者定位</strong>: 适合有一定Linux基础，希望掌握负载均衡和高可用架构的运维工程师、系统架构师和后端开发人员
<strong>预期学习时长</strong>: 20-30 小时（基础到进阶）
<strong>前置知识</strong>: Linux基本操作、TCP/IP网络基础、HTTP协议理解</p>
</blockquote>
<hr />
<h2 id="一技术概览与学习路径"><a class="header" href="#一技术概览与学习路径">一、技术概览与学习路径</a></h2>
<h3 id="11-haproxy-简介"><a class="header" href="#11-haproxy-简介">1.1 HAProxy 简介</a></h3>
<p>HAProxy（High Availability Proxy）是一个免费、高效、可靠的高可用性及负载均衡解决方案，特别适用于高负载的Web站点。它实现了事件驱动、单一进程模型，支持非常大的并发连接数。</p>
<p><strong>核心特性</strong>:</p>
<ul>
<li><strong>高性能</strong>: 采用单线程、事件驱动、非阻塞模型，能在 1ms 内处理数百个请求</li>
<li><strong>高可用性</strong>: 支持健康检查和故障转移</li>
<li><strong>负载均衡</strong>: 支持 L4（TCP）和 L7（HTTP）两种负载均衡模式</li>
<li><strong>会话保持</strong>: 支持多种会话保持机制</li>
<li><strong>SSL 支持</strong>: 可以解析 HTTPS 协议并解密</li>
<li><strong>监控统计</strong>: 提供基于 Web 的统计信息页面</li>
</ul>
<p><strong>应用场景</strong>:</p>
<ul>
<li>Web 应用负载均衡</li>
<li>微服务 API 网关</li>
<li>数据库读写分离</li>
<li>TCP 服务代理</li>
<li>SSL 卸载和加速</li>
</ul>
<h3 id="12-学习路径规划"><a class="header" href="#12-学习路径规划">1.2 学习路径规划</a></h3>
<pre><code>阶段1: 基础入门（6-8小时）
├── 环境搭建与安装
├── 配置文件结构理解
├── 基本负载均衡实现
└── 健康检查机制

阶段2: 进阶应用（8-10小时）
├── 负载均衡算法深入
├── 会话保持机制
├── ACL 规则应用
└── SSL/TLS 配置

阶段3: 高级实战（10-12小时）
├── 高可用架构设计
├── 性能优化调优
├── 监控与日志分析
└── 生产环境最佳实践
</code></pre>
<h3 id="13-核心术语"><a class="header" href="#13-核心术语">1.3 核心术语</a></h3>
<div class="table-wrapper"><table><thead><tr><th>术语</th><th>说明</th><th>应用场景</th></tr></thead><tbody>
<tr><td><strong>Frontend（前端）</strong></td><td>接收客户端请求的虚拟节点</td><td>定义监听端口、ACL规则、路由策略</td></tr>
<tr><td><strong>Backend（后端）</strong></td><td>真实的服务器集群</td><td>配置真实服务器、负载均衡算法、健康检查</td></tr>
<tr><td><strong>Listen</strong></td><td>Frontend 和 Backend 的组合</td><td>简单的一对一代理场景</td></tr>
<tr><td><strong>ACL（访问控制列表）</strong></td><td>测试条件并执行相应动作</td><td>请求路由、访问控制、流量分发</td></tr>
<tr><td><strong>Stick Table</strong></td><td>会话持久化表</td><td>会话保持、流量控制、DDoS防护</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="二环境搭建实战"><a class="header" href="#二环境搭建实战">二、环境搭建实战</a></h2>
<h3 id="21-安装-haproxy"><a class="header" href="#21-安装-haproxy">2.1 安装 HAProxy</a></h3>
<h4 id="ubuntudebian-系统"><a class="header" href="#ubuntudebian-系统">Ubuntu/Debian 系统</a></h4>
<pre><code class="language-bash"># 更新软件源
sudo apt update

# 安装 HAProxy
sudo apt install haproxy -y

# 查看版本
haproxy -v
</code></pre>
<h4 id="centosrhel-系统"><a class="header" href="#centosrhel-系统">CentOS/RHEL 系统</a></h4>
<pre><code class="language-bash"># 安装 HAProxy
sudo yum install haproxy -y

# 启动并设置开机自启
sudo systemctl start haproxy
sudo systemctl enable haproxy

# 查看状态
sudo systemctl status haproxy
</code></pre>
<h4 id="编译安装最新版本"><a class="header" href="#编译安装最新版本">编译安装最新版本</a></h4>
<pre><code class="language-bash"># 安装依赖
sudo apt install build-essential libssl-dev libpcre3-dev zlib1g-dev -y

# 下载源码
cd /usr/local/src
wget http://www.haproxy.org/download/2.8/src/haproxy-2.8.0.tar.gz
tar -zxvf haproxy-2.8.0.tar.gz
cd haproxy-2.8.0

# 编译安装
make TARGET=linux-glibc USE_OPENSSL=1 USE_ZLIB=1 USE_PCRE=1
sudo make install

# 创建配置目录
sudo mkdir -p /etc/haproxy
sudo mkdir -p /var/lib/haproxy
sudo touch /var/lib/haproxy/stats

# 创建用户
sudo useradd -r -s /sbin/nologin haproxy
</code></pre>
<h3 id="22-配置文件结构详解"><a class="header" href="#22-配置文件结构详解">2.2 配置文件结构详解</a></h3>
<p>HAProxy 配置文件（<code>/etc/haproxy/haproxy.cfg</code>）包含以下核心部分：</p>
<h4 id="global-全局配置段"><a class="header" href="#global-全局配置段">Global 全局配置段</a></h4>
<pre><code class="language-conf">global
    log 127.0.0.1 local2          # 全局日志配置，发送到本地 syslog
    chroot /var/lib/haproxy        # chroot 运行路径，增加安全性
    pidfile /var/run/haproxy.pid   # HAProxy 的 PID 存放路径
    maxconn 4000                   # 默认最大连接数
    user haproxy                   # 运行用户
    group haproxy                  # 运行用户组
    daemon                         # 以守护进程方式运行
    stats socket /var/lib/haproxy/stats level admin  # 管理套接字
</code></pre>
<h4 id="defaults-默认配置段"><a class="header" href="#defaults-默认配置段">Defaults 默认配置段</a></h4>
<pre><code class="language-conf">defaults
    mode http                      # 默认模式（tcp|http|health）
    log global                     # 应用全局日志配置
    option httplog                 # 启用 HTTP 请求日志记录
    option dontlognull            # 不记录空连接日志
    option http-server-close      # 每次请求完毕后主动关闭 HTTP 通道
    option forwardfor             # 添加 X-Forwarded-For 头部
    option redispatch             # 服务器故障时强制重新分配
    retries 3                     # 连接失败重试次数
    timeout http-request 10s      # HTTP 请求超时时间
    timeout queue 1m              # 队列超时时间
    timeout connect 10s           # 连接超时时间
    timeout client 1m             # 客户端超时时间
    timeout server 1m             # 服务器超时时间
    timeout http-keep-alive 10s   # HTTP 长连接超时
    timeout check 10s             # 健康检查超时时间
</code></pre>
<h3 id="23-第一个实战案例基础负载均衡"><a class="header" href="#23-第一个实战案例基础负载均衡">2.3 第一个实战案例：基础负载均衡</a></h3>
<p><strong>场景</strong>: 部署 3 台 Web 服务器，使用 HAProxy 实现轮询负载均衡</p>
<h4 id="步骤-1-准备测试环境"><a class="header" href="#步骤-1-准备测试环境">步骤 1: 准备测试环境</a></h4>
<pre><code class="language-bash"># 在 3 台服务器上分别安装 Nginx（或使用 Docker）
# 服务器 1: 192.168.1.10
# 服务器 2: 192.168.1.11
# 服务器 3: 192.168.1.12

# 使用 Docker 快速搭建测试环境
docker run -d --name web1 -p 8081:80 nginx
docker run -d --name web2 -p 8082:80 nginx
docker run -d --name web3 -p 8083:80 nginx

# 为每个容器创建不同的首页（便于区分）
docker exec web1 sh -c 'echo "Server 1" &gt; /usr/share/nginx/html/index.html'
docker exec web2 sh -c 'echo "Server 2" &gt; /usr/share/nginx/html/index.html'
docker exec web3 sh -c 'echo "Server 3" &gt; /usr/share/nginx/html/index.html'
</code></pre>
<h4 id="步骤-2-配置-haproxy"><a class="header" href="#步骤-2-配置-haproxy">步骤 2: 配置 HAProxy</a></h4>
<p>创建配置文件 <code>/etc/haproxy/haproxy.cfg</code>:</p>
<pre><code class="language-conf">global
    log 127.0.0.1 local2
    chroot /var/lib/haproxy
    pidfile /var/run/haproxy.pid
    maxconn 4000
    user haproxy
    group haproxy
    daemon
    stats socket /var/lib/haproxy/stats

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout http-request 10s
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    timeout http-keep-alive 10s
    timeout check 10s
    maxconn 3000

# 前端配置：监听 80 端口
frontend web_frontend
    bind *:80
    default_backend web_servers

# 后端配置：3 台 Web 服务器
backend web_servers
    balance roundrobin              # 轮询算法
    option httpchk GET /            # 健康检查：GET 请求根路径
    http-check expect status 200    # 期望返回 200 状态码
    server web1 127.0.0.1:8081 check inter 3s rise 2 fall 3
    server web2 127.0.0.1:8082 check inter 3s rise 2 fall 3
    server web3 127.0.0.1:8083 check inter 3s rise 2 fall 3
</code></pre>
<p><strong>参数说明</strong>:</p>
<ul>
<li><code>check</code>: 启用健康检查</li>
<li><code>inter 3s</code>: 每 3 秒检查一次</li>
<li><code>rise 2</code>: 连续 2 次成功则标记为 UP</li>
<li><code>fall 3</code>: 连续 3 次失败则标记为 DOWN</li>
</ul>
<h4 id="步骤-3-验证配置并启动"><a class="header" href="#步骤-3-验证配置并启动">步骤 3: 验证配置并启动</a></h4>
<pre><code class="language-bash"># 验证配置文件语法
sudo haproxy -f /etc/haproxy/haproxy.cfg -c

# 重启 HAProxy
sudo systemctl restart haproxy

# 查看状态
sudo systemctl status haproxy
</code></pre>
<h4 id="步骤-4-测试负载均衡"><a class="header" href="#步骤-4-测试负载均衡">步骤 4: 测试负载均衡</a></h4>
<pre><code class="language-bash"># 多次访问，观察轮询效果
for i in {1..9}; do
    curl http://localhost
    echo ""
done

# 预期输出：
# Server 1
# Server 2
# Server 3
# Server 1
# Server 2
# Server 3
# ...
</code></pre>
<hr />
<h2 id="三负载均衡算法深入"><a class="header" href="#三负载均衡算法深入">三、负载均衡算法深入</a></h2>
<h3 id="31-算法对比与选择"><a class="header" href="#31-算法对比与选择">3.1 算法对比与选择</a></h3>
<div class="table-wrapper"><table><thead><tr><th>算法</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody>
<tr><td><strong>roundrobin</strong></td><td>服务器性能相近</td><td>简单公平，支持权重</td><td>不考虑服务器负载</td></tr>
<tr><td><strong>leastconn</strong></td><td>长连接场景</td><td>均衡连接数</td><td>计算开销较大</td></tr>
<tr><td><strong>source</strong></td><td>需要会话保持</td><td>简单有效的会话保持</td><td>分布可能不均</td></tr>
<tr><td><strong>uri</strong></td><td>缓存场景</td><td>提高缓存命中率</td><td>热点数据可能集中</td></tr>
<tr><td><strong>hdr</strong></td><td>基于 Header 路由</td><td>灵活的路由策略</td><td>配置相对复杂</td></tr>
</tbody></table>
</div>
<h3 id="32-实战案例不同算法应用"><a class="header" href="#32-实战案例不同算法应用">3.2 实战案例：不同算法应用</a></h3>
<h4 id="案例-1-基于权重的轮询适合服务器性能不同"><a class="header" href="#案例-1-基于权重的轮询适合服务器性能不同">案例 1: 基于权重的轮询（适合服务器性能不同）</a></h4>
<pre><code class="language-conf">backend web_servers
    balance roundrobin
    option httpchk GET /health
    server web1 192.168.1.10:80 check weight 1   # 性能较低
    server web2 192.168.1.11:80 check weight 2   # 性能中等
    server web3 192.168.1.12:80 check weight 3   # 性能较高
</code></pre>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 发送 60 次请求，统计分布
for i in {1..60}; do curl -s http://localhost; done | sort | uniq -c

# 预期结果（大约）：
# 10 Server 1
# 20 Server 2
# 30 Server 3
</code></pre>
<h4 id="案例-2-最少连接算法适合长连接"><a class="header" href="#案例-2-最少连接算法适合长连接">案例 2: 最少连接算法（适合长连接）</a></h4>
<pre><code class="language-conf">backend api_servers
    balance leastconn
    option httpchk GET /api/health
    server api1 192.168.1.20:8080 check
    server api2 192.168.1.21:8080 check
    server api3 192.168.1.22:8080 check
</code></pre>
<p><strong>应用场景</strong>: WebSocket 连接、长轮询、流媒体服务</p>
<h4 id="案例-3-源地址哈希会话保持"><a class="header" href="#案例-3-源地址哈希会话保持">案例 3: 源地址哈希（会话保持）</a></h4>
<pre><code class="language-conf">backend app_servers
    balance source
    hash-type consistent    # 使用一致性哈希，减少扩容时的影响
    option httpchk GET /health
    server app1 192.168.1.30:8080 check
    server app2 192.168.1.31:8080 check
    server app3 192.168.1.32:8080 check
</code></pre>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 同一客户端多次请求应该访问同一台服务器
for i in {1..10}; do curl http://localhost; done

# 不同客户端访问（通过代理模拟）
curl -H "X-Forwarded-For: 1.1.1.1" http://localhost
curl -H "X-Forwarded-For: 2.2.2.2" http://localhost
</code></pre>
<h4 id="案例-4-uri-哈希缓存优化"><a class="header" href="#案例-4-uri-哈希缓存优化">案例 4: URI 哈希（缓存优化）</a></h4>
<pre><code class="language-conf">backend cache_servers
    balance uri
    hash-type consistent
    option httpchk GET /health
    server cache1 192.168.1.40:80 check
    server cache2 192.168.1.41:80 check
    server cache3 192.168.1.42:80 check
</code></pre>
<p><strong>应用场景</strong>: CDN 缓存、静态资源服务器、对象存储代理</p>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 相同 URI 应该访问同一台服务器
for i in {1..5}; do curl http://localhost/image/photo1.jpg; done
for i in {1..5}; do curl http://localhost/image/photo2.jpg; done
</code></pre>
<hr />
<h2 id="四会话保持与-cookie-机制"><a class="header" href="#四会话保持与-cookie-机制">四、会话保持与 Cookie 机制</a></h2>
<h3 id="41-会话保持策略对比"><a class="header" href="#41-会话保持策略对比">4.1 会话保持策略对比</a></h3>
<div class="table-wrapper"><table><thead><tr><th>策略</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody>
<tr><td><strong>source</strong></td><td>IP 哈希</td><td>配置简单</td><td>NAT 环境失效</td></tr>
<tr><td><strong>cookie</strong></td><td>Cookie 插入</td><td>精确可靠</td><td>需要支持 Cookie</td></tr>
<tr><td><strong>stick-table</strong></td><td>会话表</td><td>灵活强大</td><td>内存消耗</td></tr>
<tr><td><strong>url_param</strong></td><td>URL 参数</td><td>无需 Cookie</td><td>URL 暴露参数</td></tr>
</tbody></table>
</div>
<h3 id="42-实战案例cookie-会话保持"><a class="header" href="#42-实战案例cookie-会话保持">4.2 实战案例：Cookie 会话保持</a></h3>
<h4 id="案例-1-cookie-insert-模式"><a class="header" href="#案例-1-cookie-insert-模式">案例 1: Cookie Insert 模式</a></h4>
<pre><code class="language-conf">backend web_servers
    balance roundrobin
    # HAProxy 插入自己的 Cookie
    cookie SERVERID insert indirect nocache
    server web1 192.168.1.10:80 check cookie web1
    server web2 192.168.1.11:80 check cookie web2
    server web3 192.168.1.12:80 check cookie web3
</code></pre>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 第一次请求
curl -c cookies.txt http://localhost

# 查看 Cookie
cat cookies.txt
# 应该看到：SERVERID=web1 或 web2 或 web3

# 后续请求带上 Cookie
curl -b cookies.txt http://localhost
# 应该始终访问同一台服务器
</code></pre>
<h4 id="案例-2-cookie-prefix-模式"><a class="header" href="#案例-2-cookie-prefix-模式">案例 2: Cookie Prefix 模式</a></h4>
<pre><code class="language-conf">backend web_servers
    balance roundrobin
    # 在后端服务器的 Cookie 前添加前缀
    cookie JSESSIONID prefix nocache
    server web1 192.168.1.10:80 check cookie web1
    server web2 192.168.1.11:80 check cookie web2
    server web3 192.168.1.12:80 check cookie web3
</code></pre>
<p><strong>应用场景</strong>: 后端应用已有 Session Cookie（如 JSESSIONID）</p>
<h3 id="43-实战案例stick-table-会话保持"><a class="header" href="#43-实战案例stick-table-会话保持">4.3 实战案例：Stick Table 会话保持</a></h3>
<pre><code class="language-conf">backend web_servers
    balance roundrobin
    # 创建 Stick Table，基于源 IP 保持会话
    stick-table type ip size 200k expire 30m
    stick on src
    server web1 192.168.1.10:80 check
    server web2 192.168.1.11:80 check
    server web3 192.168.1.12:80 check
</code></pre>
<p><strong>高级应用：基于 Header 的会话保持</strong></p>
<pre><code class="language-conf">backend api_servers
    balance roundrobin
    # 基于用户 Token 保持会话
    stick-table type string len 32 size 100k expire 30m
    stick on hdr(Authorization)
    server api1 192.168.1.20:8080 check
    server api2 192.168.1.21:8080 check
</code></pre>
<hr />
<h2 id="五acl-规则与智能路由"><a class="header" href="#五acl-规则与智能路由">五、ACL 规则与智能路由</a></h2>
<h3 id="51-acl-规则语法"><a class="header" href="#51-acl-规则语法">5.1 ACL 规则语法</a></h3>
<p><strong>基本语法</strong>:</p>
<pre><code class="language-conf">acl &lt;ACL名称&gt; &lt;ACL条件&gt; &lt;匹配模式&gt;
</code></pre>
<p><strong>常用条件</strong>:</p>
<ul>
<li><code>path_beg</code>: URL 路径开头匹配</li>
<li><code>path_end</code>: URL 路径结尾匹配</li>
<li><code>hdr(header)</code>: HTTP 头部匹配</li>
<li><code>url_param(param)</code>: URL 参数匹配</li>
<li><code>src</code>: 源 IP 地址匹配</li>
<li><code>method</code>: HTTP 方法匹配</li>
</ul>
<h3 id="52-实战案例基于路径的路由"><a class="header" href="#52-实战案例基于路径的路由">5.2 实战案例：基于路径的路由</a></h3>
<pre><code class="language-conf">frontend web_frontend
    bind *:80

    # 定义 ACL 规则
    acl is_api path_beg /api
    acl is_static path_beg /static /images /css /js
    acl is_admin path_beg /admin
    acl is_websocket hdr(Upgrade) -i websocket

    # 路由规则
    use_backend api_servers if is_api
    use_backend static_servers if is_static
    use_backend admin_servers if is_admin
    use_backend websocket_servers if is_websocket
    default_backend web_servers

backend api_servers
    balance roundrobin
    server api1 192.168.1.20:8080 check

backend static_servers
    balance roundrobin
    server static1 192.168.1.30:80 check

backend admin_servers
    balance source    # 管理后台使用 IP 哈希
    server admin1 192.168.1.40:8080 check

backend websocket_servers
    balance leastconn
    option http-server-close
    server ws1 192.168.1.50:8080 check

backend web_servers
    balance roundrobin
    server web1 192.168.1.10:80 check
</code></pre>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 测试 API 路由
curl http://localhost/api/users

# 测试静态资源路由
curl http://localhost/static/logo.png

# 测试管理后台路由
curl http://localhost/admin/dashboard
</code></pre>
<h3 id="53-实战案例基于域名的虚拟主机"><a class="header" href="#53-实战案例基于域名的虚拟主机">5.3 实战案例：基于域名的虚拟主机</a></h3>
<pre><code class="language-conf">frontend web_frontend
    bind *:80

    # 基于域名的 ACL
    acl is_api_domain hdr(host) -i api.example.com
    acl is_www_domain hdr(host) -i www.example.com
    acl is_admin_domain hdr(host) -i admin.example.com

    # 路由到不同后端
    use_backend api_servers if is_api_domain
    use_backend www_servers if is_www_domain
    use_backend admin_servers if is_admin_domain
    default_backend default_servers

backend api_servers
    balance roundrobin
    server api1 192.168.1.20:8080 check

backend www_servers
    balance roundrobin
    server www1 192.168.1.10:80 check
    server www2 192.168.1.11:80 check

backend admin_servers
    balance source
    server admin1 192.168.1.40:8080 check
</code></pre>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 模拟不同域名访问
curl -H "Host: api.example.com" http://localhost
curl -H "Host: www.example.com" http://localhost
curl -H "Host: admin.example.com" http://localhost
</code></pre>
<h3 id="54-实战案例移动端与pc端分流"><a class="header" href="#54-实战案例移动端与pc端分流">5.4 实战案例：移动端与PC端分流</a></h3>
<pre><code class="language-conf">frontend web_frontend
    bind *:80

    # 移动设备检测
    acl is_mobile hdr_sub(user-agent) -i mobile iphone android
    acl is_tablet hdr_sub(user-agent) -i ipad tablet

    # 路由规则
    use_backend mobile_servers if is_mobile
    use_backend tablet_servers if is_tablet
    default_backend pc_servers

backend mobile_servers
    balance roundrobin
    server mobile1 192.168.1.60:80 check

backend tablet_servers
    balance roundrobin
    server tablet1 192.168.1.70:80 check

backend pc_servers
    balance roundrobin
    server pc1 192.168.1.10:80 check
</code></pre>
<h3 id="55-实战案例访问控制与安全防护"><a class="header" href="#55-实战案例访问控制与安全防护">5.5 实战案例：访问控制与安全防护</a></h3>
<pre><code class="language-conf">frontend web_frontend
    bind *:80

    # IP 白名单
    acl allowed_ips src 192.168.1.0/24 10.0.0.0/8

    # 恶意请求特征
    acl is_sql_injection url_sub -i select union insert update delete
    acl is_path_traversal path_sub -i ../
    acl is_scanner hdr_sub(user-agent) -i nmap sqlmap nikto

    # 限制 HTTP 方法
    acl valid_method method GET POST PUT DELETE

    # 安全规则
    http-request deny if is_sql_injection
    http-request deny if is_path_traversal
    http-request deny if is_scanner
    http-request deny unless valid_method

    # 管理后台仅允许白名单访问
    acl is_admin path_beg /admin
    http-request deny if is_admin !allowed_ips

    default_backend web_servers
</code></pre>
<hr />
<h2 id="六健康检查机制"><a class="header" href="#六健康检查机制">六、健康检查机制</a></h2>
<h3 id="61-健康检查类型"><a class="header" href="#61-健康检查类型">6.1 健康检查类型</a></h3>
<div class="table-wrapper"><table><thead><tr><th>类型</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody>
<tr><td><strong>TCP 检查</strong></td><td>端口可达性</td><td>简单快速</td><td>无法检测应用状态</td></tr>
<tr><td><strong>HTTP 检查</strong></td><td>Web 应用</td><td>可检测应用健康</td><td>开销较大</td></tr>
<tr><td><strong>自定义检查</strong></td><td>复杂应用</td><td>精确可控</td><td>需要开发健康检查接口</td></tr>
</tbody></table>
</div>
<h3 id="62-实战案例多层次健康检查"><a class="header" href="#62-实战案例多层次健康检查">6.2 实战案例：多层次健康检查</a></h3>
<h4 id="基础-tcp-检查"><a class="header" href="#基础-tcp-检查">基础 TCP 检查</a></h4>
<pre><code class="language-conf">backend web_servers
    option tcp-check
    server web1 192.168.1.10:80 check inter 2s rise 2 fall 3
</code></pre>
<h4 id="http-状态码检查"><a class="header" href="#http-状态码检查">HTTP 状态码检查</a></h4>
<pre><code class="language-conf">backend web_servers
    option httpchk GET /health
    http-check expect status 200
    server web1 192.168.1.10:80 check inter 3s rise 2 fall 3
</code></pre>
<h4 id="http-内容检查"><a class="header" href="#http-内容检查">HTTP 内容检查</a></h4>
<pre><code class="language-conf">backend api_servers
    option httpchk GET /api/health
    http-check expect string "healthy"
    server api1 192.168.1.20:8080 check inter 5s rise 2 fall 3
</code></pre>
<h4 id="完整的健康检查配置"><a class="header" href="#完整的健康检查配置">完整的健康检查配置</a></h4>
<pre><code class="language-conf">backend web_servers
    # HTTP 健康检查
    option httpchk GET /health HTTP/1.1\r\nHost:\ example.com
    http-check expect status 200
    http-check expect string "OK"

    # 健康检查参数
    # inter: 检查间隔
    # rise: 连续成功次数后标记为 UP
    # fall: 连续失败次数后标记为 DOWN
    # slowstart: 慢启动时间（逐步增加权重）
    server web1 192.168.1.10:80 check inter 3s rise 2 fall 3 slowstart 60s
    server web2 192.168.1.11:80 check inter 3s rise 2 fall 3 slowstart 60s
</code></pre>
<h3 id="63-实战案例数据库健康检查"><a class="header" href="#63-实战案例数据库健康检查">6.3 实战案例：数据库健康检查</a></h3>
<pre><code class="language-conf"># MySQL 主从架构
backend mysql_master
    mode tcp
    option tcp-check
    tcp-check connect port 3306
    tcp-check send-binary 00    # MySQL 握手
    server mysql-master 192.168.1.100:3306 check inter 5s

backend mysql_slaves
    mode tcp
    balance leastconn
    option tcp-check
    tcp-check connect port 3306
    server mysql-slave1 192.168.1.101:3306 check inter 5s
    server mysql-slave2 192.168.1.102:3306 check inter 5s
</code></pre>
<hr />
<h2 id="七ssltls-配置"><a class="header" href="#七ssltls-配置">七、SSL/TLS 配置</a></h2>
<h3 id="71-ssl-工作模式"><a class="header" href="#71-ssl-工作模式">7.1 SSL 工作模式</a></h3>
<div class="table-wrapper"><table><thead><tr><th>模式</th><th>说明</th><th>应用场景</th></tr></thead><tbody>
<tr><td><strong>SSL 终止</strong></td><td>HAProxy 解密，后端 HTTP</td><td>减轻后端负载，集中证书管理</td></tr>
<tr><td><strong>SSL 透传</strong></td><td>直接转发加密流量</td><td>端到端加密，后端自己解密</td></tr>
<tr><td><strong>SSL 桥接</strong></td><td>HAProxy 解密后重新加密</td><td>内网也需要加密</td></tr>
</tbody></table>
</div>
<h3 id="72-实战案例ssl-终止"><a class="header" href="#72-实战案例ssl-终止">7.2 实战案例：SSL 终止</a></h3>
<h4 id="步骤-1-准备-ssl-证书"><a class="header" href="#步骤-1-准备-ssl-证书">步骤 1: 准备 SSL 证书</a></h4>
<pre><code class="language-bash"># 自签名证书（测试用）
sudo mkdir -p /etc/haproxy/certs
cd /etc/haproxy/certs

# 生成私钥和证书
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout example.com.key -out example.com.crt \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=Example/CN=example.com"

# 合并证书和私钥（HAProxy 要求）
sudo cat example.com.crt example.com.key &gt; example.com.pem

# 设置权限
sudo chmod 600 example.com.pem
</code></pre>
<h4 id="步骤-2-配置-haproxy-1"><a class="header" href="#步骤-2-配置-haproxy-1">步骤 2: 配置 HAProxy</a></h4>
<pre><code class="language-conf">frontend https_frontend
    bind *:443 ssl crt /etc/haproxy/certs/example.com.pem

    # HTTP 重定向到 HTTPS
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }

    # 安全头部
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff

    default_backend web_servers

backend web_servers
    balance roundrobin
    server web1 192.168.1.10:80 check
    server web2 192.168.1.11:80 check
</code></pre>
<h4 id="步骤-3-测试-https"><a class="header" href="#步骤-3-测试-https">步骤 3: 测试 HTTPS</a></h4>
<pre><code class="language-bash"># 测试 HTTPS 访问
curl -k https://localhost

# 测试 HTTP 重定向
curl -I http://localhost
# 应该看到 301 重定向到 https://
</code></pre>
<h3 id="73-实战案例多域名-sni-支持"><a class="header" href="#73-实战案例多域名-sni-支持">7.3 实战案例：多域名 SNI 支持</a></h3>
<pre><code class="language-conf">frontend https_frontend
    # 支持多个域名证书
    bind *:443 ssl crt /etc/haproxy/certs/

    # 基于 SNI 路由
    acl is_api_domain ssl_fc_sni -i api.example.com
    acl is_www_domain ssl_fc_sni -i www.example.com

    use_backend api_servers if is_api_domain
    use_backend www_servers if is_www_domain
    default_backend web_servers
</code></pre>
<h3 id="74-ssl-性能优化"><a class="header" href="#74-ssl-性能优化">7.4 SSL 性能优化</a></h3>
<pre><code class="language-conf">global
    # SSL 优化
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

frontend https_frontend
    bind *:443 ssl crt /etc/haproxy/certs/example.com.pem alpn h2,http/1.1

    # 启用 HTTP/2
    http-response set-header Alt-Svc 'h2=":443"'

    default_backend web_servers
</code></pre>
<hr />
<h2 id="八监控与统计"><a class="header" href="#八监控与统计">八、监控与统计</a></h2>
<h3 id="81-启用统计页面"><a class="header" href="#81-启用统计页面">8.1 启用统计页面</a></h3>
<pre><code class="language-conf">listen stats
    bind *:8080
    stats enable
    stats uri /haproxy-stats          # 访问路径
    stats realm "HAProxy Statistics"   # 认证域
    stats auth admin:password123       # 用户名:密码
    stats refresh 30s                  # 自动刷新间隔
    stats show-legends                 # 显示图例
    stats show-node                    # 显示节点名称
    stats admin if TRUE                # 启用管理功能
</code></pre>
<p><strong>访问统计页面</strong>:</p>
<pre><code>http://your-server:8080/haproxy-stats
用户名: admin
密码: password123
</code></pre>
<h3 id="82-日志配置与分析"><a class="header" href="#82-日志配置与分析">8.2 日志配置与分析</a></h3>
<h4 id="配置-syslog"><a class="header" href="#配置-syslog">配置 Syslog</a></h4>
<pre><code class="language-bash"># Ubuntu/Debian
sudo vi /etc/rsyslog.d/49-haproxy.conf

# 添加以下内容
$ModLoad imudp
$UDPServerRun 514
$UDPServerAddress 127.0.0.1

local2.*    /var/log/haproxy.log

# 重启 rsyslog
sudo systemctl restart rsyslog
</code></pre>
<h4 id="日志分析"><a class="header" href="#日志分析">日志分析</a></h4>
<pre><code class="language-bash"># 实时查看日志
sudo tail -f /var/log/haproxy.log

# 统计访问最多的 IP
sudo awk '{print $6}' /var/log/haproxy.log | sort | uniq -c | sort -rn | head -10

# 统计响应时间
sudo awk '{print $10}' /var/log/haproxy.log | awk -F'/' '{print $5}' | sort -n

# 统计 HTTP 状态码
sudo awk '{print $11}' /var/log/haproxy.log | sort | uniq -c | sort -rn
</code></pre>
<h3 id="83-prometheus-集成"><a class="header" href="#83-prometheus-集成">8.3 Prometheus 集成</a></h3>
<h4 id="启用-prometheus-exporter"><a class="header" href="#启用-prometheus-exporter">启用 Prometheus Exporter</a></h4>
<pre><code class="language-conf">frontend prometheus
    bind *:8404
    http-request use-service prometheus-exporter if { path /metrics }
    stats enable
    stats uri /stats
    stats refresh 10s
</code></pre>
<h4 id="prometheus-配置"><a class="header" href="#prometheus-配置">Prometheus 配置</a></h4>
<pre><code class="language-yaml">scrape_configs:
  - job_name: 'haproxy'
    static_configs:
      - targets: ['haproxy-server:8404']
</code></pre>
<hr />
<h2 id="九高可用架构"><a class="header" href="#九高可用架构">九、高可用架构</a></h2>
<h3 id="91-使用-keepalived-实现主备"><a class="header" href="#91-使用-keepalived-实现主备">9.1 使用 Keepalived 实现主备</a></h3>
<h4 id="架构设计"><a class="header" href="#架构设计">架构设计</a></h4>
<pre><code>                   虚拟 IP: 192.168.1.100
                           |
        +------------------+------------------+
        |                                     |
   HAProxy Master                        HAProxy Backup
   192.168.1.101                         192.168.1.102
   (Priority 100)                        (Priority 90)
        |                                     |
        +------------------+------------------+
                           |
                    Backend Servers
            (192.168.1.10, .11, .12)
</code></pre>
<h4 id="安装-keepalived"><a class="header" href="#安装-keepalived">安装 Keepalived</a></h4>
<pre><code class="language-bash">sudo apt install keepalived -y
</code></pre>
<h4 id="主节点配置-etckeepalivedkeepalivedconf"><a class="header" href="#主节点配置-etckeepalivedkeepalivedconf">主节点配置 (<code>/etc/keepalived/keepalived.conf</code>)</a></h4>
<pre><code class="language-conf">vrrp_script check_haproxy {
    script "killall -0 haproxy"
    interval 2
    weight 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0              # 网卡名称
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass haproxy123
    }
    virtual_ipaddress {
        192.168.1.100/24
    }
    track_script {
        check_haproxy
    }
}
</code></pre>
<h4 id="备节点配置"><a class="header" href="#备节点配置">备节点配置</a></h4>
<pre><code class="language-conf">vrrp_script check_haproxy {
    script "killall -0 haproxy"
    interval 2
    weight 2
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 90                 # 优先级低于主节点
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass haproxy123
    }
    virtual_ipaddress {
        192.168.1.100/24
    }
    track_script {
        check_haproxy
    }
}
</code></pre>
<h4 id="启动服务"><a class="header" href="#启动服务">启动服务</a></h4>
<pre><code class="language-bash"># 在两个节点上分别启动
sudo systemctl start keepalived
sudo systemctl enable keepalived

# 检查虚拟 IP
ip addr show eth0
</code></pre>
<h4 id="测试故障转移"><a class="header" href="#测试故障转移">测试故障转移</a></h4>
<pre><code class="language-bash"># 在主节点停止 HAProxy
sudo systemctl stop haproxy

# 等待几秒后，在备节点检查 VIP
ip addr show eth0
# 应该看到 VIP 漂移到备节点

# 测试访问
curl http://192.168.1.100
</code></pre>
<hr />
<h2 id="十性能优化与调优"><a class="header" href="#十性能优化与调优">十、性能优化与调优</a></h2>
<h3 id="101-系统参数优化"><a class="header" href="#101-系统参数优化">10.1 系统参数优化</a></h3>
<pre><code class="language-bash"># 编辑 /etc/sysctl.conf
sudo vi /etc/sysctl.conf

# 添加以下参数
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.ip_local_port_range = 1024 65023
net.ipv4.tcp_max_syn_backlog = 10240
net.ipv4.tcp_max_tw_buckets = 400000
net.ipv4.tcp_max_orphans = 60000
net.ipv4.tcp_synack_retries = 3
net.core.somaxconn = 10000
net.core.netdev_max_backlog = 10000

# 应用配置
sudo sysctl -p
</code></pre>
<h3 id="102-haproxy-性能参数"><a class="header" href="#102-haproxy-性能参数">10.2 HAProxy 性能参数</a></h3>
<pre><code class="language-conf">global
    maxconn 100000              # 全局最大连接数
    nbproc 4                    # 多进程模式（4核CPU）
    cpu-map 1 0                 # 进程 CPU 绑定
    cpu-map 2 1
    cpu-map 3 2
    cpu-map 4 3

    # 优化缓冲区
    tune.bufsize 32768
    tune.maxrewrite 8192

    # SSL 优化
    tune.ssl.default-dh-param 2048
    tune.ssl.cachesize 100000

defaults
    maxconn 50000               # 默认最大连接数
    option abortonclose         # 高负载时自动结束长时间队列连接
    option tcp-smart-accept     # 延迟接受，减少无效连接
    option tcp-smart-connect    # 延迟连接，优化后端连接
</code></pre>
<h3 id="103-性能测试"><a class="header" href="#103-性能测试">10.3 性能测试</a></h3>
<h4 id="使用-ab-apache-bench"><a class="header" href="#使用-ab-apache-bench">使用 ab (Apache Bench)</a></h4>
<pre><code class="language-bash"># 安装 ab
sudo apt install apache2-utils -y

# 测试
ab -n 10000 -c 100 http://localhost/
</code></pre>
<h4 id="使用-wrk"><a class="header" href="#使用-wrk">使用 wrk</a></h4>
<pre><code class="language-bash"># 安装 wrk
sudo apt install wrk -y

# 测试
wrk -t4 -c100 -d30s http://localhost/

# 输出：
# Running 30s test @ http://localhost/
#   4 threads and 100 connections
#   Requests/sec:  12345.67
#   Transfer/sec:  1.23MB
</code></pre>
<h3 id="104-监控关键指标"><a class="header" href="#104-监控关键指标">10.4 监控关键指标</a></h3>
<pre><code class="language-bash"># 查看连接数
echo "show stat" | socat stdio /var/lib/haproxy/stats | cut -d',' -f1,2,5,6,8,18

# 查看当前会话
echo "show sess" | socat stdio /var/lib/haproxy/stats

# 查看错误
echo "show errors" | socat stdio /var/lib/haproxy/stats
</code></pre>
<hr />
<h2 id="十一生产环境最佳实践"><a class="header" href="#十一生产环境最佳实践">十一、生产环境最佳实践</a></h2>
<h3 id="111-安全加固"><a class="header" href="#111-安全加固">11.1 安全加固</a></h3>
<pre><code class="language-conf">frontend web_frontend
    bind *:443 ssl crt /etc/haproxy/certs/ alpn h2,http/1.1

    # 隐藏版本信息
    http-response del-header Server
    http-response set-header Server "WebServer"

    # 安全头部
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000"

    # 限流防护
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # IP 黑名单
    acl blacklist src -f /etc/haproxy/blacklist.txt
    http-request deny if blacklist

    default_backend web_servers
</code></pre>
<h3 id="112-配置管理流程"><a class="header" href="#112-配置管理流程">11.2 配置管理流程</a></h3>
<pre><code class="language-bash"># 1. 备份当前配置
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak.$(date +%Y%m%d_%H%M%S)

# 2. 修改配置后验证
sudo haproxy -f /etc/haproxy/haproxy.cfg -c

# 3. 平滑重载（不中断服务）
sudo systemctl reload haproxy

# 4. 验证重载是否成功
sudo systemctl status haproxy

# 5. 如果失败，回滚
sudo cp /etc/haproxy/haproxy.cfg.bak.XXXXXX /etc/haproxy/haproxy.cfg
sudo systemctl reload haproxy
</code></pre>
<h3 id="113-监控告警"><a class="header" href="#113-监控告警">11.3 监控告警</a></h3>
<p><strong>关键监控指标</strong>:</p>
<ul>
<li>当前连接数 / 最大连接数（超过 80% 告警）</li>
<li>后端服务器状态（DOWN 状态告警）</li>
<li>请求速率（QPS）</li>
<li>平均响应时间（超过阈值告警）</li>
<li>错误率（5xx 错误超过 1% 告警）</li>
<li>队列长度（有请求排队告警）</li>
</ul>
<h3 id="114-故障排查清单"><a class="header" href="#114-故障排查清单">11.4 故障排查清单</a></h3>
<div class="table-wrapper"><table><thead><tr><th>问题</th><th>排查步骤</th><th>解决方案</th></tr></thead><tbody>
<tr><td><strong>503 错误</strong></td><td>检查后端服务器状态</td><td>修复后端服务，调整健康检查参数</td></tr>
<tr><td><strong>连接超时</strong></td><td>检查 timeout 配置</td><td>增加 timeout 时间，优化后端性能</td></tr>
<tr><td><strong>性能下降</strong></td><td>检查连接数、CPU、内存</td><td>扩容、优化参数、启用多进程</td></tr>
<tr><td><strong>会话丢失</strong></td><td>检查会话保持配置</td><td>启用 Cookie 或 Stick Table</td></tr>
<tr><td><strong>SSL 错误</strong></td><td>检查证书有效期和配置</td><td>更新证书，检查 cipher 配置</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="十二完整生产环境示例"><a class="header" href="#十二完整生产环境示例">十二、完整生产环境示例</a></h2>
<h3 id="121-电商网站架构"><a class="header" href="#121-电商网站架构">12.1 电商网站架构</a></h3>
<pre><code class="language-conf">global
    log 127.0.0.1 local2
    chroot /var/lib/haproxy
    pidfile /var/run/haproxy.pid
    maxconn 50000
    user haproxy
    group haproxy
    daemon
    stats socket /var/lib/haproxy/stats level admin

    # SSL 优化
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout http-request 10s
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    timeout http-keep-alive 10s
    timeout check 10s
    maxconn 30000

# 统计页面
listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats realm HAProxy\ Statistics
    stats auth admin:Admin@2024
    stats refresh 30s
    stats admin if TRUE

# HTTPS 前端
frontend https_frontend
    bind *:443 ssl crt /etc/haproxy/certs/ alpn h2,http/1.1
    bind *:80

    # HTTP 重定向到 HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

    # 安全头部
    http-response set-header Strict-Transport-Security "max-age=31536000"
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff

    # 限流
    stick-table type ip size 100k expire 30s store http_req_rate(10s),conn_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 200 }

    # ACL 规则
    acl is_api path_beg /api
    acl is_static path_beg /static /images /css /js
    acl is_order path_beg /order
    acl is_payment path_beg /payment
    acl is_mobile hdr_sub(user-agent) -i mobile

    # 路由
    use_backend api_servers if is_api
    use_backend static_servers if is_static
    use_backend order_servers if is_order
    use_backend payment_servers if is_payment
    use_backend mobile_servers if is_mobile
    default_backend web_servers

# Web 服务器集群
backend web_servers
    balance roundrobin
    cookie SERVERID insert indirect nocache
    option httpchk GET /health
    http-check expect status 200
    server web1 192.168.1.10:80 check cookie web1 inter 3s rise 2 fall 3
    server web2 192.168.1.11:80 check cookie web2 inter 3s rise 2 fall 3
    server web3 192.168.1.12:80 check cookie web3 inter 3s rise 2 fall 3

# API 服务器集群
backend api_servers
    balance leastconn
    option httpchk GET /api/health
    http-check expect string "healthy"
    server api1 192.168.1.20:8080 check inter 3s
    server api2 192.168.1.21:8080 check inter 3s
    server api3 192.168.1.22:8080 check inter 3s

# 静态资源服务器
backend static_servers
    balance uri
    hash-type consistent
    option httpchk GET /health
    server static1 192.168.1.30:80 check
    server static2 192.168.1.31:80 check

# 订单服务器（使用 Cookie 会话保持）
backend order_servers
    balance roundrobin
    cookie ORDERID insert indirect nocache
    option httpchk GET /order/health
    server order1 192.168.1.40:8080 check cookie order1
    server order2 192.168.1.41:8080 check cookie order2

# 支付服务器（源 IP 会话保持）
backend payment_servers
    balance source
    hash-type consistent
    option httpchk GET /payment/health
    server payment1 192.168.1.50:8080 check
    server payment2 192.168.1.51:8080 check

# 移动端服务器
backend mobile_servers
    balance roundrobin
    option httpchk GET /mobile/health
    server mobile1 192.168.1.60:80 check
    server mobile2 192.168.1.61:80 check
</code></pre>
<hr />
<h2 id="十三学习验证标准"><a class="header" href="#十三学习验证标准">十三、学习验证标准</a></h2>
<h3 id="131-基础能力验证必须掌握"><a class="header" href="#131-基础能力验证必须掌握">13.1 基础能力验证（必须掌握）</a></h3>
<p><strong>验证项 1</strong>: 能够独立安装配置 HAProxy 并实现基本负载均衡</p>
<ul>
<li><input disabled="" type="checkbox"/>
在 Linux 系统上成功安装 HAProxy</li>
<li><input disabled="" type="checkbox"/>
理解配置文件的 global、defaults、frontend、backend 四个部分</li>
<li><input disabled="" type="checkbox"/>
能够配置至少 3 台后端服务器的轮询负载均衡</li>
<li><input disabled="" type="checkbox"/>
配置并验证健康检查功能</li>
</ul>
<p><strong>验证项 2</strong>: 掌握至少 3 种负载均衡算法及其应用场景</p>
<ul>
<li><input disabled="" type="checkbox"/>
能够配置 roundrobin、leastconn、source 算法</li>
<li><input disabled="" type="checkbox"/>
理解每种算法的适用场景</li>
<li><input disabled="" type="checkbox"/>
能够通过测试验证算法效果</li>
</ul>
<p><strong>验证项 3</strong>: 能够配置会话保持机制</p>
<ul>
<li><input disabled="" type="checkbox"/>
理解会话保持的必要性</li>
<li><input disabled="" type="checkbox"/>
至少掌握 Cookie 和 source 两种会话保持方法</li>
<li><input disabled="" type="checkbox"/>
能够验证会话保持是否生效</li>
</ul>
<h3 id="132-进阶能力验证熟练运用"><a class="header" href="#132-进阶能力验证熟练运用">13.2 进阶能力验证（熟练运用）</a></h3>
<p><strong>验证项 4</strong>: 能够使用 ACL 实现复杂的路由策略</p>
<ul>
<li><input disabled="" type="checkbox"/>
基于 URL 路径的路由分发</li>
<li><input disabled="" type="checkbox"/>
基于域名的虚拟主机配置</li>
<li><input disabled="" type="checkbox"/>
基于 User-Agent 的设备分流</li>
<li><input disabled="" type="checkbox"/>
访问控制和安全防护规则</li>
</ul>
<p><strong>验证项 5</strong>: 能够配置 SSL/TLS 加密</p>
<ul>
<li><input disabled="" type="checkbox"/>
生成或获取 SSL 证书</li>
<li><input disabled="" type="checkbox"/>
配置 HTTPS 终止</li>
<li><input disabled="" type="checkbox"/>
实现 HTTP 到 HTTPS 的重定向</li>
<li><input disabled="" type="checkbox"/>
配置安全头部</li>
</ul>
<h3 id="133-高级能力验证生产级别"><a class="header" href="#133-高级能力验证生产级别">13.3 高级能力验证（生产级别）</a></h3>
<p><strong>验证项 6</strong>: 能够部署高可用架构</p>
<ul>
<li><input disabled="" type="checkbox"/>
使用 Keepalived 实现主备高可用</li>
<li><input disabled="" type="checkbox"/>
验证故障转移功能</li>
<li><input disabled="" type="checkbox"/>
理解 VIP 漂移原理</li>
</ul>
<p><strong>验证项 7</strong>: 能够进行性能优化</p>
<ul>
<li><input disabled="" type="checkbox"/>
优化系统内核参数</li>
<li><input disabled="" type="checkbox"/>
优化 HAProxy 配置参数</li>
<li><input disabled="" type="checkbox"/>
进行压力测试并分析结果</li>
<li><input disabled="" type="checkbox"/>
根据监控数据调整配置</li>
</ul>
<p><strong>验证项 8</strong>: 能够处理生产环境问题</p>
<ul>
<li><input disabled="" type="checkbox"/>
配置日志记录和分析</li>
<li><input disabled="" type="checkbox"/>
启用统计页面并理解各项指标</li>
<li><input disabled="" type="checkbox"/>
能够排查常见故障（503、超时等）</li>
<li><input disabled="" type="checkbox"/>
掌握配置变更的安全流程</li>
</ul>
<hr />
<h2 id="十四扩展资源与进阶建议"><a class="header" href="#十四扩展资源与进阶建议">十四、扩展资源与进阶建议</a></h2>
<h3 id="141-官方文档与资源"><a class="header" href="#141-官方文档与资源">14.1 官方文档与资源</a></h3>
<p><strong>官方资源</strong>:</p>
<ul>
<li><a href="http://www.haproxy.org/">HAProxy 官方网站</a></li>
<li><a href="http://cbonte.github.io/haproxy-dconv/">HAProxy 官方文档</a></li>
<li><a href="https://github.com/haproxy/haproxy">HAProxy GitHub</a></li>
<li><a href="https://www.mail-archive.com/haproxy@formilux.org/">HAProxy 邮件列表</a></li>
</ul>
<p><strong>配置示例</strong>:</p>
<ul>
<li><a href="https://www.haproxy.com/documentation/hapee/latest/onepage/">HAProxy Configuration Examples</a></li>
</ul>
<h3 id="142-推荐学习路径"><a class="header" href="#142-推荐学习路径">14.2 推荐学习路径</a></h3>
<p><strong>阶段 1: 基础实践</strong>（1-2周）</p>
<ol>
<li>在虚拟机或容器中搭建测试环境</li>
<li>配置简单的 HTTP 负载均衡</li>
<li>测试不同的负载均衡算法</li>
<li>配置健康检查和会话保持</li>
</ol>
<p><strong>阶段 2: 进阶应用</strong>（2-3周）</p>
<ol>
<li>学习 ACL 规则和路由策略</li>
<li>配置 SSL/TLS 加密</li>
<li>实践监控和日志分析</li>
<li>模拟故障场景和恢复</li>
</ol>
<p><strong>阶段 3: 生产实战</strong>（3-4周）</p>
<ol>
<li>设计高可用架构</li>
<li>性能测试和调优</li>
<li>安全加固配置</li>
<li>制定运维流程</li>
</ol>
<h3 id="143-相关技术栈"><a class="header" href="#143-相关技术栈">14.3 相关技术栈</a></h3>
<p><strong>负载均衡相关</strong>:</p>
<ul>
<li>Nginx: 另一个流行的负载均衡器和反向代理</li>
<li>Traefik: 云原生环境下的动态负载均衡</li>
<li>Envoy: 服务网格中的代理组件</li>
<li>AWS ELB / ALB: 云服务商的负载均衡服务</li>
</ul>
<p><strong>高可用相关</strong>:</p>
<ul>
<li>Keepalived: VRRP 协议实现 VIP 漂移</li>
<li>Pacemaker: 集群资源管理器</li>
<li>Corosync: 集群通信框架</li>
</ul>
<p><strong>监控相关</strong>:</p>
<ul>
<li>Prometheus: 时序数据库和监控系统</li>
<li>Grafana: 可视化监控面板</li>
<li>ELK Stack: 日志收集和分析</li>
</ul>
<h3 id="144-实战项目建议"><a class="header" href="#144-实战项目建议">14.4 实战项目建议</a></h3>
<p><strong>项目 1: 个人博客负载均衡</strong></p>
<ul>
<li>部署 3 个 WordPress 实例</li>
<li>使用 HAProxy 实现负载均衡</li>
<li>配置 SSL 证书</li>
<li>实现会话保持</li>
</ul>
<p><strong>项目 2: 微服务 API 网关</strong></p>
<ul>
<li>部署多个微服务（用户、订单、支付）</li>
<li>使用 ACL 规则实现路由</li>
<li>配置限流和熔断</li>
<li>集成 Prometheus 监控</li>
</ul>
<p><strong>项目 3: 高可用架构实践</strong></p>
<ul>
<li>部署双机热备 HAProxy</li>
<li>使用 Keepalived 实现高可用</li>
<li>模拟故障场景</li>
<li>验证故障转移</li>
</ul>
<h3 id="145-常见面试题"><a class="header" href="#145-常见面试题">14.5 常见面试题</a></h3>
<ol>
<li>HAProxy 和 Nginx 负载均衡的区别？</li>
<li>HAProxy 支持哪些负载均衡算法？各自的应用场景？</li>
<li>如何实现会话保持？有哪些方案？</li>
<li>HAProxy 如何实现健康检查？</li>
<li>如何配置 HAProxy 高可用？</li>
<li>HAProxy 性能优化的关键参数有哪些？</li>
<li>如何排查 HAProxy 出现 503 错误？</li>
<li>ACL 规则的应用场景和配置方法？</li>
</ol>
<h3 id="146-进阶学习方向"><a class="header" href="#146-进阶学习方向">14.6 进阶学习方向</a></h3>
<p><strong>方向 1: 云原生负载均衡</strong></p>
<ul>
<li>学习 Kubernetes Ingress</li>
<li>了解服务网格（Service Mesh）</li>
<li>研究 Istio、Linkerd 等技术</li>
</ul>
<p><strong>方向 2: 性能调优专家</strong></p>
<ul>
<li>深入 Linux 内核网络栈</li>
<li>学习网络性能分析工具（perf、eBPF）</li>
<li>掌握高性能网络编程</li>
</ul>
<p><strong>方向 3: 安全防护</strong></p>
<ul>
<li>Web 应用防火墙（WAF）</li>
<li>DDoS 防护</li>
<li>零信任网络架构</li>
</ul>
<hr />
<h2 id="十五总结与实践建议"><a class="header" href="#十五总结与实践建议">十五、总结与实践建议</a></h2>
<h3 id="151-核心知识点回顾"><a class="header" href="#151-核心知识点回顾">15.1 核心知识点回顾</a></h3>
<p><strong>基础层</strong>:</p>
<ul>
<li>HAProxy 配置文件结构（global、defaults、frontend、backend）</li>
<li>负载均衡算法（roundrobin、leastconn、source、uri 等）</li>
<li>健康检查机制（TCP、HTTP、自定义）</li>
<li>会话保持方法（Cookie、source、stick-table）</li>
</ul>
<p><strong>进阶层</strong>:</p>
<ul>
<li>ACL 规则和智能路由</li>
<li>SSL/TLS 配置和优化</li>
<li>监控统计和日志分析</li>
<li>性能调优参数</li>
</ul>
<p><strong>高级层</strong>:</p>
<ul>
<li>高可用架构设计</li>
<li>生产环境最佳实践</li>
<li>故障排查和应急处理</li>
<li>安全加固配置</li>
</ul>
<h3 id="152-实践建议"><a class="header" href="#152-实践建议">15.2 实践建议</a></h3>
<ol>
<li><strong>动手实践</strong>: 理论学习占 30%，动手实践占 70%</li>
<li><strong>模拟生产</strong>: 尽可能模拟真实生产环境场景</li>
<li><strong>故障演练</strong>: 主动制造故障，练习排查和恢复</li>
<li><strong>持续学习</strong>: 关注官方更新和社区最佳实践</li>
<li><strong>知识输出</strong>: 通过写博客、分享经验巩固知识</li>
</ol>
<h3 id="153-学习路线图"><a class="header" href="#153-学习路线图">15.3 学习路线图</a></h3>
<pre><code>Week 1-2: 基础入门
├── 环境搭建
├── 基本负载均衡
└── 健康检查配置

Week 3-4: 进阶应用
├── 负载均衡算法
├── 会话保持机制
└── ACL 规则

Week 5-6: 高级特性
├── SSL/TLS 配置
├── 监控与日志
└── 性能优化

Week 7-8: 生产实战
├── 高可用架构
├── 安全加固
└── 完整项目实践
</code></pre>
<hr />
<p><strong>文档维护</strong>: 本学习笔记基于 HAProxy 2.8 版本编写，建议定期查看官方文档获取最新特性和最佳实践。</p>
<p><strong>反馈与改进</strong>: 如有问题或建议，请提交 Issue 或参与社区讨论。</p>
<hr />
<p><strong>祝学习顺利！掌握 HAProxy，成为负载均衡专家！</strong> 🚀</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/language/Python爬虫.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/linux/KVM.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/language/Python爬虫.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/linux/KVM.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

