<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Spring Cloud Gateway æŠ€æœ¯å­¦ä¹ ç¬”è®° - å¼€å‘</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">å¼€å‘</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="æœç´¢æœ¬ä¹¦å†…å®¹..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="spring-cloud-gateway-æŠ€æœ¯å­¦ä¹ ç¬”è®°"><a class="header" href="#spring-cloud-gateway-æŠ€æœ¯å­¦ä¹ ç¬”è®°">Spring Cloud Gateway æŠ€æœ¯å­¦ä¹ ç¬”è®°</a></h1>
<blockquote>
<p><strong>å­¦ä¹ ç›®æ ‡å®šä½</strong>: é¢å‘0-5å¹´ç»éªŒçš„å¾®æœåŠ¡å¼€å‘è€…ï¼Œç³»ç»ŸæŒæ¡Spring Cloud Gateway APIç½‘å…³ï¼Œä»åŸºç¡€åˆ°ä¼ä¸šçº§åº”ç”¨</p>
<p><strong>é¢„æœŸå­¦ä¹ æˆæœ</strong>:</p>
<ul>
<li>æ·±å…¥ç†è§£APIç½‘å…³çš„ä½œç”¨å’ŒSpring Cloud Gatewayæ¶æ„</li>
<li>æŒæ¡è·¯ç”±é…ç½®ã€æ–­è¨€å’Œè¿‡æ»¤å™¨çš„ä½¿ç”¨</li>
<li>èƒ½å¤Ÿå®ç°é™æµã€ç†”æ–­ã€è®¤è¯ç­‰é«˜çº§åŠŸèƒ½</li>
<li>å…·å¤‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å’Œæ€§èƒ½ä¼˜åŒ–èƒ½åŠ›</li>
</ul>
</blockquote>
<hr />
<h2 id="-å­¦ä¹ è·¯å¾„è§„åˆ’"><a class="header" href="#-å­¦ä¹ è·¯å¾„è§„åˆ’">ğŸ“š å­¦ä¹ è·¯å¾„è§„åˆ’</a></h2>
<pre><code class="language-mermaid">graph LR
    A[ç½‘å…³åŸºç¡€] --&gt; B[ç¯å¢ƒæ­å»º]
    B --&gt; C[è·¯ç”±é…ç½®]
    C --&gt; D[æ–­è¨€å·¥å‚]
    D --&gt; E[è¿‡æ»¤å™¨]
    E --&gt; F[é«˜çº§ç‰¹æ€§]
    F --&gt; G[ç”Ÿäº§å®è·µ]
</code></pre>
<p><strong>å»ºè®®å­¦ä¹ æ—¶é—´</strong>: 8-12å¤©</p>
<ul>
<li>åŸºç¡€é˜¶æ®µï¼ˆ1-2å¤©ï¼‰: ç½‘å…³æ¦‚å¿µ + Gatewayæ¶æ„ç†è§£</li>
<li>ç¯å¢ƒæ­å»ºï¼ˆ3å¤©ï¼‰: é¡¹ç›®åˆ›å»º + åŸºç¡€é…ç½®</li>
<li>æ ¸å¿ƒåŠŸèƒ½ï¼ˆ4-7å¤©ï¼‰: è·¯ç”± + æ–­è¨€ + è¿‡æ»¤å™¨</li>
<li>é«˜çº§ç‰¹æ€§ï¼ˆ8-10å¤©ï¼‰: é™æµ + ç†”æ–­ + è®¤è¯</li>
<li>ç”Ÿäº§éƒ¨ç½²ï¼ˆ11-12å¤©ï¼‰: ç›‘æ§ + ä¼˜åŒ– + æ•…éšœå¤„ç†</li>
</ul>
<hr />
<h2 id="1-spring-cloud-gateway-åŸºç¡€"><a class="header" href="#1-spring-cloud-gateway-åŸºç¡€">1. Spring Cloud Gateway åŸºç¡€</a></h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-api-ç½‘å…³"><a class="header" href="#11-ä»€ä¹ˆæ˜¯-api-ç½‘å…³">1.1 ä»€ä¹ˆæ˜¯ API ç½‘å…³</a></h3>
<p><strong>APIç½‘å…³</strong>æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„ç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£è¯·æ±‚è·¯ç”±ã€åè®®è½¬æ¢ã€å®‰å…¨è®¤è¯ã€æµé‡æ§åˆ¶ç­‰åŠŸèƒ½ã€‚</p>
<h4 id="ç½‘å…³çš„æ ¸å¿ƒä½œç”¨"><a class="header" href="#ç½‘å…³çš„æ ¸å¿ƒä½œç”¨">ç½‘å…³çš„æ ¸å¿ƒä½œç”¨</a></h4>
<pre><code>ä¼ ç»Ÿæ¶æ„ï¼ˆæ— ç½‘å…³ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â–º è®¢å•æœåŠ¡ (http://order-service:8001)
     â”œâ”€â”€â”€â”€â”€â”€â–º ç”¨æˆ·æœåŠ¡ (http://user-service:8002)
     â”œâ”€â”€â”€â”€â”€â”€â–º å•†å“æœåŠ¡ (http://product-service:8003)
     â””â”€â”€â”€â”€â”€â”€â–º æ”¯ä»˜æœåŠ¡ (http://payment-service:8004)

é—®é¢˜:
- å®¢æˆ·ç«¯éœ€è¦ç»´æŠ¤å¤šä¸ªæœåŠ¡åœ°å€
- è·¨åŸŸé…ç½®å¤æ‚
- å®‰å…¨è®¤è¯åˆ†æ•£
- æ— æ³•ç»Ÿä¸€é™æµå’Œç›‘æ§

å¾®æœåŠ¡æ¶æ„ï¼ˆæœ‰ç½‘å…³ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Gateway (ç½‘å…³)                 â”‚
â”‚   - ç»Ÿä¸€å…¥å£: http://gateway:8080   â”‚
â”‚   - è·¯ç”±è½¬å‘                         â”‚
â”‚   - è®¤è¯é‰´æƒ                         â”‚
â”‚   - é™æµç†”æ–­                         â”‚
â”‚   - æ—¥å¿—ç›‘æ§                         â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚             â”‚
    â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è®¢å•æœåŠ¡ â”‚   â”‚ç”¨æˆ·æœåŠ¡ â”‚   â”‚å•†å“æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½"><a class="header" href="#ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½">ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½</a></h4>
<div class="table-wrapper"><table><thead><tr><th>åŠŸèƒ½ç±»åˆ«</th><th>å…·ä½“åŠŸèƒ½</th><th>ä»·å€¼</th></tr></thead><tbody>
<tr><td><strong>è·¯ç”±è½¬å‘</strong></td><td>åŠ¨æ€è·¯ç”±ã€è´Ÿè½½å‡è¡¡</td><td>ç»Ÿä¸€å…¥å£ï¼Œç®€åŒ–å®¢æˆ·ç«¯è°ƒç”¨</td></tr>
<tr><td><strong>å®‰å…¨æ§åˆ¶</strong></td><td>è®¤è¯ã€é‰´æƒã€é˜²åˆ·</td><td>ä¿æŠ¤åç«¯æœåŠ¡å®‰å…¨</td></tr>
<tr><td><strong>æµé‡æ§åˆ¶</strong></td><td>é™æµã€ç†”æ–­ã€é™çº§</td><td>ä¿éšœç³»ç»Ÿç¨³å®šæ€§</td></tr>
<tr><td><strong>åè®®è½¬æ¢</strong></td><td>HTTP/WebSocket/gRPC</td><td>æ”¯æŒå¤šåè®®è®¿é—®</td></tr>
<tr><td><strong>ç›‘æ§æ—¥å¿—</strong></td><td>è®¿é—®æ—¥å¿—ã€æ€§èƒ½ç›‘æ§</td><td>ç»Ÿä¸€ç›‘æ§å’Œåˆ†æ</td></tr>
</tbody></table>
</div>
<h3 id="12-gateway-vs-zuul"><a class="header" href="#12-gateway-vs-zuul">1.2 Gateway vs Zuul</a></h3>
<h4 id="æŠ€æœ¯å¯¹æ¯”"><a class="header" href="#æŠ€æœ¯å¯¹æ¯”">æŠ€æœ¯å¯¹æ¯”</a></h4>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>Spring Cloud Gateway</th><th>Netflix Zuul 1.x</th><th>Netflix Zuul 2.x</th></tr></thead><tbody>
<tr><td><strong>åŸºç¡€æ¡†æ¶</strong></td><td>Spring WebFlux (Reactor)</td><td>Servlet (åŒæ­¥é˜»å¡)</td><td>Netty (å¼‚æ­¥éé˜»å¡)</td></tr>
<tr><td><strong>å¼‚æ­¥æ”¯æŒ</strong></td><td>åŸç”Ÿå¼‚æ­¥</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr>
<tr><td><strong>æ€§èƒ½</strong></td><td>é«˜</td><td>ä¸­ç­‰</td><td>é«˜</td></tr>
<tr><td><strong>Springç”Ÿæ€</strong></td><td>å®Œç¾é›†æˆ</td><td>è‰¯å¥½</td><td>åœæ­¢ç»´æŠ¤</td></tr>
<tr><td><strong>ç¼–ç¨‹æ¨¡å‹</strong></td><td>å“åº”å¼ç¼–ç¨‹</td><td>ä¼ ç»Ÿç¼–ç¨‹</td><td>å¼‚æ­¥ç¼–ç¨‹</td></tr>
<tr><td><strong>å­¦ä¹ æ›²çº¿</strong></td><td>é™¡å³­</td><td>å¹³ç¼“</td><td>é™¡å³­</td></tr>
<tr><td><strong>ç¤¾åŒºæ´»è·ƒåº¦</strong></td><td>éå¸¸é«˜</td><td>ä½</td><td>å·²åœç»´</td></tr>
</tbody></table>
</div>
<p><strong>é€‰æ‹©Gatewayçš„ç†ç”±</strong>:</p>
<ul>
<li>âœ… Netflixå·²åœæ­¢ç»´æŠ¤Zuulï¼ŒSpringå®˜æ–¹æ¨èGateway</li>
<li>âœ… åŸºäºSpring Boot 2.xå’ŒProject Reactorï¼Œæ€§èƒ½æ›´å¥½</li>
<li>âœ… åŸç”Ÿæ”¯æŒSpring Cloudç”Ÿæ€ï¼ˆNacosã€Sentinelç­‰ï¼‰</li>
<li>âœ… çµæ´»çš„è·¯ç”±é…ç½®å’Œè¿‡æ»¤å™¨æœºåˆ¶</li>
</ul>
<h3 id="13-gateway-æ¶æ„åŸç†"><a class="header" href="#13-gateway-æ¶æ„åŸç†">1.3 Gateway æ¶æ„åŸç†</a></h3>
<h4 id="æ ¸å¿ƒç»„ä»¶"><a class="header" href="#æ ¸å¿ƒç»„ä»¶">æ ¸å¿ƒç»„ä»¶</a></h4>
<pre><code class="language-yaml">Gatewayæ ¸å¿ƒç»„ä»¶:
  Route (è·¯ç”±):
    - ç½‘å…³çš„åŸºæœ¬æ„å»ºå—
    - åŒ…å«ï¼šIDã€ç›®æ ‡URIã€æ–­è¨€é›†åˆã€è¿‡æ»¤å™¨é›†åˆ
    - ä½œç”¨ï¼šå®šä¹‰è¯·æ±‚å¦‚ä½•è¢«è½¬å‘

  Predicate (æ–­è¨€):
    - åŒ¹é…HTTPè¯·æ±‚çš„æ¡ä»¶
    - åŒ…å«ï¼šè·¯å¾„ã€æ–¹æ³•ã€Headerã€å‚æ•°ç­‰
    - ä½œç”¨ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦æ»¡è¶³è·¯ç”±æ¡ä»¶

  Filter (è¿‡æ»¤å™¨):
    - å¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹
    - åˆ†ç±»ï¼šPre Filter(å‰ç½®)ã€Post Filter(åç½®)
    - ä½œç”¨ï¼šå®ç°è¯·æ±‚/å“åº”çš„å¤„ç†é€»è¾‘
</code></pre>
<h4 id="è¯·æ±‚å¤„ç†æµç¨‹"><a class="header" href="#è¯·æ±‚å¤„ç†æµç¨‹">è¯·æ±‚å¤„ç†æµç¨‹</a></h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Spring Cloud Gateway å¤„ç†æµç¨‹               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. å®¢æˆ·ç«¯è¯·æ±‚
   â”‚
   â–¼
2. Gateway Handler Mapping
   â”œâ”€ åŒ¹é…è·¯ç”± (Route Predicate)
   â”‚  - Path=/api/users/**
   â”‚  - Method=GET
   â”‚  - Header=X-Request-Id
   â”‚
   â–¼
3. Gateway Web Handler
   â”‚
   â–¼
4. Pre Filter Chain (å‰ç½®è¿‡æ»¤å™¨)
   â”œâ”€ AddRequestHeader Filter
   â”œâ”€ AddRequestParameter Filter
   â”œâ”€ Retry Filter
   â”œâ”€ RequestRateLimiter Filter
   â”‚
   â–¼
5. Proxied Service (ä»£ç†æœåŠ¡)
   â”œâ”€ LoadBalancer (è´Ÿè½½å‡è¡¡)
   â”œâ”€ è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡
   â”‚
   â–¼
6. Post Filter Chain (åç½®è¿‡æ»¤å™¨)
   â”œâ”€ AddResponseHeader Filter
   â”œâ”€ ModifyResponseBody Filter
   â”‚
   â–¼
7. è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
</code></pre>
<h4 id="å“åº”å¼ç¼–ç¨‹æ¨¡å‹"><a class="header" href="#å“åº”å¼ç¼–ç¨‹æ¨¡å‹">å“åº”å¼ç¼–ç¨‹æ¨¡å‹</a></h4>
<p><strong>GatewayåŸºäºProject Reactorå®ç°å“åº”å¼ç¼–ç¨‹</strong>ï¼š</p>
<pre><code class="language-java">// ä¼ ç»ŸåŒæ­¥é˜»å¡æ–¹å¼ (Zuul 1.x)
public String blockingCall() {
    String user = userService.getUser();      // é˜»å¡ç­‰å¾…
    String order = orderService.getOrder();   // é˜»å¡ç­‰å¾…
    return user + order;
}

// å“åº”å¼å¼‚æ­¥æ–¹å¼ (Gateway)
public Mono&lt;String&gt; reactiveCall() {
    Mono&lt;String&gt; userMono = userService.getUserAsync();
    Mono&lt;String&gt; orderMono = orderService.getOrderAsync();

    return Mono.zip(userMono, orderMono)
        .map(tuple -&gt; tuple.getT1() + tuple.getT2());
    // éé˜»å¡ï¼Œå¹¶è¡Œæ‰§è¡Œ
}
</code></pre>
<hr />
<h2 id="2-ç¯å¢ƒæ­å»º"><a class="header" href="#2-ç¯å¢ƒæ­å»º">2. ç¯å¢ƒæ­å»º</a></h2>
<h3 id="21-åˆ›å»º-gateway-é¡¹ç›®"><a class="header" href="#21-åˆ›å»º-gateway-é¡¹ç›®">2.1 åˆ›å»º Gateway é¡¹ç›®</a></h3>
<h4 id="maven-ä¾èµ–"><a class="header" href="#maven-ä¾èµ–">Maven ä¾èµ–</a></h4>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.10&lt;/version&gt;
        &lt;relativePath/&gt;
    &lt;/parent&gt;

    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;api-gateway&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;spring-cloud.version&gt;2021.0.5&lt;/spring-cloud.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;!-- Spring Cloud Gateway --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Nacos æœåŠ¡å‘ç° --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
            &lt;version&gt;2021.0.5.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- LoadBalancer è´Ÿè½½å‡è¡¡ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Redis (ç”¨äºé™æµ) --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Actuator ç›‘æ§ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>
<h4 id="å¯åŠ¨ç±»"><a class="header" href="#å¯åŠ¨ç±»">å¯åŠ¨ç±»</a></h4>
<pre><code class="language-java">package com.example.gateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient  // å¯ç”¨æœåŠ¡å‘ç°
public class GatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
        System.out.println("API Gateway Started Successfully!");
    }
}
</code></pre>
<h3 id="22-åŸºç¡€é…ç½®"><a class="header" href="#22-åŸºç¡€é…ç½®">2.2 åŸºç¡€é…ç½®</a></h3>
<p><strong>application.yml</strong>:</p>
<pre><code class="language-yaml">server:
  port: 8080  # Gatewayç«¯å£

spring:
  application:
    name: api-gateway

  # Nacos æ³¨å†Œä¸­å¿ƒ
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848

    # Gateway é…ç½®
    gateway:
      # å…¨å±€è·¨åŸŸé…ç½®
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # è·¯ç”±é…ç½®
      routes:
        # è·¯ç”±1: ç”¨æˆ·æœåŠ¡
        - id: user-service-route
          uri: lb://user-service  # lb:// è¡¨ç¤ºä»Nacosè·å–æœåŠ¡
          predicates:
            - Path=/api/users/**  # è·¯å¾„æ–­è¨€
          filters:
            - StripPrefix=1        # å»æ‰ç¬¬ä¸€å±‚è·¯å¾„å‰ç¼€

        # è·¯ç”±2: è®¢å•æœåŠ¡
        - id: order-service-route
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=1

# Actuator ç›‘æ§
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true  # å¯ç”¨Gatewayç«¯ç‚¹

# æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.loadbalancer: DEBUG
</code></pre>
<h3 id="23-æµ‹è¯•éªŒè¯"><a class="header" href="#23-æµ‹è¯•éªŒè¯">2.3 æµ‹è¯•éªŒè¯</a></h3>
<pre><code class="language-bash"># 1. å¯åŠ¨Gateway
mvn spring-boot:run

# 2. è®¿é—®Gatewayç›‘æ§ç«¯ç‚¹
curl http://localhost:8080/actuator/gateway/routes

# 3. æµ‹è¯•è·¯ç”±
curl http://localhost:8080/api/users/1
# è¯·æ±‚ä¼šè¢«è½¬å‘åˆ° http://user-service/users/1
</code></pre>
<hr />
<h2 id="3-è·¯ç”±é…ç½®-route"><a class="header" href="#3-è·¯ç”±é…ç½®-route">3. è·¯ç”±é…ç½® (Route)</a></h2>
<h3 id="31-è·¯ç”±é…ç½®æ–¹å¼"><a class="header" href="#31-è·¯ç”±é…ç½®æ–¹å¼">3.1 è·¯ç”±é…ç½®æ–¹å¼</a></h3>
<h4 id="æ–¹å¼1-yaml-é…ç½®æ¨è"><a class="header" href="#æ–¹å¼1-yaml-é…ç½®æ¨è">æ–¹å¼1: YAML é…ç½®ï¼ˆæ¨èï¼‰</a></h4>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      routes:
        - id: user-route              # è·¯ç”±å”¯ä¸€æ ‡è¯†
          uri: http://localhost:8001  # ç›®æ ‡æœåŠ¡åœ°å€
          predicates:                  # æ–­è¨€æ¡ä»¶
            - Path=/users/**
          filters:                     # è¿‡æ»¤å™¨
            - AddRequestHeader=X-Request-Source, gateway

        - id: order-route
          uri: lb://order-service      # ä»æ³¨å†Œä¸­å¿ƒè·å–
          predicates:
            - Path=/orders/**
            - Method=GET,POST
          filters:
            - StripPrefix=1
</code></pre>
<h4 id="æ–¹å¼2-java-ä»£ç é…ç½®"><a class="header" href="#æ–¹å¼2-java-ä»£ç é…ç½®">æ–¹å¼2: Java ä»£ç é…ç½®</a></h4>
<pre><code class="language-java">package com.example.gateway.config;

import org.springframework.cloud.gateway.route.RouteLocator;
import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class GatewayRoutesConfig {

    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            // è·¯ç”±1: ç”¨æˆ·æœåŠ¡
            .route("user-route", r -&gt; r
                .path("/users/**")
                .filters(f -&gt; f
                    .addRequestHeader("X-Request-Source", "gateway")
                    .addResponseHeader("X-Response-Time", String.valueOf(System.currentTimeMillis()))
                )
                .uri("lb://user-service")
            )
            // è·¯ç”±2: è®¢å•æœåŠ¡ (å¸¦æ¡ä»¶)
            .route("order-route", r -&gt; r
                .path("/orders/**")
                .and()
                .method("GET", "POST")
                .filters(f -&gt; f
                    .stripPrefix(1)
                    .retry(config -&gt; config
                        .setRetries(3)
                        .setStatuses(org.springframework.http.HttpStatus.INTERNAL_SERVER_ERROR)
                    )
                )
                .uri("lb://order-service")
            )
            // è·¯ç”±3: é‡å®šå‘
            .route("redirect-route", r -&gt; r
                .path("/old-api/**")
                .filters(f -&gt; f
                    .redirect(302, "http://new-api.example.com")
                )
                .uri("no://op")
            )
            .build();
    }
}
</code></pre>
<h3 id="32-åŠ¨æ€è·¯ç”±"><a class="header" href="#32-åŠ¨æ€è·¯ç”±">3.2 åŠ¨æ€è·¯ç”±</a></h3>
<p><strong>ä»é…ç½®ä¸­å¿ƒåŠ¨æ€åŠ è½½è·¯ç”±</strong>:</p>
<pre><code class="language-java">package com.example.gateway.config;

import org.springframework.cloud.gateway.event.RefreshRoutesEvent;
import org.springframework.cloud.gateway.route.RouteDefinition;
import org.springframework.cloud.gateway.route.RouteDefinitionWriter;
import org.springframework.cloud.gateway.support.NotFoundException;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

import java.util.List;

@Service
public class DynamicRouteService {

    private final RouteDefinitionWriter routeDefinitionWriter;
    private final ApplicationEventPublisher publisher;

    public DynamicRouteService(RouteDefinitionWriter routeDefinitionWriter,
                                ApplicationEventPublisher publisher) {
        this.routeDefinitionWriter = routeDefinitionWriter;
        this.publisher = publisher;
    }

    /**
     * æ·»åŠ è·¯ç”±
     */
    public String addRoute(RouteDefinition definition) {
        routeDefinitionWriter.save(Mono.just(definition)).subscribe();
        // å‘å¸ƒè·¯ç”±åˆ·æ–°äº‹ä»¶
        publisher.publishEvent(new RefreshRoutesEvent(this));
        return "success";
    }

    /**
     * æ›´æ–°è·¯ç”±
     */
    public String updateRoute(RouteDefinition definition) {
        try {
            deleteRoute(definition.getId());
        } catch (Exception e) {
            return "update failed";
        }
        return addRoute(definition);
    }

    /**
     * åˆ é™¤è·¯ç”±
     */
    public String deleteRoute(String id) {
        routeDefinitionWriter.delete(Mono.just(id)).subscribe();
        publisher.publishEvent(new RefreshRoutesEvent(this));
        return "success";
    }
}
</code></pre>
<p><strong>åŠ¨æ€è·¯ç”±ç®¡ç†æ¥å£</strong>:</p>
<pre><code class="language-java">@RestController
@RequestMapping("/gateway/routes")
public class RouteController {

    @Autowired
    private DynamicRouteService dynamicRouteService;

    @PostMapping("/add")
    public String addRoute(@RequestBody RouteDefinition routeDefinition) {
        return dynamicRouteService.addRoute(routeDefinition);
    }

    @PutMapping("/update")
    public String updateRoute(@RequestBody RouteDefinition routeDefinition) {
        return dynamicRouteService.updateRoute(routeDefinition);
    }

    @DeleteMapping("/delete/{id}")
    public String deleteRoute(@PathVariable String id) {
        return dynamicRouteService.deleteRoute(id);
    }
}
</code></pre>
<hr />
<h2 id="4-æ–­è¨€å·¥å‚-predicate"><a class="header" href="#4-æ–­è¨€å·¥å‚-predicate">4. æ–­è¨€å·¥å‚ (Predicate)</a></h2>
<h3 id="41-å†…ç½®æ–­è¨€å·¥å‚"><a class="header" href="#41-å†…ç½®æ–­è¨€å·¥å‚">4.1 å†…ç½®æ–­è¨€å·¥å‚</a></h3>
<h4 id="path-è·¯å¾„æ–­è¨€"><a class="header" href="#path-è·¯å¾„æ–­è¨€">Path è·¯å¾„æ–­è¨€</a></h4>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      routes:
        - id: path-route
          uri: lb://user-service
          predicates:
            # ç²¾ç¡®åŒ¹é…
            - Path=/api/users/{id}
            # é€šé…ç¬¦åŒ¹é…
            - Path=/api/users/**
</code></pre>
<h4 id="method-æ–¹æ³•æ–­è¨€"><a class="header" href="#method-æ–¹æ³•æ–­è¨€">Method æ–¹æ³•æ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  - Method=GET,POST  # åªåŒ¹é…GETå’ŒPOSTè¯·æ±‚
</code></pre>
<h4 id="header-è¯·æ±‚å¤´æ–­è¨€"><a class="header" href="#header-è¯·æ±‚å¤´æ–­è¨€">Header è¯·æ±‚å¤´æ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  # è¯·æ±‚å¤´å¿…é¡»åŒ…å«X-Request-Id
  - Header=X-Request-Id, \d+  # æ­£åˆ™è¡¨è¾¾å¼éªŒè¯å€¼
</code></pre>
<h4 id="query-æŸ¥è¯¢å‚æ•°æ–­è¨€"><a class="header" href="#query-æŸ¥è¯¢å‚æ•°æ–­è¨€">Query æŸ¥è¯¢å‚æ•°æ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  - Query=name, \w+  # å¿…é¡»æœ‰nameå‚æ•°ä¸”åŒ¹é…æ­£åˆ™
</code></pre>
<h4 id="cookie-æ–­è¨€"><a class="header" href="#cookie-æ–­è¨€">Cookie æ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  - Cookie=sessionId, \w+  # å¿…é¡»æœ‰sessionId cookie
</code></pre>
<h4 id="host-ä¸»æœºæ–­è¨€"><a class="header" href="#host-ä¸»æœºæ–­è¨€">Host ä¸»æœºæ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  - Host=**.example.com  # åŒ¹é…ä»»æ„example.comçš„å­åŸŸå
</code></pre>
<h4 id="remoteaddr-ipåœ°å€æ–­è¨€"><a class="header" href="#remoteaddr-ipåœ°å€æ–­è¨€">RemoteAddr IPåœ°å€æ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  - RemoteAddr=192.168.1.0/24  # åªå…è®¸ç‰¹å®šIPæ®µè®¿é—®
</code></pre>
<h4 id="time-æ—¶é—´æ–­è¨€"><a class="header" href="#time-æ—¶é—´æ–­è¨€">Time æ—¶é—´æ–­è¨€</a></h4>
<pre><code class="language-yaml">predicates:
  # åœ¨æŒ‡å®šæ—¶é—´ä¹‹åç”Ÿæ•ˆ
  - After=2024-01-01T00:00:00+08:00[Asia/Shanghai]
  # åœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰ç”Ÿæ•ˆ
  - Before=2024-12-31T23:59:59+08:00[Asia/Shanghai]
  # åœ¨æ—¶é—´æ®µå†…ç”Ÿæ•ˆ
  - Between=2024-01-01T00:00:00+08:00[Asia/Shanghai],2024-12-31T23:59:59+08:00[Asia/Shanghai]
</code></pre>
<h4 id="weight-æƒé‡æ–­è¨€é‡‘ä¸é›€å‘å¸ƒ"><a class="header" href="#weight-æƒé‡æ–­è¨€é‡‘ä¸é›€å‘å¸ƒ">Weight æƒé‡æ–­è¨€ï¼ˆé‡‘ä¸é›€å‘å¸ƒï¼‰</a></h4>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      routes:
        # V1ç‰ˆæœ¬ï¼š90%æµé‡
        - id: service-v1
          uri: lb://service-v1
          predicates:
            - Path=/api/**
            - Weight=group1, 9

        # V2ç‰ˆæœ¬ï¼š10%æµé‡ï¼ˆé‡‘ä¸é›€ï¼‰
        - id: service-v2
          uri: lb://service-v2
          predicates:
            - Path=/api/**
            - Weight=group1, 1
</code></pre>
<h3 id="42-è‡ªå®šä¹‰æ–­è¨€å·¥å‚"><a class="header" href="#42-è‡ªå®šä¹‰æ–­è¨€å·¥å‚">4.2 è‡ªå®šä¹‰æ–­è¨€å·¥å‚</a></h3>
<pre><code class="language-java">package com.example.gateway.predicate;

import org.springframework.cloud.gateway.handler.predicate.AbstractRoutePredicateFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;

import java.util.Arrays;
import java.util.List;
import java.util.function.Predicate;

/**
 * è‡ªå®šä¹‰æ–­è¨€ï¼šæ£€æŸ¥è¯·æ±‚æ˜¯å¦æ¥è‡ªç§»åŠ¨ç«¯
 */
@Component
public class MobileRoutePredicateFactory
    extends AbstractRoutePredicateFactory&lt;MobileRoutePredicateFactory.Config&gt; {

    public MobileRoutePredicateFactory() {
        super(Config.class);
    }

    @Override
    public Predicate&lt;ServerWebExchange&gt; apply(Config config) {
        return exchange -&gt; {
            String userAgent = exchange.getRequest()
                .getHeaders()
                .getFirst("User-Agent");

            if (userAgent == null) {
                return false;
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
            boolean isMobile = userAgent.toLowerCase().contains("mobile") ||
                               userAgent.toLowerCase().contains("android") ||
                               userAgent.toLowerCase().contains("iphone");

            return config.isMatchMobile() == isMobile;
        };
    }

    @Override
    public List&lt;String&gt; shortcutFieldOrder() {
        return Arrays.asList("matchMobile");
    }

    public static class Config {
        private boolean matchMobile = true;

        public boolean isMatchMobile() {
            return matchMobile;
        }

        public void setMatchMobile(boolean matchMobile) {
            this.matchMobile = matchMobile;
        }
    }
}
</code></pre>
<p><strong>ä½¿ç”¨è‡ªå®šä¹‰æ–­è¨€</strong>:</p>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      routes:
        # ç§»åŠ¨ç«¯è·¯ç”±
        - id: mobile-route
          uri: lb://mobile-service
          predicates:
            - Path=/api/**
            - Mobile=true  # ä½¿ç”¨è‡ªå®šä¹‰æ–­è¨€

        # PCç«¯è·¯ç”±
        - id: pc-route
          uri: lb://pc-service
          predicates:
            - Path=/api/**
            - Mobile=false
</code></pre>
<hr />
<h2 id="5-è¿‡æ»¤å™¨-filter"><a class="header" href="#5-è¿‡æ»¤å™¨-filter">5. è¿‡æ»¤å™¨ (Filter)</a></h2>
<h3 id="51-å†…ç½®è¿‡æ»¤å™¨"><a class="header" href="#51-å†…ç½®è¿‡æ»¤å™¨">5.1 å†…ç½®è¿‡æ»¤å™¨</a></h3>
<h4 id="addrequestheader--addresponseheader"><a class="header" href="#addrequestheader--addresponseheader">AddRequestHeader / AddResponseHeader</a></h4>
<pre><code class="language-yaml">filters:
  - AddRequestHeader=X-Request-Source, gateway
  - AddResponseHeader=X-Response-Time, 2024-01-15
</code></pre>
<h4 id="addrequestparameter"><a class="header" href="#addrequestparameter">AddRequestParameter</a></h4>
<pre><code class="language-yaml">filters:
  - AddRequestParameter=source, gateway
</code></pre>
<h4 id="rewritepath-è·¯å¾„é‡å†™"><a class="header" href="#rewritepath-è·¯å¾„é‡å†™">RewritePath è·¯å¾„é‡å†™</a></h4>
<pre><code class="language-yaml">filters:
  # /api/users/1 â†’ /users/1
  - RewritePath=/api(?&lt;segment&gt;/?.*), $\{segment}
</code></pre>
<h4 id="stripprefix-å»é™¤è·¯å¾„å‰ç¼€"><a class="header" href="#stripprefix-å»é™¤è·¯å¾„å‰ç¼€">StripPrefix å»é™¤è·¯å¾„å‰ç¼€</a></h4>
<pre><code class="language-yaml">filters:
  # /api/users/1 â†’ /users/1 (å»æ‰ç¬¬ä¸€å±‚è·¯å¾„)
  - StripPrefix=1
  # /v1/api/users/1 â†’ /users/1 (å»æ‰ä¸¤å±‚è·¯å¾„)
  - StripPrefix=2
</code></pre>
<h4 id="retry-é‡è¯•"><a class="header" href="#retry-é‡è¯•">Retry é‡è¯•</a></h4>
<pre><code class="language-yaml">filters:
  - name: Retry
    args:
      retries: 3                # é‡è¯•æ¬¡æ•°
      statuses: INTERNAL_SERVER_ERROR  # è§¦å‘é‡è¯•çš„çŠ¶æ€ç 
      methods: GET,POST         # é‡è¯•çš„æ–¹æ³•
      backoff:
        firstBackoff: 50ms      # ç¬¬ä¸€æ¬¡é‡è¯•ç­‰å¾…æ—¶é—´
        maxBackoff: 500ms       # æœ€å¤§ç­‰å¾…æ—¶é—´
        factor: 2               # é€€é¿å› å­
        basedOnPreviousValue: true
</code></pre>
<h4 id="requestratelimiter-é™æµ"><a class="header" href="#requestratelimiter-é™æµ">RequestRateLimiter é™æµ</a></h4>
<pre><code class="language-yaml">spring:
  redis:
    host: localhost
    port: 6379

  cloud:
    gateway:
      routes:
        - id: limited-route
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10  # ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡
                redis-rate-limiter.burstCapacity: 20  # ä»¤ç‰Œæ¡¶å®¹é‡
                key-resolver: "#{@ipKeyResolver}"     # é™æµç»´åº¦
</code></pre>
<p><strong>è‡ªå®šä¹‰é™æµKeyè§£æå™¨</strong>:</p>
<pre><code class="language-java">@Configuration
public class RateLimiterConfig {

    /**
     * åŸºäºIPé™æµ
     */
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -&gt; Mono.just(
            exchange.getRequest()
                .getRemoteAddress()
                .getAddress()
                .getHostAddress()
        );
    }

    /**
     * åŸºäºç”¨æˆ·IDé™æµ
     */
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -&gt; Mono.just(
            exchange.getRequest()
                .getHeaders()
                .getFirst("X-User-Id")
        );
    }

    /**
     * åŸºäºè·¯å¾„é™æµ
     */
    @Bean
    public KeyResolver pathKeyResolver() {
        return exchange -&gt; Mono.just(
            exchange.getRequest().getPath().value()
        );
    }
}
</code></pre>
<h3 id="52-è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨"><a class="header" href="#52-è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨">5.2 è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨</a></h3>
<h4 id="ç¤ºä¾‹1-ç»Ÿä¸€è®¤è¯è¿‡æ»¤å™¨"><a class="header" href="#ç¤ºä¾‹1-ç»Ÿä¸€è®¤è¯è¿‡æ»¤å™¨">ç¤ºä¾‹1: ç»Ÿä¸€è®¤è¯è¿‡æ»¤å™¨</a></h4>
<pre><code class="language-java">package com.example.gateway.filter;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

/**
 * å…¨å±€è®¤è¯è¿‡æ»¤å™¨
 */
@Component
public class AuthenticationFilter implements GlobalFilter, Ordered {

    private static final String TOKEN_HEADER = "Authorization";

    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        // ç™½åå•ï¼šç™»å½•ã€æ³¨å†Œç­‰æ¥å£ä¸éœ€è¦è®¤è¯
        String path = request.getPath().value();
        if (isWhiteList(path)) {
            return chain.filter(exchange);
        }

        // è·å–Token
        String token = request.getHeaders().getFirst(TOKEN_HEADER);

        // éªŒè¯Token
        if (token == null || !validateToken(token)) {
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        // è§£æç”¨æˆ·ä¿¡æ¯å¹¶ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
        String userId = extractUserId(token);
        ServerHttpRequest mutatedRequest = request.mutate()
            .header("X-User-Id", userId)
            .build();

        ServerWebExchange mutatedExchange = exchange.mutate()
            .request(mutatedRequest)
            .build();

        return chain.filter(mutatedExchange);
    }

    @Override
    public int getOrder() {
        return -100;  // ä¼˜å…ˆçº§é«˜ï¼Œå…ˆæ‰§è¡Œ
    }

    private boolean isWhiteList(String path) {
        return path.startsWith("/api/auth/") ||
               path.startsWith("/api/public/");
    }

    private boolean validateToken(String token) {
        // TODO: å®é™…é¡¹ç›®ä¸­åº”è¯¥è°ƒç”¨è®¤è¯æœåŠ¡éªŒè¯Token
        return token.startsWith("Bearer ");
    }

    private String extractUserId(String token) {
        // TODO: ä»Tokenä¸­è§£æç”¨æˆ·ID
        return "user123";
    }
}
</code></pre>
<h4 id="ç¤ºä¾‹2-è¯·æ±‚æ—¥å¿—è¿‡æ»¤å™¨"><a class="header" href="#ç¤ºä¾‹2-è¯·æ±‚æ—¥å¿—è¿‡æ»¤å™¨">ç¤ºä¾‹2: è¯·æ±‚æ—¥å¿—è¿‡æ»¤å™¨</a></h4>
<pre><code class="language-java">package com.example.gateway.filter;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

/**
 * è¯·æ±‚æ—¥å¿—è¿‡æ»¤å™¨
 */
@Component
public class RequestLogFilter implements GlobalFilter, Ordered {

    private static final Logger logger = LoggerFactory.getLogger(RequestLogFilter.class);

    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();

        long startTime = System.currentTimeMillis();

        // è®°å½•è¯·æ±‚ä¿¡æ¯
        logger.info("Gateway Request: method={}, path={}, query={}, remoteAddr={}",
            request.getMethod(),
            request.getPath().value(),
            request.getQueryParams(),
            request.getRemoteAddress()
        );

        return chain.filter(exchange).then(
            Mono.fromRunnable(() -&gt; {
                long endTime = System.currentTimeMillis();
                long duration = endTime - startTime;

                // è®°å½•å“åº”ä¿¡æ¯
                logger.info("Gateway Response: status={}, duration={}ms",
                    exchange.getResponse().getStatusCode(),
                    duration
                );
            })
        );
    }

    @Override
    public int getOrder() {
        return Ordered.LOWEST_PRECEDENCE;  // æœ€ä½ä¼˜å…ˆçº§ï¼Œæœ€åæ‰§è¡Œ
    }
}
</code></pre>
<h4 id="ç¤ºä¾‹3-è‡ªå®šä¹‰gateway-filter-factory"><a class="header" href="#ç¤ºä¾‹3-è‡ªå®šä¹‰gateway-filter-factory">ç¤ºä¾‹3: è‡ªå®šä¹‰Gateway Filter Factory</a></h4>
<pre><code class="language-java">package com.example.gateway.filter;

import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.stereotype.Component;

/**
 * è‡ªå®šä¹‰è¿‡æ»¤å™¨å·¥å‚ï¼šæ·»åŠ è¯·æ±‚æ—¶é—´æˆ³
 */
@Component
public class RequestTimeGatewayFilterFactory
    extends AbstractGatewayFilterFactory&lt;RequestTimeGatewayFilterFactory.Config&gt; {

    public RequestTimeGatewayFilterFactory() {
        super(Config.class);
    }

    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -&gt; {
            if (config.isEnabled()) {
                ServerHttpRequest request = exchange.getRequest().mutate()
                    .header("X-Request-Time", String.valueOf(System.currentTimeMillis()))
                    .build();

                return chain.filter(exchange.mutate().request(request).build());
            }
            return chain.filter(exchange);
        };
    }

    public static class Config {
        private boolean enabled = true;

        public boolean isEnabled() {
            return enabled;
        }

        public void setEnabled(boolean enabled) {
            this.enabled = enabled;
        }
    }
}
</code></pre>
<p><strong>ä½¿ç”¨è‡ªå®šä¹‰Filter Factory</strong>:</p>
<pre><code class="language-yaml">filters:
  - name: RequestTime
    args:
      enabled: true
</code></pre>
<hr />
<h2 id="6-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"><a class="header" href="#6-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡">6. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</a></h2>
<h3 id="61-é›†æˆ-nacos"><a class="header" href="#61-é›†æˆ-nacos">6.1 é›†æˆ Nacos</a></h3>
<p><strong>é…ç½®ç¤ºä¾‹</strong>:</p>
<pre><code class="language-yaml">spring:
  application:
    name: api-gateway
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: dev
        group: DEFAULT_GROUP

    gateway:
      routes:
        # ä»Nacosè·å–æœåŠ¡å®ä¾‹
        - id: user-service
          uri: lb://user-service  # lb:// è¡¨ç¤ºè´Ÿè½½å‡è¡¡
          predicates:
            - Path=/api/users/**

      # è‡ªåŠ¨ä»Nacoså‘ç°æœåŠ¡å¹¶åˆ›å»ºè·¯ç”±
      discovery:
        locator:
          enabled: true                    # å¯ç”¨æœåŠ¡å‘ç°
          lower-case-service-id: true      # æœåŠ¡åè½¬å°å†™
          predicates:
            - Path=/api/{service}/**       # è‡ªåŠ¨è·¯ç”±è§„åˆ™
          filters:
            - StripPrefix=1
</code></pre>
<h3 id="62-è´Ÿè½½å‡è¡¡é…ç½®"><a class="header" href="#62-è´Ÿè½½å‡è¡¡é…ç½®">6.2 è´Ÿè½½å‡è¡¡é…ç½®</a></h3>
<pre><code class="language-yaml">spring:
  cloud:
    loadbalancer:
      # è´Ÿè½½å‡è¡¡ç­–ç•¥
      configurations: default
      ribbon:
        enabled: false  # ç¦ç”¨Ribbonï¼Œä½¿ç”¨Spring Cloud LoadBalancer

    gateway:
      routes:
        - id: load-balanced-route
          uri: lb://user-service
          predicates:
            - Path=/users/**
</code></pre>
<p><strong>è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥</strong>:</p>
<pre><code class="language-java">package com.example.gateway.loadbalancer;

import org.springframework.beans.factory.ObjectProvider;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.loadbalancer.DefaultResponse;
import org.springframework.cloud.client.loadbalancer.Request;
import org.springframework.cloud.client.loadbalancer.Response;
import org.springframework.cloud.loadbalancer.core.ReactorServiceInstanceLoadBalancer;
import org.springframework.cloud.loadbalancer.core.ServiceInstanceListSupplier;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Random;

/**
 * è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ï¼šéšæœºç­–ç•¥
 */
public class CustomLoadBalancer implements ReactorServiceInstanceLoadBalancer {

    private final ObjectProvider&lt;ServiceInstanceListSupplier&gt; serviceInstanceListSupplierProvider;
    private final String serviceId;
    private final Random random = new Random();

    public CustomLoadBalancer(
        ObjectProvider&lt;ServiceInstanceListSupplier&gt; serviceInstanceListSupplierProvider,
        String serviceId) {
        this.serviceInstanceListSupplierProvider = serviceInstanceListSupplierProvider;
        this.serviceId = serviceId;
    }

    @Override
    public Mono&lt;Response&lt;ServiceInstance&gt;&gt; choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        return supplier.get().next()
            .map(instances -&gt; getInstanceResponse(instances));
    }

    private Response&lt;ServiceInstance&gt; getInstanceResponse(List&lt;ServiceInstance&gt; instances) {
        if (instances.isEmpty()) {
            return new DefaultResponse(null);
        }

        int index = random.nextInt(instances.size());
        return new DefaultResponse(instances.get(index));
    }
}
</code></pre>
<hr />
<h2 id="7-é™æµä¸ç†”æ–­"><a class="header" href="#7-é™æµä¸ç†”æ–­">7. é™æµä¸ç†”æ–­</a></h2>
<h3 id="71-åŸºäº-redis-çš„é™æµ"><a class="header" href="#71-åŸºäº-redis-çš„é™æµ">7.1 åŸºäº Redis çš„é™æµ</a></h3>
<p><strong>é…ç½®Redis</strong>:</p>
<pre><code class="language-yaml">spring:
  redis:
    host: localhost
    port: 6379
    password:
    database: 0

  cloud:
    gateway:
      routes:
        - id: rate-limited-route
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - name: RequestRateLimiter
              args:
                # ä»¤ç‰Œæ¡¶ç®—æ³•å‚æ•°
                redis-rate-limiter.replenishRate: 10  # æ¯ç§’å…è®¸çš„è¯·æ±‚æ•°
                redis-rate-limiter.burstCapacity: 20  # ä»¤ç‰Œæ¡¶å®¹é‡
                redis-rate-limiter.requestedTokens: 1 # æ¯ä¸ªè¯·æ±‚æ¶ˆè€—çš„ä»¤ç‰Œæ•°
                key-resolver: "#{@ipKeyResolver}"     # é™æµç»´åº¦
</code></pre>
<h3 id="72-é›†æˆ-sentinel"><a class="header" href="#72-é›†æˆ-sentinel">7.2 é›†æˆ Sentinel</a></h3>
<p><strong>æ·»åŠ ä¾èµ–</strong>:</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
    &lt;version&gt;2021.0.5.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt;
    &lt;version&gt;2021.0.5.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p><strong>é…ç½®Sentinel</strong>:</p>
<pre><code class="language-yaml">spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080  # Sentinelæ§åˆ¶å°åœ°å€
        port: 8719
      eager: true  # å¯åŠ¨æ—¶è¿æ¥

      # Gatewayé™æµè§„åˆ™
      scg:
        fallback:
          mode: response
          response-body: '{"code": 429, "message": "Too Many Requests"}'
        order: -100
</code></pre>
<p><strong>è‡ªå®šä¹‰é™çº§å¤„ç†å™¨</strong>:</p>
<pre><code class="language-java">package com.example.gateway.handler;

import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;
import com.alibaba.fastjson.JSON;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.server.ServerResponse;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.util.HashMap;
import java.util.Map;

@Component
public class CustomBlockRequestHandler implements BlockRequestHandler {

    @Override
    public Mono&lt;ServerResponse&gt; handleRequest(ServerWebExchange exchange, Throwable t) {
        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
        result.put("code", 429);
        result.put("message", "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        result.put("timestamp", System.currentTimeMillis());

        return ServerResponse.status(HttpStatus.TOO_MANY_REQUESTS)
            .contentType(MediaType.APPLICATION_JSON)
            .bodyValue(JSON.toJSONString(result));
    }
}
</code></pre>
<hr />
<h2 id="8-å®‰å…¨è®¤è¯"><a class="header" href="#8-å®‰å…¨è®¤è¯">8. å®‰å…¨è®¤è¯</a></h2>
<h3 id="81-jwt-è®¤è¯"><a class="header" href="#81-jwt-è®¤è¯">8.1 JWT è®¤è¯</a></h3>
<p><strong>JWTå·¥å…·ç±»</strong>:</p>
<pre><code class="language-java">package com.example.gateway.util;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.springframework.stereotype.Component;

import java.util.Date;

@Component
public class JwtUtil {

    private static final String SECRET_KEY = "my-secret-key-for-jwt-token-generation";
    private static final long EXPIRATION_TIME = 86400000; // 24å°æ—¶

    /**
     * ç”ŸæˆToken
     */
    public String generateToken(String userId) {
        return Jwts.builder()
            .setSubject(userId)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
            .signWith(SignatureAlgorithm.HS512, SECRET_KEY)
            .compact();
    }

    /**
     * éªŒè¯Token
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(SECRET_KEY).parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * ä»Tokenè·å–ç”¨æˆ·ID
     */
    public String getUserIdFromToken(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(SECRET_KEY)
            .parseClaimsJws(token)
            .getBody();
        return claims.getSubject();
    }

    /**
     * åˆ¤æ–­Tokenæ˜¯å¦è¿‡æœŸ
     */
    public boolean isTokenExpired(String token) {
        try {
            Claims claims = Jwts.parser()
                .setSigningKey(SECRET_KEY)
                .parseClaimsJws(token)
                .getBody();
            return claims.getExpiration().before(new Date());
        } catch (Exception e) {
            return true;
        }
    }
}
</code></pre>
<p><strong>JWTè®¤è¯è¿‡æ»¤å™¨</strong>:</p>
<pre><code class="language-java">package com.example.gateway.filter;

import com.example.gateway.util.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
public class JwtAuthenticationFilter implements GlobalFilter, Ordered {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        // ç™½åå•
        String path = request.getPath().value();
        if (isWhiteList(path)) {
            return chain.filter(exchange);
        }

        // è·å–Token
        String token = request.getHeaders().getFirst("Authorization");
        if (token != null &amp;&amp; token.startsWith("Bearer ")) {
            token = token.substring(7);
        }

        // éªŒè¯Token
        if (token == null || !jwtUtil.validateToken(token) || jwtUtil.isTokenExpired(token)) {
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        // æå–ç”¨æˆ·ä¿¡æ¯å¹¶ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
        String userId = jwtUtil.getUserIdFromToken(token);
        ServerHttpRequest mutatedRequest = request.mutate()
            .header("X-User-Id", userId)
            .build();

        return chain.filter(exchange.mutate().request(mutatedRequest).build());
    }

    @Override
    public int getOrder() {
        return -100;
    }

    private boolean isWhiteList(String path) {
        return path.startsWith("/api/auth/login") ||
               path.startsWith("/api/auth/register") ||
               path.startsWith("/api/public/");
    }
}
</code></pre>
<h3 id="82-cors-è·¨åŸŸé…ç½®"><a class="header" href="#82-cors-è·¨åŸŸé…ç½®">8.2 CORS è·¨åŸŸé…ç½®</a></h3>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - "http://localhost:3000"
              - "https://www.example.com"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
              - Content-Type
            allowCredentials: true
            maxAge: 3600
</code></pre>
<hr />
<h2 id="9-ç›‘æ§ä¸è¿ç»´"><a class="header" href="#9-ç›‘æ§ä¸è¿ç»´">9. ç›‘æ§ä¸è¿ç»´</a></h2>
<h3 id="91-actuator-ç›‘æ§"><a class="header" href="#91-actuator-ç›‘æ§">9.1 Actuator ç›‘æ§</a></h3>
<pre><code class="language-yaml">management:
  endpoints:
    web:
      exposure:
        include:
          - gateway
          - health
          - metrics
          - prometheus
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
</code></pre>
<p><strong>å¸¸ç”¨ç›‘æ§ç«¯ç‚¹</strong>:</p>
<pre><code class="language-bash"># æŸ¥çœ‹æ‰€æœ‰è·¯ç”±
curl http://localhost:8080/actuator/gateway/routes

# æŸ¥çœ‹å…¨å±€è¿‡æ»¤å™¨
curl http://localhost:8080/actuator/gateway/globalfilters

# æŸ¥çœ‹è·¯ç”±è¿‡æ»¤å™¨
curl http://localhost:8080/actuator/gateway/routefilters

# åˆ·æ–°è·¯ç”±
curl -X POST http://localhost:8080/actuator/gateway/refresh

# å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health
</code></pre>
<h3 id="92-æ—¥å¿—é…ç½®"><a class="header" href="#92-æ—¥å¿—é…ç½®">9.2 æ—¥å¿—é…ç½®</a></h3>
<p><strong>logback-spring.xml</strong>:</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
    &lt;appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;file&gt;logs/gateway.log&lt;/file&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
            &lt;fileNamePattern&gt;logs/gateway.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;logger name="org.springframework.cloud.gateway" level="DEBUG"/&gt;
    &lt;logger name="org.springframework.cloud.loadbalancer" level="DEBUG"/&gt;

    &lt;root level="INFO"&gt;
        &lt;appender-ref ref="CONSOLE"/&gt;
        &lt;appender-ref ref="FILE"/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<hr />
<h2 id="10-æ€§èƒ½ä¼˜åŒ–"><a class="header" href="#10-æ€§èƒ½ä¼˜åŒ–">10. æ€§èƒ½ä¼˜åŒ–</a></h2>
<h3 id="101-è¿æ¥æ± ä¼˜åŒ–"><a class="header" href="#101-è¿æ¥æ± ä¼˜åŒ–">10.1 è¿æ¥æ± ä¼˜åŒ–</a></h3>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      httpclient:
        # è¿æ¥è¶…æ—¶
        connect-timeout: 1000
        # å“åº”è¶…æ—¶
        response-timeout: 5s
        # è¿æ¥æ± é…ç½®
        pool:
          type: FIXED
          max-connections: 500        # æœ€å¤§è¿æ¥æ•°
          max-idle-time: 30s          # ç©ºé—²è¶…æ—¶
          max-life-time: 60s          # æœ€å¤§å­˜æ´»æ—¶é—´
          acquire-timeout: 45000      # è·å–è¿æ¥è¶…æ—¶
</code></pre>
<h3 id="102-å†…å­˜ä¼˜åŒ–"><a class="header" href="#102-å†…å­˜ä¼˜åŒ–">10.2 å†…å­˜ä¼˜åŒ–</a></h3>
<pre><code class="language-yaml"># JVMå‚æ•°
java -Xms2g -Xmx2g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -Dreactor.netty.ioWorkerCount=16 \
     -jar gateway.jar
</code></pre>
<h3 id="103-ç¼“å­˜ç­–ç•¥"><a class="header" href="#103-ç¼“å­˜ç­–ç•¥">10.3 ç¼“å­˜ç­–ç•¥</a></h3>
<pre><code class="language-java">@Configuration
public class CacheConfig {

    @Bean
    public RouteLocator cacheRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            .route("cache-route", r -&gt; r
                .path("/api/products/**")
                .filters(f -&gt; f
                    .setResponseHeader("Cache-Control", "max-age=3600")
                    .setResponseHeader("Pragma", "cache")
                )
                .uri("lb://product-service")
            )
            .build();
    }
}
</code></pre>
<hr />
<h2 id="11-æœ€ä½³å®è·µ"><a class="header" href="#11-æœ€ä½³å®è·µ">11. æœ€ä½³å®è·µ</a></h2>
<h3 id="111-ç»Ÿä¸€å¼‚å¸¸å¤„ç†"><a class="header" href="#111-ç»Ÿä¸€å¼‚å¸¸å¤„ç†">11.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†</a></h3>
<pre><code class="language-java">package com.example.gateway.exception;

import org.springframework.boot.web.reactive.error.ErrorWebExceptionHandler;
import org.springframework.core.io.buffer.DataBufferFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ResponseStatusException;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
public class GlobalExceptionHandler implements ErrorWebExceptionHandler {

    @Override
    public Mono&lt;Void&gt; handle(ServerWebExchange exchange, Throwable ex) {
        ServerHttpResponse response = exchange.getResponse();

        if (response.isCommitted()) {
            return Mono.error(ex);
        }

        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);

        if (ex instanceof ResponseStatusException) {
            response.setStatusCode(((ResponseStatusException) ex).getStatus());
        } else {
            response.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);
        }

        return response.writeWith(Mono.fromSupplier(() -&gt; {
            DataBufferFactory bufferFactory = response.bufferFactory();
            String errorMsg = String.format("{\"code\": %d, \"message\": \"%s\"}",
                response.getStatusCode().value(),
                ex.getMessage());
            return bufferFactory.wrap(errorMsg.getBytes());
        }));
    }
}
</code></pre>
<h3 id="112-ç°åº¦å‘å¸ƒç­–ç•¥"><a class="header" href="#112-ç°åº¦å‘å¸ƒç­–ç•¥">11.2 ç°åº¦å‘å¸ƒç­–ç•¥</a></h3>
<pre><code class="language-yaml">spring:
  cloud:
    gateway:
      routes:
        # ç¨³å®šç‰ˆæœ¬
        - id: service-stable
          uri: lb://service-v1
          predicates:
            - Path=/api/**
            - Header=X-Version, v1
            - Weight=version, 8

        # ç°åº¦ç‰ˆæœ¬
        - id: service-canary
          uri: lb://service-v2
          predicates:
            - Path=/api/**
            - Header=X-Canary, true
            - Weight=version, 2
</code></pre>
<hr />
<h2 id="12-å­¦ä¹ éªŒè¯æ ‡å‡†"><a class="header" href="#12-å­¦ä¹ éªŒè¯æ ‡å‡†">12. å­¦ä¹ éªŒè¯æ ‡å‡†</a></h2>
<p>å®Œæˆæœ¬ç¬”è®°å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š</p>
<h3 id="éªŒè¯æ ‡å‡†1-åŸºç¡€çŸ¥è¯†å¿…é¡»"><a class="header" href="#éªŒè¯æ ‡å‡†1-åŸºç¡€çŸ¥è¯†å¿…é¡»">éªŒè¯æ ‡å‡†1: åŸºç¡€çŸ¥è¯†ï¼ˆå¿…é¡»ï¼‰</a></h3>
<p><strong>æµ‹è¯•ä»»åŠ¡</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"/>
è§£é‡ŠAPIç½‘å…³çš„ä½œç”¨å’Œä»·å€¼</li>
<li><input disabled="" type="checkbox"/>
è¯´æ˜Gatewayçš„æ¶æ„å’Œæ ¸å¿ƒç»„ä»¶</li>
<li><input disabled="" type="checkbox"/>
å¯¹æ¯”Gatewayä¸Zuulçš„åŒºåˆ«</li>
<li><input disabled="" type="checkbox"/>
æ­å»ºä¸€ä¸ªåŸºç¡€çš„Gatewayé¡¹ç›®</li>
</ul>
<p><strong>éªŒè¯æ–¹å¼</strong>: å®ŒæˆGatewayé¡¹ç›®æ­å»ºå¹¶èƒ½è®¿é—®ä¸‹æ¸¸æœåŠ¡</p>
<h3 id="éªŒè¯æ ‡å‡†2-è·¯ç”±ä¸æ–­è¨€å¿…é¡»"><a class="header" href="#éªŒè¯æ ‡å‡†2-è·¯ç”±ä¸æ–­è¨€å¿…é¡»">éªŒè¯æ ‡å‡†2: è·¯ç”±ä¸æ–­è¨€ï¼ˆå¿…é¡»ï¼‰</a></h3>
<p><strong>æµ‹è¯•ä»»åŠ¡</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"/>
é…ç½®åŸºäºè·¯å¾„ã€æ–¹æ³•ã€Headerçš„è·¯ç”±</li>
<li><input disabled="" type="checkbox"/>
ä½¿ç”¨å¤šç§æ–­è¨€å·¥å‚ç»„åˆè·¯ç”±æ¡ä»¶</li>
<li><input disabled="" type="checkbox"/>
å®ç°åŠ¨æ€è·¯ç”±ç®¡ç†</li>
<li><input disabled="" type="checkbox"/>
é…ç½®æƒé‡è·¯ç”±å®ç°é‡‘ä¸é›€å‘å¸ƒ</li>
</ul>
<p><strong>éªŒè¯æ–¹å¼</strong>: å®ç°3ç§ä»¥ä¸Šæ–­è¨€ç»„åˆçš„è·¯ç”±é…ç½®</p>
<h3 id="éªŒè¯æ ‡å‡†3-è¿‡æ»¤å™¨å¼€å‘å¿…é¡»"><a class="header" href="#éªŒè¯æ ‡å‡†3-è¿‡æ»¤å™¨å¼€å‘å¿…é¡»">éªŒè¯æ ‡å‡†3: è¿‡æ»¤å™¨å¼€å‘ï¼ˆå¿…é¡»ï¼‰</a></h3>
<p><strong>æµ‹è¯•ä»»åŠ¡</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"/>
ä½¿ç”¨5ç§ä»¥ä¸Šå†…ç½®è¿‡æ»¤å™¨</li>
<li><input disabled="" type="checkbox"/>
å¼€å‘è‡ªå®šä¹‰GlobalFilter</li>
<li><input disabled="" type="checkbox"/>
å¼€å‘è‡ªå®šä¹‰GatewayFilterFactory</li>
<li><input disabled="" type="checkbox"/>
å®ç°è¯·æ±‚æ—¥å¿—è®°å½•å’Œç»Ÿä¸€è®¤è¯</li>
</ul>
<p><strong>éªŒè¯æ–¹å¼</strong>: å®Œæˆè®¤è¯è¿‡æ»¤å™¨å’Œæ—¥å¿—è¿‡æ»¤å™¨å¼€å‘</p>
<h3 id="éªŒè¯æ ‡å‡†4-é«˜çº§ç‰¹æ€§æ¨è"><a class="header" href="#éªŒè¯æ ‡å‡†4-é«˜çº§ç‰¹æ€§æ¨è">éªŒè¯æ ‡å‡†4: é«˜çº§ç‰¹æ€§ï¼ˆæ¨èï¼‰</a></h3>
<p><strong>æµ‹è¯•ä»»åŠ¡</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"/>
é…ç½®Redisé™æµ</li>
<li><input disabled="" type="checkbox"/>
é›†æˆSentinelç†”æ–­é™çº§</li>
<li><input disabled="" type="checkbox"/>
å®ç°JWTè®¤è¯</li>
<li><input disabled="" type="checkbox"/>
é…ç½®CORSè·¨åŸŸ</li>
</ul>
<p><strong>éªŒè¯æ–¹å¼</strong>: å‹æµ‹éªŒè¯é™æµå’Œç†”æ–­æ•ˆæœ</p>
<h3 id="éªŒè¯æ ‡å‡†5-ç”Ÿäº§å®è·µè¿›é˜¶"><a class="header" href="#éªŒè¯æ ‡å‡†5-ç”Ÿäº§å®è·µè¿›é˜¶">éªŒè¯æ ‡å‡†5: ç”Ÿäº§å®è·µï¼ˆè¿›é˜¶ï¼‰</a></h3>
<p><strong>æµ‹è¯•ä»»åŠ¡</strong>:</p>
<ul>
<li><input disabled="" type="checkbox"/>
é…ç½®Actuatorç›‘æ§</li>
<li><input disabled="" type="checkbox"/>
ä¼˜åŒ–è¿æ¥æ± å’Œå†…å­˜å‚æ•°</li>
<li><input disabled="" type="checkbox"/>
å®ç°ç°åº¦å‘å¸ƒ</li>
<li><input disabled="" type="checkbox"/>
æ’æŸ¥å¹¶è§£å†³ä¸€ä¸ªæ€§èƒ½é—®é¢˜</li>
</ul>
<p><strong>éªŒè¯æ–¹å¼</strong>: åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²Gatewayå¹¶ç›‘æ§è¿è¡Œ</p>
<hr />
<h2 id="13-æ‰©å±•èµ„æº"><a class="header" href="#13-æ‰©å±•èµ„æº">13. æ‰©å±•èµ„æº</a></h2>
<h3 id="å®˜æ–¹æ–‡æ¡£"><a class="header" href="#å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</a></h3>
<ul>
<li>Spring Cloud Gateway: https://spring.io/projects/spring-cloud-gateway</li>
<li>å®˜æ–¹æ–‡æ¡£: https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/</li>
<li>GitHub: https://github.com/spring-cloud/spring-cloud-gateway</li>
</ul>
<h3 id="æ¨èä¹¦ç±"><a class="header" href="#æ¨èä¹¦ç±">æ¨èä¹¦ç±</a></h3>
<ul>
<li>ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹</li>
<li>ã€ŠSpring Cloud Gatewayå®æˆ˜ã€‹</li>
<li>ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹</li>
</ul>
<h3 id="è§†é¢‘æ•™ç¨‹"><a class="header" href="#è§†é¢‘æ•™ç¨‹">è§†é¢‘æ•™ç¨‹</a></h3>
<ul>
<li>å°šç¡…è°·Spring Cloud Gatewayæ•™ç¨‹</li>
<li>é»‘é©¬ç¨‹åºå‘˜å¾®æœåŠ¡ç½‘å…³ä¸“é¢˜</li>
<li>Bilibili Spring Cloudå®æˆ˜ç³»åˆ—</li>
</ul>
<h3 id="å®è·µé¡¹ç›®"><a class="header" href="#å®è·µé¡¹ç›®">å®è·µé¡¹ç›®</a></h3>
<ol>
<li>ç”µå•†ç³»ç»ŸAPIç½‘å…³</li>
<li>ç»Ÿä¸€è®¤è¯ç½‘å…³</li>
<li>å¾®æœåŠ¡èšåˆç½‘å…³</li>
</ol>
<h3 id="è¿›é˜¶ä¸»é¢˜"><a class="header" href="#è¿›é˜¶ä¸»é¢˜">è¿›é˜¶ä¸»é¢˜</a></h3>
<ul>
<li>Gatewayæºç åˆ†æ</li>
<li>WebFluxå“åº”å¼ç¼–ç¨‹</li>
<li>Gatewayä¸Istioå¯¹æ¯”</li>
<li>Gatewayæ€§èƒ½æé™ä¼˜åŒ–</li>
</ul>
<hr />
<h2 id="-å­¦ä¹ è®°å½•"><a class="header" href="#-å­¦ä¹ è®°å½•">ğŸ“ å­¦ä¹ è®°å½•</a></h2>
<pre><code class="language-yaml">å­¦ä¹ æ—¥å¿—æ¨¡æ¿:
  æ—¥æœŸ: 2024-01-15
  å­¦ä¹ å†…å®¹: Spring Cloud Gatewayè·¯ç”±å’Œè¿‡æ»¤å™¨
  å®è·µæ¡ˆä¾‹:
    - é…ç½®äº†åŸºäºè·¯å¾„å’ŒHeaderçš„è·¯ç”±
    - å¼€å‘äº†JWTè®¤è¯è¿‡æ»¤å™¨
    - å®ç°äº†Redisé™æµ
  é‡åˆ°çš„é—®é¢˜:
    - WebFluxå“åº”å¼ç¼–ç¨‹ç†è§£å›°éš¾
    - è§£å†³æ–¹æ¡ˆ: å­¦ä¹ Project ReactoråŸºç¡€
  å¿ƒå¾—ä½“ä¼š:
    - Gatewayçš„è¿‡æ»¤å™¨æœºåˆ¶éå¸¸çµæ´»
    - å“åº”å¼ç¼–ç¨‹éœ€è¦è½¬å˜æ€ç»´æ–¹å¼
  ä¸‹ä¸€æ­¥è®¡åˆ’:
    - å­¦ä¹ Sentinelé›†æˆ
    - ç ”ç©¶æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
</code></pre>
<hr />
<h2 id="-æ€»ç»“"><a class="header" href="#-æ€»ç»“">ğŸ¯ æ€»ç»“</a></h2>
<p>Spring Cloud Gatewayæ˜¯Spring Cloudç”Ÿæ€çš„æ–°ä¸€ä»£APIç½‘å…³ï¼š</p>
<ul>
<li>ğŸš€ <strong>é«˜æ€§èƒ½</strong>: åŸºäºWebFluxå’ŒReactorï¼Œå¼‚æ­¥éé˜»å¡</li>
<li>ğŸ”§ <strong>çµæ´»</strong>: ä¸°å¯Œçš„æ–­è¨€å’Œè¿‡æ»¤å™¨ï¼Œæ˜“äºæ‰©å±•</li>
<li>ğŸ›¡ï¸ <strong>å®Œå–„</strong>: æ”¯æŒé™æµã€ç†”æ–­ã€è®¤è¯ç­‰ä¼ä¸šçº§åŠŸèƒ½</li>
<li>ğŸ“Š <strong>é›†æˆ</strong>: ä¸Spring Cloudç”Ÿæ€æ— ç¼é›†æˆ</li>
</ul>
<p><strong>å…³é”®è¦ç‚¹</strong>ï¼š</p>
<ol>
<li><strong>ç†è§£å“åº”å¼</strong>: æŒæ¡WebFluxå’ŒReactorç¼–ç¨‹æ¨¡å‹</li>
<li><strong>çµæ´»é…ç½®</strong>: ç†Ÿç»ƒä½¿ç”¨è·¯ç”±ã€æ–­è¨€ã€è¿‡æ»¤å™¨</li>
<li><strong>å®‰å…¨è®¤è¯</strong>: å®ç°ç»Ÿä¸€çš„è®¤è¯é‰´æƒæœºåˆ¶</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: åˆç†é…ç½®è¿æ¥æ± å’ŒJVMå‚æ•°</li>
</ol>
<p>ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼Œæˆä¸ºGatewayä¸“å®¶ï¼ğŸ‰</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../ç¼–ç¨‹/springcloud/springcloud.dubbo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../ç¼–ç¨‹/springcloud/springcloud.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../ç¼–ç¨‹/springcloud/springcloud.dubbo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../ç¼–ç¨‹/springcloud/springcloud.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

