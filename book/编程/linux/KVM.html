<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>KVM 虚拟化技术学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="kvm-虚拟化技术学习笔记"><a class="header" href="#kvm-虚拟化技术学习笔记">KVM 虚拟化技术学习笔记</a></h1>
<blockquote>
<p><strong>学习者定位</strong>: 适合Linux系统管理员、云平台工程师、虚拟化架构师及希望深入了解虚拟化技术的开发人员
<strong>预期学习时长</strong>: 30-40 小时（基础到高级）
<strong>前置知识</strong>: Linux系统管理基础、网络基础知识、存储基础概念</p>
</blockquote>
<hr />
<h2 id="一技术概览与学习路径"><a class="header" href="#一技术概览与学习路径">一、技术概览与学习路径</a></h2>
<h3 id="11-什么是-kvm"><a class="header" href="#11-什么是-kvm">1.1 什么是 KVM</a></h3>
<p>KVM (Kernel-based Virtual Machine) 是Linux内核的一个虚拟化模块，它将Linux内核转换为一个Type-1（裸机）hypervisor。KVM于2007年被合并到Linux主线内核中，是目前最主流的开源虚拟化技术之一。</p>
<p><strong>核心特点</strong>:</p>
<ul>
<li><strong>内核级虚拟化</strong>: 直接集成在Linux内核中，性能卓越</li>
<li><strong>硬件辅助虚拟化</strong>: 依赖CPU的虚拟化扩展（Intel VT-x或AMD-V）</li>
<li><strong>高性能</strong>: 接近原生性能的虚拟化体验</li>
<li><strong>开源免费</strong>: 基于GPL许可证，社区活跃</li>
<li><strong>成熟稳定</strong>: 经过大规模生产环境验证</li>
</ul>
<p><strong>应用场景</strong>:</p>
<ul>
<li>私有云平台（OpenStack、CloudStack）</li>
<li>虚拟桌面基础架构（VDI）</li>
<li>开发测试环境隔离</li>
<li>服务器整合与资源优化</li>
<li>容器运行时（Kata Containers）</li>
</ul>
<h3 id="12-kvm-vs-其他虚拟化技术"><a class="header" href="#12-kvm-vs-其他虚拟化技术">1.2 KVM vs 其他虚拟化技术</a></h3>
<div class="table-wrapper"><table><thead><tr><th>特性</th><th>KVM</th><th>VMware ESXi</th><th>Xen</th><th>VirtualBox</th></tr></thead><tbody>
<tr><td><strong>类型</strong></td><td>Type-1</td><td>Type-1</td><td>Type-1</td><td>Type-2</td></tr>
<tr><td><strong>许可证</strong></td><td>GPL（开源）</td><td>商业</td><td>GPL（开源）</td><td>GPL（开源）</td></tr>
<tr><td><strong>性能</strong></td><td>高（接近原生）</td><td>高</td><td>高</td><td>中等</td></tr>
<tr><td><strong>硬件要求</strong></td><td>VT-x/AMD-V必须</td><td>VT-x/AMD-V必须</td><td>可选</td><td>可选</td></tr>
<tr><td><strong>管理复杂度</strong></td><td>中等</td><td>低（商业支持）</td><td>高</td><td>低</td></tr>
<tr><td><strong>适用场景</strong></td><td>企业私有云</td><td>企业虚拟化</td><td>云平台</td><td>开发测试</td></tr>
</tbody></table>
</div>
<h3 id="13-学习路径规划"><a class="header" href="#13-学习路径规划">1.3 学习路径规划</a></h3>
<pre><code>阶段1: 基础入门（10-12小时）
├── KVM架构原理理解
├── 环境搭建与安装配置
├── 虚拟机创建与基本管理
├── libvirt 工具使用
└── 网络和存储基础配置

阶段2: 进阶应用（12-15小时）
├── CPU/内存虚拟化深入
├── 存储虚拟化高级配置
├── 网络虚拟化与优化
├── 虚拟机迁移技术
└── 性能监控与分析

阶段3: 高级实战（15-18小时）
├── 性能优化与调优
├── 高可用架构设计
├── 故障排查与恢复
├── 自动化管理与编排
└── 生产环境最佳实践
</code></pre>
<hr />
<h2 id="二kvm-架构深入理解"><a class="header" href="#二kvm-架构深入理解">二、KVM 架构深入理解</a></h2>
<h3 id="21-整体架构"><a class="header" href="#21-整体架构">2.1 整体架构</a></h3>
<pre><code>┌─────────────────────────────────────────────────────┐
│              用户空间 (User Space)                    │
│  ┌─────────┬──────────┬─────────────┬─────────────┐ │
│  │ libvirt │   QEMU   │virt-manager │  virsh/API  │ │
│  └─────────┴──────────┴─────────────┴─────────────┘ │
├─────────────────────────────────────────────────────┤
│              内核空间 (Kernel Space)                  │
│  ┌─────────────────────────────────────────────────┐│
│  │  KVM模块  │ 调度器 │ 内存管理 │  I/O子系统    ││
│  │(kvm.ko, kvm-intel.ko/kvm-amd.ko)               ││
│  └─────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────┤
│              硬件层 (Hardware)                        │
│  ┌─────────────────────────────────────────────────┐│
│  │ CPU (VT-x/AMD-V) │ 内存 │ 存储 │ 网络 │ 其他   ││
│  └─────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
</code></pre>
<h3 id="22-核心工作原理"><a class="header" href="#22-核心工作原理">2.2 核心工作原理</a></h3>
<ol>
<li><strong>内核模块</strong>: KVM作为内核模块提供虚拟化基础设施</li>
<li><strong>QEMU进程</strong>: 每个虚拟机对应一个QEMU用户空间进程</li>
<li><strong>硬件辅助</strong>: 利用CPU的VT-x/AMD-V扩展实现硬件级虚拟化</li>
<li><strong>内存虚拟化</strong>: 通过EPT/NPT技术实现高效的内存地址转换</li>
<li><strong>I/O虚拟化</strong>: 设备模拟和直通技术处理I/O操作</li>
</ol>
<h3 id="23-虚拟化模式"><a class="header" href="#23-虚拟化模式">2.3 虚拟化模式</a></h3>
<div class="table-wrapper"><table><thead><tr><th>模式</th><th>说明</th><th>优点</th><th>缺点</th><th>应用场景</th></tr></thead><tbody>
<tr><td><strong>全虚拟化</strong></td><td>完全模拟硬件</td><td>客户机无需修改</td><td>性能开销较大</td><td>运行未修改的操作系统</td></tr>
<tr><td><strong>半虚拟化</strong></td><td>通过hypercall通信</td><td>性能更优</td><td>需修改客户机</td><td>性能敏感场景</td></tr>
<tr><td><strong>硬件辅助虚拟化</strong></td><td>CPU虚拟化扩展</td><td>无需修改+高性能</td><td>需要硬件支持</td><td>现代虚拟化主流方式</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="三环境搭建实战"><a class="header" href="#三环境搭建实战">三、环境搭建实战</a></h2>
<h3 id="31-硬件要求检查"><a class="header" href="#31-硬件要求检查">3.1 硬件要求检查</a></h3>
<h4 id="步骤-1-检查cpu虚拟化支持"><a class="header" href="#步骤-1-检查cpu虚拟化支持">步骤 1: 检查CPU虚拟化支持</a></h4>
<pre><code class="language-bash"># 检查CPU是否支持虚拟化扩展
egrep -c '(vmx|svm)' /proc/cpuinfo
# 输出 &gt; 0 表示支持
# vmx: Intel VT-x
# svm: AMD-V

# 查看详细虚拟化信息
lscpu | grep Virtualization

# 检查是否在BIOS中启用
dmesg | grep -i virtualization
</code></pre>
<p><strong>预期输出</strong>:</p>
<pre><code>Virtualization:      VT-x    # Intel
或
Virtualization:      AMD-V   # AMD
</code></pre>
<h4 id="步骤-2-检查内核kvm模块"><a class="header" href="#步骤-2-检查内核kvm模块">步骤 2: 检查内核KVM模块</a></h4>
<pre><code class="language-bash"># 检查KVM模块是否加载
lsmod | grep kvm

# 如果未加载，手动加载
sudo modprobe kvm
sudo modprobe kvm_intel  # Intel CPU
# 或
sudo modprobe kvm_amd    # AMD CPU

# 验证加载成功
ls /dev/kvm
# 应该看到 /dev/kvm 设备文件
</code></pre>
<h3 id="32-安装-kvm-完整环境"><a class="header" href="#32-安装-kvm-完整环境">3.2 安装 KVM 完整环境</a></h3>
<h4 id="ubuntudebian-系统"><a class="header" href="#ubuntudebian-系统">Ubuntu/Debian 系统</a></h4>
<pre><code class="language-bash"># 更新软件包列表
sudo apt update

# 安装KVM和相关工具
sudo apt install -y qemu-kvm \
                    libvirt-daemon-system \
                    libvirt-clients \
                    bridge-utils \
                    virt-manager \
                    virt-viewer \
                    virtinst \
                    cpu-checker

# 检查系统是否支持KVM
kvm-ok

# 预期输出：
# INFO: /dev/kvm exists
# KVM acceleration can be used

# 将当前用户添加到libvirt组
sudo usermod -aG libvirt $USER
sudo usermod -aG kvm $USER

# 重新登录使组生效，或执行
newgrp libvirt

# 启动libvirt服务
sudo systemctl start libvirtd
sudo systemctl enable libvirtd

# 验证安装
virsh version
virsh list --all
</code></pre>
<h4 id="centosrhel-系统"><a class="header" href="#centosrhel-系统">CentOS/RHEL 系统</a></h4>
<pre><code class="language-bash"># 安装KVM和相关工具
sudo yum install -y qemu-kvm \
                    libvirt \
                    libvirt-python \
                    libguestfs-tools \
                    virt-install \
                    virt-manager \
                    virt-viewer

# 启动libvirt服务
sudo systemctl start libvirtd
sudo systemctl enable libvirtd

# 验证KVM模块
lsmod | grep kvm

# 添加用户到组
sudo usermod -aG libvirt $USER
sudo usermod -aG kvm $USER

# 配置防火墙（如果启用）
sudo firewall-cmd --permanent --add-service=libvirt
sudo firewall-cmd --reload
</code></pre>
<h3 id="33-第一个实战案例创建虚拟机"><a class="header" href="#33-第一个实战案例创建虚拟机">3.3 第一个实战案例：创建虚拟机</a></h3>
<h4 id="案例-1-使用-virt-install-创建虚拟机"><a class="header" href="#案例-1-使用-virt-install-创建虚拟机">案例 1: 使用 virt-install 创建虚拟机</a></h4>
<p><strong>场景</strong>: 创建一个 CentOS 8 虚拟机</p>
<pre><code class="language-bash"># 下载 CentOS 8 ISO（示例）
cd /var/lib/libvirt/images
sudo wget https://mirrors.tuna.tsinghua.edu.cn/centos/8-stream/isos/x86_64/CentOS-Stream-8-x86_64-latest-dvd1.iso

# 创建虚拟机
sudo virt-install \
  --name centos8-vm \
  --ram 2048 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/centos8-vm.qcow2,size=20,format=qcow2 \
  --os-variant centos8 \
  --network bridge=virbr0 \
  --graphics vnc,listen=0.0.0.0,port=5900 \
  --console pty,target_type=serial \
  --cdrom /var/lib/libvirt/images/CentOS-Stream-8-x86_64-latest-dvd1.iso \
  --boot uefi
</code></pre>
<p><strong>参数说明</strong>:</p>
<ul>
<li><code>--name</code>: 虚拟机名称</li>
<li><code>--ram</code>: 内存大小（MB）</li>
<li><code>--vcpus</code>: 虚拟CPU数量</li>
<li><code>--disk</code>: 磁盘配置（路径、大小、格式）</li>
<li><code>--os-variant</code>: 操作系统类型（<code>osinfo-query os</code> 查看支持的类型）</li>
<li><code>--network</code>: 网络配置</li>
<li><code>--graphics</code>: 图形显示配置</li>
<li><code>--cdrom</code>: ISO镜像路径</li>
</ul>
<h4 id="案例-2-使用-virsh-管理虚拟机"><a class="header" href="#案例-2-使用-virsh-管理虚拟机">案例 2: 使用 virsh 管理虚拟机</a></h4>
<pre><code class="language-bash"># 列出所有虚拟机
virsh list --all

# 启动虚拟机
virsh start centos8-vm

# 连接虚拟机控制台
virsh console centos8-vm

# 查看虚拟机详细信息
virsh dominfo centos8-vm

# 关闭虚拟机
virsh shutdown centos8-vm

# 强制关闭虚拟机
virsh destroy centos8-vm

# 删除虚拟机（不删除磁盘）
virsh undefine centos8-vm

# 删除虚拟机并删除磁盘
virsh undefine centos8-vm --remove-all-storage
</code></pre>
<h4 id="案例-3-使用-virt-manager-图形界面"><a class="header" href="#案例-3-使用-virt-manager-图形界面">案例 3: 使用 virt-manager 图形界面</a></h4>
<pre><code class="language-bash"># 启动virt-manager
virt-manager

# 或者通过SSH X11转发远程使用
ssh -X user@kvm-host
virt-manager
</code></pre>
<p><strong>图形界面操作步骤</strong>:</p>
<ol>
<li>点击"创建新虚拟机"</li>
<li>选择安装媒体（本地安装介质、网络安装等）</li>
<li>选择ISO镜像文件</li>
<li>配置内存和CPU</li>
<li>配置磁盘</li>
<li>配置网络</li>
<li>开始安装</li>
</ol>
<hr />
<h2 id="四网络虚拟化深入"><a class="header" href="#四网络虚拟化深入">四、网络虚拟化深入</a></h2>
<h3 id="41-网络模式详解"><a class="header" href="#41-网络模式详解">4.1 网络模式详解</a></h3>
<h4 id="模式-1-nat-模式默认"><a class="header" href="#模式-1-nat-模式默认">模式 1: NAT 模式（默认）</a></h4>
<p><strong>特点</strong>: 虚拟机通过宿主机NAT访问外网，虚拟机之间可以互通</p>
<pre><code class="language-bash"># 查看默认网络
virsh net-list --all

# 查看default网络配置
virsh net-dumpxml default

# 启动网络
virsh net-start default
virsh net-autostart default
</code></pre>
<p><strong>配置示例</strong>:</p>
<pre><code class="language-xml">&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;forward mode='nat'/&gt;
  &lt;bridge name='virbr0' stp='on' delay='0'/&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.122.100' end='192.168.122.200'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre>
<p><strong>测试验证</strong>:</p>
<pre><code class="language-bash"># 在宿主机查看网桥
brctl show

# 查看NAT规则
sudo iptables -t nat -L -n -v | grep virbr0

# 在虚拟机内测试网络
ping 8.8.8.8
curl http://www.baidu.com
</code></pre>
<h4 id="模式-2-桥接模式"><a class="header" href="#模式-2-桥接模式">模式 2: 桥接模式</a></h4>
<p><strong>特点</strong>: 虚拟机直接连接到物理网络，获得与宿主机同网段的IP</p>
<p><strong>步骤 1: 创建网桥</strong></p>
<pre><code class="language-bash"># 安装bridge-utils
sudo apt install bridge-utils -y

# 创建网桥配置文件 /etc/netplan/01-netcfg.yaml（Ubuntu）
network:
  version: 2
  ethernets:
    ens33:
      dhcp4: no
  bridges:
    br0:
      interfaces: [ens33]
      dhcp4: yes
      parameters:
        stp: false

# 应用配置
sudo netplan apply

# 验证网桥
brctl show
ip addr show br0
</code></pre>
<p><strong>CentOS/RHEL 配置</strong>:</p>
<pre><code class="language-bash"># 网桥配置 /etc/sysconfig/network-scripts/ifcfg-br0
DEVICE=br0
TYPE=Bridge
BOOTPROTO=dhcp
ONBOOT=yes
DELAY=0

# 物理网卡配置 /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
BRIDGE=br0

# 重启网络
sudo systemctl restart network
</code></pre>
<p><strong>步骤 2: 创建虚拟机使用桥接</strong></p>
<pre><code class="language-bash"># 创建桥接网络虚拟机
sudo virt-install \
  --name bridge-vm \
  --ram 2048 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/bridge-vm.qcow2,size=20 \
  --os-variant centos8 \
  --network bridge=br0,model=virtio \
  --graphics vnc \
  --cdrom /var/lib/libvirt/images/centos8.iso
</code></pre>
<h4 id="模式-3-仅主机模式"><a class="header" href="#模式-3-仅主机模式">模式 3: 仅主机模式</a></h4>
<pre><code class="language-bash"># 创建仅主机网络
cat &gt; /tmp/isolated.xml &lt;&lt;EOF
&lt;network&gt;
  &lt;name&gt;isolated&lt;/name&gt;
  &lt;bridge name='virbr1' stp='on' delay='0'/&gt;
  &lt;ip address='192.168.100.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.100.100' end='192.168.100.200'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
EOF

# 定义并启动网络
virsh net-define /tmp/isolated.xml
virsh net-start isolated
virsh net-autostart isolated
</code></pre>
<h3 id="42-网络性能优化"><a class="header" href="#42-网络性能优化">4.2 网络性能优化</a></h3>
<h4 id="启用多队列网络"><a class="header" href="#启用多队列网络">启用多队列网络</a></h4>
<pre><code class="language-xml">&lt;interface type='bridge'&gt;
  &lt;source bridge='br0'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;driver name='vhost' queues='4'/&gt;
  &lt;tune&gt;
    &lt;sndbuf&gt;1048576&lt;/sndbuf&gt;
  &lt;/tune&gt;
&lt;/interface&gt;
</code></pre>
<p><strong>在虚拟机内启用多队列</strong>:</p>
<pre><code class="language-bash"># 查看网卡队列
ethtool -l eth0

# 设置队列数量
ethtool -L eth0 combined 4

# 验证
ethtool -l eth0
</code></pre>
<h4 id="sr-iov-配置高级"><a class="header" href="#sr-iov-配置高级">SR-IOV 配置（高级）</a></h4>
<pre><code class="language-bash"># 检查网卡是否支持SR-IOV
lspci -v | grep -i sr-iov

# 启用SR-IOV
echo 4 &gt; /sys/class/net/eth0/device/sriov_numvfs

# 查看VF设备
lspci | grep "Virtual Function"

# 在虚拟机XML中配置VF直通
&lt;interface type='hostdev' managed='yes'&gt;
  &lt;source&gt;
    &lt;address type='pci' domain='0x0000' bus='0x01' slot='0x10' function='0x0'/&gt;
  &lt;/source&gt;
&lt;/interface&gt;
</code></pre>
<hr />
<h2 id="五存储虚拟化深入"><a class="header" href="#五存储虚拟化深入">五、存储虚拟化深入</a></h2>
<h3 id="51-存储格式对比"><a class="header" href="#51-存储格式对比">5.1 存储格式对比</a></h3>
<div class="table-wrapper"><table><thead><tr><th>格式</th><th>特点</th><th>性能</th><th>快照</th><th>压缩</th><th>适用场景</th></tr></thead><tbody>
<tr><td><strong>RAW</strong></td><td>原始格式</td><td>最佳</td><td>否</td><td>否</td><td>生产环境高性能场景</td></tr>
<tr><td><strong>QCOW2</strong></td><td>功能丰富</td><td>良好</td><td>是</td><td>是</td><td>开发测试、需要快照</td></tr>
<tr><td><strong>VDI</strong></td><td>VirtualBox格式</td><td>中等</td><td>是</td><td>否</td><td>与VirtualBox互操作</td></tr>
<tr><td><strong>VMDK</strong></td><td>VMware格式</td><td>良好</td><td>是</td><td>否</td><td>与VMware互操作</td></tr>
</tbody></table>
</div>
<h3 id="52-存储池管理实战"><a class="header" href="#52-存储池管理实战">5.2 存储池管理实战</a></h3>
<h4 id="案例-1-创建目录存储池"><a class="header" href="#案例-1-创建目录存储池">案例 1: 创建目录存储池</a></h4>
<pre><code class="language-bash"># 创建存储目录
sudo mkdir -p /data/kvm/images

# 定义存储池
virsh pool-define-as \
  --name data-pool \
  --type dir \
  --target /data/kvm/images

# 构建并启动存储池
virsh pool-build data-pool
virsh pool-start data-pool
virsh pool-autostart data-pool

# 查看存储池
virsh pool-list --all
virsh pool-info data-pool

# 刷新存储池
virsh pool-refresh data-pool
</code></pre>
<h4 id="案例-2-创建-lvm-存储池"><a class="header" href="#案例-2-创建-lvm-存储池">案例 2: 创建 LVM 存储池</a></h4>
<pre><code class="language-bash"># 创建LVM卷组
sudo pvcreate /dev/sdb
sudo vgcreate vg-kvm /dev/sdb

# 定义LVM存储池
virsh pool-define-as \
  --name lvm-pool \
  --type logical \
  --source-name vg-kvm \
  --target /dev/vg-kvm

# 启动存储池
virsh pool-build lvm-pool
virsh pool-start lvm-pool
virsh pool-autostart lvm-pool

# 创建卷
virsh vol-create-as lvm-pool vm1-disk 20G

# 列出卷
virsh vol-list lvm-pool
</code></pre>
<h4 id="案例-3-创建-nfs-存储池"><a class="header" href="#案例-3-创建-nfs-存储池">案例 3: 创建 NFS 存储池</a></h4>
<pre><code class="language-bash"># NFS服务器配置 /etc/exports
/data/nfs-kvm 192.168.1.0/24(rw,sync,no_root_squash)

# 在KVM主机上挂载
sudo mkdir -p /mnt/nfs-kvm

# 定义NFS存储池
virsh pool-define-as \
  --name nfs-pool \
  --type netfs \
  --source-host 192.168.1.100 \
  --source-path /data/nfs-kvm \
  --target /mnt/nfs-kvm

# 启动存储池
virsh pool-build nfs-pool
virsh pool-start nfs-pool
virsh pool-autostart nfs-pool
</code></pre>
<h3 id="53-磁盘镜像管理"><a class="header" href="#53-磁盘镜像管理">5.3 磁盘镜像管理</a></h3>
<h4 id="创建磁盘镜像"><a class="header" href="#创建磁盘镜像">创建磁盘镜像</a></h4>
<pre><code class="language-bash"># 创建RAW格式镜像
qemu-img create -f raw disk.raw 20G

# 创建QCOW2格式镜像
qemu-img create -f qcow2 disk.qcow2 20G

# 创建QCOW2镜像并预分配元数据
qemu-img create -f qcow2 -o preallocation=metadata disk.qcow2 20G

# 创建QCOW2镜像并完全预分配
qemu-img create -f qcow2 -o preallocation=full disk.qcow2 20G
</code></pre>
<h4 id="镜像格式转换"><a class="header" href="#镜像格式转换">镜像格式转换</a></h4>
<pre><code class="language-bash"># 查看镜像信息
qemu-img info disk.qcow2

# QCOW2转RAW
qemu-img convert -f qcow2 -O raw disk.qcow2 disk.raw

# RAW转QCOW2
qemu-img convert -f raw -O qcow2 disk.raw disk.qcow2

# 压缩转换
qemu-img convert -c -O qcow2 source.qcow2 compressed.qcow2
</code></pre>
<h4 id="磁盘扩容"><a class="header" href="#磁盘扩容">磁盘扩容</a></h4>
<pre><code class="language-bash"># 扩容QCOW2镜像
qemu-img resize disk.qcow2 +10G

# 查看扩容后大小
qemu-img info disk.qcow2

# 在虚拟机内扩展分区（以ext4为例）
sudo growpart /dev/vda 1
sudo resize2fs /dev/vda1

# 对于LVM
sudo pvresize /dev/vda2
sudo lvextend -l +100%FREE /dev/mapper/vg-root
sudo resize2fs /dev/mapper/vg-root
</code></pre>
<h3 id="54-快照管理"><a class="header" href="#54-快照管理">5.4 快照管理</a></h3>
<h4 id="内部快照qcow2格式"><a class="header" href="#内部快照qcow2格式">内部快照（QCOW2格式）</a></h4>
<pre><code class="language-bash"># 创建快照
virsh snapshot-create-as centos8-vm \
  snapshot1 \
  "Before system upgrade"

# 列出快照
virsh snapshot-list centos8-vm

# 查看快照信息
virsh snapshot-info centos8-vm snapshot1

# 恢复快照
virsh snapshot-revert centos8-vm snapshot1

# 删除快照
virsh snapshot-delete centos8-vm snapshot1
</code></pre>
<h4 id="外部快照"><a class="header" href="#外部快照">外部快照</a></h4>
<pre><code class="language-bash"># 创建外部快照
virsh snapshot-create-as centos8-vm \
  snapshot-ext \
  "External snapshot" \
  --disk-only \
  --diskspec vda,snapshot=external

# 查看快照链
qemu-img info --backing-chain /var/lib/libvirt/images/centos8-vm.qcow2

# 合并快照（需要关机）
virsh blockcommit centos8-vm vda --active --pivot
</code></pre>
<hr />
<h2 id="六cpu与内存优化"><a class="header" href="#六cpu与内存优化">六、CPU与内存优化</a></h2>
<h3 id="61-cpu配置优化"><a class="header" href="#61-cpu配置优化">6.1 CPU配置优化</a></h3>
<h4 id="cpu拓扑配置"><a class="header" href="#cpu拓扑配置">CPU拓扑配置</a></h4>
<pre><code class="language-xml">&lt;vcpu placement='static'&gt;8&lt;/vcpu&gt;
&lt;cpu mode='host-passthrough' check='none'&gt;
  &lt;topology sockets='2' cores='2' threads='2'/&gt;
  &lt;cache mode='passthrough'/&gt;
  &lt;feature policy='require' name='vmx'/&gt;  &lt;!-- 嵌套虚拟化 --&gt;
&lt;/cpu&gt;
</code></pre>
<p><strong>CPU模式说明</strong>:</p>
<ul>
<li><code>host-passthrough</code>: 完全透传宿主机CPU特性（性能最佳）</li>
<li><code>host-model</code>: 基于宿主机CPU的最佳匹配</li>
<li><code>custom</code>: 自定义CPU模型</li>
</ul>
<h4 id="cpu绑定cpu-pinning"><a class="header" href="#cpu绑定cpu-pinning">CPU绑定（CPU Pinning）</a></h4>
<pre><code class="language-bash"># 查看物理CPU拓扑
lscpu
virsh nodeinfo

# 编辑虚拟机配置
virsh edit centos8-vm
</code></pre>
<pre><code class="language-xml">&lt;vcpu placement='static' cpuset='2-5'&gt;4&lt;/vcpu&gt;
&lt;cputune&gt;
  &lt;vcpupin vcpu='0' cpuset='2'/&gt;
  &lt;vcpupin vcpu='1' cpuset='3'/&gt;
  &lt;vcpupin vcpu='2' cpuset='4'/&gt;
  &lt;vcpupin vcpu='3' cpuset='5'/&gt;
  &lt;emulatorpin cpuset='0-1'/&gt;
  &lt;iothreadpin iothread='1' cpuset='0-1'/&gt;
&lt;/cputune&gt;
</code></pre>
<p><strong>验证CPU绑定</strong>:</p>
<pre><code class="language-bash"># 查看vCPU绑定
virsh vcpuinfo centos8-vm

# 动态绑定vCPU
virsh vcpupin centos8-vm 0 2
virsh vcpupin centos8-vm 1 3
</code></pre>
<h3 id="62-内存配置优化"><a class="header" href="#62-内存配置优化">6.2 内存配置优化</a></h3>
<h4 id="大页内存配置"><a class="header" href="#大页内存配置">大页内存配置</a></h4>
<pre><code class="language-bash"># 查看大页支持
cat /proc/meminfo | grep Huge

# 配置2MB大页（需要512个2MB大页 = 1GB）
echo 512 &gt; /proc/sys/vm/nr_hugepages

# 永久配置
echo "vm.nr_hugepages = 512" &gt;&gt; /etc/sysctl.conf
sysctl -p

# 配置1GB大页（需要在内核参数中配置）
# 编辑 /etc/default/grub
GRUB_CMDLINE_LINUX="... hugepagesz=1G hugepages=8"
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
sudo reboot

# 查看大页使用情况
cat /proc/meminfo | grep Huge
hugeadm --pool-list
</code></pre>
<p><strong>虚拟机配置使用大页</strong>:</p>
<pre><code class="language-xml">&lt;memory unit='GiB'&gt;8&lt;/memory&gt;
&lt;currentMemory unit='GiB'&gt;8&lt;/currentMemory&gt;
&lt;memoryBacking&gt;
  &lt;hugepages&gt;
    &lt;page size='1' unit='GiB'/&gt;
  &lt;/hugepages&gt;
  &lt;locked/&gt;
&lt;/memoryBacking&gt;
</code></pre>
<h4 id="numa配置"><a class="header" href="#numa配置">NUMA配置</a></h4>
<pre><code class="language-bash"># 查看NUMA拓扑
numactl --hardware
lscpu | grep NUMA

# 查看虚拟机NUMA配置
virsh numatune centos8-vm
</code></pre>
<pre><code class="language-xml">&lt;numatune&gt;
  &lt;memory mode='strict' nodeset='0'/&gt;
  &lt;memnode cellid='0' mode='strict' nodeset='0'/&gt;
  &lt;memnode cellid='1' mode='strict' nodeset='1'/&gt;
&lt;/numatune&gt;

&lt;cpu&gt;
  &lt;numa&gt;
    &lt;cell id='0' cpus='0-3' memory='4' unit='GiB'/&gt;
    &lt;cell id='1' cpus='4-7' memory='4' unit='GiB'/&gt;
  &lt;/numa&gt;
&lt;/cpu&gt;
</code></pre>
<h4 id="内存气球与ksm"><a class="header" href="#内存气球与ksm">内存气球与KSM</a></h4>
<pre><code class="language-bash"># 启用KSM（内存去重）
echo 1 &gt; /sys/kernel/mm/ksm/run

# 查看KSM效果
cat /sys/kernel/mm/ksm/pages_shared
cat /sys/kernel/mm/ksm/pages_sharing

# 虚拟机配置内存气球
</code></pre>
<pre><code class="language-xml">&lt;memballoon model='virtio'&gt;
  &lt;stats period='5'/&gt;
  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/&gt;
&lt;/memballoon&gt;
</code></pre>
<pre><code class="language-bash"># 动态调整虚拟机内存
virsh setmem centos8-vm 4G --live
</code></pre>
<hr />
<h2 id="七虚拟机迁移技术"><a class="header" href="#七虚拟机迁移技术">七、虚拟机迁移技术</a></h2>
<h3 id="71-冷迁移"><a class="header" href="#71-冷迁移">7.1 冷迁移</a></h3>
<p><strong>场景</strong>: 虚拟机关机状态下迁移到另一台宿主机</p>
<pre><code class="language-bash"># 在源主机导出虚拟机配置
virsh dumpxml centos8-vm &gt; centos8-vm.xml

# 拷贝磁盘镜像到目标主机
scp /var/lib/libvirt/images/centos8-vm.qcow2 \
    root@target-host:/var/lib/libvirt/images/

# 拷贝配置文件到目标主机
scp centos8-vm.xml root@target-host:/tmp/

# 在目标主机定义虚拟机
ssh root@target-host
virsh define /tmp/centos8-vm.xml
virsh start centos8-vm

# 在源主机取消定义
virsh undefine centos8-vm
</code></pre>
<h3 id="72-热迁移在线迁移"><a class="header" href="#72-热迁移在线迁移">7.2 热迁移（在线迁移）</a></h3>
<p><strong>前提条件</strong>:</p>
<ol>
<li>共享存储（NFS、Ceph、GlusterFS等）</li>
<li>两台宿主机网络互通</li>
<li>相同的CPU架构和相近的CPU型号</li>
</ol>
<h4 id="基于共享存储的热迁移"><a class="header" href="#基于共享存储的热迁移">基于共享存储的热迁移</a></h4>
<pre><code class="language-bash"># 配置共享存储（NFS示例）
# 在NFS服务器上
sudo mkdir -p /data/shared-kvm
echo "/data/shared-kvm 192.168.1.0/24(rw,sync,no_root_squash)" &gt;&gt; /etc/exports
sudo exportfs -ra

# 在两台KVM主机上挂载
sudo mkdir -p /var/lib/libvirt/images/shared
sudo mount -t nfs nfs-server:/data/shared-kvm /var/lib/libvirt/images/shared

# 创建虚拟机使用共享存储
sudo virt-install \
  --name migrate-vm \
  --ram 2048 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/shared/migrate-vm.qcow2,size=20 \
  --os-variant centos8 \
  --network bridge=br0 \
  --graphics vnc \
  --cdrom /var/lib/libvirt/images/centos8.iso

# 执行热迁移
virsh migrate --live migrate-vm \
  qemu+ssh://target-host/system \
  --verbose \
  --persistent

# 带宽限制和压缩迁移
virsh migrate-setmaxdowntime migrate-vm 500  # 最大停机时间(ms)
virsh migrate-setspeed migrate-vm 1000       # 迁移带宽(MiB/s)

virsh migrate --live migrate-vm \
  qemu+ssh://target-host/system \
  --compressed \
  --verbose \
  --persistent
</code></pre>
<h4 id="无共享存储的热迁移"><a class="header" href="#无共享存储的热迁移">无共享存储的热迁移</a></h4>
<pre><code class="language-bash"># 迁移虚拟机及其磁盘
virsh migrate --live migrate-vm \
  qemu+ssh://target-host/system \
  --copy-storage-all \
  --persistent \
  --verbose

# 仅迁移增量磁盘数据
virsh migrate --live migrate-vm \
  qemu+ssh://target-host/system \
  --copy-storage-inc \
  --persistent \
  --verbose
</code></pre>
<h3 id="73-迁移监控与故障处理"><a class="header" href="#73-迁移监控与故障处理">7.3 迁移监控与故障处理</a></h3>
<pre><code class="language-bash"># 监控迁移进度
virsh domjobinfo migrate-vm --completed

# 取消迁移
virsh migrate-setmaxdowntime migrate-vm 0
virsh domjobabort migrate-vm

# 迁移故障排查
journalctl -u libvirtd -f
tail -f /var/log/libvirt/qemu/migrate-vm.log
</code></pre>
<hr />
<h2 id="八性能优化实战"><a class="header" href="#八性能优化实战">八、性能优化实战</a></h2>
<h3 id="81-系统级优化"><a class="header" href="#81-系统级优化">8.1 系统级优化</a></h3>
<h4 id="内核参数调优"><a class="header" href="#内核参数调优">内核参数调优</a></h4>
<pre><code class="language-bash"># 编辑 /etc/sysctl.conf
sudo tee -a /etc/sysctl.conf &lt;&lt;EOF
# KVM性能优化
vm.swappiness = 1
vm.dirty_ratio = 5
vm.dirty_background_ratio = 2
kernel.numa_balancing = 0
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
EOF

# 应用配置
sudo sysctl -p
</code></pre>
<h4 id="cpu性能模式"><a class="header" href="#cpu性能模式">CPU性能模式</a></h4>
<pre><code class="language-bash"># 设置CPU为性能模式
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    echo performance | sudo tee $cpu
done

# 或使用cpupower工具
sudo cpupower frequency-set -g performance

# 禁用CPU睿频（某些场景）
echo 1 | sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo
</code></pre>
<h4 id="透明大页thp"><a class="header" href="#透明大页thp">透明大页（THP）</a></h4>
<pre><code class="language-bash"># 查看THP状态
cat /sys/kernel/mm/transparent_hugepage/enabled

# 禁用THP（推荐用于KVM）
echo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled
echo never | sudo tee /sys/kernel/mm/transparent_hugepage/defrag

# 永久配置
sudo grub2-editenv - set "$(grub2-editenv - list | grep kernelopts) transparent_hugepage=never"
</code></pre>
<h3 id="82-存储io优化"><a class="header" href="#82-存储io优化">8.2 存储I/O优化</a></h3>
<h4 id="io线程配置"><a class="header" href="#io线程配置">I/O线程配置</a></h4>
<pre><code class="language-xml">&lt;domain type='kvm'&gt;
  &lt;iothreads&gt;2&lt;/iothreads&gt;
  ...
  &lt;disk type='file' device='disk'&gt;
    &lt;driver name='qemu' type='qcow2' cache='none' io='native' iothread='1' queues='4'/&gt;
    &lt;source file='/var/lib/libvirt/images/vm.qcow2'/&gt;
    &lt;target dev='vda' bus='virtio'/&gt;
    &lt;iotune&gt;
      &lt;read_iops_sec&gt;3000&lt;/read_iops_sec&gt;
      &lt;write_iops_sec&gt;3000&lt;/write_iops_sec&gt;
      &lt;read_bytes_sec&gt;157286400&lt;/read_bytes_sec&gt;
      &lt;write_bytes_sec&gt;157286400&lt;/write_bytes_sec&gt;
    &lt;/iotune&gt;
  &lt;/disk&gt;
&lt;/domain&gt;
</code></pre>
<h4 id="缓存模式选择"><a class="header" href="#缓存模式选择">缓存模式选择</a></h4>
<div class="table-wrapper"><table><thead><tr><th>缓存模式</th><th>说明</th><th>性能</th><th>数据安全</th><th>适用场景</th></tr></thead><tbody>
<tr><td><strong>none</strong></td><td>绕过宿主机缓存</td><td>中</td><td>高</td><td>生产环境推荐</td></tr>
<tr><td><strong>writethrough</strong></td><td>写穿缓存</td><td>中</td><td>高</td><td>数据一致性要求高</td></tr>
<tr><td><strong>writeback</strong></td><td>写回缓存</td><td>高</td><td>低</td><td>测试环境</td></tr>
<tr><td><strong>directsync</strong></td><td>直接同步</td><td>低</td><td>最高</td><td>关键数据</td></tr>
</tbody></table>
</div>
<h3 id="83-网络性能优化"><a class="header" href="#83-网络性能优化">8.3 网络性能优化</a></h3>
<h4 id="多队列网络配置"><a class="header" href="#多队列网络配置">多队列网络配置</a></h4>
<pre><code class="language-xml">&lt;interface type='bridge'&gt;
  &lt;source bridge='br0'/&gt;
  &lt;model type='virtio'/&gt;
  &lt;driver name='vhost' queues='4' rx_queue_size='1024' tx_queue_size='1024'/&gt;
  &lt;tune&gt;
    &lt;sndbuf&gt;1048576&lt;/sndbuf&gt;
  &lt;/tune&gt;
&lt;/interface&gt;
</code></pre>
<p><strong>在虚拟机内配置</strong>:</p>
<pre><code class="language-bash"># 查看网卡队列
ethtool -l eth0

# 设置为4个队列
sudo ethtool -L eth0 combined 4

# 永久配置
cat &gt; /etc/udev/rules.d/60-net-queue.rules &lt;&lt;EOF
ACTION=="add", SUBSYSTEM=="net", NAME=="eth0", RUN+="/sbin/ethtool -L eth0 combined 4"
EOF
</code></pre>
<hr />
<h2 id="九故障排查与监控"><a class="header" href="#九故障排查与监控">九、故障排查与监控</a></h2>
<h3 id="91-常见问题诊断"><a class="header" href="#91-常见问题诊断">9.1 常见问题诊断</a></h3>
<h4 id="虚拟机启动失败"><a class="header" href="#虚拟机启动失败">虚拟机启动失败</a></h4>
<pre><code class="language-bash"># 检查错误日志
journalctl -u libvirtd | tail -50
tail -f /var/log/libvirt/qemu/&lt;vm-name&gt;.log

# 检查KVM模块
lsmod | grep kvm
dmesg | grep kvm

# 检查硬件虚拟化
egrep -c '(vmx|svm)' /proc/cpuinfo
kvm-ok

# 检查资源
virsh nodeinfo
free -h
df -h /var/lib/libvirt/images

# 验证XML配置
virsh dumpxml &lt;vm-name&gt; | xmllint --format -
</code></pre>
<h4 id="网络连通性问题"><a class="header" href="#网络连通性问题">网络连通性问题</a></h4>
<pre><code class="language-bash"># 检查网桥
brctl show
ip link show

# 检查防火墙
sudo iptables -L -n -v
sudo firewall-cmd --list-all

# 检查libvirt网络
virsh net-list --all
virsh net-dumpxml default

# 检查虚拟机网络接口
virsh domiflist &lt;vm-name&gt;
virsh domifstat &lt;vm-name&gt; vnet0
</code></pre>
<h4 id="性能问题诊断"><a class="header" href="#性能问题诊断">性能问题诊断</a></h4>
<pre><code class="language-bash"># CPU使用率
top -p $(pgrep -d',' qemu-kvm)

# 内存使用
virsh domstats &lt;vm-name&gt; --balloon

# 磁盘I/O
virsh domblkstat &lt;vm-name&gt;
iostat -x 2

# 网络I/O
virsh domifstat &lt;vm-name&gt; vnet0
iftop -i virbr0
</code></pre>
<h3 id="92-性能监控工具"><a class="header" href="#92-性能监控工具">9.2 性能监控工具</a></h3>
<h4 id="virt-top-实时监控"><a class="header" href="#virt-top-实时监控">virt-top 实时监控</a></h4>
<pre><code class="language-bash"># 安装virt-top
sudo apt install virt-top -y

# 运行监控
virt-top

# 常用选项
virt-top -1  # 显示所有vCPU
virt-top -d 2  # 2秒刷新间隔
</code></pre>
<h4 id="prometheus--grafana-监控"><a class="header" href="#prometheus--grafana-监控">Prometheus + Grafana 监控</a></h4>
<pre><code class="language-bash"># 安装libvirt-exporter
wget https://github.com/kumina/libvirt_exporter/releases/download/v0.1.0/libvirt_exporter
chmod +x libvirt_exporter
./libvirt_exporter --libvirt.uri=qemu:///system

# Prometheus配置
cat &gt;&gt; /etc/prometheus/prometheus.yml &lt;&lt;EOF
  - job_name: 'libvirt'
    static_configs:
      - targets: ['localhost:9177']
EOF

# 重启Prometheus
sudo systemctl restart prometheus
</code></pre>
<hr />
<h2 id="十学习验证标准"><a class="header" href="#十学习验证标准">十、学习验证标准</a></h2>
<h3 id="101-基础能力验证必须掌握"><a class="header" href="#101-基础能力验证必须掌握">10.1 基础能力验证（必须掌握）</a></h3>
<p><strong>验证项 1</strong>: KVM环境搭建与虚拟机创建</p>
<ul>
<li><input disabled="" type="checkbox"/>
成功安装KVM和相关组件</li>
<li><input disabled="" type="checkbox"/>
检查硬件虚拟化支持并启用</li>
<li><input disabled="" type="checkbox"/>
使用virt-install创建虚拟机</li>
<li><input disabled="" type="checkbox"/>
使用virsh管理虚拟机生命周期</li>
</ul>
<p><strong>验证项 2</strong>: 网络和存储基础配置</p>
<ul>
<li><input disabled="" type="checkbox"/>
配置NAT网络模式</li>
<li><input disabled="" type="checkbox"/>
配置桥接网络模式</li>
<li><input disabled="" type="checkbox"/>
创建和管理存储池</li>
<li><input disabled="" type="checkbox"/>
创建和管理虚拟磁盘</li>
</ul>
<p><strong>验证项 3</strong>: 基本运维操作</p>
<ul>
<li><input disabled="" type="checkbox"/>
虚拟机的启动、停止、重启</li>
<li><input disabled="" type="checkbox"/>
快照的创建和恢复</li>
<li><input disabled="" type="checkbox"/>
虚拟机配置的查看和修改</li>
<li><input disabled="" type="checkbox"/>
基本故障排查</li>
</ul>
<h3 id="102-进阶能力验证熟练运用"><a class="header" href="#102-进阶能力验证熟练运用">10.2 进阶能力验证（熟练运用）</a></h3>
<p><strong>验证项 4</strong>: 性能优化配置</p>
<ul>
<li><input disabled="" type="checkbox"/>
配置CPU绑定和拓扑</li>
<li><input disabled="" type="checkbox"/>
配置大页内存</li>
<li><input disabled="" type="checkbox"/>
配置多队列网络</li>
<li><input disabled="" type="checkbox"/>
配置I/O线程和存储优化</li>
</ul>
<p><strong>验证项 5</strong>: 虚拟机迁移</p>
<ul>
<li><input disabled="" type="checkbox"/>
执行冷迁移</li>
<li><input disabled="" type="checkbox"/>
基于共享存储的热迁移</li>
<li><input disabled="" type="checkbox"/>
监控迁移进度和处理故障</li>
</ul>
<p><strong>验证项 6</strong>: 高级网络配置</p>
<ul>
<li><input disabled="" type="checkbox"/>
配置VLAN</li>
<li><input disabled="" type="checkbox"/>
配置多个网络</li>
<li><input disabled="" type="checkbox"/>
理解SR-IOV原理并配置</li>
</ul>
<h3 id="103-高级能力验证生产级别"><a class="header" href="#103-高级能力验证生产级别">10.3 高级能力验证（生产级别）</a></h3>
<p><strong>验证项 7</strong>: 性能调优能力</p>
<ul>
<li><input disabled="" type="checkbox"/>
系统级参数优化</li>
<li><input disabled="" type="checkbox"/>
针对不同工作负载的优化策略</li>
<li><input disabled="" type="checkbox"/>
性能监控和瓶颈分析</li>
<li><input disabled="" type="checkbox"/>
使用工具进行性能测试</li>
</ul>
<p><strong>验证项 8</strong>: 故障排查能力</p>
<ul>
<li><input disabled="" type="checkbox"/>
分析日志定位问题</li>
<li><input disabled="" type="checkbox"/>
处理启动失败问题</li>
<li><input disabled="" type="checkbox"/>
处理网络连通性问题</li>
<li><input disabled="" type="checkbox"/>
处理性能下降问题</li>
</ul>
<p><strong>验证项 9</strong>: 自动化管理</p>
<ul>
<li><input disabled="" type="checkbox"/>
编写脚本自动化部署虚拟机</li>
<li><input disabled="" type="checkbox"/>
使用Ansible管理KVM环境</li>
<li><input disabled="" type="checkbox"/>
实现监控告警系统</li>
</ul>
<hr />
<h2 id="十一扩展资源与进阶建议"><a class="header" href="#十一扩展资源与进阶建议">十一、扩展资源与进阶建议</a></h2>
<h3 id="111-官方文档与资源"><a class="header" href="#111-官方文档与资源">11.1 官方文档与资源</a></h3>
<p><strong>官方资源</strong>:</p>
<ul>
<li><a href="https://www.linux-kvm.org/">KVM官方网站</a></li>
<li><a href="https://www.qemu.org/docs/master/">QEMU文档</a></li>
<li><a href="https://libvirt.org/docs.html">libvirt官方文档</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_virtualization/">Red Hat虚拟化指南</a></li>
</ul>
<p><strong>社区资源</strong>:</p>
<ul>
<li>KVM邮件列表</li>
<li>QEMU开发者邮件列表</li>
<li>Libvirt用户社区</li>
</ul>
<h3 id="112-推荐学习路径"><a class="header" href="#112-推荐学习路径">11.2 推荐学习路径</a></h3>
<p><strong>阶段 1: 基础实践</strong>（2-3周）</p>
<ol>
<li>搭建KVM测试环境</li>
<li>创建和管理虚拟机</li>
<li>配置网络和存储</li>
<li>掌握virsh命令</li>
</ol>
<p><strong>阶段 2: 进阶应用</strong>（3-4周）</p>
<ol>
<li>CPU和内存虚拟化深入</li>
<li>存储虚拟化和性能优化</li>
<li>网络虚拟化高级配置</li>
<li>虚拟机迁移技术</li>
</ol>
<p><strong>阶段 3: 生产实战</strong>（4-5周）</p>
<ol>
<li>性能调优最佳实践</li>
<li>高可用架构设计</li>
<li>监控告警体系</li>
<li>自动化运维</li>
</ol>
<h3 id="113-相关技术栈"><a class="header" href="#113-相关技术栈">11.3 相关技术栈</a></h3>
<p><strong>虚拟化技术</strong>:</p>
<ul>
<li>Xen: 另一个开源虚拟化解决方案</li>
<li>VMware: 商业虚拟化平台</li>
<li>Hyper-V: 微软虚拟化技术</li>
</ul>
<p><strong>云平台</strong>:</p>
<ul>
<li>OpenStack: 开源云计算平台</li>
<li>CloudStack: Apache云计算平台</li>
<li>oVirt: 开源虚拟化管理平台</li>
</ul>
<p><strong>容器技术</strong>:</p>
<ul>
<li>Docker: 应用容器化</li>
<li>Kubernetes: 容器编排</li>
<li>Kata Containers: 基于KVM的安全容器</li>
</ul>
<h3 id="114-实战项目建议"><a class="header" href="#114-实战项目建议">11.4 实战项目建议</a></h3>
<p><strong>项目 1: 私有云平台搭建</strong></p>
<ul>
<li>部署多节点KVM集群</li>
<li>配置共享存储（Ceph/GlusterFS）</li>
<li>实现虚拟机自动化部署</li>
<li>配置监控告警</li>
</ul>
<p><strong>项目 2: 高性能计算环境</strong></p>
<ul>
<li>CPU绑定和NUMA优化</li>
<li>大页内存配置</li>
<li>SR-IOV网络直通</li>
<li>GPU直通配置</li>
</ul>
<p><strong>项目 3: 开发测试环境</strong></p>
<ul>
<li>快速创建测试虚拟机</li>
<li>快照和克隆管理</li>
<li>网络隔离配置</li>
<li>自动化脚本编写</li>
</ul>
<h3 id="115-常见面试题"><a class="header" href="#115-常见面试题">11.5 常见面试题</a></h3>
<ol>
<li>KVM和QEMU的关系和区别？</li>
<li>KVM支持哪些虚拟化模式？各有什么特点？</li>
<li>如何配置大页内存？有什么好处？</li>
<li>KVM网络有哪些模式？如何选择？</li>
<li>如何实现虚拟机热迁移？有哪些前提条件？</li>
<li>CPU绑定的作用是什么？如何配置？</li>
<li>QCOW2和RAW格式的区别？</li>
<li>如何排查虚拟机性能问题？</li>
</ol>
<h3 id="116-进阶学习方向"><a class="header" href="#116-进阶学习方向">11.6 进阶学习方向</a></h3>
<p><strong>方向 1: 云原生虚拟化</strong></p>
<ul>
<li>Kata Containers</li>
<li>Firecracker</li>
<li>Cloud Hypervisor</li>
</ul>
<p><strong>方向 2: NFV（网络功能虚拟化）</strong></p>
<ul>
<li>SR-IOV深入</li>
<li>DPDK高性能网络</li>
<li>OVS/OVN</li>
</ul>
<p><strong>方向 3: 虚拟化安全</strong></p>
<ul>
<li>SELinux/AppArmor</li>
<li>安全启动</li>
<li>加密虚拟机</li>
</ul>
<hr />
<h2 id="十二总结与实践建议"><a class="header" href="#十二总结与实践建议">十二、总结与实践建议</a></h2>
<h3 id="121-核心知识点回顾"><a class="header" href="#121-核心知识点回顾">12.1 核心知识点回顾</a></h3>
<p><strong>基础层</strong>:</p>
<ul>
<li>KVM架构和工作原理</li>
<li>虚拟机创建和管理</li>
<li>网络和存储基础配置</li>
<li>libvirt工具使用</li>
</ul>
<p><strong>进阶层</strong>:</p>
<ul>
<li>CPU/内存虚拟化技术</li>
<li>存储虚拟化高级特性</li>
<li>网络虚拟化优化</li>
<li>虚拟机迁移技术</li>
</ul>
<p><strong>高级层</strong>:</p>
<ul>
<li>性能优化和调优</li>
<li>故障排查方法论</li>
<li>高可用架构设计</li>
<li>自动化运维实践</li>
</ul>
<h3 id="122-实践建议"><a class="header" href="#122-实践建议">12.2 实践建议</a></h3>
<ol>
<li><strong>循序渐进</strong>: 从简单的虚拟机创建开始，逐步深入</li>
<li><strong>多动手</strong>: 虚拟化技术需要大量实践，理论占30%，实践占70%</li>
<li><strong>搭建测试环境</strong>: 在生产环境实验前先在测试环境验证</li>
<li><strong>阅读源码</strong>: 有能力的话阅读KVM和QEMU源码</li>
<li><strong>关注社区</strong>: 参与社区讨论，关注技术发展</li>
</ol>
<h3 id="123-学习路线图"><a class="header" href="#123-学习路线图">12.3 学习路线图</a></h3>
<pre><code>Week 1-2: 环境搭建与基础操作
├── KVM安装配置
├── 虚拟机创建管理
└── virsh命令掌握

Week 3-4: 网络与存储
├── 网络模式配置
├── 存储池管理
└── 快照和克隆

Week 5-6: 性能优化基础
├── CPU配置优化
├── 内存配置优化
└── 存储I/O优化

Week 7-8: 高级特性
├── 虚拟机迁移
├── 设备直通
└── 高级网络配置

Week 9-10: 生产实践
├── 性能调优
├── 故障排查
└── 自动化管理
</code></pre>
<hr />
<p><strong>文档维护</strong>: 本学习笔记基于 KVM/QEMU 最新稳定版本编写，建议定期查看官方文档获取最新特性。</p>
<p><strong>反馈与改进</strong>: 欢迎提出宝贵意见和建议，共同完善学习资料。</p>
<hr />
<p><strong>祝学习顺利！掌握 KVM，构建高性能虚拟化平台！</strong> 🚀</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/linux/Haproxy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/linux/LinuxCommand.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/linux/Haproxy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/linux/LinuxCommand.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

