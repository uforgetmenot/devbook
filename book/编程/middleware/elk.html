<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ELK Stack 技术学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="elk-stack-技术学习笔记"><a class="header" href="#elk-stack-技术学习笔记">ELK Stack 技术学习笔记</a></h1>
<blockquote>
<p><strong>学习者角色定位</strong>: 具备基础Linux和Docker操作能力的运维/开发人员
<strong>目标群体</strong>: 0-3年工作经验的运维工程师、DevOps工程师
<strong>预计学习周期</strong>: 2-3周（每天2-3小时）</p>
</blockquote>
<h2 id="一技术概述与核心价值"><a class="header" href="#一技术概述与核心价值">一、技术概述与核心价值</a></h2>
<h3 id="11-什么是elk-stack"><a class="header" href="#11-什么是elk-stack">1.1 什么是ELK Stack</a></h3>
<p>ELK是三个开源项目的首字母缩写：</p>
<ul>
<li><strong>Elasticsearch</strong>: 分布式搜索和分析引擎</li>
<li><strong>Logstash</strong>: 数据处理管道工具</li>
<li><strong>Kibana</strong>: 数据可视化和查询界面</li>
</ul>
<p><strong>更新说明</strong>: ELK Stack 现在被称为 <strong>Elastic Stack</strong>，因为加入了 Beats（轻量级数据采集器）等其他组件。</p>
<h3 id="12-核心应用场景"><a class="header" href="#12-核心应用场景">1.2 核心应用场景</a></h3>
<div class="table-wrapper"><table><thead><tr><th>应用场景</th><th>说明价值</th><th>业务价值</th></tr></thead><tbody>
<tr><td><strong>日志收集</strong></td><td>集中管理应用、系统、网络日志</td><td>快速定位问题，降低MTTR</td></tr>
<tr><td><strong>性能监控</strong></td><td>APM应用性能监控</td><td>提前发现性能瓶颈</td></tr>
<tr><td><strong>安全分析</strong></td><td>安全事件检测与分析</td><td>及时发现安全威胁</td></tr>
<tr><td><strong>业务分析</strong></td><td>用户行为分析、数据挖掘</td><td>数据驱动决策</td></tr>
<tr><td><strong>全文搜索</strong></td><td>实现搜索和内容推荐</td><td>提升用户体验</td></tr>
</tbody></table>
</div>
<h3 id="13-传统方案对比"><a class="header" href="#13-传统方案对比">1.3 传统方案对比</a></h3>
<pre><code> 传统方式             vs    ELK Stack
------------------------------------------
分散日志文件          →    集中存储
grep 查找慢           →    全文快速搜索
手动分析难             →    可视化数据分析
无法追溯历史           →    长期数据存储
</code></pre>
<hr />
<h2 id="二环境搭建与快速启动"><a class="header" href="#二环境搭建与快速启动">二、环境搭建与快速启动</a></h2>
<h3 id="21-使用docker快速部署单机版"><a class="header" href="#21-使用docker快速部署单机版">2.1 使用Docker快速部署（单机版）</a></h3>
<p><strong>步骤1: 创建Docker网络</strong></p>
<pre><code class="language-bash">docker network create elastic
</code></pre>
<p><strong>步骤2: 启动Elasticsearch</strong></p>
<pre><code class="language-bash">docker run -d \
  --name elasticsearch \
  --net elastic \
  -p 9200:9200 \
  -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
  docker.elastic.co/elasticsearch/elasticsearch:8.11.0
</code></pre>
<p><strong>步骤3: 验证Elasticsearch启动</strong></p>
<pre><code class="language-bash">curl http://localhost:9200
# 返回JSON说明启动成功
</code></pre>
<p><strong>步骤4: 启动Kibana</strong></p>
<pre><code class="language-bash">docker run -d \
  --name kibana \
  --net elastic \
  -p 5601:5601 \
  -e "ELASTICSEARCH_HOSTS=http://elasticsearch:9200" \
  docker.elastic.co/kibana/kibana:8.11.0
</code></pre>
<p><strong>步骤5: 启动Logstash</strong></p>
<pre><code class="language-bash"># 创建配置文件
cat &gt; logstash.conf &lt;&lt;EOF
input {
  tcp {
    port =&gt; 5000
    codec =&gt; json
  }
}

output {
  elasticsearch {
    hosts =&gt; ["elasticsearch:9200"]
    index =&gt; "logstash-%{+YYYY.MM.dd}"
  }
  stdout { codec =&gt; rubydebug }
}
EOF

# 启动Logstash
docker run -d \
  --name logstash \
  --net elastic \
  -p 5000:5000 \
  -v $(pwd)/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \
  docker.elastic.co/logstash/logstash:8.11.0
</code></pre>
<p><strong>步骤6: 访问Kibana界面</strong></p>
<pre><code>浏览器访问: http://localhost:5601
</code></pre>
<h3 id="22-使用docker-compose一键部署"><a class="header" href="#22-使用docker-compose一键部署">2.2 使用Docker Compose一键部署</a></h3>
<p><strong>创建 docker-compose.yml</strong></p>
<pre><code class="language-yaml">version: '3.8'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - elastic

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - elastic

  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: logstash
    ports:
      - "5000:5000"
      - "9600:9600"
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline
    depends_on:
      - elasticsearch
    networks:
      - elastic

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: filebeat
    user: root
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    depends_on:
      - elasticsearch
      - logstash
    networks:
      - elastic

volumes:
  es_data:
    driver: local

networks:
  elastic:
    driver: bridge
</code></pre>
<p><strong>启动服务</strong></p>
<pre><code class="language-bash">docker-compose up -d
</code></pre>
<hr />
<h2 id="三elasticsearch-核心概念"><a class="header" href="#三elasticsearch-核心概念">三、Elasticsearch 核心概念</a></h2>
<h3 id="31-基本概念对比"><a class="header" href="#31-基本概念对比">3.1 基本概念对比</a></h3>
<p><strong>与传统数据库类比</strong></p>
<pre><code>MySQL          →    Elasticsearch
Database       →    Index (索引)
Table          →    Type (类型，现在一个Index只有一个Type)
Row            →    Document (文档)
Column         →    Field (字段)
Schema         →    Mapping (映射)
SQL            →    DSL (Domain Specific Language)
</code></pre>
<h3 id="32-索引管理操作"><a class="header" href="#32-索引管理操作">3.2 索引管理操作</a></h3>
<p><strong>创建索引并定义映射</strong></p>
<pre><code class="language-bash"># 创建一个用户索引
curl -X PUT "localhost:9200/users" -H 'Content-Type: application/json' -d'
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "username": {
        "type": "keyword"
      },
      "email": {
        "type": "keyword"
      },
      "age": {
        "type": "integer"
      },
      "bio": {
        "type": "text",
        "analyzer": "standard"
      },
      "created_at": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "location": {
        "type": "geo_point"
      }
    }
  }
}
'
</code></pre>
<p><strong>字段类型说明</strong></p>
<pre><code class="language-javascript">// 常用字段类型
text        // 全文搜索字段，会分词
keyword     // 精确匹配字段，不分词
integer     // 整数
long        // 长整数
float       // 浮点数
double      // 双精度浮点数
boolean     // 布尔值
date        // 日期
object      // 对象（类似JSON）
nested      // 嵌套类型（用于数组对象）
geo_point   // 地理位置坐标
ip          // IP地址
</code></pre>
<h3 id="33-文档crud操作"><a class="header" href="#33-文档crud操作">3.3 文档CRUD操作</a></h3>
<p><strong>创建文档</strong></p>
<pre><code class="language-bash"># 指定ID创建
curl -X PUT "localhost:9200/users/_doc/1" -H 'Content-Type: application/json' -d'
{
  "username": "zhangsan",
  "email": "zhangsan@example.com",
  "age": 28,
  "bio": "一名全栈工程师，热爱开源",
  "created_at": "2024-01-15 10:30:00",
  "location": {
    "lat": 39.9042,
    "lon": 116.4074
  }
}
'

# 自动生成ID
curl -X POST "localhost:9200/users/_doc" -H 'Content-Type: application/json' -d'
{
  "username": "lisi",
  "email": "lisi@example.com",
  "age": 32,
  "bio": "大数据工程师，精通分布式系统",
  "created_at": "2024-01-16 14:20:00"
}
'
</code></pre>
<p><strong>查询文档</strong></p>
<pre><code class="language-bash"># 根据ID查询
curl -X GET "localhost:9200/users/_doc/1"

# 查询所有文档
curl -X GET "localhost:9200/users/_search?pretty"
</code></pre>
<p><strong>更新文档</strong></p>
<pre><code class="language-bash"># 部分更新
curl -X POST "localhost:9200/users/_update/1" -H 'Content-Type: application/json' -d'
{
  "doc": {
    "age": 29
  }
}
'

# 脚本更新
curl -X POST "localhost:9200/users/_update/1" -H 'Content-Type: application/json' -d'
{
  "script": {
    "source": "ctx._source.age += params.increment",
    "params": {
      "increment": 1
    }
  }
}
'
</code></pre>
<p><strong>删除文档</strong></p>
<pre><code class="language-bash">curl -X DELETE "localhost:9200/users/_doc/1"
</code></pre>
<h3 id="34-搜索查询dsl"><a class="header" href="#34-搜索查询dsl">3.4 搜索查询DSL</a></h3>
<p><strong>基本查询示例</strong></p>
<pre><code class="language-bash"># 1. Match查询（全文搜索）
curl -X GET "localhost:9200/users/_search" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match": {
      "bio": "工程师"
    }
  }
}
'

# 2. Term查询（精确匹配）
curl -X GET "localhost:9200/users/_search" -H 'Content-Type: application/json' -d'
{
  "query": {
    "term": {
      "username": "zhangsan"
    }
  }
}
'

# 3. Range查询（范围查询）
curl -X GET "localhost:9200/users/_search" -H 'Content-Type: application/json' -d'
{
  "query": {
    "range": {
      "age": {
        "gte": 25,
        "lte": 35
      }
    }
  }
}
'

# 4. Bool查询（组合查询）
curl -X GET "localhost:9200/users/_search" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "bio": "工程师" } }
      ],
      "filter": [
        { "range": { "age": { "gte": 25 } } }
      ],
      "should": [
        { "term": { "username": "zhangsan" } }
      ],
      "must_not": [
        { "term": { "email": "test@example.com" } }
      ]
    }
  }
}
'
</code></pre>
<p><strong>Bool查询子句说明</strong></p>
<ul>
<li><code>must</code>: 必须匹配，计算相关性评分</li>
<li><code>filter</code>: 必须匹配，不计算评分（性能更好）</li>
<li><code>should</code>: 可选匹配，提升相关性</li>
<li><code>must_not</code>: 必须不匹配，不计算评分</li>
</ul>
<h3 id="35-聚合分析"><a class="header" href="#35-聚合分析">3.5 聚合分析</a></h3>
<p><strong>聚合类型</strong></p>
<pre><code class="language-bash"># 1. Metrics聚合（指标聚合）
curl -X GET "localhost:9200/users/_search" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "avg_age": {
      "avg": { "field": "age" }
    },
    "max_age": {
      "max": { "field": "age" }
    },
    "min_age": {
      "min": { "field": "age" }
    },
    "age_stats": {
      "stats": { "field": "age" }
    }
  }
}
'

# 2. Bucket聚合（分组聚合）
curl -X GET "localhost:9200/users/_search" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "age_ranges": {
      "range": {
        "field": "age",
        "ranges": [
          { "to": 25 },
          { "from": 25, "to": 35 },
          { "from": 35 }
        ]
      },
      "aggs": {
        "avg_age_in_range": {
          "avg": { "field": "age" }
        }
      }
    }
  }
}
'

# 3. 时间直方图聚合
curl -X GET "localhost:9200/logs/_search" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "logs_over_time": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "1d"
      }
    }
  }
}
'
</code></pre>
<hr />
<h2 id="四logstash-数据处理管道"><a class="header" href="#四logstash-数据处理管道">四、Logstash 数据处理管道</a></h2>
<h3 id="41-logstash架构流程"><a class="header" href="#41-logstash架构流程">4.1 Logstash架构流程</a></h3>
<pre><code>Input（输入）  →  Filter（过滤）  →  Output（输出）
     ↓               ↓                  ↓
文件/TCP/HTTP    解析/转换/丰富      ES/File/Kafka
</code></pre>
<h3 id="42-input插件配置"><a class="header" href="#42-input插件配置">4.2 Input插件配置</a></h3>
<p><strong>常用Input插件</strong></p>
<pre><code class="language-ruby"># 1. File输入 - 读取日志文件
input {
  file {
    path =&gt; "/var/log/nginx/access.log"
    start_position =&gt; "beginning"
    sincedb_path =&gt; "/dev/null"  # 禁用状态追踪文件
    codec =&gt; "plain"
  }
}

# 2. TCP输入 - 接收网络数据
input {
  tcp {
    port =&gt; 5000
    codec =&gt; json_lines
  }
}

# 3. Beats输入 - 接收Filebeat数据
input {
  beats {
    port =&gt; 5044
  }
}

# 4. HTTP输入 - REST API接收
input {
  http {
    port =&gt; 8080
    codec =&gt; json
  }
}

# 5. Kafka输入 - 从Kafka消费
input {
  kafka {
    bootstrap_servers =&gt; "localhost:9092"
    topics =&gt; ["logs"]
    group_id =&gt; "logstash-consumer"
    codec =&gt; json
  }
}
</code></pre>
<h3 id="43-filter插件---数据处理核心"><a class="header" href="#43-filter插件---数据处理核心">4.3 Filter插件 - 数据处理核心</a></h3>
<p><strong>Grok插件 - 日志解析</strong></p>
<pre><code class="language-ruby">filter {
  grok {
    # 解析Nginx访问日志
    match =&gt; {
      "message" =&gt; "%{IPORHOST:clientip} - - \\[%{HTTPDATE:timestamp}\\] \\\"%{WORD:method} %{URIPATHPARAM:request} HTTP/%{NUMBER:httpversion}\\\" %{NUMBER:status} %{NUMBER:bytes} \\\"%{DATA:referer}\\\" \\\"%{DATA:agent}\\\""
    }
  }

  # 删除解析失败的日志
  if "_grokparsefailure" in [tags] {
    drop { }
  }
}

# 常用Grok模式
# %{IP:client_ip}              - 匹配IP地址
# %{NUMBER:response_time}      - 匹配数字
# %{WORD:method}               - 匹配单词
# %{QUOTEDSTRING:message}      - 匹配带引号字符串
# %{TIMESTAMP_ISO8601:time}    - 匹配ISO8601时间格式
</code></pre>
<p><strong>Date插件 - 时间戳转换</strong></p>
<pre><code class="language-ruby">filter {
  date {
    match =&gt; [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    target =&gt; "@timestamp"
  }
}
</code></pre>
<p><strong>Mutate插件 - 字段操作</strong></p>
<pre><code class="language-ruby">filter {
  mutate {
    # 添加字段
    add_field =&gt; { "environment" =&gt; "production" }

    # 删除字段
    remove_field =&gt; [ "message", "host" ]

    # 重命名字段
    rename =&gt; { "old_field" =&gt; "new_field" }

    # 类型转换
    convert =&gt; {
      "response_time" =&gt; "integer"
      "bytes" =&gt; "integer"
    }

    # 字段分割
    split =&gt; { "tags" =&gt; "," }

    # 字段合并
    merge =&gt; { "tags" =&gt; "new_tags" }

    # 去除空格
    strip =&gt; [ "message" ]

    # 转小写
    lowercase =&gt; [ "method" ]
  }
}
</code></pre>
<p><strong>完整Nginx日志处理示例</strong></p>
<pre><code class="language-ruby">input {
  file {
    path =&gt; "/var/log/nginx/access.log"
    start_position =&gt; "beginning"
    type =&gt; "nginx-access"
  }
}

filter {
  if [type] == "nginx-access" {
    grok {
      match =&gt; {
        "message" =&gt; "%{IPORHOST:client_ip} - - \\[%{HTTPDATE:timestamp}\\] \\\"%{WORD:method} %{URIPATHPARAM:request} HTTP/%{NUMBER:http_version}\\\" %{NUMBER:status:int} %{NUMBER:bytes:int} \\\"%{DATA:referer}\\\" \\\"%{DATA:user_agent}\\\" rt=%{NUMBER:response_time:float}"
      }
    }

    date {
      match =&gt; [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      target =&gt; "@timestamp"
    }

    geoip {
      source =&gt; "client_ip"
      target =&gt; "geoip"
    }

    useragent {
      source =&gt; "user_agent"
      target =&gt; "ua"
    }

    mutate {
      add_field =&gt; {
        "[@metadata][index_prefix]" =&gt; "nginx-access"
      }
      remove_field =&gt; [ "message", "timestamp" ]
    }
  }
}

output {
  elasticsearch {
    hosts =&gt; ["localhost:9200"]
    index =&gt; "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
  }
}
</code></pre>
<h3 id="44-output插件配置"><a class="header" href="#44-output插件配置">4.4 Output插件配置</a></h3>
<pre><code class="language-ruby"># 1. Elasticsearch输出
output {
  elasticsearch {
    hosts =&gt; ["http://localhost:9200"]
    index =&gt; "logstash-%{+YYYY.MM.dd}"
    document_type =&gt; "_doc"
    template_overwrite =&gt; true
  }
}

# 2. 多个Elasticsearch集群输出
output {
  if [type] == "nginx" {
    elasticsearch {
      hosts =&gt; ["http://es-cluster1:9200"]
      index =&gt; "nginx-%{+YYYY.MM.dd}"
    }
  } else {
    elasticsearch {
      hosts =&gt; ["http://es-cluster2:9200"]
      index =&gt; "app-%{+YYYY.MM.dd}"
    }
  }
}

# 3. File输出（调试用）
output {
  file {
    path =&gt; "/var/log/logstash/output.log"
    codec =&gt; line { format =&gt; "%{message}" }
  }
}

# 4. Kafka输出
output {
  kafka {
    bootstrap_servers =&gt; "localhost:9092"
    topic_id =&gt; "processed-logs"
    codec =&gt; json
  }
}

# 5. 标准输出（测试用）
output {
  stdout {
    codec =&gt; rubydebug
  }
}
</code></pre>
<hr />
<h2 id="五kibana-数据可视化"><a class="header" href="#五kibana-数据可视化">五、Kibana 数据可视化</a></h2>
<h3 id="51-index-pattern配置"><a class="header" href="#51-index-pattern配置">5.1 Index Pattern配置</a></h3>
<p><strong>步骤说明</strong></p>
<ol>
<li>打开Kibana: http://localhost:5601</li>
<li>导航: Management → Stack Management → Index Patterns</li>
<li>点击"Create index pattern"</li>
<li>输入索引模式: <code>logstash-*</code> 或 <code>nginx-*</code></li>
<li>选择时间字段: <code>@timestamp</code></li>
<li>完成创建</li>
</ol>
<h3 id="52-discover---数据探索"><a class="header" href="#52-discover---数据探索">5.2 Discover - 数据探索</a></h3>
<p><strong>功能介绍</strong></p>
<ul>
<li>实时搜索日志数据</li>
<li>使用KQL（Kibana Query Language）进行过滤</li>
<li>保存搜索结果</li>
</ul>
<p><strong>KQL查询示例</strong></p>
<pre><code># 精确匹配
status: 200

# 范围查询
response_time &gt; 1000

# 布尔查询
status: 200 AND method: "GET"
status: 500 OR status: 502

# 通配符
request: /api/*

# 存在性检查
user_id: *

# 否定查询
NOT status: 200

# 组合查询
(status: 200 OR status: 201) AND method: "POST"
</code></pre>
<h3 id="53-visualize---可视化图表"><a class="header" href="#53-visualize---可视化图表">5.3 Visualize - 可视化图表</a></h3>
<p><strong>常用图表类型</strong></p>
<p><strong>1. Line Chart - 折线图</strong></p>
<pre><code>用途: 显示时间趋势变化
示例: 查看请求量与延迟趋势
配置:
  - X轴: Date Histogram (@timestamp)
  - Y轴: Count / Average(response_time)
</code></pre>
<p><strong>2. Bar Chart - 柱状图</strong></p>
<pre><code>用途: 对比不同类别数据
示例: 不同状态码的请求数量
配置:
  - X轴: Terms (status)
  - Y轴: Count
</code></pre>
<p><strong>3. Pie Chart - 饼图</strong></p>
<pre><code>用途: 显示占比关系
示例: 不同请求方法的占比
配置:
  - Slice: Terms (method)
  - Size: Count
</code></pre>
<p><strong>4. Data Table - 数据表</strong></p>
<pre><code>用途: 显示聚合详细数据
示例: TOP 10访问IP及请求量
配置:
  - Rows: Terms (client_ip, size: 10)
  - Metrics: Count, Average(response_time)
</code></pre>
<p><strong>5. Metric - 单指标显示</strong></p>
<pre><code>用途: 显示关键指标
示例: 总请求量、平均延迟、错误率
配置:
  - Metric: Count / Average / Sum
</code></pre>
<p><strong>6. Heat Map - 热力图</strong></p>
<pre><code>用途: 显示数据密度分布
示例: 一周内每小时请求量热力图
配置:
  - X轴: Date Histogram (1 hour)
  - Y轴: Terms (day_of_week)
  - Color: Count
</code></pre>
<h3 id="54-dashboard---仪表板"><a class="header" href="#54-dashboard---仪表板">5.4 Dashboard - 仪表板</a></h3>
<p><strong>创建综合监控仪表板</strong></p>
<p><strong>示例: Nginx访问监控仪表板</strong></p>
<pre><code>布局规划:
┌─────────────────────────────────────────────┐
│  总请求量  |  平均延迟  |  错误率      │
├─────────────────────────────────────────────┤
│  请求量趋势图 (Line Chart)              │
├─────────────────────┬───────────────────────┤
│ 状态码分布 (Pie)     │ TOP 10 URI (Table)   │
├─────────────────────┴───────────────────────┤
│ 请求量热力图 (Bar)   │ TOP IP访问 (Table)   │
├─────────────────────────────────────────────┤
│  地理位置分布图 (Region Map)               │
└─────────────────────────────────────────────┘
</code></pre>
<p><strong>仪表板最佳实践</strong></p>
<ol>
<li>使用统一的时间筛选器</li>
<li>按逻辑分组仪表板布局（核心指标置顶）</li>
<li>使用 Markdown 添加说明文字</li>
<li>配置合适的刷新间隔</li>
<li>保存仪表板并设置默认首页</li>
</ol>
<hr />
<h2 id="六beats---轻量级数据采集器"><a class="header" href="#六beats---轻量级数据采集器">六、Beats - 轻量级数据采集器</a></h2>
<h3 id="61-filebeat配置"><a class="header" href="#61-filebeat配置">6.1 Filebeat配置</a></h3>
<p><strong>基本配置文件 filebeat.yml</strong></p>
<pre><code class="language-yaml"># ============= Filebeat输入配置 =============
filebeat.inputs:
  # 应用日志
  - type: log
    enabled: true
    paths:
      - /var/log/app/*.log
    fields:
      app: myapp
      env: production
    fields_under_root: true
    multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
    multiline.negate: true
    multiline.match: after

  # Nginx访问日志
  - type: log
    enabled: true
    paths:
      - /var/log/nginx/access.log
    fields:
      log_type: nginx_access

  # Nginx错误日志
  - type: log
    enabled: true
    paths:
      - /var/log/nginx/error.log
    fields:
      log_type: nginx_error

# ============= Filebeat模块 =============
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 10s

# ============= Elasticsearch输出 =============
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "filebeat-%{[agent.version]}-%{+yyyy.MM.dd}"

# ============= Logstash输出（推荐）=============
output.logstash:
  hosts: ["localhost:5044"]
  loadbalance: true

# ============= Kibana配置 =============
setup.kibana:
  host: "localhost:5601"

# ============= 日志级别 =============
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
</code></pre>
<p><strong>启动Filebeat</strong></p>
<pre><code class="language-bash"># 启动前检查配置
filebeat test config

# 加载Kibana仪表板
filebeat setup --dashboards

# 启动Filebeat
filebeat -e -c filebeat.yml
</code></pre>
<h3 id="62-metricbeat---指标监控"><a class="header" href="#62-metricbeat---指标监控">6.2 Metricbeat - 指标监控</a></h3>
<p><strong>metricbeat.yml配置</strong></p>
<pre><code class="language-yaml">metricbeat.modules:
  # 系统模块
  - module: system
    period: 10s
    metricsets:
      - cpu
      - load
      - memory
      - network
      - process
      - process_summary
      - filesystem
    processes: ['.*']

  # Docker模块
  - module: docker
    period: 10s
    hosts: ["unix:///var/run/docker.sock"]
    metricsets:
      - container
      - cpu
      - memory
      - network

  # Nginx模块
  - module: nginx
    period: 10s
    hosts: ["http://localhost"]
    server_status_path: "/nginx_status"

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "metricbeat-%{[agent.version]}-%{+yyyy.MM.dd}"
</code></pre>
<hr />
<h2 id="七实战案例"><a class="header" href="#七实战案例">七、实战案例</a></h2>
<h3 id="71-案例一监控spring-boot应用日志"><a class="header" href="#71-案例一监控spring-boot应用日志">7.1 案例一：监控Spring Boot应用日志</a></h3>
<p><strong>场景</strong>: 收集Spring Boot应用日志，并监控错误率与性能指标</p>
<p><strong>应用日志格式</strong></p>
<pre><code>2024-01-15 10:30:25.123 INFO [http-nio-8080-exec-1] c.e.UserController : 用户登录成功 userId=1001
2024-01-15 10:30:26.456 ERROR [http-nio-8080-exec-2] c.e.OrderService : 创建订单失败 orderId=2001 error=库存不足
</code></pre>
<p><strong>Logstash配置 - springboot.conf</strong></p>
<pre><code class="language-ruby">input {
  beats {
    port =&gt; 5044
  }
}

filter {
  # 解析Spring Boot日志
  grok {
    match =&gt; {
      "message" =&gt; "%{TIMESTAMP_ISO8601:log_timestamp} +%{LOGLEVEL:log_level} +\\[%{DATA:thread}\\] +%{JAVACLASS:logger} +: +%{GREEDYDATA:log_message}"
    }
  }

  # 转换日志级别为小写
  mutate {
    lowercase =&gt; [ "log_level" ]
  }

  # 提取业务字段
  if [log_message] =~ /userId=/ {
    grok {
      match =&gt; { "log_message" =&gt; "userId=%{NUMBER:user_id}" }
    }
  }

  if [log_message] =~ /orderId=/ {
    grok {
      match =&gt; { "log_message" =&gt; "orderId=%{NUMBER:order_id}" }
    }
  }

  # 时间戳转换
  date {
    match =&gt; [ "log_timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    target =&gt; "@timestamp"
    timezone =&gt; "Asia/Shanghai"
  }

  # 添加标签
  if [log_level] == "error" {
    mutate {
      add_tag =&gt; [ "error_alert" ]
    }
  }
}

output {
  elasticsearch {
    hosts =&gt; ["localhost:9200"]
    index =&gt; "springboot-logs-%{+YYYY.MM.dd}"
  }

  # 错误日志单独索引
  if "error_alert" in [tags] {
    elasticsearch {
      hosts =&gt; ["localhost:9200"]
      index =&gt; "springboot-errors-%{+YYYY.MM.dd}"
    }
  }
}
</code></pre>
<p><strong>Kibana Dashboard配置</strong></p>
<pre><code>1. 日志数量趋势（Line Chart）
   - X轴: @timestamp (per minute)
   - Y轴: Count

2. 日志级别分布（Pie Chart）
   - Slice: log_level

3. 错误日志明细（Data Table）
   - Filter: log_level: error
   - Columns: @timestamp, logger, log_message

4. Top错误日志（Bar Chart）
   - X轴: Terms(logger, size: 10)
   - Filter: log_level: error
</code></pre>
<h3 id="72-案例二分析nginx访问日志"><a class="header" href="#72-案例二分析nginx访问日志">7.2 案例二：分析Nginx访问日志</a></h3>
<p><strong>场景</strong>: 收集Nginx访问日志，统计UV、PV、响应时间分布</p>
<p><strong>Nginx日志格式配置</strong></p>
<pre><code class="language-nginx">log_format json_log escape=json '{'
    '"time":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"request_method":"$request_method",'
    '"request_uri":"$request_uri",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"http_referer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"request_time":$request_time,'
    '"upstream_response_time":"$upstream_response_time"'
'}';

access_log /var/log/nginx/access.log json_log;
</code></pre>
<p><strong>Logstash配置 - nginx.conf</strong></p>
<pre><code class="language-ruby">input {
  file {
    path =&gt; "/var/log/nginx/access.log"
    start_position =&gt; "beginning"
    codec =&gt; json
  }
}

filter {
  # 时间转换
  date {
    match =&gt; [ "time", "ISO8601" ]
    target =&gt; "@timestamp"
  }

  # GeoIP解析
  geoip {
    source =&gt; "remote_addr"
    target =&gt; "geoip"
  }

  # User Agent解析
  useragent {
    source =&gt; "http_user_agent"
    target =&gt; "user_agent"
  }

  # 延迟转换为毫秒
  ruby {
    code =&gt; "
      event.set('request_time_ms', (event.get('request_time').to_f * 1000).to_i)
      if event.get('upstream_response_time') != '-'
        event.set('upstream_time_ms', (event.get('upstream_response_time').to_f * 1000).to_i)
      end
    "
  }

  # 标记慢请求
  if [request_time_ms] &gt; 1000 {
    mutate {
      add_tag =&gt; [ "slow_request" ]
    }
  }

  # 标记错误请求
  if [status] &gt;= 400 {
    mutate {
      add_tag =&gt; [ "error_request" ]
    }
  }

  # 识别爬虫
  if [http_user_agent] =~ /bot|spider|crawler/i {
    mutate {
      add_tag =&gt; [ "bot" ]
    }
  }
}

output {
  elasticsearch {
    hosts =&gt; ["localhost:9200"]
    index =&gt; "nginx-access-%{+YYYY.MM.dd}"
  }
}
</code></pre>
<p><strong>告警规则配置</strong></p>
<p>创建 Watcher（需要X-Pack）</p>
<pre><code class="language-json">PUT _watcher/watch/slow_requests_alert
{
  "trigger": {
    "schedule": {
      "interval": "5m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ["nginx-access-*"],
        "body": {
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-5m"
                    }
                  }
                },
                {
                  "term": {
                    "tags": "slow_request"
                  }
                }
              ]
            }
          },
          "aggs": {
            "slow_count": {
              "value_count": {
                "field": "_id"
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.aggregations.slow_count.value": {
        "gt": 10
      }
    }
  },
  "actions": {
    "send_email": {
      "email": {
        "to": "ops@example.com",
        "subject": "慢请求告警",
        "body": "最近5分钟内检测到{{ctx.payload.aggregations.slow_count.value}}个慢请求"
      }
    }
  }
}
</code></pre>
<h3 id="73-案例三实现分布式链路追踪日志聚合"><a class="header" href="#73-案例三实现分布式链路追踪日志聚合">7.3 案例三：实现分布式链路追踪日志聚合</a></h3>
<p><strong>场景</strong>: 多个微服务的日志关联查询</p>
<p><strong>方案实现 - 添加TraceId</strong></p>
<p><strong>Spring Boot配置</strong></p>
<pre><code class="language-java">// MDC添加TraceId
@Component
public class TraceIdFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response,
                        FilterChain chain) throws IOException, ServletException {
        String traceId = UUID.randomUUID().toString().replace("-", "");
        MDC.put("traceId", traceId);
        try {
            chain.doFilter(request, response);
        } finally {
            MDC.remove("traceId");
        }
    }
}

// logback.xml配置
&lt;configuration&gt;
    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId}] %-5level [%thread] %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
&lt;/configuration&gt;
</code></pre>
<p><strong>Logstash提取TraceId</strong></p>
<pre><code class="language-ruby">filter {
  grok {
    match =&gt; {
      "message" =&gt; "%{TIMESTAMP_ISO8601:timestamp} \\[%{DATA:trace_id}\\] %{LOGLEVEL:level} \\[%{DATA:thread}\\] %{JAVACLASS:logger} - %{GREEDYDATA:log_message}"
    }
  }

  # 将TraceId设为元数据
  if [trace_id] {
    mutate {
      add_field =&gt; { "[@metadata][trace_id]" =&gt; "%{trace_id}" }
    }
  }
}
</code></pre>
<p><strong>Kibana查询关联</strong></p>
<pre><code># 查询整个请求链路的所有日志
trace_id: "abc123def456"

# 结果示例
gateway-service   → 10:30:25.123 - 接收请求 /api/order
user-service      → 10:30:25.234 - 查询用户信息 userId=1001
order-service     → 10:30:25.345 - 创建订单 orderId=2001
payment-service   → 10:30:25.456 - 处理支付
order-service     → 10:30:25.567 - 更新订单状态
gateway-service   → 10:30:25.678 - 返回结果
</code></pre>
<hr />
<h2 id="八性能优化与最佳实践"><a class="header" href="#八性能优化与最佳实践">八、性能优化与最佳实践</a></h2>
<h3 id="81-elasticsearch性能优化"><a class="header" href="#81-elasticsearch性能优化">8.1 Elasticsearch性能优化</a></h3>
<p><strong>索引优化</strong></p>
<pre><code class="language-json">// 1. 合理设置分片数量
PUT /my-index
{
  "settings": {
    "number_of_shards": 3,     // 分片数 = 节点数 × 1-3
    "number_of_replicas": 1,   // 副本数根据可用性要求
    "refresh_interval": "30s", // 减少刷新频率
    "index.codec": "best_compression" // 启用压缩
  }
}

// 2. 使用Index Template统一配置
PUT /_index_template/logs_template
{
  "index_patterns": ["logs-*"],
  "template": {
    "settings": {
      "number_of_shards": 3,
      "number_of_replicas": 1,
      "refresh_interval": "30s"
    },
    "mappings": {
      "properties": {
        "@timestamp": { "type": "date" },
        "message": { "type": "text" },
        "level": { "type": "keyword" }
      }
    }
  }
}
</code></pre>
<p><strong>查询优化</strong></p>
<pre><code class="language-json">// 1. 使用Filter Context（不计算相关性评分，可缓存）
{
  "query": {
    "bool": {
      "filter": [
        { "term": { "status": 200 } },
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  }
}

// 2. 减少返回字段
{
  "query": { "match_all": {} },
  "_source": ["@timestamp", "message", "level"]
}

// 3. 使用分页，避免深度分页
// 错误: from=10000, size=10
// 正确: search_after 或 scroll API
</code></pre>
<p><strong>索引生命周期管理（ILM）</strong></p>
<pre><code class="language-json">// 定义ILM策略
PUT _ilm/policy/logs_policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "1d"
          }
        }
      },
      "warm": {
        "min_age": "3d",
        "actions": {
          "shrink": {
            "number_of_shards": 1
          },
          "forcemerge": {
            "max_num_segments": 1
          }
        }
      },
      "cold": {
        "min_age": "7d",
        "actions": {
          "freeze": {}
        }
      },
      "delete": {
        "min_age": "30d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}

// 应用策略到索引模板
PUT _index_template/logs_template
{
  "index_patterns": ["logs-*"],
  "template": {
    "settings": {
      "index.lifecycle.name": "logs_policy",
      "index.lifecycle.rollover_alias": "logs"
    }
  }
}
</code></pre>
<h3 id="82-logstash性能优化"><a class="header" href="#82-logstash性能优化">8.2 Logstash性能优化</a></h3>
<p><strong>配置优化</strong></p>
<pre><code class="language-ruby"># logstash.yml
pipeline.workers: 4              # 并行处理线程数 = CPU核数
pipeline.batch.size: 125         # 批处理大小
pipeline.batch.delay: 50         # 批处理延迟（毫秒）

# JVM堆内存设置
# jvm.options
-Xms2g
-Xmx2g
</code></pre>
<p><strong>管道优化</strong></p>
<pre><code class="language-ruby"># 使用条件判断避免不必要的处理
filter {
  if [type] == "nginx" {
    grok { ... }
  } else if [type] == "app" {
    grok { ... }
  }
}

# 使用drop过滤器去除不需要的数据
filter {
  if [status] == 200 and [request] =~ /health_check/ {
    drop { }
  }
}

# 并发输出
output {
  elasticsearch {
    hosts =&gt; ["localhost:9200"]
    workers =&gt; 2  # 增加worker数量
  }
}
</code></pre>
<h3 id="83-集群规划建议"><a class="header" href="#83-集群规划建议">8.3 集群规划建议</a></h3>
<p><strong>硬件推荐配置</strong></p>
<div class="table-wrapper"><table><thead><tr><th>组件</th><th>CPU</th><th>内存</th><th>磁盘</th><th>备注</th></tr></thead><tbody>
<tr><td>Elasticsearch</td><td>8核+</td><td>32GB+</td><td>SSD 500GB+</td><td>内存:数据比例 1:30</td></tr>
<tr><td>Logstash</td><td>4核+</td><td>8GB+</td><td>100GB</td><td>CPU密集型</td></tr>
<tr><td>Kibana</td><td>2核+</td><td>4GB+</td><td>50GB</td><td>内存适中即可</td></tr>
</tbody></table>
</div>
<p><strong>集群规模</strong></p>
<pre><code>小规模（日志量 &lt; 10GB/天）
  - 单节点ES + Logstash + Kibana

中等规模（10-100GB/天）
  - 3节点ES集群
  - 2节点Logstash（负载均衡）
  - 1节点Kibana

大规模（&gt; 100GB/天）
  - ES集群: 至少Master节点 × 3 + 数据节点 × N
  - Logstash: 多节点 + 消息队列（Kafka/Redis）
  - Kibana: 多节点 + 负载均衡
</code></pre>
<h3 id="84-安全配置"><a class="header" href="#84-安全配置">8.4 安全配置</a></h3>
<p><strong>Elasticsearch安全配置</strong></p>
<pre><code class="language-yaml"># elasticsearch.yml
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# 创建用户
bin/elasticsearch-users useradd admin -p password -r superuser
bin/elasticsearch-users useradd kibana_system -p password -r kibana_system
bin/elasticsearch-users useradd logstash_system -p password -r logstash_system
</code></pre>
<p><strong>Kibana安全配置</strong></p>
<pre><code class="language-yaml"># kibana.yml
elasticsearch.username: "kibana_system"
elasticsearch.password: "password"
elasticsearch.ssl.verificationMode: certificate
</code></pre>
<p><strong>Logstash安全配置</strong></p>
<pre><code class="language-ruby">output {
  elasticsearch {
    hosts =&gt; ["https://localhost:9200"]
    user =&gt; "logstash_system"
    password =&gt; "password"
    ssl =&gt; true
    cacert =&gt; "/path/to/ca.crt"
  }
}
</code></pre>
<hr />
<h2 id="九故障排查与常见问题"><a class="header" href="#九故障排查与常见问题">九、故障排查与常见问题</a></h2>
<h3 id="91-elasticsearch常见问题"><a class="header" href="#91-elasticsearch常见问题">9.1 Elasticsearch常见问题</a></h3>
<p><strong>问题1: 集群状态Yellow</strong></p>
<pre><code class="language-bash"># 查看集群健康状态
curl -X GET "localhost:9200/_cluster/health?pretty"

# 原因: 副本分片未分配（单节点模式）
# 解决方法: 设置副本数为0
curl -X PUT "localhost:9200/_settings" -H 'Content-Type: application/json' -d'
{
  "index": {
    "number_of_replicas": 0
  }
}
'
</code></pre>
<p><strong>问题2: 内存不足或频繁GC</strong></p>
<pre><code class="language-bash"># 查看节点JVM内存使用
curl -X GET "localhost:9200/_nodes/stats/jvm?pretty"

# 解决方法:
# 1. 增加堆内存（不超过32GB）
# 2. 启用G1GC垃圾回收器
# jvm.options
-XX:+UseG1GC
-XX:G1ReservePercent=25
-XX:InitiatingHeapOccupancyPercent=30
</code></pre>
<p><strong>问题3: 搜索慢</strong></p>
<pre><code class="language-bash"># 启用慢查询日志
curl -X PUT "localhost:9200/_settings" -H 'Content-Type: application/json' -d'
{
  "index.search.slowlog.threshold.query.warn": "1s",
  "index.search.slowlog.threshold.query.info": "500ms"
}
'

# 查看慢查询日志
tail -f /var/log/elasticsearch/elasticsearch_index_search_slowlog.log

# 优化建议:
# - 使用filter代替query
# - 减少返回字段
# - 使用routing
# - 优化mapping设计
</code></pre>
<h3 id="92-logstash常见问题"><a class="header" href="#92-logstash常见问题">9.2 Logstash常见问题</a></h3>
<p><strong>问题1: 数据处理延迟</strong></p>
<pre><code class="language-bash"># 查看管道指标
curl -X GET "localhost:9600/_node/stats/pipelines?pretty"

# 解决方法:
# 1. 增加pipeline.workers
# 2. 增加pipeline.batch.size
# 3. 优化filter复杂度
# 4. 增加Kafka/Redis缓冲层
</code></pre>
<p><strong>问题2: Grok解析失败</strong></p>
<pre><code class="language-ruby"># 使用Grok Debugger调试
# Kibana -&gt; Dev Tools -&gt; Grok Debugger

# 添加标签方便排查
filter {
  grok {
    match =&gt; { "message" =&gt; "..." }
    tag_on_failure =&gt; ["_grokparsefailure_custom"]
  }
}

# 查询失败的日志
GET logstash-*/_search
{
  "query": {
    "term": {
      "tags": "_grokparsefailure_custom"
    }
  }
}
</code></pre>
<p><strong>问题3: Logstash内存溢出</strong></p>
<pre><code class="language-bash"># 监控内存使用
watch -n 5 'ps aux | grep logstash'

# 解决方法:
# 1. 减少JVM堆内存
# 2. 降低启动线程（4个足够）
# 3. 停止或限制其他任务
# 4. 分离输入源处理
</code></pre>
<h3 id="93-kibana常见问题"><a class="header" href="#93-kibana常见问题">9.3 Kibana常见问题</a></h3>
<p><strong>问题1: Kibana启动失败</strong></p>
<pre><code class="language-bash"># 查看日志
tail -f /var/log/kibana/kibana.log

# 常见原因:
# 1. Elasticsearch不可用
# 2. 端口已被占用
# 3. 配置错误

# 验证端口
curl -X GET "localhost:9200"
curl -X GET "localhost:5601/api/status"
</code></pre>
<p><strong>问题2: Index Pattern创建失败</strong></p>
<pre><code># 原因: 索引不存在或无数据与字段
# 解决: 确认ES中已有对应索引及数据

# 查看索引
curl -X GET "localhost:9200/_cat/indices?v"

# 查看mapping
curl -X GET "localhost:9200/my-index/_mapping?pretty"
</code></pre>
<hr />
<h2 id="十学习成果验证标准"><a class="header" href="#十学习成果验证标准">十、学习成果验证标准</a></h2>
<h3 id="验证标准1-环境搭建能力"><a class="header" href="#验证标准1-环境搭建能力">验证标准1: 环境搭建能力</a></h3>
<p><strong>要求</strong>: 能够在30分钟内使用Docker Compose搭建完整ELK环境
<strong>验证步骤</strong>:</p>
<pre><code class="language-bash"># 1. 编写docker-compose.yml
# 2. 启动服务
docker-compose up -d

# 3. 验证服务状态
curl http://localhost:9200         # ES正常
curl http://localhost:5601/status  # Kibana正常

# 4. 发送测试数据
echo '{"message":"test"}' | nc localhost 5000

# 5. 在Kibana中查看数据
</code></pre>
<h3 id="验证标准2-日志解析能力"><a class="header" href="#验证标准2-日志解析能力">验证标准2: 日志解析能力</a></h3>
<p><strong>要求</strong>: 能够使用Grok解析各种格式的日志
<strong>验证任务</strong>: 解析如下Nginx日志，并编写Logstash配置完成</p>
<pre><code>192.168.1.100 - - [15/Jan/2024:10:30:25 +0800] "GET /api/users HTTP/1.1" 200 1234 "https://www.example.com" "Mozilla/5.0" rt=0.123
</code></pre>
<p><strong>要求提取字段</strong>:</p>
<ul>
<li>client_ip, timestamp, method, uri, status, bytes, referer, user_agent, response_time</li>
</ul>
<h3 id="验证标准3-可视化能力"><a class="header" href="#验证标准3-可视化能力">验证标准3: 可视化能力</a></h3>
<p><strong>要求</strong>: 能够创建至少5种不同图表类型的Dashboard
<strong>验证任务</strong>:</p>
<ol>
<li>创建Metric图表显示总请求量</li>
<li>创建Line Chart显示请求趋势</li>
<li>创建Pie Chart显示状态码分布</li>
<li>创建Data Table显示TOP 10 URI</li>
<li>创建Heat Map显示请求量热力图</li>
</ol>
<h3 id="验证标准4-性能优化能力"><a class="header" href="#验证标准4-性能优化能力">验证标准4: 性能优化能力</a></h3>
<p><strong>要求</strong>: 能够识别并优化慢查询
<strong>验证任务</strong>: 给定一个慢查询，分析原因并提供优化方案</p>
<pre><code class="language-json">// 慢查询示例
{
  "query": {
    "bool": {
      "must": [
        { "match": { "message": "error" } }
      ]
    }
  },
  "from": 10000,
  "size": 10
}

// 优化方向:
// 1. 使用filter代替must
// 2. 使用search_after代替深度分页
// 3. 减少返回字段
</code></pre>
<h3 id="验证标准5-故障处理能力"><a class="header" href="#验证标准5-故障处理能力">验证标准5: 故障处理能力</a></h3>
<p><strong>要求</strong>: 能够快速排查ELK常见问题
<strong>测试场景</strong>:</p>
<ol>
<li>Elasticsearch集群状态Red，如何排查</li>
<li>Logstash不处理数据，如何排查</li>
<li>Kibana无法连接Elasticsearch，如何排查</li>
</ol>
<p><strong>排查思路</strong>:</p>
<ul>
<li>能够使用API查看集群状态</li>
<li>能够分析日志找到根因</li>
<li>能够提出解决方案</li>
</ul>
<hr />
<h2 id="十一进阶学习路径"><a class="header" href="#十一进阶学习路径">十一、进阶学习路径</a></h2>
<h3 id="111-进阶技术方向"><a class="header" href="#111-进阶技术方向">11.1 进阶技术方向</a></h3>
<p><strong>方向1: Elasticsearch高级特性</strong></p>
<ul>
<li>Search Template与Script Query</li>
<li>Index Alias与Reindex</li>
<li>Snapshot与Restore</li>
<li>Cross Cluster Search</li>
<li>Machine Learning功能</li>
</ul>
<p><strong>方向2: 大规模架构演进</strong></p>
<pre><code>应用 → Filebeat → Kafka → Logstash → Elasticsearch → Kibana
              ↓
            多消费者（数据分流）
</code></pre>
<p><strong>方向3: 安全与权限管理</strong></p>
<ul>
<li>X-Pack Security配置</li>
<li>RBAC角色权限管理</li>
<li>字段级加密</li>
<li>审计日志配置</li>
</ul>
<p><strong>方向4: 云原生部署</strong></p>
<ul>
<li>Kubernetes上部署ELK（Elastic Cloud on Kubernetes）</li>
<li>使用Operator管理ELK</li>
<li>自动化扩缩容配置</li>
<li>监控与告警集成</li>
</ul>
<h3 id="112-推荐学习资源"><a class="header" href="#112-推荐学习资源">11.2 推荐学习资源</a></h3>
<p><strong>官方文档</strong></p>
<ul>
<li>Elasticsearch: https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</li>
<li>Logstash: https://www.elastic.co/guide/en/logstash/current/index.html</li>
<li>Kibana: https://www.elastic.co/guide/en/kibana/current/index.html</li>
</ul>
<p><strong>实战项目</strong></p>
<ol>
<li>搭建个人博客全链路日志监控系统</li>
<li>实现微服务应用链路追踪日志聚合</li>
<li>构建网站访问性能分析系统</li>
<li>开发自定义Logstash插件</li>
</ol>
<p><strong>社区资源</strong></p>
<ul>
<li>Elastic中文社区: https://elasticsearch.cn/</li>
<li>GitHub开源项目: 搜索 "ELK" 关键字项目</li>
<li>YouTube视频教程: Elasticsearch官方频道</li>
</ul>
<p><strong>书籍推荐</strong></p>
<ul>
<li>《Elasticsearch权威指南》</li>
<li>《深入理解Elasticsearch》</li>
<li>《ELK Stack权威指南》</li>
</ul>
<h3 id="113-认证考试"><a class="header" href="#113-认证考试">11.3 认证考试</a></h3>
<p><strong>Elastic认证工程师（ECE）</strong></p>
<ul>
<li>考试内容: Elasticsearch集群配置、优化、故障处理</li>
<li>适合人群: 1年以上ELK使用经验</li>
<li>官网: https://www.elastic.co/training/certification</li>
</ul>
<hr />
<h2 id="十二附录"><a class="header" href="#十二附录">十二、附录</a></h2>
<h3 id="121-常用命令速查"><a class="header" href="#121-常用命令速查">12.1 常用命令速查</a></h3>
<p><strong>Elasticsearch</strong></p>
<pre><code class="language-bash"># 集群管理
GET /_cluster/health
GET /_cat/nodes?v
GET /_cat/indices?v
GET /_cat/shards?v

# 索引管理
PUT /my-index
DELETE /my-index
POST /my-index/_close
POST /my-index/_open

# 文档操作
PUT /my-index/_doc/1
GET /my-index/_doc/1
DELETE /my-index/_doc/1
POST /my-index/_update/1

# 搜索查询
GET /my-index/_search
GET /my-index/_count
POST /my-index/_search
</code></pre>
<p><strong>Logstash</strong></p>
<pre><code class="language-bash"># 检查配置
bin/logstash -f config.conf --config.test_and_exit

# 启动
bin/logstash -f config.conf

# 热重载配置
bin/logstash -f config.conf --config.reload.automatic

# 查看管道指标
curl -X GET "localhost:9600/_node/stats/pipelines?pretty"
</code></pre>
<p><strong>Kibana</strong></p>
<pre><code class="language-bash"># 导出saved objects
curl -X POST "localhost:5601/api/saved_objects/_export" \
  -H 'kbn-xsrf: true' \
  -H 'Content-Type: application/json' \
  -d '{"type":"dashboard"}'

# 导入saved objects
curl -X POST "localhost:5601/api/saved_objects/_import" \
  -H 'kbn-xsrf: true' \
  --form file=@export.ndjson
</code></pre>
<h3 id="122-grok-pattern速查表"><a class="header" href="#122-grok-pattern速查表">12.2 Grok Pattern速查表</a></h3>
<pre><code>常用模式:
%{IP:client_ip}                    - IP地址
%{NUMBER:response_time}            - 数字
%{INT:status}                      - 整数
%{WORD:method}                     - 单词
%{DATA:message}                    - 任意字符匹配
%{GREEDYDATA:message}              - 贪婪字符匹配
%{QUOTEDSTRING:quoted}             - 带引号字符串
%{URI:url}                         - URL
%{TIMESTAMP_ISO8601:timestamp}     - ISO8601日期
%{HTTPDATE:timestamp}              - HTTP日期格式
%{LOGLEVEL:level}                  - 日志级别
%{JAVACLASS:class}                 - Java类名
</code></pre>
<h3 id="123-常见错误码"><a class="header" href="#123-常见错误码">12.3 常见错误码</a></h3>
<div class="table-wrapper"><table><thead><tr><th>错误码</th><th>说明</th><th>解决方法</th></tr></thead><tbody>
<tr><td>429</td><td>Too Many Requests</td><td>减少请求频率或增加队列大小</td></tr>
<tr><td>503</td><td>Service Unavailable</td><td>检查集群状态或资源</td></tr>
<tr><td>400</td><td>Bad Request</td><td>检查请求格式是否正确</td></tr>
<tr><td>404</td><td>Not Found</td><td>检查索引或文档是否存在</td></tr>
<tr><td>500</td><td>Internal Server Error</td><td>查看ES日志找到根因</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="结语"><a class="header" href="#结语">结语</a></h2>
<p>ELK Stack是现代DevOps与SRE必备技能，通过统一的日志收集、存储、检索和可视化，极大提升了运维效率与故障定位能力。</p>
<p><strong>学习路径总结</strong>:</p>
<ol>
<li>掌握核心组件功能，搭建测试环境</li>
<li>理解数据流转机制，编写Logstash配置</li>
<li>深入查询语法，掌握数据分析能力</li>
<li>实践业务场景，积累实战经验</li>
<li>使用进阶特性，深入架构优化</li>
</ol>
<p><strong>持续提升建议</strong>:</p>
<ul>
<li>定期review配置优化</li>
<li>关注性能指标</li>
<li>积累端到端案例</li>
<li>关注社区最新版本</li>
</ul>
<p>祝你学习之旅圆满！:ELK全栈掌握</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/linux/Uboot.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/middleware/prometheus.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/linux/Uboot.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/middleware/prometheus.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

