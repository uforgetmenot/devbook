<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Secure Boot 虚拟化与云平台学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="secure-boot-虚拟化与云平台学习笔记"><a class="header" href="#secure-boot-虚拟化与云平台学习笔记">Secure Boot 虚拟化与云平台学习笔记</a></h1>
<blockquote>
<p>面向 0-5 年经验的虚拟化、云平台、安全工程师，系统掌握 Secure Boot 原理、密钥管理、在物理/虚拟机上的配置与验证、与云平台（OpenStack、KubeVirt、Azure/AWS）集成、常见问题与排查。</p>
</blockquote>
<hr />
<h2 id="学习定位与总体目标"><a class="header" href="#学习定位与总体目标">学习定位与总体目标</a></h2>
<ul>
<li><strong>学习者画像</strong>：熟悉基本的 UEFI、操作系统安装及虚拟化操作，希望在企业、云平台或多租户环境中启用 Secure Boot 提升安全、合规水平的工程师。</li>
<li><strong>技术定位</strong>：Secure Boot 是 UEFI 提供的启动链完整性保护机制，通过验证引导程序和驱动的签名，防止未授权代码（如 rootkit）在启动时加载。虚拟化与云平台场景需要额外关注虚拟固件、密钥分发、镜像签名与自动化配置。</li>
<li><strong>学习目标</strong>：
<ol>
<li>理解 Secure Boot 信任链、密钥层级（PK/KEK/DB/DBX）、签名与验证流程；</li>
<li>熟悉在物理服务器及虚拟化环境（KVM/libvirt/OVMF、Hyper-V、VMware、OpenStack、KubeVirt）中启用与管理 Secure Boot；</li>
<li>能够配置自定义密钥、签名引导程序、集成 CI/CD 与镜像仓库，确保自研镜像可通过验证；</li>
<li>建立故障排查流程（启动失败、证书过期、驱动拒绝加载），制定应急与回滚方案；</li>
<li>输出操作手册、自动化脚本、验证标准和最佳实践，满足合规、审计、安全要求。</li>
</ol>
</li>
<li><strong>成果要求</strong>：
<ul>
<li>完成 Secure Boot 启动链分析与实验验证；</li>
<li>在虚拟化环境中成功启用 Secure Boot 并运行自定义签名镜像；</li>
<li>构建密钥管理与镜像签名流程（脚本/CI）；</li>
<li>编写故障排查案例、维护操作指南与知识库；</li>
<li>通过团队评审，纳入安全标准。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="核心模块结构"><a class="header" href="#核心模块结构">核心模块结构</a></h2>
<ol>
<li><strong>模块一：Secure Boot 原理与信任链</strong> —— UEFI 架构、密钥层级、启动流程。</li>
<li><strong>模块二：密钥管理与签名实践</strong> —— PK/KEK/DB/DBX、密钥生成、签名工具。</li>
<li><strong>模块三：物理服务器与虚拟化平台配置</strong> —— BIOS/UEFI 设置、OVMF、libvirt、Hyper-V、VMware。</li>
<li><strong>模块四：云平台与自动化集成</strong> —— OpenStack、KubeVirt、AWS/Azure/GCP、镜像签名流水线、CI/CD。</li>
<li><strong>模块五：故障诊断、安全治理与最佳实践</strong> —— 常见问题、日志分析、回滚、合规策略。</li>
<li><strong>模块六：学习路径、实战案例与验证标准</strong> —— 学习计划、项目案例、成果评估、资源扩展。</li>
</ol>
<hr />
<h2 id="模块一secure-boot-原理与信任链"><a class="header" href="#模块一secure-boot-原理与信任链">模块一：Secure Boot 原理与信任链</a></h2>
<h3 id="11-uefi-与安全启动概述"><a class="header" href="#11-uefi-与安全启动概述">1.1 UEFI 与安全启动概述</a></h3>
<ul>
<li>UEFI（Unified Extensible Firmware Interface）取代传统 BIOS，提供更强的可扩展性和安全能力；</li>
<li>Secure Boot 在 UEFI 上实现，引导链条包含：UEFI 固件 → Boot Manager → Bootloader → OS；</li>
<li>Secure Boot 通过核对数字签名确保加载的模块被授权。</li>
</ul>
<h3 id="12-信任链结构与密钥层级"><a class="header" href="#12-信任链结构与密钥层级">1.2 信任链结构与密钥层级</a></h3>
<ul>
<li><strong>PK（Platform Key）</strong>：系统所有权根，控制更新 KEK；</li>
<li><strong>KEK（Key Exchange Key）</strong>：允许操作系统供应商或管理员更新 DB/DBX；</li>
<li><strong>DB（Signature Database）</strong>：授权签名列表（允许加载）；</li>
<li><strong>DBX（Forbidden Signature Database）</strong>：撤销列表（禁止）；</li>
<li>流程：UEFI 验证 PK → KEK → Bootloader/Driver 签名；</li>
<li>常见固件中预装 Microsoft KEK/DB 以允许 Windows 引导。</li>
</ul>
<h3 id="13-启动流程细分"><a class="header" href="#13-启动流程细分">1.3 启动流程细分</a></h3>
<ol>
<li>UEFI Firmware 加载 -&gt; 读取 Secure Boot 状态；</li>
<li>验证 PK/KEK/DB/DBX 完整性；</li>
<li>加载 Boot Manager（EFI executable）并验证签名；</li>
<li>启动 Bootloader（如 shim.efi, grubx64.efi）；</li>
<li>Bootloader 验证内核签名（shim + MOK 机制）；</li>
<li>启动操作系统；</li>
<li>OS 内加载驱动时继续验证。</li>
</ol>
<h3 id="14-shim-与-mok-manager"><a class="header" href="#14-shim-与-mok-manager">1.4 shim 与 Mok Manager</a></h3>
<ul>
<li>shim：通用引导程序，由 Microsoft 签名，允许引导 Linux；</li>
<li>shim 内置证书，加载 grub 或内核；</li>
<li>MokManager：Machine Owner Key 管理工具，可在启动时注册额外证书；</li>
<li><code>mokutil</code> 命令在 Linux 中管理 MOK。</li>
</ul>
<h3 id="15-secure-boot-在不同平台的状态"><a class="header" href="#15-secure-boot-在不同平台的状态">1.5 Secure Boot 在不同平台的状态</a></h3>
<div class="table-wrapper"><table><thead><tr><th>平台</th><th>默认证书</th><th>签名流程</th></tr></thead><tbody>
<tr><td>Windows</td><td>Microsoft PK/KEK/DB</td><td>可使用自定义证书</td></tr>
<tr><td>Linux 发行版</td><td>shim + Microsoft KEK (兼容)</td><td>支持注册 MOK</td></tr>
<tr><td>虚拟化（OVMF）</td><td>可加载自定义 PK/KEK/DB</td><td>OVMF 提供变量存储</td></tr>
<tr><td>云平台</td><td>提供预装证书（Azure/AWS/GCP）</td><td>需符合供应商要求</td></tr>
</tbody></table>
</div>
<h3 id="16-安全保证与限制"><a class="header" href="#16-安全保证与限制">1.6 安全保证与限制</a></h3>
<ul>
<li>防止 Bootkit/Rootkit；</li>
<li>需配合内核模块签名、驱动签名；</li>
<li>不防止内核漏洞、用户态攻击；</li>
<li>需要维护证书更新/撤销（应对 CVE）；</li>
<li>虚拟化场景需考虑各租户密钥策略。</li>
</ul>
<h3 id="17-学习重点与易错点"><a class="header" href="#17-学习重点与易错点">1.7 学习重点与易错点</a></h3>
<ul>
<li><strong>重点</strong>：密钥层级、启动链、shim+MOK；</li>
<li><strong>易错点</strong>：
<ol>
<li>修改密钥导致系统无法启动；</li>
<li>忽略 DBX 更新，无法撤销存在漏洞的引导程序；</li>
<li>混淆 shim/MOK 与 Secure Boot 关系；</li>
<li>未签名内核/驱动；</li>
<li>虚拟机未加载 OVMF Secure Boot 固件；</li>
<li>镜像未包含 shim/签名引导程序。</li>
</ol>
</li>
</ul>
<h3 id="18-参考文档"><a class="header" href="#18-参考文档">1.8 参考文档</a></h3>
<ul>
<li>UEFI Specification Secure Boot 章节；</li>
<li>Microsoft Secure Boot Guidelines；</li>
<li>Red Hat Security Guide；</li>
<li>https://github.com/rhboot/shim。</li>
</ul>
<hr />
<h2 id="模块二密钥管理与签名实践"><a class="header" href="#模块二密钥管理与签名实践">模块二：密钥管理与签名实践</a></h2>
<h3 id="21-密钥生成"><a class="header" href="#21-密钥生成">2.1 密钥生成</a></h3>
<ul>
<li>使用 <code>openssl</code> 创建 PK/KEK/DB/DBX：
<pre><code class="language-bash">openssl req -new -x509 -newkey rsa:2048 -subj "/CN=Platform Key/" -keyout PK.key -out PK.crt -days 3650 -sha256
openssl x509 -in PK.crt -outform DER -out PK.cer
</code></pre>
</li>
<li>类似生成 KEK/DB/DBX，建议 2048/3072 位密钥；</li>
<li>使用离线环境或 HSM 保存私钥。</li>
</ul>
<h3 id="22-签名工具"><a class="header" href="#22-签名工具">2.2 签名工具</a></h3>
<ul>
<li><code>sbsigntool</code>: <code>sbsign --key DB.key --cert DB.crt file.efi</code>；</li>
<li><code>pesign</code>：可签署 PE/COFF；</li>
<li><code>sbverify</code>：检验签名；</li>
<li><code>mokutil</code>：管理 Machine Owner Key；</li>
<li>Windows 平台可使用 <code>signtool</code>。</li>
</ul>
<h3 id="23-管理-uefi-变量"><a class="header" href="#23-管理-uefi-变量">2.3 管理 UEFI 变量</a></h3>
<ul>
<li>BIOS 设置或 UEFI Shell (<code>KeyTool.efi</code>) 导入证书；</li>
<li>Linux 中 <code>/sys/firmware/efi/efivars</code> 访问变量；</li>
<li>OVMF 使用 <code>OVMF_VARS.fd</code> 存储变量，每个 VM 需独立副本；</li>
<li><code>efibootmgr</code> 管理 Boot Entry。</li>
</ul>
<h3 id="24-证书轮换流程"><a class="header" href="#24-证书轮换流程">2.4 证书轮换流程</a></h3>
<ul>
<li>更新 PK：需当前 PK 私钥及物理访问；</li>
<li>更新 KEK/DB/DBX：通过签署更新包；</li>
<li>记录证书有效期、计划更新；</li>
<li>遇到 shim/bootloader CVE 时更新 DBX 阻止旧版本。</li>
</ul>
<h3 id="25-操作系统与驱动签名"><a class="header" href="#25-操作系统与驱动签名">2.5 操作系统与驱动签名</a></h3>
<ul>
<li>Linux：签名 shim/grub/内核 (<code>sbsign</code>, <code>kmodsign</code>)，使用 MOK 注册；</li>
<li>Windows：需 WHQL 或 cross-sign；</li>
<li>虚拟化驱动（VirtIO）需官方签名保障加载；</li>
<li>模块签名配合 <code>modprobe</code> 策略。</li>
</ul>
<h3 id="26-自定义证书策略"><a class="header" href="#26-自定义证书策略">2.6 自定义证书策略</a></h3>
<ul>
<li>企业自签证书控制启动链；</li>
<li>在所有硬件/VM 中导入 PK/KEK/DB；</li>
<li>适用于高安全环境、离线环境；</li>
<li>记录证书指纹，纳入 CMDB。</li>
</ul>
<h3 id="27-密钥安全策略"><a class="header" href="#27-密钥安全策略">2.7 密钥安全策略</a></h3>
<ul>
<li>密钥存储与访问控制，使用 HSM/Vault；</li>
<li>角色分离：PK 管理、镜像签名人员；</li>
<li>审计密钥使用与变更；</li>
<li>定期验证证书有效性。</li>
</ul>
<h3 id="28-实践练习"><a class="header" href="#28-实践练习">2.8 实践练习</a></h3>
<ul>
<li>生成 PK/KEK/DB 并导入 OVMF；</li>
<li>使用 sbsign 签名 grub/内核；</li>
<li>mokutil 导入/删除 MOK；</li>
<li>编写证书轮换文档；</li>
<li>记录整个操作日志。</li>
</ul>
<hr />
<h2 id="模块三物理服务器与虚拟化平台配置"><a class="header" href="#模块三物理服务器与虚拟化平台配置">模块三：物理服务器与虚拟化平台配置</a></h2>
<h3 id="31-物理服务器-biosuefi"><a class="header" href="#31-物理服务器-biosuefi">3.1 物理服务器 BIOS/UEFI</a></h3>
<ul>
<li>启用 Secure Boot（Setup Mode -&gt; Enroll Keys -&gt; User Mode）；</li>
<li>备份出厂证书，导入自定义证书；</li>
<li>记录 BIOS 版本、配置快照；</li>
<li>支持的厂商：Dell iDRAC、HPE iLO、Lenovo XClarity 等提供远程管理。</li>
</ul>
<h3 id="32-ovmf-虚拟固件"><a class="header" href="#32-ovmf-虚拟固件">3.2 OVMF 虚拟固件</a></h3>
<ul>
<li>选择带 Secure Boot 的 OVMF（例如 <code>/usr/share/OVMF/OVMF_CODE.secboot.fd</code>）；</li>
<li>为每个 VM 复制 VARS 文件：<code>cp /usr/share/OVMF/OVMF_VARS.fd /var/lib/libvirt/qemu/nvram/vm_VARS.fd</code>；</li>
<li>libvirt XML 示例：
<pre><code class="language-xml">&lt;os&gt;
  &lt;type arch='x86_64' machine='pc-q35-7.2'&gt;hvm&lt;/type&gt;
  &lt;loader readonly='yes' secure='yes' type='pflash'&gt;/usr/share/OVMF/OVMF_CODE.secboot.fd&lt;/loader&gt;
  &lt;nvram&gt;/var/lib/libvirt/qemu/nvram/vm_VARS.fd&lt;/nvram&gt;
&lt;/os&gt;
&lt;features&gt;
  &lt;secureboot state='on'/&gt;
&lt;/features&gt;
</code></pre>
</li>
<li>QEMU CLI：
<pre><code class="language-bash">qemu-system-x86_64 -enable-kvm \
  -drive if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE.secboot.fd \
  -drive if=pflash,format=raw,file=/var/lib/libvirt/qemu/nvram/test_VARS.fd \
  ...
</code></pre>
</li>
</ul>
<h3 id="33-libvirtvirt-manager"><a class="header" href="#33-libvirtvirt-manager">3.3 libvirt/virt-manager</a></h3>
<ul>
<li>virt-manager → “Overview” → Firmware 选择 “UEFI x86_64: SecureBoot”；</li>
<li>确保 <code>OVMF_CODE.secboot.fd</code> 和 <code>OVMF_VARS.fd</code> 权限正确；</li>
<li>迁移/备份时同步 VARS 文件；</li>
<li>与 <code>swtpm</code> 结合提供 vTPM。</li>
</ul>
<h3 id="34-vmware--hyper-v"><a class="header" href="#34-vmware--hyper-v">3.4 VMware / Hyper-V</a></h3>
<ul>
<li>VMware ESXi：VM 选项 → 引导选项 → 勾选 “Enable Secure Boot”；</li>
<li>Hyper-V：Generation 2 VM 默认支持 Secure Boot，<code>Set-VMFirmware -EnableSecureBoot On</code>；</li>
<li>Linux 发行版需使用支持 Secure Boot 的 shim；</li>
<li>记录平台证书与镜像要求。</li>
</ul>
<h3 id="35-其他平台"><a class="header" href="#35-其他平台">3.5 其他平台</a></h3>
<ul>
<li>Proxmox VE：启用 <code>EFI (special)</code> + Secure Boot；</li>
<li>oVirt/RHV：模板中勾选 Secure Boot；</li>
<li>XenServer：使用 UEFI 引导并启用 SB；</li>
<li>所有平台需准备相同版本 OVMF 固件。</li>
</ul>
<h3 id="36-验证步骤"><a class="header" href="#36-验证步骤">3.6 验证步骤</a></h3>
<ul>
<li>Linux：<code>mokutil --sb-state</code>；</li>
<li>Windows：<code>Confirm-SecureBootUEFI</code> PowerShell；</li>
<li>测试未签名二进制被拒绝加载；</li>
<li>检查 <code>journalctl -b | grep -i secureboot</code>。</li>
</ul>
<h3 id="37-迁移与备份注意"><a class="header" href="#37-迁移与备份注意">3.7 迁移与备份注意</a></h3>
<ul>
<li>迁移 VM 时同步 VARS 文件；</li>
<li>备份/恢复 VARS 以防损坏；</li>
<li>集群中保持 OVMF 版本一致。</li>
</ul>
<h3 id="38-实践练习"><a class="header" href="#38-实践练习">3.8 实践练习</a></h3>
<ul>
<li>在 KVM/libvirt 中配置 Secure Boot + 自定义证书；</li>
<li>在 VMware/Hyper-V 中创建启用 Secure Boot 的 VM；</li>
<li>验证未签名程序被拦截；</li>
<li>记录 BIOS/固件参数与验证结果。</li>
</ul>
<hr />
<h2 id="模块四云平台与自动化集成"><a class="header" href="#模块四云平台与自动化集成">模块四：云平台与自动化集成</a></h2>
<h3 id="41-openstack-nova"><a class="header" href="#41-openstack-nova">4.1 OpenStack Nova</a></h3>
<ul>
<li>Flavor extra specs：
<ul>
<li>`os:
*** End Patch</li>
</ul>
</li>
</ul>
<h3 id="36-验证步骤-1"><a class="header" href="#36-验证步骤-1">3.6 验证步骤</a></h3>
<ul>
<li>Linux：<code>mokutil --sb-state</code>；</li>
<li>Windows：PowerShell <code>Confirm-SecureBootUEFI</code>；</li>
<li>测试未签名 EFI 程序应被拒绝；</li>
<li>检查 <code>journalctl -b | grep -i secureboot</code> 或 Windows Event Viewer。</li>
</ul>
<h3 id="37-迁移与备份注意-1"><a class="header" href="#37-迁移与备份注意-1">3.7 迁移与备份注意</a></h3>
<ul>
<li>迁移 VM 时同步 VARS 文件；</li>
<li>备份/恢复 VARS 以防损坏；</li>
<li>集群内保持 OVMF 版本一致，避免兼容性问题。</li>
</ul>
<h3 id="38-实践练习-1"><a class="header" href="#38-实践练习-1">3.8 实践练习</a></h3>
<ul>
<li>在 KVM/libvirt 中启用 Secure Boot 并验证；</li>
<li>在 VMware/Hyper-V 中部署启用 Secure Boot 的虚拟机；</li>
<li>测试签名/未签名引导程序的差异；</li>
<li>记录参数、截图与验证结果。</li>
</ul>
<hr />
<h2 id="模块四云平台与自动化集成-1"><a class="header" href="#模块四云平台与自动化集成-1">模块四：云平台与自动化集成</a></h2>
<h3 id="41-openstack-nova-1"><a class="header" href="#41-openstack-nova-1">4.1 OpenStack Nova</a></h3>
<ul>
<li>Flavor extra specs：<code>hw:firmware_type=uefi</code>、<code>os_secure_boot=required</code>、<code>hw_machine_type=q35</code>；</li>
<li>Glance 镜像属性：<code>hw_firmware_type=uefi</code>、<code>hw_secure_boot=True</code>；</li>
<li>计算节点安装 OVMF Secure Boot 固件；</li>
<li>利用 Heat/Terraform 模板自动化部署；</li>
<li>验证 nova-compute 日志与实例控制台输出。</li>
</ul>
<h3 id="42-kubevirt--harvester"><a class="header" href="#42-kubevirt--harvester">4.2 KubeVirt / Harvester</a></h3>
<ul>
<li>VirtualMachine YAML 示例：
<pre><code class="language-yaml">spec:
  template:
    spec:
      domain:
        firmware:
          bootloader:
            efi:
              secureBoot: true
</code></pre>
</li>
<li>镜像需包含 shim/grub 签名；</li>
<li>与 Longhorn/Ceph 存储结合，保留 VARS snapshot；</li>
<li>CICD 自动签名镜像并上传 DataVolume。</li>
</ul>
<h3 id="43-公有云平台"><a class="header" href="#43-公有云平台">4.3 公有云平台</a></h3>
<ul>
<li><strong>Azure</strong>：Generation 2 VM 默认 Secure Boot，需符合 Azure 镜像签名规范；</li>
<li><strong>AWS</strong>：Nitro 实例支持 Secure Boot，启用 <code>--hibernation-options Configured=true</code>?（根据实例类型），AMI 必须兼容 UEFI；</li>
<li><strong>GCP</strong>：Shielded VM 启用 Secure Boot + vTPM，通过 gcloud 设置 <code>--shielded-secure-boot</code>；</li>
<li>了解各平台 CLI/API 操作与限制。</li>
</ul>
<h3 id="44-镜像签名流水线"><a class="header" href="#44-镜像签名流水线">4.4 镜像签名流水线</a></h3>
<ul>
<li>流程：构建镜像 → 签名 shim/grub/kernel → <code>sbverify</code> 验证 → 生成 metadata（证书指纹、SHA256） → 发布；</li>
<li>使用 Jenkins/GitLab CI：
<pre><code class="language-yaml">script:
  - sbsign --key $SB_KEY --cert $SB_CERT EFI/BOOT/grubx64.efi
  - sbverify --cert $SB_CERT EFI/BOOT/grubx64.efi
</code></pre>
</li>
<li>将证书与镜像版本记录在 CMDB。</li>
</ul>
<h3 id="45-自动化测试"><a class="header" href="#45-自动化测试">4.5 自动化测试</a></h3>
<ul>
<li>利用 cloud-init 在启动后执行 <code>mokutil --sb-state</code> 并回传结果；</li>
<li>失败时触发报警；</li>
<li>结合 Terraform + Ansible 实现一键部署与验证。</li>
</ul>
<h3 id="46-合规与审计"><a class="header" href="#46-合规与审计">4.6 合规与审计</a></h3>
<ul>
<li>记录证书版本、生效期、轮换计划；</li>
<li>审计 UEFI 变量变更、签名操作日志；</li>
<li>符合 CIS、PCI-DSS 等要求；</li>
<li>监控 shim/bootloader CVE，与 DBX 更新同步。</li>
</ul>
<h3 id="47-实践练习"><a class="header" href="#47-实践练习">4.7 实践练习</a></h3>
<ul>
<li>在 OpenStack 与 KubeVirt 环境完成 Secure Boot 部署；</li>
<li>构建签名镜像流水线并输出报告；</li>
<li>将 Secure Boot 验证纳入 CI/CD；</li>
<li>整理操作日志与结果。</li>
</ul>
<hr />
<h2 id="模块五故障诊断安全治理与最佳实践"><a class="header" href="#模块五故障诊断安全治理与最佳实践">模块五：故障诊断、安全治理与最佳实践</a></h2>
<h3 id="51-常见问题与排查"><a class="header" href="#51-常见问题与排查">5.1 常见问题与排查</a></h3>
<div class="table-wrapper"><table><thead><tr><th>问题</th><th>现象</th><th>排查</th><th>解决</th></tr></thead><tbody>
<tr><td><code>Security Violation</code></td><td>引导被拒绝</td><td>检查 shim/grub 签名</td><td>重新签名或导入证书</td></tr>
<tr><td>进入 Setup Mode</td><td>PK/KEK 丢失</td><td>查看 UEFI 变量</td><td>重新导入 PK/KEK</td></tr>
<tr><td>新内核无法启动</td><td>内核未签名</td><td><code>dmesg</code> 查看 lockdown 日志</td><td>签名内核或注册 MOK</td></tr>
<tr><td>驱动加载失败</td><td>驱动未签名</td><td>Windows Event Viewer</td><td>获取签名驱动</td></tr>
<tr><td>迁移后启动失败</td><td>VARS 不匹配</td><td>检查 nvram 文件</td><td>同步 VARS</td></tr>
<tr><td>证书过期</td><td>启动警告</td><td>检查证书有效期</td><td>更新证书</td></tr>
<tr><td>DBX 更新导致旧镜像失败</td><td>DBX 含撤销证书</td><td>查看 DBX 变更</td><td>升级镜像或重新签名</td></tr>
</tbody></table>
</div>
<h3 id="52-排查流程"><a class="header" href="#52-排查流程">5.2 排查流程</a></h3>
<ol>
<li>收集 BIOS/UEFI 控制台日志、<code>mokutil --sb-state</code> 输出；</li>
<li>使用 <code>sbverify</code> 检查 EFI 文件签名；</li>
<li>查看 <code>journalctl -b</code> 或 Event Viewer；</li>
<li>确认 VARS 文件完整；</li>
<li>如需临时恢复，可禁用 Secure Boot 或恢复旧证书；</li>
<li>记录问题与措施，形成 RCA。</li>
</ol>
<h3 id="53-安全治理"><a class="header" href="#53-安全治理">5.3 安全治理</a></h3>
<ul>
<li>密钥管理与访问控制；</li>
<li>证书轮换策略；</li>
<li>DBX 更新流程；</li>
<li>与 vTPM、Measured Boot、内核 lockdown 联动；</li>
<li>记录并审计所有签名与证书操作。</li>
</ul>
<h3 id="54-最佳实践清单"><a class="header" href="#54-最佳实践清单">5.4 最佳实践清单</a></h3>
<ul>
<li>统一规划密钥体系，保留备份；</li>
<li>将镜像签名流程自动化；</li>
<li>在虚拟化平台中使用官方 Secure Boot 固件；</li>
<li>定期验证镜像、清理未签名组件；</li>
<li>构建回滚方案（保留旧证书、镜像）；</li>
<li>培训运维人员，建立文档与 SOP。</li>
</ul>
<h3 id="55-自动化脚本示例"><a class="header" href="#55-自动化脚本示例">5.5 自动化脚本示例</a></h3>
<pre><code class="language-bash">#!/bin/bash
EFI=$1
CERT=$2
if ! sbverify --cert "$CERT" "$EFI" &gt;/dev/null; then
  echo "[FAIL] $EFI verification failed"
  exit 1
fi
echo "[PASS] $EFI is signed by expected certificate"
</code></pre>
<ul>
<li>可在 CI 流水线中对 shim/grub/内核进行验证。</li>
</ul>
<h3 id="56-实践练习"><a class="header" href="#56-实践练习">5.6 实践练习</a></h3>
<ul>
<li>模拟证书过期并更新；</li>
<li>恢复因 DBX 更新导致的启动失败；</li>
<li>建立审计与告警机制；</li>
<li>输出故障排查案例。</li>
</ul>
<hr />
<h2 id="模块六学习路径实战案例与验证标准"><a class="header" href="#模块六学习路径实战案例与验证标准">模块六：学习路径、实战案例与验证标准</a></h2>
<h3 id="61-学习路径"><a class="header" href="#61-学习路径">6.1 学习路径</a></h3>
<div class="table-wrapper"><table><thead><tr><th>阶段</th><th>时间</th><th>目标</th><th>行动</th><th>产出</th></tr></thead><tbody>
<tr><td>阶段 0：准备</td><td>1 天</td><td>了解原理，搭建实验环境</td><td>阅读文档、准备支持 UEFI 的 VM</td><td>环境记录</td></tr>
<tr><td>阶段 1：基础实践</td><td>3 天</td><td>密钥生成、签名、导入验证</td><td>完成模块二、三练习</td><td>操作手册</td></tr>
<tr><td>阶段 2：平台集成</td><td>4 天</td><td>在 libvirt/OpenStack/KubeVirt 启用 Secure Boot</td><td>实验报告</td><td>平台指南</td></tr>
<tr><td>阶段 3：自动化</td><td>4 天</td><td>构建签名流水线、验证脚本</td><td>脚本仓库、CI 配置</td><td>自动化文档</td></tr>
<tr><td>阶段 4：安全治理</td><td>5 天</td><td>故障排查、证书轮换、审计</td><td>SOP、RCA、审计记录</td><td>安全策略</td></tr>
<tr><td>阶段 5：推广沉淀</td><td>持续</td><td>培训、评审、知识库</td><td>分享材料、优化计划</td><td>知识库</td></tr>
</tbody></table>
</div>
<h3 id="62-实战案例"><a class="header" href="#62-实战案例">6.2 实战案例</a></h3>
<ul>
<li><strong>案例一：企业自签 Secure Boot 镜像平台</strong>：使用 HSM 生成密钥，Packer+CI 签名镜像，OpenStack 部署验证；</li>
<li><strong>案例二：多租户云 Secure Boot 支持</strong>：KubeVirt/Harvester 提供启用 SB 的模板，自助注册 MOK，设置监控与审计；</li>
<li><strong>案例三：DBX 更新应急演练</strong>：模拟 shim CVE，更新 DBX 并验证旧镜像被阻止，制定回滚策略；</li>
<li><strong>案例四：证书轮换自动化</strong>：脚本化更新 PK/KEK/DB，记录 CMDB，自动化验证；</li>
<li><strong>案例五：安全检测</strong>：定期扫描镜像签名状态，输出合规报告。</li>
</ul>
<h3 id="63-学习成果验证标准"><a class="header" href="#63-学习成果验证标准">6.3 学习成果验证标准</a></h3>
<ol>
<li>完成密钥生成、导入、镜像签名与验证；</li>
<li>在至少两种平台成功启用 Secure Boot 并验证；</li>
<li>交付签名流水线或脚本；</li>
<li>制定证书轮换与审计策略；</li>
<li>完成 ≥2 种故障演练并形成 RCA；</li>
<li>沉淀操作手册、FAQ、知识库；</li>
<li>分享成果并通过团队评审；</li>
<li>制定 Secure Boot 安全优化路线图。</li>
</ol>
<h3 id="64-扩展资源与进阶建议"><a class="header" href="#64-扩展资源与进阶建议">6.4 扩展资源与进阶建议</a></h3>
<ul>
<li>官方文档：UEFI Spec、Microsoft Secure Boot、Red Hat Security Guide；</li>
<li>工具：<code>sbsigntool</code>, <code>shim</code>, <code>efitools</code>, <code>swtpm</code>；</li>
<li>社区：shim mailing list、linux-efi、OpenStack-discuss；</li>
<li>进阶建议：
<ol>
<li>研究 Measured Boot、TPM PCR、远程验证；</li>
<li>与软件供应链安全（签名、SBOM）结合；</li>
<li>自动化证书轮换与镜像再签名；</li>
<li>关注 shim/bootloader CVE 并及时响应；</li>
<li>参与社区贡献或文档翻译。</li>
</ol>
</li>
</ul>
<hr />
<h2 id="附录"><a class="header" href="#附录">附录</a></h2>
<h3 id="a-常用命令速查"><a class="header" href="#a-常用命令速查">A. 常用命令速查</a></h3>
<pre><code class="language-bash">mokutil --sb-state
mokutil --list-enrolled
sbsign --key DB.key --cert DB.crt grubx64.efi
sbverify --cert DB.crt grubx64.efi
pesign --sign --cert DB.pem --key DB.key --output shim-signed.efi shim.efi
openssl x509 -in PK.crt -text -noout
</code></pre>
<h3 id="b-参考文件路径"><a class="header" href="#b-参考文件路径">B. 参考文件路径</a></h3>
<ul>
<li><code>/usr/share/OVMF/OVMF_CODE.secboot.fd</code></li>
<li><code>/usr/share/OVMF/OVMF_VARS.fd</code></li>
<li><code>/var/lib/libvirt/qemu/nvram/*_VARS.fd</code></li>
<li><code>/sys/firmware/efi/efivars</code></li>
<li><code>/usr/share/EFI/</code>（shim、grub）</li>
</ul>
<h3 id="c-审计规则示例"><a class="header" href="#c-审计规则示例">C. 审计规则示例</a></h3>
<pre><code class="language-bash">auditctl -w /sys/firmware/efi/efivars -p w -k secureboot-vars
auditctl -w /usr/bin/sbsign -p x -k secureboot-sign
ausearch -k secureboot-vars | aureport -f
</code></pre>
<h3 id="d-故障记录模板"><a class="header" href="#d-故障记录模板">D. 故障记录模板</a></h3>
<pre><code>事件编号：SB-2024-08
时间：2024-08-12 09:30
环境：OpenStack + OVMF Secure Boot
现象：实例启动失败，报错 Security Violation
排查：
1. 控制台输出确认 Secure Boot 拒绝
2. 检查镜像，发现 grubx64.efi 未签名
3. 使用 sbsign 重新签名 grubx64.efi
4. 更新镜像后启动成功
预防：
- 将签名流程纳入 CI
- 在镜像上传前执行 sbverify
</code></pre>
<blockquote>
<p>Secure Boot 是保障虚拟化与云平台启动链安全的重要机制。深入理解密钥管理、签名流程及平台配置，结合自动化与监控治理，可显著提升企业的安全基线与合规水平。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/云计算/qemu.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/云计算/sev.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/云计算/qemu.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/云计算/sev.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

