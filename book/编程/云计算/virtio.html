<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Virtio 虚拟设备学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="virtio-虚拟设备学习笔记"><a class="header" href="#virtio-虚拟设备学习笔记">Virtio 虚拟设备学习笔记</a></h1>
<blockquote>
<p>面向 0-5 年经验的虚拟化、云平台工程师，系统掌握 Virtio 架构、驱动、设备类型、性能调优与实践场景。</p>
</blockquote>
<hr />
<h2 id="学习定位与总体目标"><a class="header" href="#学习定位与总体目标">学习定位与总体目标</a></h2>
<ul>
<li><strong>学习者画像</strong>：部署 KVM/libvirt、OpenStack、KubeVirt、云桌面等平台，需要优化虚拟设备性能。</li>
<li><strong>技术定位</strong>：Virtio 是半虚拟化设备标准，通过 Virtqueue/Ring Buffer 提供高性能 I/O。常见设备包括 virtio-net、virtio-blk、virtio-scsi、virtio-gpu、virtio-fs、virtio-rng 等。</li>
<li><strong>学习目标</strong>：
<ol>
<li>理解 Virtio 架构、特性、队列机制；</li>
<li>掌握不同 Virtio 设备的使用场景、优缺点；</li>
<li>熟悉 QEMU/libvirt 配置、驱动安装、性能调优；</li>
<li>与 SR-IOV、vhost、DPDK、vGPU 等集成；</li>
<li>故障排查、安全策略、自动化部署。</li>
</ol>
</li>
<li><strong>成果要求</strong>：
<ul>
<li>配置多种 Virtio 设备并验证性能；</li>
<li>编写调优脚本、监控与故障排查文档；</li>
<li>形成知识库与培训材料。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="核心模块结构"><a class="header" href="#核心模块结构">核心模块结构</a></h2>
<ol>
<li><strong>模块一：Virtio 架构与原理</strong> —— Virtqueue、Rings、Feature 协商。</li>
<li><strong>模块二：常用 Virtio 设备类型与配置</strong> —— 网络、块存储、SCSI、GPU、FS、RNG、Balloon。</li>
<li><strong>模块三：性能优化、vhost 与 DPDK 集成</strong> —— vhost-net/vhost-user、Multi-queue、HugePages、NUMA。</li>
<li><strong>模块四：平台集成与自动化</strong> —— libvirt XML、OpenStack/KubeVirt、cloud-init、Ansible。</li>
<li><strong>模块五：故障排查、安全治理与最佳实践</strong> —— 日志、驱动、兼容性、安全策略。</li>
<li><strong>模块六：学习路径、实战案例与验证标准</strong> —— 计划、案例、成果评估、资源。</li>
</ol>
<hr />
<h2 id="模块一virtio-架构"><a class="header" href="#模块一virtio-架构">模块一：Virtio 架构</a></h2>
<h3 id="11-virtqueue"><a class="header" href="#11-virtqueue">1.1 Virtqueue</a></h3>
<ul>
<li>Virtio 通过共享内存队列（descriptor ring）进行 I/O；</li>
<li>Guest 与 Host 经由驱动/设备协同；</li>
<li>支持 split queue 与 packed queue。</li>
</ul>
<h3 id="12-feature-协商"><a class="header" href="#12-feature-协商">1.2 Feature 协商</a></h3>
<ul>
<li>Driver 与 device 交换 feature bits；</li>
<li>只启用双方支持的功能（多队列、checksum offload）。</li>
</ul>
<h3 id="13-transport"><a class="header" href="#13-transport">1.3 Transport</a></h3>
<ul>
<li>PCI、MMIO、Channel I/O；</li>
<li>Virtio PCI 常见，支持 MSI/MSI-X。</li>
</ul>
<h3 id="14-学习重点"><a class="header" href="#14-学习重点">1.4 学习重点</a></h3>
<ul>
<li>队列结构、feature 协商、设备驱动、vhost 加速。</li>
</ul>
<hr />
<h2 id="模块二virtio-设备类型"><a class="header" href="#模块二virtio-设备类型">模块二：Virtio 设备类型</a></h2>
<h3 id="21-virtio-net"><a class="header" href="#21-virtio-net">2.1 virtio-net</a></h3>
<pre><code class="language-xml">&lt;interface type='network'&gt;
  &lt;model type='virtio'/&gt;
  &lt;driver name='vhost' queues='4'/&gt;
&lt;/interface&gt;
</code></pre>
<ul>
<li>多队列、TSO、checksum offload；</li>
<li>Guest 驱动 <code>virtio_net</code>。</li>
</ul>
<h3 id="22-virtio-blk"><a class="header" href="#22-virtio-blk">2.2 virtio-blk</a></h3>
<ul>
<li>简单块设备，IOPS 高；</li>
<li>QEMU <code>-drive if=virtio</code>;</li>
<li>不支持 SCSI 命令。</li>
</ul>
<h3 id="23-virtio-scsi"><a class="header" href="#23-virtio-scsi">2.3 virtio-scsi</a></h3>
<ul>
<li>支持 SCSI、热插拔；</li>
<li><code>&lt;controller type='scsi' model='virtio-scsi'/&gt;</code>；</li>
<li>驱动 <code>virtio_scsi</code>。</li>
</ul>
<h3 id="24-virtio-gpu"><a class="header" href="#24-virtio-gpu">2.4 virtio-gpu</a></h3>
<ul>
<li>图形输出，支持 virgl；</li>
<li><code>&lt;video&gt;&lt;model type='virtio' heads='2'/&gt;&lt;/video&gt;</code>。</li>
</ul>
<h3 id="25-virtio-fs"><a class="header" href="#25-virtio-fs">2.5 virtio-fs</a></h3>
<ul>
<li>高性能共享文件系统；</li>
<li><code>virtiofsd</code> + <code>&lt;filesystem type='mount' accessmode='passthrough'&gt;</code>。</li>
</ul>
<h3 id="26-其他"><a class="header" href="#26-其他">2.6 其他</a></h3>
<ul>
<li>virtio-rng、virtio-balloon、virtio-serial、virtio-vsock。</li>
</ul>
<h3 id="27-驱动安装"><a class="header" href="#27-驱动安装">2.7 驱动安装</a></h3>
<ul>
<li>Linux 内置；</li>
<li>Windows 使用 <code>virtio-win</code>。</li>
</ul>
<h3 id="28-实践"><a class="header" href="#28-实践">2.8 实践</a></h3>
<ul>
<li>比较 virtio vs emulated 设备；</li>
<li>热插拔磁盘；</li>
<li>配置 virtio-fs。</li>
</ul>
<hr />
<h2 id="模块三性能优化"><a class="header" href="#模块三性能优化">模块三：性能优化</a></h2>
<h3 id="31-vhost"><a class="header" href="#31-vhost">3.1 vhost</a></h3>
<ul>
<li>vhost-net 内核加速；</li>
<li>vhost-user -&gt; DPDK/OVS；</li>
<li><code>&lt;driver name='vhost' queues='8'/&gt;</code>。</li>
</ul>
<h3 id="32-多队列"><a class="header" href="#32-多队列">3.2 多队列</a></h3>
<ul>
<li>virtio-net：<code>ethtool -L ens3 combined 4</code>；</li>
<li>Guest 需支持 RSS。</li>
</ul>
<h3 id="33-packed-queue"><a class="header" href="#33-packed-queue">3.3 Packed Queue</a></h3>
<ul>
<li>QEMU 5+，<code>virtio-net-pci,packed=on</code>；</li>
<li>Guest 驱动支持。</li>
</ul>
<h3 id="34-numahugepages"><a class="header" href="#34-numahugepages">3.4 NUMA/HugePages</a></h3>
<ul>
<li>对齐 CPU/内存；</li>
<li>使用 HugePages 减少 TLB。</li>
</ul>
<h3 id="35-dpdk-集成"><a class="header" href="#35-dpdk-集成">3.5 DPDK 集成</a></h3>
<ul>
<li><code>--vdev=net_virtio_user0</code>；</li>
<li>适合 NFV。</li>
</ul>
<hr />
<h2 id="模块四平台集成"><a class="header" href="#模块四平台集成">模块四：平台集成</a></h2>
<h3 id="41-libvirt"><a class="header" href="#41-libvirt">4.1 libvirt</a></h3>
<ul>
<li><code>&lt;disk bus='virtio'&gt;</code>、<code>&lt;interface model='virtio'&gt;</code>；</li>
<li><code>&lt;filesystem type='mount'&gt;</code> virtio-fs。</li>
</ul>
<h3 id="42-openstack"><a class="header" href="#42-openstack">4.2 OpenStack</a></h3>
<ul>
<li>镜像属性 <code>hw_vif_model=virtio</code>, <code>hw_disk_bus=scsi</code>；</li>
<li>Flavor <code>hw:mem_page_size</code>。</li>
</ul>
<h3 id="43-kubevirt"><a class="header" href="#43-kubevirt">4.3 KubeVirt</a></h3>
<ul>
<li><code>spec.domain.devices.interfaces: masquerade</code> (默认 virtio)；</li>
<li>virtio-fs via <code>filesystem</code>。</li>
</ul>
<h3 id="44-windows-镜像"><a class="header" href="#44-windows-镜像">4.4 Windows 镜像</a></h3>
<ul>
<li>注入 <code>virtio-win</code> 驱动；</li>
<li>sysprep 或 cloudbase-init。</li>
</ul>
<h3 id="45-自动化"><a class="header" href="#45-自动化">4.5 自动化</a></h3>
<ul>
<li>Ansible, Terraform, Packer。</li>
</ul>
<hr />
<h2 id="模块五故障排查与安全"><a class="header" href="#模块五故障排查与安全">模块五：故障排查与安全</a></h2>
<h3 id="51-常见问题"><a class="header" href="#51-常见问题">5.1 常见问题</a></h3>
<div class="table-wrapper"><table><thead><tr><th>问题</th><th>排查</th><th>解决</th></tr></thead><tbody>
<tr><td>无驱动</td><td>Windows</td><td>安装 virtio-win</td></tr>
<tr><td>网络慢</td><td>vhost 未启用</td><td><code>&lt;driver name='vhost'&gt;</code></td></tr>
<tr><td>热插拔失败</td><td>使用 virtio-blk</td><td>切换 virtio-scsi</td></tr>
<tr><td>virtio-fs 挂载失败</td><td>virtiofsd 未启动</td><td>启动服务</td></tr>
</tbody></table>
</div>
<h3 id="52-日志"><a class="header" href="#52-日志">5.2 日志</a></h3>
<ul>
<li><code>journalctl</code>, <code>/var/log/libvirt/qemu</code>；</li>
<li>Guest <code>dmesg | grep virtio</code>。</li>
</ul>
<h3 id="53-安全"><a class="header" href="#53-安全">5.3 安全</a></h3>
<ul>
<li>控制 vhost-user socket 权限；</li>
<li>监控 IOMMU 配置；</li>
<li>更新驱动补丁。</li>
</ul>
<h3 id="54-自动化脚本"><a class="header" href="#54-自动化脚本">5.4 自动化脚本</a></h3>
<pre><code class="language-bash">virsh dumpxml $1 | grep -A5 virtio
</code></pre>
<hr />
<h2 id="模块六学习路径与案例"><a class="header" href="#模块六学习路径与案例">模块六：学习路径与案例</a></h2>
<div class="table-wrapper"><table><thead><tr><th>阶段</th><th>时间</th><th>目标</th><th>行动</th><th>产出</th></tr></thead><tbody>
<tr><td>阶段 0</td><td>1 天</td><td>理解架构</td><td>环境记录</td><td></td></tr>
<tr><td>阶段 1</td><td>3 天</td><td>配置设备</td><td>操作手册</td><td></td></tr>
<tr><td>阶段 2</td><td>4 天</td><td>调优</td><td>调优报告</td><td></td></tr>
<tr><td>阶段 3</td><td>4 天</td><td>平台集成</td><td>模板</td><td></td></tr>
<tr><td>阶段 4</td><td>3 天</td><td>故障演练</td><td>SOP</td><td></td></tr>
<tr><td>阶段 5</td><td>持续</td><td>知识库</td><td>文档</td><td></td></tr>
</tbody></table>
</div>
<h3 id="案例"><a class="header" href="#案例">案例</a></h3>
<ul>
<li>NFV 网络优化；</li>
<li>云磁盘性能提升；</li>
<li>KubeVirt virtio-fs；</li>
<li>Windows virtio 驱动注入。</li>
</ul>
<h3 id="验证标准"><a class="header" href="#验证标准">验证标准</a></h3>
<ol>
<li>Virtio 设备正常；</li>
<li>性能指标达标；</li>
<li>脚本运行成功；</li>
<li>故障记录；</li>
<li>安全策略；</li>
<li>知识库。</li>
</ol>
<h3 id="资源"><a class="header" href="#资源">资源</a></h3>
<ul>
<li>Virtio spec；</li>
<li>QEMU/libvirt docs；</li>
<li>DPDK virtio user；</li>
<li>Red Hat guide。</li>
</ul>
<hr />
<h2 id="附录"><a class="header" href="#附录">附录</a></h2>
<h3 id="命令速查"><a class="header" href="#命令速查">命令速查</a></h3>
<pre><code class="language-bash">lsmod | grep virtio
ethtool -S ens3
virsh domiflist vm
virsh domblklist vm
</code></pre>
<h3 id="故障记录模板"><a class="header" href="#故障记录模板">故障记录模板</a></h3>
<pre><code>事件编号：VIRTIO-2024-06
时间：2024-08-08 14:30
现象：virtio-net 吞吐低
排查：
1. ethtool 显示单队列
2. XML 未启用 queues
处理：
1. 更新 &lt;driver queues='4'&gt;
2. 重启后性能提升
预防：
- 模板启用多队列
- 监控队列状态
</code></pre>
<blockquote>
<p>Virtio 为虚拟化提供高性能设备标准。掌握其原理与调优，可满足多种云平台和虚拟化工作负载需求。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/云计算/virsh.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/云计算/vnc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/云计算/virsh.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/云计算/vnc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

