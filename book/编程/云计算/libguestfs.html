<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>libguestfs 虚拟机镜像管理学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="libguestfs-虚拟机镜像管理学习笔记"><a class="header" href="#libguestfs-虚拟机镜像管理学习笔记">libguestfs 虚拟机镜像管理学习笔记</a></h1>
<blockquote>
<p>面向 0-5 年经验的虚拟化、云平台、DevOps、自动化运维工程师，系统掌握 libguestfs 工具链在虚拟机镜像管理、批量定制、运维自动化、故障救援中的应用。</p>
</blockquote>
<hr />
<h2 id="学习定位与总体目标"><a class="header" href="#学习定位与总体目标">学习定位与总体目标</a></h2>
<ul>
<li><strong>学习者画像</strong>：熟悉 Linux 基础、了解 KVM/虚拟化平台使用，负责构建或维护虚拟机镜像、自动化部署、故障排查，是云平台、DevOps、VDI、容器混合环境中的关键角色。</li>
<li><strong>技术定位</strong>：libguestfs 提供一套用户态虚拟化镜像操作工具集合，在不启动虚拟机的情况下直接挂载、修改、检查、备份虚拟磁盘，支持多种格式（QCOW2、RAW、VMDK、VDI 等），为镜像生命周期管理、补丁更新、数据恢复提供高效方案。</li>
<li><strong>学习目标</strong>：
<ol>
<li>理解 libguestfs 架构、工作流程、内部组件（libguestfs library、libvirt、appliance）；</li>
<li>熟悉 guestfish、guestmount、virt-* 系列命令、API（Python、Ruby、Go）；</li>
<li>掌握镜像创建、定制、合并、对比、修复、检测、合规检查的操作场景；</li>
<li>能够设计自动化脚本、CI/CD 流水线，实现大规模镜像管理与快速交付；</li>
<li>建立安全、审计、备份策略，制定故障排查与恢复流程；</li>
<li>打造企业级知识库、培训资料，实现经验沉淀。</li>
</ol>
</li>
<li><strong>成果要求</strong>：
<ul>
<li>构建基础镜像定制和补丁更新自动化流程；</li>
<li>完成镜像一致性检查、文件注入、密码重置、备份还原等操作案例；</li>
<li>制作运行手册、故障排查指南、监控方案；</li>
<li>编写脚本/模块供团队复用，输出性能与安全评估报告。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="核心模块结构"><a class="header" href="#核心模块结构">核心模块结构</a></h2>
<ol>
<li><strong>模块一：libguestfs 原理与生态概览</strong> —— 架构、组件、支持格式、工作流程。</li>
<li><strong>模块二：基础工具与常用命令实践</strong> —— guestfish、guestmount、virt-* 工具族。</li>
<li><strong>模块三：镜像生命周期管理与自动化场景</strong> —— 创建、定制、补丁、备份、比较。</li>
<li><strong>模块四：运维救援与安全合规</strong> —— 密码重置、文件恢复、病毒查杀、合规检查。</li>
<li><strong>模块五：自动化集成、性能优化与监控</strong> —— CI/CD、脚本、API、性能调优、监控。</li>
<li><strong>模块六：故障诊断、学习路径与扩展资源</strong> —— 常见问题、排查模板、学习计划、案例。</li>
</ol>
<hr />
<h2 id="模块一libguestfs-原理与生态概览"><a class="header" href="#模块一libguestfs-原理与生态概览">模块一：libguestfs 原理与生态概览</a></h2>
<h3 id="11-项目背景"><a class="header" href="#11-项目背景">1.1 项目背景</a></h3>
<ul>
<li>由 Red Hat 主导开发，可运行在 Linux 上；</li>
<li>通过用户空间工具控制内置的轻量虚拟机（appliance）访问来宾磁盘；</li>
<li>优势：无须启动来宾 OS，避免安全风险、节省资源；</li>
<li>广泛应用于 RHEL、OpenStack、oVirt、Harvester、Proxmox 等生态。</li>
</ul>
<h3 id="12-架构组成"><a class="header" href="#12-架构组成">1.2 架构组成</a></h3>
<pre><code>┌─────────────────────────────────────────────┐
│               应用 / CLI / API               │
├────────────────────────────┬────────────────┤
│      libguestfs Library     │  virt-* 工具   │
├───────────────┬────────────┴────────────────┤
│     libvirt    │   轻量 appliance (qemu)     │
├───────────────┴─────────────────────────────┤
│              虚拟机磁盘 / 映像               │
└─────────────────────────────────────────────┘
</code></pre>
<ul>
<li><strong>libguestfs 库</strong>：提供 API；</li>
<li><strong>appliance</strong>：以 qcow2 形式存在的最小化虚拟机镜像，启动后挂载目标磁盘；</li>
<li><strong>libvirt</strong>：可选，默认使用 qemu；</li>
<li><strong>工具集</strong>：<code>guestfish</code>, <code>guestmount</code>, <code>virt-resize</code>, <code>virt-sysprep</code>, <code>virt-customize</code> 等。</li>
</ul>
<h3 id="13-支持的磁盘格式"><a class="header" href="#13-支持的磁盘格式">1.3 支持的磁盘格式</a></h3>
<ul>
<li>raw, qcow, qcow2, cow, vmdk, vdi, qed, vhd, vhdx, luks 加密, lvm, btrfs snapshot;</li>
<li>支持多分区、多文件系统（ext4, xfs, btrfs, ntfs, fat, swap）。</li>
</ul>
<h3 id="14-工作流程"><a class="header" href="#14-工作流程">1.4 工作流程</a></h3>
<ol>
<li>启动 appliance，加载必要工具；</li>
<li>将目标磁盘（文件或块设备）映射到 appliance；</li>
<li>在 appliance 内执行文件系统操作（mount, copy, edit）；</li>
<li>退出 appliance，确保写入同步。</li>
</ol>
<h3 id="15-安全性"><a class="header" href="#15-安全性">1.5 安全性</a></h3>
<ul>
<li>默认只读操作，需要显式 <code>--rw</code> 才写入；</li>
<li>操作在隔离环境进行，降低直接在宿主挂载的风险；</li>
<li>支持 LUKS 解密、SELinux context 处理。</li>
</ul>
<h3 id="16-学习重点与易错点"><a class="header" href="#16-学习重点与易错点">1.6 学习重点与易错点</a></h3>
<ul>
<li><strong>重点</strong>：理解 appliance 的作用、虚拟机磁盘操作流程、工具族功能；</li>
<li><strong>易错点</strong>：
<ol>
<li>忘记 <code>--rw</code> 导致修改未保存；</li>
<li>直接对生产镜像操作未备份，风险高；</li>
<li>忽略 SELinux context，导致 VM 启动后权限问题；</li>
<li>未同步镜像（<code>virt-resize</code>、<code>virt-sparsify</code> 操作不完整）；</li>
<li>LUKS 或文件系统密码不匹配导致挂载失败；</li>
<li>未安装 <code>libguestfs-appliance</code> 包导致工具启动失败。</li>
</ol>
</li>
</ul>
<h3 id="17-环境准备"><a class="header" href="#17-环境准备">1.7 环境准备</a></h3>
<ul>
<li>安装：<code>sudo dnf install libguestfs libguestfs-tools-c libvirt qemu-kvm</code>; 或 <code>sudo apt install libguestfs-tools</code>;</li>
<li>特权：普通用户可以使用，但需访问镜像文件 / qemu；</li>
<li>验证：<code>libguestfs-test-tool</code>；</li>
<li>准备测试镜像（<code>virt-builder</code> 或现有 VM 磁盘）。</li>
</ul>
<hr />
<h2 id="模块二基础工具与常用命令实践"><a class="header" href="#模块二基础工具与常用命令实践">模块二：基础工具与常用命令实践</a></h2>
<h3 id="21-guestfish"><a class="header" href="#21-guestfish">2.1 guestfish</a></h3>
<ul>
<li>交互式 shell，可执行文件系统操作；</li>
<li>基本语法：<code>guestfish --ro -a image.qcow2 -i</code>；</li>
<li>常用命令：
<ul>
<li><code>list-devices</code>, <code>list-partitions</code>, <code>mount</code>, <code>ls</code>, <code>edit</code>, <code>copy-in</code>, <code>copy-out</code>, <code>upload</code>, <code>download</code>, <code>touch</code>, <code>mkdir</code>, <code>rm</code>；</li>
<li><code>virt-edit</code>（批量编辑文件）；</li>
<li><code>cat</code>, <code>write</code>, <code>append</code>;</li>
<li><code>sh</code> 执行 appliance shell 命令。</li>
</ul>
</li>
<li>批处理模式：<code>guestfish --rw -a image.qcow2 -i &lt;&lt;'EOF' ... EOF</code>。</li>
</ul>
<h3 id="22-guestmount"><a class="header" href="#22-guestmount">2.2 guestmount</a></h3>
<ul>
<li>将镜像挂载到宿主机目录：
<pre><code class="language-bash">guestmount -a image.qcow2 -i --ro /mnt/guest
</code></pre>
</li>
<li>写入模式：<code>--rw</code>；</li>
<li>适合文件系统浏览、备份、对比；</li>
<li>注意卸载：<code>guestunmount /mnt/guest</code>。</li>
</ul>
<h3 id="23-virt--工具族"><a class="header" href="#23-virt--工具族">2.3 virt-* 工具族</a></h3>
<div class="table-wrapper"><table><thead><tr><th>工具</th><th>功能</th><th>场景</th></tr></thead><tbody>
<tr><td><code>virt-inspector</code></td><td>检查虚拟机操作系统信息</td><td>制作清单、合规检查</td></tr>
<tr><td><code>virt-cat</code>, <code>virt-edit</code></td><td>查看/编辑文件</td><td>修改配置、脚本</td></tr>
<tr><td><code>virt-copy-in/out</code></td><td>拷贝文件</td><td>批量注入配置、备份</td></tr>
<tr><td><code>virt-resize</code></td><td>调整磁盘分区大小</td><td>扩容、缩容</td></tr>
<tr><td><code>virt-df</code></td><td>查看磁盘使用情况</td><td>审计、容量规划</td></tr>
<tr><td><code>virt-sparsify</code></td><td>压缩镜像</td><td>节省存储</td></tr>
<tr><td><code>virt-sysprep</code></td><td>清理系统唯一信息</td><td>模板化</td></tr>
<tr><td><code>virt-customize</code></td><td>定制镜像（安装包、修改配置）</td><td>自动化构建</td></tr>
<tr><td><code>virt-v2v</code></td><td>从 VMware/Hyper-V 迁移</td><td>异构平台迁移</td></tr>
<tr><td><code>virt-p2v</code></td><td>物理机转换</td><td>P2V 迁移</td></tr>
<tr><td><code>virt-builder</code></td><td>快速构建官方模板</td><td>实验镜像</td></tr>
<tr><td><code>virt-ls</code>, <code>virt-findfs</code></td><td>列表文件、查找</td><td>巡检</td></tr>
<tr><td><code>virt-log</code></td><td>查看日志</td><td>排查</td></tr>
</tbody></table>
</div>
<h3 id="24-常用命令示例"><a class="header" href="#24-常用命令示例">2.4 常用命令示例</a></h3>
<pre><code class="language-bash"># 查看镜像操作系统信息
virt-inspector -a image.qcow2 | xmllint --format -

# 复制文件到镜像
virt-copy-in -a image.qcow2 ./nginx.conf /etc/nginx/

# 编辑镜像内文件
virt-edit -a image.qcow2 /etc/default/grub

# 调整磁盘大小
dd if=/dev/zero of=image.qcow2 bs=1G count=10 oflag=append conv=notrunc
virt-resize --expand /dev/sda2 image.qcow2 image-resized.qcow2

# 精简镜像
virt-sparsify image.qcow2 image-slim.qcow2 --compress

# 自定义镜像（安装包、运行脚本）
virt-customize -a base.qcow2 --install nginx --run-command 'systemctl enable nginx'
</code></pre>
<h3 id="25-lvm-与加密支持"><a class="header" href="#25-lvm-与加密支持">2.5 LVM 与加密支持</a></h3>
<ul>
<li><code>virt-lvs</code>, <code>virt-vgks</code> 识别 LVM；</li>
<li><code>--key</code> 选项提供 LUKS 密钥：<code>guestfish --key secret:key:file.key -a encrypted.qcow2</code>；</li>
<li>加密镜像操作需确保密钥安全；</li>
<li>Btrfs 子卷：<code>guestfish</code> 支持 <code>btrfs-subvolume-list</code>。</li>
</ul>
<h3 id="26-windows-镜像支持"><a class="header" href="#26-windows-镜像支持">2.6 Windows 镜像支持</a></h3>
<ul>
<li>需要 <code>ntfs-3g</code>; <code>virt-win-reg</code> 编辑注册表；</li>
<li><code>virt-win-reg --merge</code> 导入 reg 文件；</li>
<li>重置管理员密码：<code>virt-edit</code> 编辑 SAM 或使用 <code>virt-rescue</code> + <code>chntpw</code>；</li>
<li>注意 sysprep、驱动注入。</li>
</ul>
<h3 id="27-virt-rescue"><a class="header" href="#27-virt-rescue">2.7 virt-rescue</a></h3>
<ul>
<li>提供一个救援 shell，直接进入 appliance 进行高级操作；</li>
<li><code>virt-rescue -a image.qcow2</code>；</li>
<li>挂载磁盘后执行 fsck、chroot；</li>
<li>类似 LiveCD 救援模式。</li>
</ul>
<h3 id="28-性能与日志"><a class="header" href="#28-性能与日志">2.8 性能与日志</a></h3>
<ul>
<li><code>LIBGUESTFS_DEBUG=1</code> 开启 debug；</li>
<li><code>LIBGUESTFS_TRACE=1</code> 打印命令；</li>
<li>appliance 镜像位置：<code>/usr/lib64/guestfs/supermin.d</code>；</li>
<li>定制 appliance：<code>supermin</code>。</li>
</ul>
<h3 id="29-练习任务"><a class="header" href="#29-练习任务">2.9 练习任务</a></h3>
<ul>
<li>使用 guestfish 列出镜像内所有用户；</li>
<li>通过 guestmount 挂载镜像并提取日志；</li>
<li>使用 virt-customize 注入 SSH key 与 cloud-init 配置；</li>
<li>使用 virt-sysprep 清理敏感信息，构建模板；</li>
<li>记录所有操作流程与命令。</li>
</ul>
<hr />
<h2 id="模块三镜像生命周期管理与自动化场景"><a class="header" href="#模块三镜像生命周期管理与自动化场景">模块三：镜像生命周期管理与自动化场景</a></h2>
<h3 id="31-镜像创建与定制流程"><a class="header" href="#31-镜像创建与定制流程">3.1 镜像创建与定制流程</a></h3>
<ol>
<li>基础镜像准备：<code>virt-builder</code>/官方 ISO 安装；</li>
<li>使用 <code>virt-sysprep</code> 清理主机名、SSH 指纹、日志；</li>
<li><code>virt-customize</code> 注入软件包、配置、脚本；</li>
<li><code>virt-sparsify</code> 精简；</li>
<li><code>virt-resize</code> 调整分区；</li>
<li>创建快照、上传镜像仓库（Glance, Swift, S3）。</li>
</ol>
<h3 id="32-cloud-init-与自动化安装"><a class="header" href="#32-cloud-init-与自动化安装">3.2 Cloud-init 与自动化安装</a></h3>
<ul>
<li>配合 <code>cloud-localds</code> + <code>virt-customize</code> 设置 cloud-init 模块；</li>
<li><code>virt-customize --touch /etc/cloud/cloud-init.disabled</code> 控制；</li>
<li>适用于 OpenStack、KubeVirt、Harvester、Proxmox 云模板。</li>
</ul>
<h3 id="33-批量补丁与软件更新"><a class="header" href="#33-批量补丁与软件更新">3.3 批量补丁与软件更新</a></h3>
<ul>
<li>结合 Ansible/ssh vs libguestfs：
<ul>
<li>优势：无需启动 VM，即可批量更新（适合离线补丁）；</li>
</ul>
</li>
<li>示例：
<pre><code class="language-bash">virt-customize -a image.qcow2 --update --install securitypatch --run-command 'yum clean all'
</code></pre>
</li>
<li>使用 <code>virt-copy-in/out</code> 注入/提取脚本；</li>
<li>记录版本、生成报告。</li>
</ul>
<h3 id="34-镜像验证与检测"><a class="header" href="#34-镜像验证与检测">3.4 镜像验证与检测</a></h3>
<ul>
<li><code>virt-df</code> 检查磁盘使用；</li>
<li><code>virt-filesystems --all</code> 列出结构；</li>
<li><code>virt-inspector</code> 获取软件包、服务、内核版本；</li>
<li><code>virt-verify</code>?（结合自定义脚本）;</li>
<li>编写 <code>guestfish</code> 脚本检查配置项（selinux、sysctl、用户列表）。</li>
</ul>
<h3 id="35-差异分析与对比"><a class="header" href="#35-差异分析与对比">3.5 差异分析与对比</a></h3>
<ul>
<li><code>virt-ls -lR -a img1.qcow2 /etc &gt; list1.txt</code> vs <code>img2</code>; diff；</li>
<li>将镜像 mount 到 <code>/mnt/guest1</code>, <code>/mnt/guest2</code> 进行 <code>rsync --dry-run</code>;</li>
<li><code>guestfish</code> <code>checksum-device</code> 计算校验；</li>
<li>记录变更日志。</li>
</ul>
<h3 id="36-快照备份与还原"><a class="header" href="#36-快照备份与还原">3.6 快照、备份与还原</a></h3>
<ul>
<li><code>qemu-img snapshot</code> 结合 <code>libguestfs</code>；</li>
<li><code>virt-v2v</code> 迁移时备份；</li>
<li><code>virt-copy-out</code> 全量备份；</li>
<li><code>guestfish</code> + LVM snapshot -&gt; offline backup；</li>
<li>与 Ceph RBD snapshot 结合；</li>
<li>Disaster Recovery：脚本 + 验证流程。</li>
</ul>
<h3 id="37-大规模镜像管理"><a class="header" href="#37-大规模镜像管理">3.7 大规模镜像管理</a></h3>
<ul>
<li>构建镜像仓库（OpenStack Glance, Foreman/Katello）；</li>
<li>CI/CD Pipeline：Git commit → Packer → virt-customize → 发布；</li>
<li>Tag 与版本控制（SemVer）；</li>
<li>元数据文档（software list, security baseline）；</li>
<li>与 Helm/KubeVirt Template 结合。</li>
</ul>
<h3 id="38-自动化脚本与模板"><a class="header" href="#38-自动化脚本与模板">3.8 自动化脚本与模板</a></h3>
<ul>
<li>Bash/guestfish 脚本模板：
<pre><code class="language-bash">#!/bin/bash
image=$1
guestfish --rw -a "$image" -i &lt;&lt;'EOF'
touch /etc/motd
write /etc/motd "Welcome $(date)"
mkdir-p /opt/tools
upload ./monitor.sh /opt/tools/monitor.sh
chmod 0755 /opt/tools/monitor.sh
EOF
</code></pre>
</li>
<li>Python API；Go API；</li>
<li>Integrate with Jenkins pipeline。</li>
</ul>
<h3 id="39-容器镜像与混合场景"><a class="header" href="#39-容器镜像与混合场景">3.9 容器镜像与混合场景</a></h3>
<ul>
<li>使用 <code>virt-customize</code> 构建 VM base image → <code>buildah</code>/<code>kaniko</code> 生成容器镜像；</li>
<li>Hybrid 方案：VM Node + Container runtime；</li>
<li>镜像签名与供应链安全（cosign, Notary）。</li>
</ul>
<h3 id="310-实践练习"><a class="header" href="#310-实践练习">3.10 实践练习</a></h3>
<ul>
<li>构建 RHEL/CentOS 基础镜像模板并推送 OpenStack;</li>
<li>编写脚本自动注入更新补丁，记录版本；</li>
<li>使用 <code>virt-df</code>, <code>virt-inspector</code> 生成报告；</li>
<li>对比两个镜像差异并生成差异文档；</li>
<li>设计 CI 流水线自动执行上述步骤。</li>
</ul>
<hr />
<h2 id="模块四运维救援与安全合规"><a class="header" href="#模块四运维救援与安全合规">模块四：运维救援与安全合规</a></h2>
<h3 id="41-密码重置与用户管理"><a class="header" href="#41-密码重置与用户管理">4.1 密码重置与用户管理</a></h3>
<ul>
<li>Linux：<code>virt-edit /etc/shadow</code>，删除密码哈希或设置新密码；</li>
<li>结合 <code>virt-customize --root-password password:S3cret</code>；</li>
<li>Windows：<code>virt-win-reg --merge password.reg</code> 或 <code>virt-rescue</code> + <code>chntpw</code>；</li>
<li>注意记录操作审计。</li>
</ul>
<h3 id="42-文件恢复与日志提取"><a class="header" href="#42-文件恢复与日志提取">4.2 文件恢复与日志提取</a></h3>
<ul>
<li><code>guestmount --ro</code> 提取日志、配置；</li>
<li>适用于故障分析、取证；</li>
<li>结合 <code>rsync</code>, <code>tar</code> ;</li>
<li>版本管理：<code>git</code> 保存关键配置快照。</li>
</ul>
<h3 id="43-文件系统修复"><a class="header" href="#43-文件系统修复">4.3 文件系统修复</a></h3>
<ul>
<li>使用 <code>virt-rescue</code> + <code>fsck</code>, <code>xfs_repair</code>;</li>
<li>修改 fstab、grub；</li>
<li><code>guestfish</code> <code>zero /boot/grub2/grub.cfg</code> 等；</li>
<li>适用于 VM 无法启动情况。</li>
</ul>
<h3 id="44-恶意软件与安全扫描"><a class="header" href="#44-恶意软件与安全扫描">4.4 恶意软件与安全扫描</a></h3>
<ul>
<li>将镜像以只读方式挂载，使用本地杀毒/安全工具扫描；</li>
<li><code>clamscan -r /mnt/guest</code>; <code>osqueryi --json</code>;</li>
<li>Security baseline：检查 <code>sudoers</code>, <code>ssh config</code>；</li>
<li>记录结果，生成合规报告。</li>
</ul>
<h3 id="45-selinux-与权限修复"><a class="header" href="#45-selinux-与权限修复">4.5 SELinux 与权限修复</a></h3>
<ul>
<li><code>virt-customize --selinux-relabel</code>；</li>
<li><code>virt-rescue</code> + <code>touch /.autorelabel</code>；</li>
<li>修复 <code>file context</code>；</li>
<li><code>virt-ls --selinux</code> 查看标签。</li>
</ul>
<h3 id="46-合规检查"><a class="header" href="#46-合规检查">4.6 合规检查</a></h3>
<ul>
<li><code>virt-inspector</code> 输出 XML/JSON；</li>
<li><code>ansible + guestfish</code> 检查配置；</li>
<li>保持影子镜像用于审计；</li>
<li>某些监管文件（PCI-DSS, GDPR）支持 offline inspection。</li>
</ul>
<h3 id="47-证据保留与取证"><a class="header" href="#47-证据保留与取证">4.7 证据保留与取证</a></h3>
<ul>
<li>对镜像做哈希校验 (<code>sha256sum</code>)；</li>
<li>按照 Forensic 流程记录操作；</li>
<li>只读挂载 + snapshot；</li>
<li>使用 <code>virt-tar-out</code> 打包证据。</li>
</ul>
<h3 id="48-灾难恢复"><a class="header" href="#48-灾难恢复">4.8 灾难恢复</a></h3>
<ul>
<li>定期备份镜像与关键配置；</li>
<li>演练：恢复镜像 → <code>virt-customize</code> 修改网络 → 启动；</li>
<li>结合 Ceph/Gluster snapshot；</li>
<li>记录恢复时间与成功率。</li>
</ul>
<h3 id="49-安全注意事项"><a class="header" href="#49-安全注意事项">4.9 安全注意事项</a></h3>
<ul>
<li>必须在操作前备份镜像；</li>
<li>使用 <code>--ro</code> 模式进行分析，避免误写；</li>
<li>控制工具使用权限，防止滥用；</li>
<li>清除 appliance 中的敏感数据；</li>
<li>加固操作日志（sudo audit）；</li>
<li>结合 PAM/LDAP 控制访问。</li>
</ul>
<h3 id="410-实践练习"><a class="header" href="#410-实践练习">4.10 实践练习</a></h3>
<ul>
<li>重置无法登录 VM 的 root 密码；</li>
<li>提取故障 VM 的日志并执行 fsck 修复；</li>
<li>对镜像执行安全检查脚本，输出扫描报告；</li>
<li>使用 <code>virt-sysprep</code> 清理，然后重新注入安全策略；</li>
<li>制作操作 SOP 与审计记录模板。</li>
</ul>
<hr />
<h2 id="模块五自动化集成性能优化与监控"><a class="header" href="#模块五自动化集成性能优化与监控">模块五：自动化集成、性能优化与监控</a></h2>
<h3 id="51-cicd-集成"><a class="header" href="#51-cicd-集成">5.1 CI/CD 集成</a></h3>
<ul>
<li>Pipeline 示例：
<ol>
<li>代码提交 → 触发 Jenkins/GitLab Runner；</li>
<li>使用 Packer + libguestfs 模板；</li>
<li>运行 <code>virt-customize</code> 注入版本；</li>
<li><code>virt-df</code>/<code>virt-inspector</code> 生成报告；</li>
<li>单元测试：<code>vm boots test</code>（OpenQA, virt-test）；</li>
<li>发布镜像到仓库（Glance, Artifactory, S3）。</li>
</ol>
</li>
<li>结合 ArgoCD/GitOps 管理 YAML（KubeVirt）。</li>
</ul>
<h3 id="52-api-使用"><a class="header" href="#52-api-使用">5.2 API 使用</a></h3>
<ul>
<li>Python：<code>import guestfs</code>; <code>g = guestfs.GuestFS()</code>；</li>
<li>Go：<code>github.com/libguestfs/go-libguestfs</code>；</li>
<li>Ruby/Perl:
<pre><code class="language-python">import guestfs
g = guestfs.GuestFS(python_return_dict=True)
g.add_drive_opts("image.qcow2", format="qcow2", readonly=0)
g.launch()
g.mount_options("", "/dev/sda1", "/")
g.write("/etc/motd", "Welcome\n")
g.umount_all()
g.shutdown()
</code></pre>
</li>
<li>与 Flask/Django API 服务结合，实现镜像自助平台。</li>
</ul>
<h3 id="53-性能注意事项"><a class="header" href="#53-性能注意事项">5.3 性能注意事项</a></h3>
<ul>
<li>appliance 启动开销：预热（<code>guestfish --keys-from-stdin</code>）；</li>
<li>并行处理：多进程每个镜像一个 <code>guestfs</code> 实例；</li>
<li>I/O 瓶颈：使用 SSD、NVMe、分布式存储；</li>
<li>处理大镜像时使用 <code>virt-sparsify --tmp</code>；</li>
<li>监控 CPU/IO/网络；</li>
<li>限制 <code>libguestfs</code> 线程数（<code>LIBGUESTFS_MEMSIZE</code>, <code>LIBGUESTFS_BACKEND</code>）。</li>
</ul>
<h3 id="54-监控与日志"><a class="header" href="#54-监控与日志">5.4 监控与日志</a></h3>
<ul>
<li><code>LIBGUESTFS_DEBUG</code>, <code>TRACE</code>；</li>
<li><code>sosreport</code> 集成；</li>
<li>Prometheus Exporter：自定义脚本统计处理时间、失败率；</li>
<li>日志收集：ELK、Loki；</li>
<li>审计：记录操作人、命令、镜像名称。</li>
</ul>
<h3 id="55-自动化脚本库"><a class="header" href="#55-自动化脚本库">5.5 自动化脚本库</a></h3>
<ul>
<li>Git 仓库管理脚本：模块化（python package, bash functions）；</li>
<li>结合 <code>make</code>、<code>tox</code>、<code>pytest</code>；</li>
<li>版本化输出（SemVer）；</li>
<li>文档：README、使用示例、测试结果。</li>
</ul>
<h3 id="56-与其他工具集成"><a class="header" href="#56-与其他工具集成">5.6 与其他工具集成</a></h3>
<ul>
<li>Packer：<code>qemu</code> builder + <code>shell-local</code> 使用 libguestfs；</li>
<li>Ansible：<code>community.general.virt</code> + <code>guestfish</code>；</li>
<li>Terraform：自定义 provisioner；</li>
<li>SRE 工具：<code>KubeVirt</code>, <code>Harvester</code>, <code>OpenShift Virtualization</code>；</li>
<li>Hybrid： docker-virt（容器化运行 guestfish）。</li>
</ul>
<h3 id="57-资源优化"><a class="header" href="#57-资源优化">5.7 资源优化</a></h3>
<ul>
<li>清理临时文件：<code>/tmp/tmp.*</code>；</li>
<li><code>virt-sysprep --operations</code> 精准操作；</li>
<li>压缩镜像：<code>xz</code>, <code>zstd</code>;</li>
<li>快速复制：<code>qemu-img convert --target-image-opts</code>;</li>
<li>利用 <code>overlay</code> 进行增量更新。</li>
</ul>
<h3 id="58-安全与合规自动化"><a class="header" href="#58-安全与合规自动化">5.8 安全与合规自动化</a></h3>
<ul>
<li>整合安全扫描脚本（OpenSCAP, Lynis）；</li>
<li>强制执行 CIS baseline；</li>
<li>生成自动化报告：Markdown/HTML/PDF；</li>
<li>版本签名（GPG）确保镜像可信；</li>
<li>审计日志对接 SIEM。</li>
</ul>
<h3 id="59-案例自动化镜像工厂"><a class="header" href="#59-案例自动化镜像工厂">5.9 案例：自动化镜像工厂</a></h3>
<ul>
<li>使用 GitLab CI + Packer + libguestfs；</li>
<li>每次 commit 自动构建 Ubuntu/RHEL 镜像；</li>
<li>集成安全扫描（Trivy, OpenSCAP）；</li>
<li>自动生成 <code>release note</code>;</li>
<li>发布至多云（AWS, OpenStack, Harvester）。</li>
</ul>
<h3 id="510-实践练习"><a class="header" href="#510-实践练习">5.10 实践练习</a></h3>
<ul>
<li>编写 Python API 脚本进行文件注入；</li>
<li>在 CI 中运行 <code>virt-customize</code>, <code>virt-sysprep</code>;</li>
<li>监控操作耗时并发送指标到 Prometheus；</li>
<li>优化 <code>virt-sparsify</code> 过程，减少时间；</li>
<li>设计自动化报告模板。</li>
</ul>
<hr />
<h2 id="模块六故障诊断学习路径与扩展资源"><a class="header" href="#模块六故障诊断学习路径与扩展资源">模块六：故障诊断、学习路径与扩展资源</a></h2>
<h3 id="61-常见问题与排查"><a class="header" href="#61-常见问题与排查">6.1 常见问题与排查</a></h3>
<div class="table-wrapper"><table><thead><tr><th>问题</th><th>现象</th><th>排查</th><th>解决</th></tr></thead><tbody>
<tr><td><code>libguestfs-test-tool</code> 失败</td><td>appliance 启动错误</td><td>检查 qemu-kvm、权限、SELinux</td><td>安装 <code>libguestfs-appliance</code>, 调整权限</td></tr>
<tr><td><code>guestfish: No operating systems</code></td><td>无法自动识别</td><td>指定分区 <code>-m /dev/sda1</code></td><td>手动挂载</td></tr>
<tr><td><code>virt-resize</code> 失败</td><td>分区不支持</td><td>查看 <code>lsblk</code>, <code>parted</code></td><td>手动扩展 partition + filesystem</td></tr>
<tr><td><code>guestmount</code> 卡住/忙</td><td>退出挂载点</td><td><code>guestunmount</code> + <code>fuser</code></td><td>强制卸载</td></tr>
<tr><td><code>virt-sysprep</code> 破坏配置</td><td>服务不可用</td><td>使用 <code>--operations</code> 控制</td><td>先备份，选择性清理</td></tr>
<tr><td>LUKS 解密失败</td><td>提示密钥错误</td><td>检查 key file</td><td>更新 key，使用 <code>--key</code></td></tr>
<tr><td>Windows 修改失败</td><td>权限或工具缺失</td><td>安装 <code>virt-win-tools</code></td><td>使用 <code>virt-win-reg</code></td></tr>
<tr><td>SELinux 标签错乱</td><td>VM 无法启动</td><td><code>virt-customize --selinux-relabel</code></td><td>启动 VM 执行 <code>touch /.autorelabel</code></td></tr>
<tr><td>批量脚本失败</td><td>耗时长、资源高</td><td>监控 appliance 资源</td><td>批量处理加并发控制</td></tr>
<tr><td>用户误写</td><td>镜像损坏</td><td>备份</td><td>恢复 snapshot</td></tr>
</tbody></table>
</div>
<h3 id="62-排查流程模板"><a class="header" href="#62-排查流程模板">6.2 排查流程模板</a></h3>
<ol>
<li>确认工具安装、版本；</li>
<li>运行 <code>libguestfs-test-tool</code>；</li>
<li>检查镜像格式 <code>qemu-img info</code>；</li>
<li>分析日志（<code>LIBGUESTFS_DEBUG=1</code>）；</li>
<li>使用 <code>guestfish --ro</code> 验证读取；</li>
<li>排除 LVM/加密问题；</li>
<li>记录问题并制作 RCA。</li>
</ol>
<h3 id="63-学习路径设计"><a class="header" href="#63-学习路径设计">6.3 学习路径设计</a></h3>
<div class="table-wrapper"><table><thead><tr><th>阶段</th><th>时间</th><th>目标</th><th>行动</th><th>产出</th></tr></thead><tbody>
<tr><td>阶段 0：准备</td><td>1 天</td><td>安装环境、验证工具</td><td>安装 libguestfs, 运行测试</td><td>环境记录</td></tr>
<tr><td>阶段 1：基础操作</td><td>3 天</td><td>掌握 guestfish/guestmount/virt-*</td><td>完成文件操作、复制、编辑</td><td>命令清单、操作手册</td></tr>
<tr><td>阶段 2：镜像管理</td><td>4 天</td><td>实现镜像定制、清理、压缩</td><td>构建模板、运行 virt-sysprep/customize</td><td>模板仓库、脚本</td></tr>
<tr><td>阶段 3：运维救援</td><td>3 天</td><td>掌握密码重置、日志提取、修复</td><td>完成故障模拟与恢复</td><td>救援手册、RCA 模板</td></tr>
<tr><td>阶段 4：自动化</td><td>5 天</td><td>构建 CI/CD、监控、API</td><td>编写脚本、集成 pipeline</td><td>自动化流程、监控面板</td></tr>
<tr><td>阶段 5：持续优化</td><td>持续</td><td>扩展场景、知识沉淀</td><td>文档化、培训、社区互动</td><td>知识库、培训材料</td></tr>
</tbody></table>
</div>
<h3 id="64-实战案例"><a class="header" href="#64-实战案例">6.4 实战案例</a></h3>
<h4 id="案例一openstack-镜像工厂"><a class="header" href="#案例一openstack-镜像工厂">案例一：OpenStack 镜像工厂</a></h4>
<ul>
<li>目标：为多租户平台提供标准化镜像。</li>
<li>流程：
<ol>
<li>基于 <code>virt-builder</code> 获取官方镜像；</li>
<li>使用 <code>virt-customize</code> 注入安全补丁、代理、cloud-init；</li>
<li><code>virt-sysprep</code> 清理历史；</li>
<li><code>virt-sparsify</code> 压缩；</li>
<li>上传 Glance，生成元数据；</li>
</ol>
</li>
<li>成果：镜像构建脚本、CI Pipeline、验证报告。</li>
</ul>
<h4 id="案例二故障虚拟机救援"><a class="header" href="#案例二故障虚拟机救援">案例二：故障虚拟机救援</a></h4>
<ul>
<li>背景：关键业务 VM 无法启动。</li>
<li>步骤：
<ol>
<li><code>guestmount --ro</code> 提取日志；</li>
<li>发现 fstab 配置错误；</li>
<li><code>guestfish --rw</code> 修改 <code>/etc/fstab</code>；</li>
<li><code>virt-customize --selinux-relabel</code>;</li>
<li>启动 VM 验证；</li>
</ol>
</li>
<li>成果：救援 SOP、RCA、预防措施。</li>
</ul>
<h4 id="案例三安全基线检查"><a class="header" href="#案例三安全基线检查">案例三：安全基线检查</a></h4>
<ul>
<li>目标：批量审计镜像安全设置。</li>
<li>流程：
<ol>
<li><code>guestfish --ro</code> 批量遍历镜像；</li>
<li>检查 <code>/etc/ssh/sshd_config</code>, <code>/etc/passwd</code>；</li>
<li>输出 JSON 报告；</li>
<li>自动生成告警；</li>
</ol>
</li>
<li>成果：审计脚本、报告、整改计划。</li>
</ul>
<h4 id="案例四跨平台迁移vmware--kvm"><a class="header" href="#案例四跨平台迁移vmware--kvm">案例四：跨平台迁移（VMware → KVM）</a></h4>
<ul>
<li>使用 <code>virt-v2v</code> 将 VMDK 转换为 QCOW2；</li>
<li>修改驱动（注入 virtio）；</li>
<li>验证网络、存储；</li>
<li>成果：迁移脚本、测试报告。</li>
</ul>
<h4 id="案例五容器化自动化工具"><a class="header" href="#案例五容器化自动化工具">案例五：容器化自动化工具</a></h4>
<ul>
<li>使用 Docker 运行 libguestfs 工具（需 <code>--privileged</code>）；</li>
<li>构建 <code>image-tool</code> 容器镜像；</li>
<li>CI 调用容器，统一环境；</li>
<li>发布 Helm Chart；</li>
<li>成果：工具镜像、使用文档、CI 模板。</li>
</ul>
<h3 id="65-学习成果验证标准"><a class="header" href="#65-学习成果验证标准">6.5 学习成果验证标准</a></h3>
<ol>
<li><strong>操作熟练度</strong>：完成文件注入、编辑、定制、压缩等任务；</li>
<li><strong>自动化水平</strong>：交付脚本或 API 服务，实现批量处理；</li>
<li><strong>安全与合规</strong>：跑通安全基线检查，输出报告；</li>
<li><strong>救援能力</strong>：完成至少两种故障恢复演练；</li>
<li><strong>性能评估</strong>：记录操作耗时、资源消耗，提出优化；</li>
<li><strong>文档化</strong>：完成操作手册、FAQ、培训材料；</li>
<li><strong>团队协作</strong>：组织分享会，获得反馈；</li>
<li><strong>迭代计划</strong>：列出后续优化和工具改进路线图。</li>
</ol>
<h3 id="66-扩展资源与进阶建议"><a class="header" href="#66-扩展资源与进阶建议">6.6 扩展资源与进阶建议</a></h3>
<ul>
<li><strong>官方文档</strong>：https://libguestfs.org/</li>
<li><strong>工具手册</strong>：<code>man guestfish</code>, <code>man virt-customize</code>, <code>man virt-sysprep</code>；</li>
<li><strong>博客与案例</strong>：Red Hat Developer Blog, virt-tools mailing list；</li>
<li><strong>社区</strong>：<code>#libguestfs</code> IRC、Fedora/RHEL mailing list；</li>
<li><strong>书籍</strong>：
<ul>
<li>《Virtualization for Dummies》</li>
<li>《KVM Virtualization Cookbook》</li>
</ul>
</li>
<li><strong>进阶建议</strong>：
<ol>
<li>学习 supermin 构建自定义 appliance；</li>
<li>探索 libguestfs 与 Ceph、Gluster、S3 混合存储结合；</li>
<li>集成安全扫描、镜像签名、合规审计；</li>
<li>参与开源贡献（提交 bug, PR, 文档）；</li>
<li>构建跨云镜像发布平台；</li>
<li>持续优化自动化流程与性能监控。</li>
</ol>
</li>
</ul>
<hr />
<h2 id="附录"><a class="header" href="#附录">附录</a></h2>
<h3 id="a-常用命令速查"><a class="header" href="#a-常用命令速查">A. 常用命令速查</a></h3>
<pre><code class="language-bash">guestfish --ro -a img.qcow2 -i list-filesystems
guestmount -a img.qcow2 -i --rw /mnt/vm
virt-customize -a img.qcow2 --install nginx --run-command 'systemctl enable nginx'
virt-sysprep -a img.qcow2 --operations ssh-userdir,logfiles
virt-sparsify img.qcow2 img-slim.qcow2
virt-df -a img.qcow2
virt-cat -a img.qcow2 /etc/hostname
virt-edit -a img.qcow2 /etc/fstab
virt-resize --expand /dev/sda2 img.qcow2 img-new.qcow2
virt-v2v -i libvirt vm1 -o local -os /backup
</code></pre>
<h3 id="b-自动化脚本结构示例"><a class="header" href="#b-自动化脚本结构示例">B. 自动化脚本结构示例</a></h3>
<pre><code>libguestfs-tooling/
├── scripts/
│   ├── build-image.sh
│   ├── patch-image.sh
│   └── report-image.sh
├── python/
│   ├── lgf_client.py
│   └── requirements.txt
├── ansible/
│   ├── roles/image-build
│   └── playbooks/build.yml
└── docs/
    ├── SOP.md
    └── FAQ.md
</code></pre>
<h3 id="c-安全检查脚本片段"><a class="header" href="#c-安全检查脚本片段">C. 安全检查脚本片段</a></h3>
<pre><code class="language-bash">#!/bin/bash
image=$1
guestshell=$(guestfish --ro -a "$image" -i)
ssh_conf=$(echo "cat /etc/ssh/sshd_config" | $guestshell)
if echo "$ssh_conf" | grep -q "PermitRootLogin yes"; then
  echo "[WARN] $image: PermitRootLogin enabled"
fi
$guestshell exit
</code></pre>
<h3 id="d-故障响应表模板"><a class="header" href="#d-故障响应表模板">D. 故障响应表模板</a></h3>
<pre><code>事件编号：LGF-2024-05
时间：2024-09-18 10:00
操作类型：密码重置
镜像：prod-web-20240917.qcow2
执行人：alice
步骤：
1. virt-customize --root-password password:Temporary123!
2. virt-sysprep --operations ssh-userdir
3. 记录 hash
结果：成功
复盘：将操作记录到审计系统，提醒用户及时修改密码。
</code></pre>
<h3 id="e-常用环境变量"><a class="header" href="#e-常用环境变量">E. 常用环境变量</a></h3>
<div class="table-wrapper"><table><thead><tr><th>变量</th><th>说明</th></tr></thead><tbody>
<tr><td><code>LIBGUESTFS_DEBUG</code></td><td>打印调试信息</td></tr>
<tr><td><code>LIBGUESTFS_TRACE</code></td><td>显示执行的命令</td></tr>
<tr><td><code>LIBGUESTFS_BACKEND</code></td><td>设置 backend（<code>direct</code>, <code>libvirt</code>）</td></tr>
<tr><td><code>LIBGUESTFS_MEMSIZE</code></td><td>调整 appliance 内存</td></tr>
<tr><td><code>LIBGUESTFS_TMPDIR</code></td><td>设置临时目录</td></tr>
<tr><td><code>LIBGUESTFS_CACHEDIR</code></td><td>缓存目录</td></tr>
</tbody></table>
</div>
<blockquote>
<p>libguestfs 是虚拟化镜像管理的瑞士军刀。掌握其工具链、自动化能力与安全治理策略，将极大提升团队在镜像生命周期管理、故障救援、合规审查方面的效率与可靠性。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/云计算/kvm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/云计算/libvirt.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/云计算/kvm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/云计算/libvirt.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

