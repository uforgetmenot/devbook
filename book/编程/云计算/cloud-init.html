<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>cloud-init 云主机初始化学习笔记 - 开发</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/pagetoc.css">
        <link rel="stylesheet" href="../../theme/help-overlay.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">开发</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="搜索本书内容..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="cloud-init-云主机初始化学习笔记"><a class="header" href="#cloud-init-云主机初始化学习笔记">cloud-init 云主机初始化学习笔记</a></h1>
<blockquote>
<p>面向 0-5 年经验的云计算、DevOps 与自动化运维工程师，帮助其系统掌握 cloud-init 的工作原理、配置语法、跨平台实践与企业级落地方法。</p>
</blockquote>
<hr />
<h2 id="学习定位与总体目标"><a class="header" href="#学习定位与总体目标">学习定位与总体目标</a></h2>
<ul>
<li><strong>学习者画像</strong>：具备 Linux 基础与常见配置管理工具（Ansible/Salt/Script）的使用经验，正在构建或维护云平台（OpenStack、VMware、阿里云、AWS、Azure）上的虚拟机生命周期管理。</li>
<li><strong>技术定位</strong>：cloud-init 是云主机启动阶段执行的初始化引擎，通过多源数据驱动，实现主机个性化配置、软件安装、密钥注入与应用引导，是 IaaS 层“黄金镜像 + 初始化”模式的核心组件。</li>
<li><strong>学习目标</strong>：
<ol>
<li>理解 cloud-init 的启动流程、数据源体系、模块执行顺序与日志体系；</li>
<li>熟练编写 cloud-config、part-handlers、自定义模块；</li>
<li>能够在多云环境中调试数据源问题，构建可重复交付的初始化方案；</li>
<li>打造自动化测试、监控与安全审计机制；</li>
<li>输出适用于团队的标准化模板、最佳实践与预案。</li>
</ol>
</li>
<li><strong>成果要求</strong>：
<ul>
<li>发布 3+ 套覆盖不同业务场景的 cloud-config 模板；</li>
<li>实现 CI 流水线自动验证 cloud-init；</li>
<li>建立日志收集与错误恢复方案；</li>
<li>形成知识库/操作手册供新成员复用。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="核心模块结构"><a class="header" href="#核心模块结构">核心模块结构</a></h2>
<ol>
<li><strong>模块一：cloud-init 原理与体系结构</strong> —— 掌握组件、启动阶段、数据源机制。</li>
<li><strong>模块二：实验环境搭建与基础体验</strong> —— 构建本地/云端实验环境，熟悉核心命令。</li>
<li><strong>模块三：标准 cloud-config 配置模块详解</strong> —— 按执行阶段拆解常用配置与语法。</li>
<li><strong>模块四：进阶功能与扩展开发</strong> —— 模块化执行、part-handlers、Python 扩展与与 CM 工具联动。</li>
<li><strong>模块五：企业级落地实践</strong> —— 多云适配、镜像流水线、安全治理与运维管控。</li>
<li><strong>模块六：故障诊断、测试与最佳实践</strong> —— 日志分析、自动化测试、问题排查与知识沉淀。</li>
</ol>
<hr />
<h2 id="模块一cloud-init-原理与体系结构"><a class="header" href="#模块一cloud-init-原理与体系结构">模块一：cloud-init 原理与体系结构</a></h2>
<h3 id="11-项目背景与演进"><a class="header" href="#11-项目背景与演进">1.1 项目背景与演进</a></h3>
<ul>
<li>发源于 Canonical（Ubuntu），当前由社区维护，支持多数主流 Linux 发行版（Ubuntu、Debian、RHEL/Fedora、CentOS、Amazon Linux、SUSE、Alpine 等）；</li>
<li>随着云平台发展，从早期单一 <code>User-Data</code> 脚本扩展为多阶段配置引擎；</li>
<li>被 OpenStack、AWS EC2、Azure、GCP、阿里云、腾讯云、华为云等广泛采用。</li>
</ul>
<h3 id="12-核心架构组成"><a class="header" href="#12-核心架构组成">1.2 核心架构组成</a></h3>
<ul>
<li><strong>cloud-init 服务</strong>：系统服务（systemd unit），启动阶段调用；</li>
<li><strong>数据源（datasource）</strong>：与云平台交互获取 metadata/user-data；</li>
<li><strong>Renderer</strong>：生成网络配置（<code>netplan</code>, <code>eni</code>, <code>NetworkManager</code> 等）；</li>
<li><strong>模块系统</strong>：按阶段执行预定义模块（<code>cloudinit/config/*</code>）。</li>
</ul>
<pre><code>┌──────────────────────────────────────────────────────┐
│              cloud-init Service (systemd)            │
├─────────────────────┬────────────────────────────────┤
│     Init Stage      │  Read Metadata / Config        │
├─────────────────────┼────────────────────────────────┤
│ cloudinit.init |cloudinit.net |cloudinit.config|... │
├────────────┬────────┴─────────────┬────────────────┤
│ Datasource │ Network Renderer     │ Config Modules │
│ (IMDS/MAAS │ (netplan, ENI, NM)   │ (users, ssh,   │
│  NoCloud…) │                      │  packages, runc│
└────────────┴──────────────────────┴────────────────┘
</code></pre>
<h3 id="13-四个主要执行阶段"><a class="header" href="#13-四个主要执行阶段">1.3 四个主要执行阶段</a></h3>
<div class="table-wrapper"><table><thead><tr><th>阶段</th><th>systemd 单元</th><th>目的</th><th>典型模块</th></tr></thead><tbody>
<tr><td><code>cloud-init-local</code></td><td><code>cloud-init-local.service</code></td><td>最早阶段，挂载文件系统前读取本地数据源</td><td><code>DataSourceNoCloud</code>、本地网络准备</td></tr>
<tr><td><code>cloud-init</code></td><td><code>cloud-init.service</code></td><td>初始化网络、读取远程 metadata</td><td><code>set_hostname</code>, <code>update_hostname</code>, <code>network</code></td></tr>
<tr><td><code>cloud-config</code></td><td><code>cloud-config.service</code></td><td>执行配置模块（用户、包、文件）</td><td><code>users-groups</code>, <code>ssh</code>, <code>packages</code></td></tr>
<tr><td><code>cloud-final</code></td><td><code>cloud-final.service</code></td><td>运行最终脚本、服务启动、信标上报</td><td><code>runcmd</code>, <code>bootcmd</code>, <code>scripts-per-once</code></td></tr>
</tbody></table>
</div>
<h3 id="14-数据源分类"><a class="header" href="#14-数据源分类">1.4 数据源分类</a></h3>
<ul>
<li><strong>公有云</strong>：<code>Ec2</code>, <code>Azure</code>, <code>GCE</code>, <code>AliYun</code>, <code>Tencent</code>, <code>HwCloud</code> 等；</li>
<li><strong>私有云/虚拟化</strong>：<code>ConfigDrive</code>, <code>NoCloud</code>, <code>OpenStack</code>, <code>VMware</code>, <code>MAAS</code>；</li>
<li><strong>容器/裸机</strong>：<code>RbxCloud</code>, <code>DigitalOcean</code>, <code>Nocloud-Net</code>；</li>
<li><strong>自定义</strong>：支持自定义 DataSource 插件。</li>
</ul>
<h3 id="15-配置文件与目录结构"><a class="header" href="#15-配置文件与目录结构">1.5 配置文件与目录结构</a></h3>
<div class="table-wrapper"><table><thead><tr><th>路径</th><th>说明</th></tr></thead><tbody>
<tr><td><code>/etc/cloud/cloud.cfg</code></td><td>主配置文件，定义默认模块执行列表；</td></tr>
<tr><td><code>/etc/cloud/cloud.cfg.d/*.cfg</code></td><td>追加/覆盖的配置片段，按字典序执行；</td></tr>
<tr><td><code>/etc/cloud/templates/</code></td><td>模板文件（<code>hosts</code>, <code>sources.list</code>）；</td></tr>
<tr><td><code>/var/lib/cloud/</code></td><td>状态目录，记录执行历史；</td></tr>
<tr><td><code>/var/log/cloud-init.log</code></td><td>主日志；</td></tr>
<tr><td><code>/var/log/cloud-init-output.log</code></td><td>用户脚本输出。</td></tr>
</tbody></table>
</div>
<h3 id="16-关键概念梳理"><a class="header" href="#16-关键概念梳理">1.6 关键概念梳理</a></h3>
<ul>
<li><strong>Instance ID</strong>：唯一标识实例；导致 cloud-init 判断是否重跑。</li>
<li><strong>User-Data</strong>：用户自定义数据（cloud-config、脚本、MIME）；</li>
<li><strong>Metadata</strong>：平台提供的信息（主机名、网络、密钥、SSH）；</li>
<li><strong>Vendor-Data</strong>：供应商预置数据（可追加默认配置）；</li>
<li><strong>Seed</strong>：NoCloud 数据源，用于本地文件或 ISO;</li>
<li><strong>Stages</strong>：<code>init</code>, <code>config</code>, <code>final</code> 模块执行链。</li>
</ul>
<h3 id="17-学习重点与易错点"><a class="header" href="#17-学习重点与易错点">1.7 学习重点与易错点</a></h3>
<ul>
<li><strong>重点</strong>：
<ul>
<li>明确阶段顺序与模块执行时机；</li>
<li>数据源选择策略与 fallback；</li>
<li>cloud-config 的 YAML 结构、常见字段；</li>
<li>日志排查路径。</li>
</ul>
</li>
<li><strong>易错点</strong>：
<ol>
<li>镜像缓存 <code>instance-id</code> 导致 cloud-init 被跳过；</li>
<li>YAML 缩进错误导致配置无效；</li>
<li>网络渲染器不匹配发行版；</li>
<li>Multiple MIME parts 拼装失误（缺 boundary）；</li>
<li>忘记清理 <code>/var/lib/cloud</code> 导致二次初始化失败；</li>
<li>云平台 metadata endpoint 不可达 → 数据源超时。</li>
</ol>
</li>
</ul>
<h3 id="18-入门练习解析模块顺序"><a class="header" href="#18-入门练习解析模块顺序">1.8 入门练习：解析模块顺序</a></h3>
<pre><code class="language-bash">sudo cloud-init devel module-lists
sudo cloud-init analyze show
sudo cloud-init schema --system | less
</code></pre>
<blockquote>
<p>通过 <code>cloud-init analyze</code> 回顾各阶段耗时，为后续优化提供依据。</p>
</blockquote>
<hr />
<h2 id="模块二实验环境搭建与基础体验"><a class="header" href="#模块二实验环境搭建与基础体验">模块二：实验环境搭建与基础体验</a></h2>
<h3 id="21-实验环境选型"><a class="header" href="#21-实验环境选型">2.1 实验环境选型</a></h3>
<ul>
<li><strong>方案 A：本地 KVM + NoCloud</strong>
<ul>
<li>使用 <code>cloud-localds</code> 生成 seed ISO；</li>
<li>通过 <code>virt-install</code> 创建 VM；</li>
<li>适合自定义数据源与脚本调试。</li>
</ul>
</li>
<li><strong>方案 B：OpenStack 实验项目</strong>
<ul>
<li>创建 Flavor + Image + Network；</li>
<li>注入 user-data；</li>
<li>通过 <code>openstack console log show</code> 查看日志。</li>
</ul>
</li>
<li><strong>方案 C：公有云免费层</strong>
<ul>
<li>AWS/Azure/GCP 免费实例；</li>
<li>直接在控制台粘贴 cloud-config 体验。</li>
</ul>
</li>
</ul>
<h3 id="22-创建-nocloud-seed-iso"><a class="header" href="#22-创建-nocloud-seed-iso">2.2 创建 NoCloud Seed ISO</a></h3>
<pre><code class="language-bash">cat &lt;&lt;'YAML' &gt; user-data
#cloud-config
hostname: cloudinit-lab
users:
  - name: devops
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [wheel]
    ssh_import_id:
      - gh:your-github-id
write_files:
  - path: /etc/motd
    content: |
      欢迎来到 cloud-init 实验环境！
YAML

touch meta-data

cloud-localds seed.iso user-data meta-data
</code></pre>
<h3 id="23-启动虚拟机"><a class="header" href="#23-启动虚拟机">2.3 启动虚拟机</a></h3>
<pre><code class="language-bash">virt-install \
  --name cloudinit-lab \
  --memory 2048 \
  --disk path=/var/lib/libvirt/images/ubuntu-22.qcow2,backing_store=/var/lib/libvirt/images/ubuntu-22-base.qcow2 \
  --disk path=/var/lib/libvirt/images/seed.iso,device=cdrom \
  --os-variant ubuntu22.04 \
  --network network=default \
  --import --noautoconsole
</code></pre>
<h3 id="24-常用命令"><a class="header" href="#24-常用命令">2.4 常用命令</a></h3>
<ul>
<li><code>cloud-init status --long</code></li>
<li><code>cloud-init clean</code></li>
<li><code>cloud-init single --name &lt;module&gt;</code></li>
<li><code>cloud-init query --format yaml ds</code></li>
<li><code>cloud-init collect-logs</code></li>
</ul>
<h3 id="25-初次验证清单"><a class="header" href="#25-初次验证清单">2.5 初次验证清单</a></h3>
<div class="table-wrapper"><table><thead><tr><th>项目</th><th>验证方法</th><th>预期</th></tr></thead><tbody>
<tr><td>主机名</td><td><code>hostnamectl</code></td><td>cloud-config 中的 hostname</td></tr>
<tr><td>用户</td><td><code>id devops</code></td><td>用户存在，sudo 权限</td></tr>
<tr><td>MOTD</td><td><code>cat /etc/motd</code></td><td>内容匹配</td></tr>
<tr><td>SSH Key</td><td><code>ssh -i ~/.ssh/id_rsa devops@ip</code></td><td>可登陆</td></tr>
</tbody></table>
</div>
<h3 id="26-入门练习"><a class="header" href="#26-入门练习">2.6 入门练习</a></h3>
<ul>
<li>修改 <code>write_files</code> 添加 systemd unit；</li>
<li>在 <code>runcmd</code> 中执行 <code>apt update &amp;&amp; apt install -y nginx</code>；</li>
<li>使用 <code>cloud-init clean</code> + 重启 3 次，验证幂等性。</li>
</ul>
<hr />
<h2 id="模块三标准-cloud-config-配置模块详解"><a class="header" href="#模块三标准-cloud-config-配置模块详解">模块三：标准 cloud-config 配置模块详解</a></h2>
<h3 id="31-yaml-结构基础"><a class="header" href="#31-yaml-结构基础">3.1 YAML 结构基础</a></h3>
<ul>
<li>Cloud-config 以 YAML 编写，第一行 <code>#cloud-config</code>；</li>
<li>支持 <code>!!binary</code>, <code>!!str</code>, <code>|</code>, <code>&gt;</code> 等 YAML 语法；</li>
<li>注意 2 空格缩进，数组使用 <code>-</code>；</li>
<li>复杂配置可以 <code>merge</code>、<code>anchor</code> (<code>&amp;ref</code>, <code>*ref</code>)。</li>
</ul>
<h3 id="32-常用字段一览表"><a class="header" href="#32-常用字段一览表">3.2 常用字段一览表</a></h3>
<div class="table-wrapper"><table><thead><tr><th>字段</th><th>功能</th><th>备注</th></tr></thead><tbody>
<tr><td><code>hostname</code> / <code>fqdn</code></td><td>配置主机名、域名</td><td>影响 <code>/etc/hosts</code> 生成</td></tr>
<tr><td><code>users</code></td><td>创建用户、配置密码/密钥</td><td>支持 ssh_import_id</td></tr>
<tr><td><code>chpasswd</code></td><td>设置密码</td><td>支持 <code>expire: False</code></td></tr>
<tr><td><code>ssh_authorized_keys</code></td><td>注入公钥</td><td>结合 metadata 密钥</td></tr>
<tr><td><code>packages</code>, <code>package_update</code></td><td>软件安装</td><td>Debian/RedHat 均支持</td></tr>
<tr><td><code>write_files</code></td><td>写文件，支持权限、编码、<code>append</code></td><td>支持 <code>encoding: b64</code></td></tr>
<tr><td><code>runcmd</code></td><td>最后执行的命令列表</td><td>在 <code>cloud-final</code> 阶段运行</td></tr>
<tr><td><code>bootcmd</code></td><td>引导阶段执行（单次）</td><td>早于 <code>runcmd</code></td></tr>
<tr><td><code>phone_home</code></td><td>回调 URL</td><td>用于集成自动化系统</td></tr>
<tr><td><code>ntp</code>, <code>timezone</code></td><td>时间同步</td><td>根据发行版使用 chrony/ntp</td></tr>
<tr><td><code>apt</code>, <code>yum_repos</code></td><td>包仓库配置</td><td>需正确指向镜像源</td></tr>
</tbody></table>
</div>
<h3 id="33-阶段化执行顺序与模板示例"><a class="header" href="#33-阶段化执行顺序与模板示例">3.3 阶段化执行顺序与模板示例</a></h3>
<pre><code class="language-yaml">#cloud-config
preserve_hostname: false
hostname: app-server-{{instance_id}}
manage_etc_hosts: true

apt:
  sources:
    custom-ppa:
      source: "deb http://ppa.launchpad.net/ansible/ansible/ubuntu focal main"
      keyid: 6125E2A8
      filename: ansible.list

ssh_authorized_keys:
  - ssh-rsa AAAAB3Nz...

write_files:
  - path: /etc/systemd/system/app-health.service
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=App Health Check
      After=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/app-health.sh

      [Install]
      WantedBy=multi-user.target

bootcmd:
  - [ sh, -xc, 'echo "BOOTCMD 执行于: $(date)" &gt;&gt; /var/log/bootcmd.log' ]

runcmd:
  - apt-get update
  - apt-get install -y ansible
  - systemctl daemon-reload
  - systemctl enable --now app-health.service

final_message: "cloud-init finished at $(date +%Y-%m-%d_%H:%M:%S)"
</code></pre>
<h3 id="34-文件写入与模板技巧"><a class="header" href="#34-文件写入与模板技巧">3.4 文件写入与模板技巧</a></h3>
<ul>
<li><code>owner</code>, <code>permissions</code> 支持字符串 octal；</li>
<li><code>content</code> 可使用多行文本 (<code>|</code>)，保持缩进一致；</li>
<li><code>defer: true</code> 表示写入推迟到 <code>cloud-final</code>；</li>
<li><code>encoding: b64</code> + <code>content: !!binary</code> 用于二进制文件；</li>
<li><code>append: true</code> 追加模式；</li>
<li><code>template: jinja</code> 结合 <code>vars</code> 使用。</li>
</ul>
<h3 id="35-包管理"><a class="header" href="#35-包管理">3.5 包管理</a></h3>
<ul>
<li><code>package_upgrade: true</code>/<code>false</code> 控制升级；</li>
<li>`packages:
<ul>
<li>nginx</li>
<li>[docker-ce, 20.10.22]`</li>
</ul>
</li>
<li><code>snap</code>, <code>flatpak</code> 需要额外配置；</li>
<li>RHEL 系：<code>yum_repos</code>、<code>rhn_register</code>、<code>subscription-manager</code>。</li>
</ul>
<h3 id="36-网络配置模块"><a class="header" href="#36-网络配置模块">3.6 网络配置模块</a></h3>
<ul>
<li><code>network: {version: 2, ethernets: ...}</code> → Netplan；</li>
<li><code>network:   config:     - type: physical       name: eth0       mac_address: 'fa:16:3e:...'</code></li>
<li>指定渲染器：<code>network:   version: 2   ethernets:     ens160:       renderer: networkd       dhcp4: true</code></li>
<li>Bond/Bridge/VLAN 例子。</li>
</ul>
<pre><code class="language-yaml"># VLAN + Bond 示例
network:
  version: 2
  bonds:
    bond0:
      interfaces: [ens3, ens4]
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
  vlans:
    bond0.100:
      id: 100
      link: bond0
      addresses: [10.10.100.10/24]
      gateway4: 10.10.100.1
      nameservers:
        addresses: [10.10.0.2, 10.10.0.3]
</code></pre>
<h3 id="37-用户与安全配置"><a class="header" href="#37-用户与安全配置">3.7 用户与安全配置</a></h3>
<ul>
<li><code>users</code> 支持 <code>lock_passwd</code>, <code>sudo</code>, <code>shell</code>, <code>groups</code>；</li>
<li><code>ssh_authorized_keys</code>  vs <code>ssh_import_id</code>；</li>
<li><code>disable_root: true</code>/<code>false</code>；</li>
<li><code>ssh_pwauth: false</code> 禁用密码登录；</li>
<li><code>chpasswd: {expire: False}</code> 保持密码不过期；</li>
<li><code>ssh_keys:   rsa_private: |     -----BEGIN RSA PRIVATE KEY-----   rsa_public: ssh-rsa ...</code>。</li>
</ul>
<h3 id="38-服务与应用启动"><a class="header" href="#38-服务与应用启动">3.8 服务与应用启动</a></h3>
<ul>
<li><code>system_info -&gt; default_user</code> 影响默认用户；</li>
<li><code>snap</code>, <code>flatpak</code>, <code>docker</code> 配置；</li>
<li><code>runcmd</code> + <code>scripts-per-once</code> + <code>scripts-per-boot</code> + <code>scripts-per-instance</code>；</li>
<li><code>power_state:</code> 模块控制重启/关机；</li>
<li><code>snappy</code>, <code>write-metadata</code>, <code>ntp</code>.</li>
</ul>
<h3 id="39-多部件-mime-消息"><a class="header" href="#39-多部件-mime-消息">3.9 多部件 MIME 消息</a></h3>
<ul>
<li>结构：<code>multipart/mixed</code> + boundary；</li>
<li>使用工具 <code>cloud-init devel make-mime</code>。</li>
</ul>
<pre><code class="language-bash">cloud-init devel make-mime --locale en_US \
  --attach user-data:cloud-config:config.yaml \
  --attach part-handler:custom-handler.py &gt; payload.txt
</code></pre>
<h3 id="310-模块练习"><a class="header" href="#310-模块练习">3.10 模块练习</a></h3>
<ul>
<li>编写 cloud-config 完成：
<ol>
<li>设置静态网络 + Bond；</li>
<li>部署 Nginx 并写入配置；</li>
<li>添加用户、注入密钥；</li>
<li>安装监控 agent；</li>
<li>通过 <code>phone_home</code> 将安装结果回传。</li>
</ol>
</li>
<li>使用 <code>cloud-init schema --system</code> 验证 YAML。</li>
</ul>
<hr />
<h2 id="模块四进阶功能与扩展开发"><a class="header" href="#模块四进阶功能与扩展开发">模块四：进阶功能与扩展开发</a></h2>
<h3 id="41-自定义模块介绍"><a class="header" href="#41-自定义模块介绍">4.1 自定义模块介绍</a></h3>
<ul>
<li>模块类型：<code>cloudinit/config/&lt;module&gt;.py</code>；</li>
<li>继承 <code>cloudinit.config.cc_&lt;name&gt;</code>；</li>
<li>注册于 <code>/etc/cloud/cloud.cfg.d/</code> 通过 <code>cloud_config_modules</code> 注入；</li>
<li>使用优先级控制执行顺序。</li>
</ul>
<h3 id="42-part-handler-开发"><a class="header" href="#42-part-handler-开发">4.2 part-handler 开发</a></h3>
<ul>
<li>适合处理特定 MIME part，例如自动挂载 ISO；</li>
<li>Python 类必须实现 <code>list_types</code>, <code>handle_part</code>, <code>__init__</code>, <code>__del__</code>。</li>
</ul>
<pre><code class="language-python"># part-handler.py
import logging

LOG = logging.getLogger(__name__)

def list_types():
    return ["text/x-shellscript", "text/cloud-config"]

def handle_part(data, ctype, filename, payload):
    LOG.info("Handling part %s of type %s", filename, ctype)
    if ctype == "text/x-shellscript":
        with open("/root/custom.sh", "wb") as f:
            f.write(payload)
</code></pre>
<h3 id="43-python-自定义数据源"><a class="header" href="#43-python-自定义数据源">4.3 Python 自定义数据源</a></h3>
<ul>
<li>继承 <code>cloudinit.sources.DataSource</code>；</li>
<li>实现 <code>_get_data()</code>，返回 <code>metadata</code>, <code>userdata</code>, <code>vendordata</code>；</li>
<li>在 <code>/etc/cloud/cloud.cfg.d/90_dpkg.cfg</code> 注册：<code>datasource_list: [CustomDS, Ec2, NoCloud]</code>；</li>
<li>适合闭源平台或私有 API。</li>
</ul>
<h3 id="44-module-hotplugcloud-init-single"><a class="header" href="#44-module-hotplugcloud-init-single">4.4 Module Hotplug：<code>cloud-init single</code></a></h3>
<ul>
<li>调试单个模块：<code>cloud-init single --name cc_runcmd --frequency always --debug</code>；</li>
<li><code>--frequency once|always|per-instance</code>；</li>
<li>适合开发/测试阶段验证脚本。</li>
</ul>
<h3 id="45-cloud-init-内嵌模板渲染"><a class="header" href="#45-cloud-init-内嵌模板渲染">4.5 cloud-init 内嵌模板渲染</a></h3>
<ul>
<li><code>write_files</code> 支持 Jinja，通过 <code>content: |   {% for ip in host_ips %}   {{ ip }}   {% endfor %}</code>；</li>
<li><code>template: true</code> + <code>vars: { host_ips: ['10.0.0.1'] }</code>；</li>
<li>结合 metadata keys (e.g. <code>{{ ds.meta_data.availability_zone }}</code>)。</li>
</ul>
<h3 id="46-与配置管理工具协作"><a class="header" href="#46-与配置管理工具协作">4.6 与配置管理工具协作</a></h3>
<ul>
<li><code>bootcmd</code>/<code>runcmd</code> 启动 Ansible Pull、Salt Minion、Chef；</li>
<li>使用 <code>packages</code> 安装 <code>ansible</code>, <code>git</code>；</li>
<li><code>write_files</code> 分发 config；</li>
<li><code>phone_home</code> 通知 CM 系统启动；</li>
<li>方案：cloud-init 负责引导 → CM 管理持续配置。</li>
</ul>
<h3 id="47-与容器边缘场景结合"><a class="header" href="#47-与容器边缘场景结合">4.7 与容器/边缘场景结合</a></h3>
<ul>
<li><code>cloud-init</code> + <code>LXD</code>：通过 <code>cloud-init</code> profile 初始化容器；</li>
<li><code>cloud-init</code> + <code>k3s</code>：自动部署 k3s 节点；</li>
<li>Edge：使用 <code>NoCloud</code> + USB/CDROM 提供配置。</li>
</ul>
<h3 id="48-安全与合规扩展"><a class="header" href="#48-安全与合规扩展">4.8 安全与合规扩展</a></h3>
<ul>
<li>敏感信息 (<code>password</code>, <code>key</code>) 使用 <code>vault</code> 生成；</li>
<li>结合 <code>cloud-init devel render</code> + pipeline 加密；</li>
<li><code>cc_ssh_import_id</code> 支持 GitHub/GitLab；</li>
<li><code>disable_ec2_metadata</code>: true 防止 metadata 泄露（特定环境）。</li>
</ul>
<h3 id="49-module-execution-policy"><a class="header" href="#49-module-execution-policy">4.9 Module Execution Policy</a></h3>
<ul>
<li><code>system_info</code> 里 <code>distro</code>, <code>package_mirrors</code> 控制平台差异；</li>
<li><code>cloud_config_modules</code>/<code>cloud_final_modules</code> 列表控制顺序；</li>
<li><code>frequency</code> 决定多次执行逻辑。</li>
</ul>
<h3 id="410-模块练习"><a class="header" href="#410-模块练习">4.10 模块练习</a></h3>
<ul>
<li>编写 part-handler 将 shell 脚本与配置文件存储到自定义路径，并在 <code>cloud-final</code> 调用；</li>
<li>实现自定义数据源读取 HTTP JSON 并转换为 metadata；</li>
<li>将 cloud-init 与 Ansible Pull 集成，实现节点自动加入 inventory。</li>
</ul>
<hr />
<h2 id="模块五企业级落地实践"><a class="header" href="#模块五企业级落地实践">模块五：企业级落地实践</a></h2>
<h3 id="51-多云适配策略"><a class="header" href="#51-多云适配策略">5.1 多云适配策略</a></h3>
<ul>
<li><strong>跨云差异</strong>：
<ul>
<li>数据源名称、metadata 字段不同；</li>
<li>网络 renderer 可能不同；</li>
<li>包管理器/镜像源差异；</li>
<li>平台提供的 vendor-data（Azure provisioning agent/waagent）。</li>
</ul>
</li>
<li><strong>策略</strong>：
<ol>
<li>使用 <code>cloud-init</code> 的 <code>datasource_list</code> 控制优先级；</li>
<li>编写 <code>00-&lt;provider&gt;.cfg</code> 适配；</li>
<li>模板中使用条件（<code>%{ if ds.meta_data.provider == 'AliYun' }</code>）。</li>
</ol>
</li>
</ul>
<h3 id="52-镜像制作流水线"><a class="header" href="#52-镜像制作流水线">5.2 镜像制作流水线</a></h3>
<ul>
<li>流程：
<ol>
<li>使用 Packer/virt-builder 制作基础镜像；</li>
<li>预装 cloud-init + 依赖；</li>
<li>清理状态：
<pre><code class="language-bash">sudo cloud-init clean --logs
sudo rm -rf /var/lib/cloud/*
sudo truncate -s0 /etc/machine-id
</code></pre>
</li>
<li>打包镜像上传平台；</li>
<li>通过测试脚本验证。</li>
</ol>
</li>
<li>版本管理：使用 Git 存储 cloud-config 模板 + schema 验证。</li>
</ul>
<h3 id="53-云上批量实例初始化"><a class="header" href="#53-云上批量实例初始化">5.3 云上批量实例初始化</a></h3>
<ul>
<li>批量入口：IaaS API、Terraform、OpenStack Heat；</li>
<li>cloud-config 作为变量模板；</li>
<li>结合 <code>Cloud-Init per-instance</code> 进行差异化配置；</li>
<li>使用 <code>#include</code> 指令组合；</li>
<li>记录版本/变更：<code>phone_home</code> 发送 <code>git commit hash</code>。</li>
</ul>
<h3 id="54-安全控制"><a class="header" href="#54-安全控制">5.4 安全控制</a></h3>
<ul>
<li>使用 cloud-init 配置 <code>auditd</code>, <code>fail2ban</code>, <code>osquery</code>；</li>
<li>强制 <code>ssh_pwauth: false</code>, <code>disable_root: true</code>；</li>
<li>部署 <code>CIS</code> 检查脚本；</li>
<li>处理敏感信息：结合 <code>HashiCorp Vault</code>, <code>KMS</code>, <code>Secrets Manager</code>；</li>
<li><code>cc_ca_certs</code> 信任企业 CA。</li>
</ul>
<h3 id="55-日志收集与可观测性"><a class="header" href="#55-日志收集与可观测性">5.5 日志收集与可观测性</a></h3>
<ul>
<li><code>cloud-init collect-logs --tarfile /tmp/cloud-init-logs.tgz</code>；</li>
<li>使用 Filebeat/Fluent Bit 收集 <code>/var/log/cloud-init*</code>；</li>
<li>将执行事件发送到 ELK/Grafana Loki；</li>
<li><code>phone_home</code> + <code>webhook</code> + <code>MQ</code>。</li>
</ul>
<h3 id="56-自愈与回滚"><a class="header" href="#56-自愈与回滚">5.6 自愈与回滚</a></h3>
<ul>
<li><code>runcmd</code> 中实现失败检测，错误时 <code>power_state: {mode: reboot, condition: true}</code>；</li>
<li><code>bootcmd</code> 配合 <code>retry</code>；</li>
<li>失败回滚：结合快照、Terraform Destroy；</li>
<li><code>cloud-init analyze blame</code> 定位耗时模块 → 优化。</li>
</ul>
<h3 id="57-与-cicd-集成"><a class="header" href="#57-与-cicd-集成">5.7 与 CI/CD 集成</a></h3>
<ul>
<li>Pipeline 中注入 cloud-config 作为 Artifact；</li>
<li>使用 <code>pytest</code> + <code>testinfra</code> 验证节点状态；</li>
<li>k8s cluster 节点自动加入：cloud-init 执行 kubeadm join；</li>
<li><code>GitOps</code>：cloud-config versioned in Git，ArgoCD 分发。</li>
</ul>
<h3 id="58-生命周期管理"><a class="header" href="#58-生命周期管理">5.8 生命周期管理</a></h3>
<ul>
<li>cloud-init 一次性服务 vs 再次运行：<code>cloud-init clean</code>; <code>cloud-init status</code>; <code>per-instance</code>；</li>
<li>变更管理：
<ul>
<li>新增模块 → 版本控制；</li>
<li>通过 <code>phone_home</code> / <code>metadata</code> 记录版本；</li>
<li>复用 <code>cloud-init</code> 进行扩容/升级。</li>
</ul>
</li>
</ul>
<h3 id="59-多语言跨平台场景"><a class="header" href="#59-多语言跨平台场景">5.9 多语言/跨平台场景</a></h3>
<ul>
<li>Windows 支持：<code>cloudbase-init</code>; 配置类似 cloud-init；</li>
<li>BSD/FreeBSD 兼容性；</li>
<li>组合 <code>Ignition</code> (CoreOS)；</li>
<li><code>cloud-init</code> 与 <code>Ansible</code> 角色；</li>
<li>通过 <code>ConfigDrive</code> 适配 VMware vSphere/OVF。</li>
</ul>
<h3 id="510-实战项目案例"><a class="header" href="#510-实战项目案例">5.10 实战项目案例</a></h3>
<ul>
<li><strong>OpenStack 业务集群初始化</strong>：
<ul>
<li>使用 Heat 模板 + cloud-init；</li>
<li>tasks: 创建多网卡、部署 Consul、设置日志；</li>
<li>输出：初始化耗时 &lt; 5 min，失败率 &lt; 1%。</li>
</ul>
</li>
<li><strong>公有云多环境统一模板</strong>：
<ul>
<li>设计 YAML <code>base.yaml</code>, <code>aws.yaml</code>, <code>aliyun.yaml</code>;</li>
<li>CI 渲染 + <code>cloud-init schema</code> 验证；</li>
<li>结果：模板复用率 80%，变更可追踪。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="模块六故障诊断测试与最佳实践"><a class="header" href="#模块六故障诊断测试与最佳实践">模块六：故障诊断、测试与最佳实践</a></h2>
<h3 id="61-日志分析"><a class="header" href="#61-日志分析">6.1 日志分析</a></h3>
<ul>
<li><code>/var/log/cloud-init.log</code>：主日志；</li>
<li><code>/var/log/cloud-init-output.log</code>：script stdout/stderr；</li>
<li><code>journalctl -u cloud-init</code>; <code>journalctl -u cloud-final</code>。</li>
</ul>
<h3 id="62-常见错误案例"><a class="header" href="#62-常见错误案例">6.2 常见错误案例</a></h3>
<div class="table-wrapper"><table><thead><tr><th>场景</th><th>日志提示</th><th>处理策略</th></tr></thead><tbody>
<tr><td>YAML 解析失败</td><td><code>Error parsing config...</code></td><td>使用 <code>yamllint</code> / <code>cloud-init schema</code> 验证</td></tr>
<tr><td>数据源不可达</td><td><code>datasource... not found</code></td><td>检查网络、 metadata endpoint、fallback 机制</td></tr>
<tr><td>网络配置错误</td><td><code>Renderer did not apply</code></td><td>确认 renderer，检查 Netplan 语法</td></tr>
<tr><td>实例不再执行 cloud-init</td><td><code>no new changes</code></td><td>清理 <code>/var/lib/cloud</code>, 重置 instance-id</td></tr>
<tr><td>script 超时</td><td><code>Command ... failed</code></td><td>引入超时、重试，把逻辑移至 CM</td></tr>
<tr><td>包安装失败</td><td><code>apt-get</code>/<code>yum</code> 错误</td><td>检查镜像源、使用 <code>package_retry_updates</code></td></tr>
</tbody></table>
</div>
<h3 id="63-分层排查流程"><a class="header" href="#63-分层排查流程">6.3 分层排查流程</a></h3>
<ol>
<li><strong>确认数据源</strong>：<code>cloud-init query ds</code>；</li>
<li><strong>查看状态</strong>：<code>cloud-init status --long</code>；</li>
<li><strong>检查日志</strong>；</li>
<li><strong>重跑模块</strong>：<code>cloud-init single</code>；</li>
<li><strong>定位 YAML</strong>：<code>cloud-init schema --annotate</code>；</li>
<li><strong>系统层验证</strong>：<code>ls -l /var/lib/cloud/instance</code>；</li>
<li><strong>平台排查</strong>：metadata 服务、API 侧；</li>
<li><strong>镜像检查</strong>：cloud-init 版本、组件。</li>
</ol>
<h3 id="64-自动化测试策略"><a class="header" href="#64-自动化测试策略">6.4 自动化测试策略</a></h3>
<ul>
<li><strong>本地测试</strong>：<code>cloud-init analyze</code> + KVM NoCloud；</li>
<li><strong>单元测试</strong>：使用 <code>pytest</code> + <code>testinfra</code> 验证系统状态；</li>
<li><strong>集成测试</strong>：CI 启动临时实例，执行 <code>goss/serverspec</code>；</li>
<li><strong>schema 验证</strong>：<code>yamllint</code>, <code>cloud-init schema</code>；</li>
<li><strong>Mock 数据源</strong>：<code>cloud-init devel schema</code> + <code>cloud-init query</code>；</li>
<li><strong>回归</strong>：对关键模板建立回归测试集。</li>
</ul>
<h3 id="65-性能优化"><a class="header" href="#65-性能优化">6.5 性能优化</a></h3>
<ul>
<li>减少 <code>apt update</code> 次数，使用预装包；</li>
<li>合理利用 <code>package_update</code>, <code>package_upgrade</code>；</li>
<li>使用 <code>snap-preseed</code>（Ubuntu）缩短安装时间；</li>
<li>预热镜像、缓存；</li>
<li><code>cloud-init analyze blame</code> 找出耗时模块。</li>
</ul>
<h3 id="66-安全注意事项"><a class="header" href="#66-安全注意事项">6.6 安全注意事项</a></h3>
<ul>
<li>避免在 User-Data 中明文存 secrets；</li>
<li>使用云平台 secrets manager；</li>
<li>限制 metadata service 访问 (<code>iptables</code>/<code>AWS IMDSv2</code>);</li>
<li>cloud-init 版本更新 → 跟进 CVE；</li>
<li>采用 <code>sshd_config</code> 强化策略；</li>
<li>定期审计 <code>write_files</code> 生成的脚本。</li>
</ul>
<h3 id="67-结果度量指标"><a class="header" href="#67-结果度量指标">6.7 结果度量指标</a></h3>
<ul>
<li>初始化成功率、耗时、失败原因；</li>
<li>配置漂移检测（对比 baseline）；</li>
<li>自动化覆盖率（测试案例数）；</li>
<li>安全合规项通过率；</li>
<li>模板重用率、变更频率。</li>
</ul>
<h3 id="68-知识体系沉淀"><a class="header" href="#68-知识体系沉淀">6.8 知识体系沉淀</a></h3>
<ul>
<li>搭建文档库：配置模板、FAQ、调试指南；</li>
<li>每次故障复盘（RCA）；</li>
<li>建立 <code>cloud-init</code> 社区关注列表；</li>
<li>技术分享/培训材料。</li>
</ul>
<h3 id="69-常见问答-faq"><a class="header" href="#69-常见问答-faq">6.9 常见问答 (FAQ)</a></h3>
<ol>
<li><strong>如何禁用 cloud-init？</strong>
<ul>
<li>修改 <code>/etc/cloud/cloud-init.disabled</code>；</li>
<li>或 <code>sudo touch /etc/cloud/cloud-init.disabled</code>；</li>
</ul>
</li>
<li><strong>如何在运行中重新执行 cloud-init？</strong>
<ul>
<li><code>sudo cloud-init clean</code>; <code>sudo cloud-init init</code>；</li>
</ul>
</li>
<li><strong>如何为不同环境加载不同配置？</strong>
<ul>
<li>使用 <code>#include</code> 指向公共 HTTP URL；</li>
<li>自定义数据源；</li>
</ul>
</li>
<li><strong>如何避免重复执行 runcmd？</strong>
<ul>
<li>脚本内部写标记文件；</li>
<li>使用 <code>frequency</code> 控制。</li>
</ul>
</li>
</ol>
<h3 id="610-实战演练清单"><a class="header" href="#610-实战演练清单">6.10 实战演练清单</a></h3>
<ul>
<li>模拟数据源故障（关闭 metadata 服务），观察 fallback；</li>
<li>模拟 YAML 语法错误 → 使用 lint 工具定位；</li>
<li>记录 cloud-init 执行耗时 → 优化；</li>
<li>在不同发行版测试模板兼容性；</li>
<li>构建 <code>cloud-init</code> 版本升级策略。</li>
</ul>
<hr />
<h2 id="学习路径设计"><a class="header" href="#学习路径设计">学习路径设计</a></h2>
<div class="table-wrapper"><table><thead><tr><th>阶段</th><th>时间建议</th><th>学习目标</th><th>关键行动</th><th>产出</th></tr></thead><tbody>
<tr><td>阶段 0：基础准备</td><td>1 天</td><td>了解 cloud-init 概念、安装环境</td><td>阅读官方文档、部署 KVM 实验环境</td><td>资料整理、环境手册</td></tr>
<tr><td>阶段 1：核心掌握</td><td>3 天</td><td>掌握 cloud-config 常用字段与模块</td><td>编写基础模板、验证用户/网络/包</td><td>模板仓库初版、验证报告</td></tr>
<tr><td>阶段 2：进阶扩展</td><td>4 天</td><td>自定义模块、part-handler、数据源</td><td>开发扩展、与 CM 工具集成</td><td>扩展模块代码、CI 流水线</td></tr>
<tr><td>阶段 3：企业落地</td><td>5-7 天</td><td>构建多云适配、安全治理、监控</td><td>打造镜像流水线、日志采集</td><td>企业标准模板、监控方案</td></tr>
<tr><td>阶段 4：持续优化</td><td>持续</td><td>故障排查、性能优化、知识沉淀</td><td>建立 FAQ、演练、参与社区</td><td>知识库、培训材料</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="实战案例设计"><a class="header" href="#实战案例设计">实战案例设计</a></h2>
<h3 id="案例一openstack-自动化部署-web-集群"><a class="header" href="#案例一openstack-自动化部署-web-集群">案例一：OpenStack 自动化部署 Web 集群</a></h3>
<ul>
<li><strong>背景</strong>：企业在 OpenStack 上部署多节点 Web 应用，需要统一初始化。</li>
<li><strong>步骤</strong>：
<ol>
<li>设计 <code>base.yaml</code>，包含用户、SSH、日志；</li>
<li><code>web.yaml</code> 扩展：安装 Nginx、部署应用、配置日志；</li>
<li>Heat 模板传递 <code>user_data</code>；</li>
<li>使用 <code>cloud-init analyze</code> 分析耗时；</li>
<li><code>phone_home</code> 通知 Ansible 完成收尾；</li>
<li>收集日志上传 ELK；</li>
</ol>
</li>
<li><strong>验收标准</strong>：实例上线后 3 分钟内完成服务部署；错误率 &lt; 1%。</li>
</ul>
<h3 id="案例二多云统一镜像管理"><a class="header" href="#案例二多云统一镜像管理">案例二：多云统一镜像管理</a></h3>
<ul>
<li><strong>背景</strong>：团队维护 AWS/Azure/阿里云三套环境，需统一 Cloud-init 初始化。</li>
<li><strong>步骤</strong>：
<ol>
<li>使用 Packer + HCL 定义多平台镜像构建；</li>
<li>Cloud-config 模板分层：<code>base.yaml</code> + <code>platform-specific</code>；</li>
<li>CI 校验 <code>cloud-init schema</code> + <code>yamllint</code>；</li>
<li>自动上传镜像到各云平台；</li>
<li>编写兼容测试脚本验证用户/网络/安全项；</li>
</ol>
</li>
<li><strong>验收标准</strong>：模板统一维护，版本号统一；云实例初始化一致性 100%。</li>
</ul>
<h3 id="案例三云数据库节点加固"><a class="header" href="#案例三云数据库节点加固">案例三：云数据库节点加固</a></h3>
<ul>
<li><strong>背景</strong>：部署数据库集群，需要在初始化阶段配置安全策略、监控、备份。</li>
<li><strong>步骤</strong>：
<ol>
<li>通过 cloud-config 配置用户、禁用 root、启用 MFA；</li>
<li>安装数据库软件、配置 systemd；</li>
<li>部署监控 agent、Logrotate、备份脚本；</li>
<li>配置 <code>phone_home</code> 上传节点健康信息；</li>
<li>运行 <code>runcmd</code> 进行数据目录挂载与权限配置；</li>
</ol>
</li>
<li><strong>验收标准</strong>：安全检查通过率 100%，备份任务自动执行。</li>
</ul>
<h3 id="案例四边缘节点-usb-nocloud-引导"><a class="header" href="#案例四边缘节点-usb-nocloud-引导">案例四：边缘节点 USB-NoCloud 引导</a></h3>
<ul>
<li><strong>背景</strong>：离线环境，通过 USB 驱动器提供 cloud-init 配置。</li>
<li><strong>步骤</strong>：
<ol>
<li>创建 <code>seed.iso</code> + <code>user-data</code>, <code>meta-data</code>；</li>
<li>使用 Kickstart/Autoinstall + cloud-init；</li>
<li><code>write_files</code> 分发应用配置，<code>bootcmd</code> 设置串口；</li>
<li><code>runcmd</code> 启动服务并通过短信/卫星网络 <code>phone_home</code>；</li>
</ol>
</li>
<li><strong>验收标准</strong>：离线节点在 5 分钟内完成配置并上传状态。</li>
</ul>
<h3 id="案例五cloud-init-兼容性测试平台"><a class="header" href="#案例五cloud-init-兼容性测试平台">案例五：cloud-init 兼容性测试平台</a></h3>
<ul>
<li><strong>目标</strong>：搭建自动化平台，对模板在多个发行版/平台验证。</li>
<li><strong>方案</strong>：
<ol>
<li>Jenkins pipeline + Terraform 创建实例；</li>
<li>分发 cloud-config，执行测试；</li>
<li>收集日志、cloud-init analyze 结果；</li>
<li>生成报告，统计成功率/耗时；</li>
</ol>
</li>
<li><strong>验收标准</strong>：覆盖 4 个发行版、3 个云平台；自动生成日报。</li>
</ul>
<hr />
<h2 id="学习成果验证标准"><a class="header" href="#学习成果验证标准">学习成果验证标准</a></h2>
<ol>
<li><strong>模板质量</strong>：所有 cloud-config 通过 <code>cloud-init schema</code>, <code>yamllint</code>, 单元测试；</li>
<li><strong>自动化覆盖</strong>：CI 中 cloud-init 测试覆盖率 ≥ 80%；</li>
<li><strong>初始化稳定性</strong>：批量 100 台实例初始化失败率 ≤ 2%；</li>
<li><strong>性能指标</strong>：cloud-init 执行总耗时 &lt; 180 秒；</li>
<li><strong>安全合规</strong>：启用 SSH 加固、日志审计，满足公司安全基线；</li>
<li><strong>知识沉淀</strong>：输出至少 2 篇技术分享/文档，团队评审通过；</li>
<li><strong>漏洞响应</strong>：建立 cloud-init 版本升级流程，响应时间 &lt; 24h。</li>
</ol>
<hr />
<h2 id="扩展资源与进阶建议"><a class="header" href="#扩展资源与进阶建议">扩展资源与进阶建议</a></h2>
<ul>
<li><strong>官方文档</strong>：
<ul>
<li>https://cloudinit.readthedocs.io</li>
<li>Ubuntu Wiki: CloudInit</li>
</ul>
</li>
<li><strong>源码与社区</strong>：
<ul>
<li>GitHub: https://github.com/canonical/cloud-init</li>
<li>Launchpad Bugs：https://bugs.launchpad.net/cloud-init</li>
<li>IRC/Matrix：<code>#cloud-init</code> 频道；</li>
</ul>
</li>
<li><strong>工具链</strong>：
<ul>
<li><code>cloud-utils</code>、<code>cloud-localds</code>、<code>cloud-init analyze</code>；</li>
<li><code>Packer</code>, <code>Terraform</code>, <code>Ansible</code>, <code>Testinfra</code>, <code>Goss</code>；</li>
</ul>
</li>
<li><strong>书籍与课程</strong>：
<ul>
<li>《OpenStack Cloud Administrator Guide》</li>
<li>AWS/Azure/GCP 官方培训材料</li>
</ul>
</li>
<li><strong>进阶建议</strong>：
<ol>
<li>深入阅读 cloud-init 源码，了解模块执行细节；</li>
<li>在企业中推动 cloud-init 模板治理与变更流程；</li>
<li>参与社区贡献：提交 PR、Bugfix、文档翻译；</li>
<li>探索 cloud-init 与容器、边缘计算结合；</li>
<li>建立 cloud-init 监控与报警最佳实践。</li>
</ol>
</li>
</ul>
<hr />
<h2 id="附录"><a class="header" href="#附录">附录</a></h2>
<h3 id="a-常用命令速查"><a class="header" href="#a-常用命令速查">A. 常用命令速查</a></h3>
<pre><code class="language-bash">sudo cloud-init status --long         # 查看执行状态
sudo cloud-init clean --logs          # 清理状态和日志，准备重跑
sudo cloud-init single --name cc_runcmd --frequency always --debug
sudo cloud-init analyze show          # 显示时间线
sudo cloud-init query --all           # 查询数据源内容
sudo cloud-init collect-logs          # 打包日志
cloud-init devel render &lt;file&gt;        # 渲染模板（实验）
</code></pre>
<h3 id="b-日志位置"><a class="header" href="#b-日志位置">B. 日志位置</a></h3>
<ul>
<li><code>/var/log/cloud-init.log</code></li>
<li><code>/var/log/cloud-init-output.log</code></li>
<li><code>/run/cloud-init</code> 临时状态</li>
<li><code>/var/lib/cloud/instance</code> 历史信息</li>
</ul>
<h3 id="c-yaml-lint-规则建议"><a class="header" href="#c-yaml-lint-规则建议">C. YAML Lint 规则建议</a></h3>
<ul>
<li>使用 <code>pip install yamllint</code></li>
<li>示例配置：</li>
</ul>
<pre><code class="language-yaml">extends: default
rules:
  line-length:
    max: 180
  truthy:
    allowed-values: ['true', 'false', 'on', 'off']
  document-start: disable
</code></pre>
<h3 id="d-元数据字段示例openstack"><a class="header" href="#d-元数据字段示例openstack">D. 元数据字段示例（OpenStack）</a></h3>
<pre><code class="language-json">{
  "uuid": "e2c83cf0-...",
  "availability_zone": "nova",
  "hostname": "web-01",
  "public_keys": {
    "default": "ssh-rsa AAAAB3..."
  },
  "meta": {
    "group": "web",
    "env": "prod"
  }
}
</code></pre>
<h3 id="e-参考-cloud-config-模板库结构"><a class="header" href="#e-参考-cloud-config-模板库结构">E. 参考 cloud-config 模板库结构</a></h3>
<pre><code>cloud-config/
├── base/
│   ├── 00-global.yaml
│   ├── 10-security.yaml
│   └── 20-monitoring.yaml
├── env/
│   ├── prod.yaml
│   ├── staging.yaml
│   └── dev.yaml
├── platform/
│   ├── aws.yaml
│   ├── azure.yaml
│   └── openstack.yaml
└── apps/
    ├── web.yaml
    ├── db.yaml
    └── cache.yaml
</code></pre>
<blockquote>
<p>cloud-init 是云主机初始化的基石。掌握其机制、构建自动化治理体系，并持续迭代经验沉淀，才能在快速扩缩容、跨云部署与高可靠运维中保持效率与稳定。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../编程/云计算/blivet.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../编程/云计算/cpu-pinning.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../编程/云计算/blivet.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../编程/云计算/cpu-pinning.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../theme/segmentit.umd.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../theme/searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../theme/pagetoc.js"></script>



    </div>
    </body>
</html>

